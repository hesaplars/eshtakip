<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Evde SaÄŸlÄ±k">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <meta name="format-detection" content="telephone=no">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.9/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Sisteme gÃ¶re deÄŸil, bizim ekleyeceÄŸimiz 'class'a gÃ¶re Ã§alÄ±ÅŸÄ±r
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f3f4f6;
            /* bg-gray-100 */
            /* MOBÄ°L Ä°Ã‡Ä°N EKLENEN KISIM: */
            overscroll-behavior-y: contain;
            /* SayfayÄ± aÅŸaÄŸÄ± Ã§ekince yenilemeyi engeller */
            -webkit-tap-highlight-color: transparent;
            /* TÄ±klayÄ±nca Ã§Ä±kan mavi kutuyu kaldÄ±rÄ±r */
            touch-action: manipulation;
            /* Dokunmatik tepkisini hÄ±zlandÄ±rÄ±r */
        }

        /* KARANLIK MOD Ä°Ã‡Ä°N Ã–ZEL STÄ°LLER (HIZLI Ã‡Ã–ZÃœM) */
        .dark body {
            background-color: #111827 !important;
            color: #e5e7eb !important;
        }

        .dark .bg-white {
            background-color: #1f2937 !important;
            border-color: #374151 !important;
            color: #e5e7eb !important;
        }

        .dark .bg-gray-50 {
            background-color: #111827 !important;
            border-color: #374151 !important;
            color: #9ca3af !important;
        }

        .dark .bg-gray-100 {
            background-color: #374151 !important;
            color: #e5e7eb !important;
        }

        .dark .text-gray-900,
        .dark .text-gray-800,
        .dark .text-gray-700 {
            color: #f3f4f6 !important;
        }

        .dark .text-gray-600,
        .dark .text-gray-500 {
            color: #9ca3af !important;
        }

        .dark .border-gray-100,
        .dark .border-gray-200,
        .dark .border-gray-300 {
            border-color: #374151 !important;
        }

        /* Tablo ve Inputlar iÃ§in Ã¶zel ayarlar */
        .dark input,
        .dark select,
        .dark textarea {
            background-color: #374151 !important;
            color: #fff !important;
            border-color: #4b5563 !important;
        }

        .dark table thead th {
            background-color: #111827 !important;
            color: #9ca3af !important;
            border-color: #374151 !important;
        }

        .dark .modal-enter {
            background-color: #1f2937 !important;
            border-color: #4b5563 !important;
        }

        /* Renkli alanlarÄ± biraz yumuÅŸat (GÃ¶z almasÄ±n) */
        .dark .bg-indigo-50 {
            background-color: #312e81 !important;
            color: #e0e7ff !important;
            border-color: #4338ca !important;
        }

        .dark .text-indigo-900 {
            color: #e0e7ff !important;
        }

        .dark .bg-red-50 {
            background-color: #7f1d1d !important;
            color: #fca5a5 !important;
        }

        .dark .bg-green-50 {
            background-color: #14532d !important;
            color: #86efac !important;
        }

        .dark .bg-blue-50 {
            background-color: #1e3a8a !important;
            color: #93c5fd !important;
        }

        .dark .bg-orange-50 {
            background-color: #7c2d12 !important;
            color: #fdba74 !important;
        }

        .dark .bg-yellow-50 {
            background-color: #713f12 !important;
            color: #fde047 !important;
        }

        .dark .bg-purple-50 {
            background-color: #581c87 !important;
            color: #d8b4fe !important;
        }

        /* Scrollbar'Ä± da karartalÄ±m */
        .dark ::-webkit-scrollbar-track {
            background: #111827;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        /* KaydÄ±rma Ã§ubuÄŸunu gizle ama kaydÄ±rmaya izin ver */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* MOBÄ°L Ä°Ã‡Ä°N Ã–ZEL SIKIÅTIRMA AYARLARI */
        @media (max-width: 768px) {

            /* Tablo hÃ¼crelerindeki boÅŸluklarÄ± azalt ve yazÄ±yÄ± kÃ¼Ã§Ã¼lt */
            table th,
            table td {
                padding-left: 4px !important;
                padding-right: 4px !important;
                padding-top: 6px !important;
                padding-bottom: 6px !important;
                font-size: 10px !important;
                /* YazÄ±lar daha kÃ¼Ã§Ã¼k */
            }

            /* ButonlarÄ±n iÃ§indeki yazÄ±larÄ± mobilde gizle, sadece ikon kalsÄ±n */
            .mobile-icon-only span {
                display: none !important;
            }

            /* Mobilde butonlarÄ±n paddingini azalt */
            .mobile-icon-only {
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
        }

        /* ============================================
   Ã–ZEL GÃœN TEMA ANÄ°MASYONLARI
   ============================================ */

        /* Kar YaÄŸÄ±ÅŸÄ± Animasyonu */
        @keyframes snowfall {
            0% {
                transform: translateY(-10vh) translateX(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(110vh) translateX(50px) rotate(360deg);
                opacity: 0.3;
            }
        }

        .snowflake {
            position: fixed;
            top: -20px;
            color: #fff;
            font-size: 1.5rem;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            pointer-events: none;
            z-index: 9998;
            animation: snowfall linear infinite;
        }

        /* Konfeti Animasyonu */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(110vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            top: -20px;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 9998;
            animation: confetti-fall linear infinite;
        }

        /* Balon Animasyonu */
        @keyframes balloon-float {
            0% {
                transform: translateY(110vh) rotate(-5deg);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateY(-20vh) rotate(5deg);
                opacity: 0;
            }
        }

        .balloon {
            position: fixed;
            bottom: -50px;
            font-size: 2.5rem;
            pointer-events: none;
            z-index: 9998;
            animation: balloon-float ease-in-out infinite;
        }

        /* Havai FiÅŸek Animasyonu */
        @keyframes firework-explode {
            0% {
                transform: scale(0);
                opacity: 1;
            }

            50% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .firework {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            animation: firework-explode 1.5s ease-out forwards;
        }

        /* Bayrak Dalgalanma */
        @keyframes flag-wave {

            0%,
            100% {
                transform: rotate(-2deg) scale(1);
            }

            50% {
                transform: rotate(2deg) scale(1.02);
            }
        }

        .flag-icon {
            animation: flag-wave 2s ease-in-out infinite;
            display: inline-block;
        }

        /* Hilal ParÄ±ltÄ±sÄ± */
        @keyframes crescent-glow {

            0%,
            100% {
                filter: drop-shadow(0 0 10px gold);
            }

            50% {
                filter: drop-shadow(0 0 20px gold) drop-shadow(0 0 30px orange);
            }
        }

        .crescent-icon {
            animation: crescent-glow 2s ease-in-out infinite;
            display: inline-block;
        }

        /* Banner Stilleri */
        #special-day-banner {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        #special-day-banner.banner-newyear {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 50%, #1e3a5f 100%);
            border-bottom: 3px solid #fbbf24;
        }

        #special-day-banner.banner-children {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 50%, #3b82f6 100%);
            border-bottom: 3px solid #fcd34d;
        }

        #special-day-banner.banner-national {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-bottom: 3px solid #fef3c7;
        }

        #special-day-banner.banner-republic {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            border-bottom: 3px solid #fbbf24;
        }

        #special-day-banner.banner-ataturk {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            border-bottom: 3px solid #6b7280;
        }

        #special-day-banner.banner-religious {
            background: linear-gradient(135deg, #065f46 0%, #047857 50%, #059669 100%);
            border-bottom: 3px solid #fcd34d;
        }

        #special-day-banner.banner-labor {
            background: linear-gradient(135deg, #dc2626 0%, #ea580c 100%);
            border-bottom: 3px solid #fef3c7;
        }

        #special-day-banner.banner-democracy {
            background: linear-gradient(135deg, #1e40af 0%, #dc2626 100%);
            border-bottom: 3px solid #fbbf24;
        }

        /* 10 KasÄ±m Anma Modu */
        .ataturk-memorial-mode {
            filter: grayscale(100%);
        }

        .ataturk-memorial-mode #special-day-banner {
            filter: grayscale(0%);
        }

        /* Efekt Container */
        #theme-effects-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9997;
            overflow: hidden;
        }

        /* ============================================
   ROL BAZLI YETKÄ°LENDÄ°RME STÄ°LLERÄ°
   ============================================ */

        /* Viewer iÃ§in gizlenecek elementler */
        .role-hide-viewer {
            display: none !important;
        }

        /* User iÃ§in gizlenecek elementler */
        .role-hide-user {
            display: none !important;
        }

        /* Rol badge stilleri */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .role-badge.admin {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .role-badge.user {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .role-badge.viewer {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #9ca3af;
        }
    </style>

    <!-- Firebase SDK v10.7.1 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>


<body class="p-4 md:p-6 lg:p-8 text-gray-800">

    <!-- Firebase Authentication UI -->
    <div id="auth-container"
        class="fixed inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 flex items-center justify-center z-[9999]">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div
                    class="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-white">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Evde SaÄŸlÄ±k YÃ¶netimi</h1>
                <p class="text-gray-500 text-sm">GÃ¼venli giriÅŸ yapÄ±n veya hesap oluÅŸturun</p>
            </div>

            <div class="flex border-b mb-6">
                <button id="tab-login-btn" onclick="switchAuthTab('login')"
                    class="flex-1 py-3 text-sm font-semibold border-b-2 border-indigo-600 text-indigo-600">GiriÅŸ
                    Yap</button>
                <button id="tab-register-btn" onclick="switchAuthTab('register')"
                    class="flex-1 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-500">KayÄ±t
                    Ol</button>
            </div>

            <div id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">E-posta</label>
                    <input type="email" id="login-email" placeholder="ornek@email.com"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Åifre</label>
                    <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <button onclick="loginUser()"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md">GiriÅŸ
                    Yap</button>
                <div class="text-center pt-2">
                    <button onclick="showPasswordResetForm()"
                        class="text-sm text-indigo-600 hover:text-indigo-800 font-medium hover:underline">ğŸ” Åifremi
                        Unuttum</button>
                </div>
            </div>

            <div id="register-form" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">E-posta</label>
                    <input type="email" id="register-email" placeholder="ornek@email.com"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Åifre (en az 6 karakter)</label>
                    <input type="password" id="register-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Åifre Tekrar</label>
                    <input type="password" id="register-password-confirm" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="border-t pt-4 mt-4">
                    <p class="text-xs text-gray-500 mb-3 bg-yellow-50 p-2 rounded border border-yellow-200">âš ï¸ GÃ¼venlik
                        sorusu, ÅŸifrenizi unuttuÄŸunuzda hesabÄ±nÄ±zÄ± kurtarmanÄ±z iÃ§in kullanÄ±lacaktÄ±r.</p>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">GÃ¼venlik Sorusu</label>
                        <select id="register-security-question"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="">-- Bir soru seÃ§in --</option>
                            <option value="Ä°lk evcil hayvanÄ±nÄ±zÄ±n adÄ± nedir?">Ä°lk evcil hayvanÄ±nÄ±zÄ±n adÄ± nedir?</option>
                            <option value="Annenizin kÄ±zlÄ±k soyadÄ± nedir?">Annenizin kÄ±zlÄ±k soyadÄ± nedir?</option>
                            <option value="Ä°lk okulunuzun adÄ± nedir?">Ä°lk okulunuzun adÄ± nedir?</option>
                            <option value="DoÄŸduÄŸunuz ÅŸehir neresidir?">DoÄŸduÄŸunuz ÅŸehir neresidir?</option>
                            <option value="En sevdiÄŸiniz kitap nedir?">En sevdiÄŸiniz kitap nedir?</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">GÃ¼venlik CevabÄ±</label>
                        <input type="text" id="register-security-answer" placeholder="CevabÄ±nÄ±zÄ± yazÄ±n..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <button onclick="registerUser()"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md">Hesap
                    OluÅŸtur</button>
            </div>

            <div id="password-reset-form" class="space-y-4 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-bold text-blue-800 mb-1">ğŸ” Åifre SÄ±fÄ±rlama</h3>
                    <p class="text-xs text-blue-600">GÃ¼venlik sorunuzu doÄŸru cevaplayarak ÅŸifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ±
                        alabilirsiniz.</p>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">E-posta Adresiniz</label>
                    <input type="email" id="reset-email" placeholder="ornek@email.com"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <button onclick="fetchSecurityQuestion()" id="btn-fetch-question"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-md">GÃ¼venlik
                    Sorumu Getir</button>
                <div id="security-question-area" class="hidden space-y-4 border-t pt-4 mt-4">
                    <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                        <p class="text-xs text-yellow-700 font-bold uppercase mb-1">GÃ¼venlik Sorunuz:</p>
                        <p id="display-security-question" class="text-sm font-semibold text-gray-800"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">CevabÄ±nÄ±z</label>
                        <input type="text" id="reset-security-answer" placeholder="CevabÄ± yazÄ±n..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <button onclick="verifyAndSendReset()"
                        class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition shadow-md">âœ‰ï¸
                        Åifre SÄ±fÄ±rlama E-postasÄ± GÃ¶nder</button>
                </div>
                <div class="text-center pt-2 border-t mt-4">
                    <button onclick="hidePasswordResetForm()"
                        class="text-sm text-gray-500 hover:text-gray-700 font-medium hover:underline">â† GiriÅŸ EkranÄ±na
                        DÃ¶n</button>
                </div>
            </div>

            <div id="auth-message" class="mt-4 text-sm text-center hidden"></div>
            <div id="auth-loading" class="mt-6 text-center hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <p class="text-sm text-gray-600 mt-2">YÃ¼kleniyor...</p>
            </div>
        </div>
    </div>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDrCHrD7k1egixzle9WbIXPg2ZfSAoJXBM",
            authDomain: "evdesaglikv2.firebaseapp.com",
            databaseURL: "https://evdesaglikv2-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "evdesaglikv2",
            storageBucket: "evdesaglikv2.firebasestorage.app",
            messagingSenderId: "400960066062",
            appId: "1:400960066062:web:d07109838f3230e7ab625f"
        };

        // Firebase'i baÅŸlat
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        console.log('ğŸ”¥ Firebase baÅŸlatÄ±ldÄ±');
        console.log('ğŸ“¡ Database URL:', firebaseConfig.databaseURL);

        // Firebase baÄŸlantÄ± durumunu izle
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            if (snap.val() === true) {
                console.log('âœ… Firebase: BaÄŸlantÄ± aktif');
            } else {
                console.log('âš ï¸ Firebase: BaÄŸlantÄ± yok - Offline modda Ã§alÄ±ÅŸÄ±yor');
            }
        });

        let currentUser = null;
        let userDataPath = null;
        let firebaseListeners = [];
        let isInitialLoad = true; // Ä°lk yÃ¼klemeyi tespit etmek iÃ§in flag
        window.doctorRequestsList = []; // Doktor talepleri listesi - GLOBAL scope (canlÄ± senkronizasyon iÃ§in)

        function switchAuthTab(tab) {
            const loginBtn = document.getElementById('tab-login-btn');
            const registerBtn = document.getElementById('tab-register-btn');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');

            if (tab === 'login') {
                loginBtn.classList.add('border-indigo-600', 'text-indigo-600');
                loginBtn.classList.remove('border-transparent', 'text-gray-500');
                registerBtn.classList.remove('border-indigo-600', 'text-indigo-600');
                registerBtn.classList.add('border-transparent', 'text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerBtn.classList.add('border-indigo-600', 'text-indigo-600');
                registerBtn.classList.remove('border-transparent', 'text-gray-500');
                loginBtn.classList.remove('border-indigo-600', 'text-indigo-600');
                loginBtn.classList.add('border-transparent', 'text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
            document.getElementById('auth-message').classList.add('hidden');
        }

        function showAuthMessage(message, type = 'error') {
            const msgEl = document.getElementById('auth-message');
            msgEl.textContent = message;
            msgEl.className = `mt-4 text-sm text-center ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            msgEl.classList.remove('hidden');
        }

        async function registerUser() {
            if (!isRegistrationEnabled) {
                showAuthMessage('Yeni Ã¼ye alÄ±mÄ± ÅŸu an kapalÄ±dÄ±r.');
                return;
            }
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            const securityQuestion = document.getElementById('register-security-question').value;
            const securityAnswer = document.getElementById('register-security-answer').value.trim();

            if (!email || !password) {
                showAuthMessage('LÃ¼tfen e-posta ve ÅŸifre girin.');
                return;
            }
            if (password.length < 6) {
                showAuthMessage('Åifre en az 6 karakter olmalÄ±dÄ±r.');
                return;
            }
            if (password !== passwordConfirm) {
                showAuthMessage('Åifreler eÅŸleÅŸmiyor.');
                return;
            }
            if (!securityQuestion || !securityAnswer) {
                showAuthMessage('LÃ¼tfen gÃ¼venlik sorusu seÃ§in ve cevabÄ± yazÄ±n!');
                return;
            }

            document.getElementById('auth-loading').classList.remove('hidden');

            try {
                await auth.createUserWithEmailAndPassword(email, password);

                // GÃ¼venlik sorusunu Firebase'e kaydet
                const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
                await database.ref(`security_questions/${emailKey}`).set({
                    question: securityQuestion,
                    answer: securityAnswer.toLowerCase(),
                    createdAt: new Date().toISOString()
                });

                showAuthMessage('Hesap oluÅŸturuldu! GiriÅŸ yapÄ±lÄ±yor...', 'success');
            } catch (error) {
                document.getElementById('auth-loading').classList.add('hidden');
                let errorMsg = 'KayÄ±t baÅŸarÄ±sÄ±z.';
                if (error.code === 'auth/email-already-in-use') errorMsg = 'Bu e-posta zaten kullanÄ±mda.';
                else if (error.code === 'auth/invalid-email') errorMsg = 'GeÃ§ersiz e-posta adresi.';
                else if (error.code === 'auth/weak-password') errorMsg = 'Åifre Ã§ok zayÄ±f.';
                showAuthMessage(errorMsg);
            }
        }

        async function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showAuthMessage('LÃ¼tfen e-posta ve ÅŸifre girin.');
                return;
            }

            document.getElementById('auth-loading').classList.remove('hidden');

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showAuthMessage('GiriÅŸ baÅŸarÄ±lÄ±!', 'success');
            } catch (error) {
                document.getElementById('auth-loading').classList.add('hidden');
                let errorMsg = 'GiriÅŸ baÅŸarÄ±sÄ±z.';
                if (error.code === 'auth/user-not-found') errorMsg = 'KullanÄ±cÄ± bulunamadÄ±.';
                else if (error.code === 'auth/wrong-password') errorMsg = 'HatalÄ± ÅŸifre.';
                else if (error.code === 'auth/invalid-email') errorMsg = 'GeÃ§ersiz e-posta.';
                else if (error.code === 'auth/invalid-credential') errorMsg = 'GeÃ§ersiz kimlik bilgileri.';
                showAuthMessage(errorMsg);
            }
        }

        function logoutUser() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?')) {
                auth.signOut();
            }
        }

        // ÅÄ°FRE SIFIRLAMA FONKSÄ°YONLARI
        function showPasswordResetForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('password-reset-form').classList.remove('hidden');
            document.getElementById('security-question-area').classList.add('hidden');
            document.getElementById('reset-email').value = document.getElementById('login-email').value || '';
            document.getElementById('auth-message').classList.add('hidden');
        }

        function hidePasswordResetForm() {
            document.getElementById('password-reset-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('btn-fetch-question').classList.remove('hidden');
            document.getElementById('auth-message').classList.add('hidden');
        }

        async function fetchSecurityQuestion() {
            const email = document.getElementById('reset-email').value.trim();
            if (!email) { showAuthMessage('LÃ¼tfen e-posta adresinizi girin.'); return; }

            const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
            document.getElementById('auth-loading').classList.remove('hidden');

            try {
                const snapshot = await database.ref(`security_questions/${emailKey}`).once('value');
                const data = snapshot.val();
                document.getElementById('auth-loading').classList.add('hidden');

                if (data && data.question) {
                    document.getElementById('display-security-question').textContent = data.question;
                    document.getElementById('security-question-area').classList.remove('hidden');
                    document.getElementById('btn-fetch-question').classList.add('hidden');
                    showAuthMessage('GÃ¼venlik sorunuz bulundu!', 'success');
                } else {
                    showAuthMessage('Bu e-posta iÃ§in gÃ¼venlik sorusu bulunamadÄ±.');
                }
            } catch (error) {
                document.getElementById('auth-loading').classList.add('hidden');
                showAuthMessage('Bir hata oluÅŸtu: ' + error.message);
            }
        }

        async function verifyAndSendReset() {
            const email = document.getElementById('reset-email').value.trim();
            const answer = document.getElementById('reset-security-answer').value.trim().toLowerCase();

            if (!answer) { showAuthMessage('LÃ¼tfen cevabÄ± girin.'); return; }

            const emailKey = email.replace(/\./g, ',').replace(/@/g, '_at_');
            document.getElementById('auth-loading').classList.remove('hidden');

            try {
                const snapshot = await database.ref(`security_questions/${emailKey}`).once('value');
                const data = snapshot.val();

                if (data && data.answer && data.answer.toLowerCase() === answer) {
                    await auth.sendPasswordResetEmail(email);
                    document.getElementById('auth-loading').classList.add('hidden');
                    showAuthMessage('âœ… Åifre sÄ±fÄ±rlama linki e-postanÄ±za gÃ¶nderildi!', 'success');
                    setTimeout(() => hidePasswordResetForm(), 3000);
                } else {
                    document.getElementById('auth-loading').classList.add('hidden');
                    showAuthMessage('âŒ GÃ¼venlik cevabÄ± yanlÄ±ÅŸ!');
                }
            } catch (error) {
                document.getElementById('auth-loading').classList.add('hidden');
                showAuthMessage('Hata: ' + error.message);
            }
        }
        const FirebaseStorage = {
            async set(key, value) {
                if (!currentUser || !userDataPath) {
                    console.warn('Firebase: KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ, veri kaydedilemiyor');
                    return false;
                }
                try {
                    console.log(`Firebase: "${key}" anahtarÄ± kaydediliyor...`);
                    await database.ref(`${userDataPath}/${key}`).set(value);
                    console.log(`âœ… Firebase: "${key}" baÅŸarÄ±yla kaydedildi`);
                    return true;
                } catch (error) {
                    console.error(`âŒ Firebase set hatasÄ± (${key}):`, error);
                    if (error.code === 'PERMISSION_DENIED') {
                        alert('âš ï¸ Firebase izin hatasÄ±! VeritabanÄ± kurallarÄ±nÄ±zÄ± kontrol edin.');
                    }
                    return false;
                }
            },

            async get(key) {
                if (!currentUser || !userDataPath) return null;
                try {
                    const snapshot = await database.ref(`${userDataPath}/${key}`).once('value');
                    const value = snapshot.val();
                    console.log(`Firebase: "${key}" okundu`, value !== null ? 'âœ…' : '(boÅŸ)');
                    return value;
                } catch (error) {
                    console.error(`Firebase get hatasÄ± (${key}):`, error);
                    return null;
                }
            },

            // localStorage uyumluluÄŸu iÃ§in setItem() metodu
            async setItem(key, value) {
                // KullanÄ±cÄ± kimlik doÄŸrulamasÄ± kontrolÃ¼
                if (!auth.currentUser || !currentUser || !userDataPath) {
                    console.warn('âš ï¸ Firebase: KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ, veri kaydedilemiyor');
                    // Yedek olarak localStorage'a kaydet
                    try {
                        originalLocalStorage.setItem(key, value);
                    } catch (error) {
                        console.error(`âŒ localStorage: Kaydetme hatasÄ±: ${error.message}`);
                    }
                    return false;
                }

                try {
                    // DeÄŸeri iÅŸle (JSON string ise parse et)
                    let processedValue = value;
                    if (typeof value === 'string') {
                        try {
                            processedValue = JSON.parse(value);
                        } catch {
                            processedValue = value; // JSON deÄŸilse string olarak sakla
                        }
                    }

                    // --- DÃœZELTME BURADA YAPILDI ---
                    // Ã–NCE Cache'i gÃ¼ncelle (BÃ¶ylece listener tetiklendiÄŸinde gÃ¼ncel veriyi okur)
                    if (!window._firebaseCache) window._firebaseCache = {};
                    window._firebaseCache[key] = processedValue;

                    // Sonra Firebase'e gÃ¶nder
                    console.log(`ğŸ”„ Firebase: "${key}" kaydediliyor...`);
                    await database.ref(`${userDataPath}/${key}`).set(processedValue);
                    console.log(`âœ… Firebase: "${key}" baÅŸarÄ±yla kaydedildi`);

                    // localStorage'a yedek olarak kaydet
                    try {
                        originalLocalStorage.setItem(key, value);
                    } catch (error) {
                        console.warn(`âš ï¸ localStorage: Yedekleme baÅŸarÄ±sÄ±z (${error.message})`);
                    }

                    return true;
                } catch (error) {
                    console.error(`âŒ Firebase: Kaydetme hatasÄ±: ${error.message}`, error);
                    if (error.code === 'PERMISSION_DENIED') {
                        alert('âš ï¸ Firebase izin hatasÄ±! VeritabanÄ± kurallarÄ±nÄ±zÄ± kontrol edin.');
                    }
                    return false;
                }
            },

            // localStorage uyumluluÄŸu iÃ§in getItem() metodu
            async getItem(key) {
                // KullanÄ±cÄ± kimlik doÄŸrulamasÄ± kontrolÃ¼
                if (!auth.currentUser || !currentUser || !userDataPath) {
                    console.warn('âš ï¸ Firebase: KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ, localStorage\'dan okunuyor');
                    // Yedekten oku
                    try {
                        return originalLocalStorage.getItem(key);
                    } catch (error) {
                        console.error(`âŒ localStorage: Okuma hatasÄ±: ${error.message}`);
                        return null;
                    }
                }

                try {
                    // Ã–nce cache'den kontrol et
                    if (window._firebaseCache && window._firebaseCache[key] !== undefined) {
                        const cachedValue = window._firebaseCache[key];
                        console.log(`ğŸ“¦ Cache: "${key}" cache'den okundu`);
                        return typeof cachedValue === 'string' ? cachedValue : JSON.stringify(cachedValue);
                    }

                    // Firebase'den oku
                    const snapshot = await database.ref(`${userDataPath}/${key}`).once('value');
                    const value = snapshot.val();

                    if (value !== null && value !== undefined) {
                        console.log(`âœ… Firebase: "${key}" okundu`);
                        // Cache'e ekle
                        if (!window._firebaseCache) window._firebaseCache = {};
                        window._firebaseCache[key] = value;
                        // localStorage string dÃ¶ndÃ¼rÃ¼r
                        return typeof value === 'string' ? value : JSON.stringify(value);
                    } else {
                        // Firebase'de yok, localStorage'dan dene
                        console.log(`âš ï¸ Firebase: "${key}" bulunamadÄ±, localStorage kontrol ediliyor`);
                        const localValue = originalLocalStorage.getItem(key);
                        if (localValue !== null) {
                            console.log(`ğŸ’¾ localStorage: "${key}" yedekten okundu`);
                        }
                        return localValue;
                    }
                } catch (error) {
                    console.error(`âŒ Firebase: Okuma hatasÄ±: ${error.message}`, error);
                    // Hata durumunda localStorage'dan oku
                    try {
                        const localValue = originalLocalStorage.getItem(key);
                        if (localValue !== null) {
                            console.log(`ğŸ’¾ localStorage: "${key}" yedekten okundu (Firebase hatasÄ±)`);
                        }
                        return localValue;
                    } catch (storageError) {
                        console.error(`âŒ localStorage: Okuma da baÅŸarÄ±sÄ±z: ${storageError.message}`);
                        return null;
                    }
                }
            },

            async remove(key) {
                if (!currentUser || !userDataPath) return false;
                try {
                    console.log(`Firebase: "${key}" siliniyor...`);
                    await database.ref(`${userDataPath}/${key}`).remove();
                    console.log(`âœ… Firebase: "${key}" silindi`);
                    return true;
                } catch (error) {
                    console.error(`Firebase remove hatasÄ± (${key}):`, error);
                    return false;
                }
            },

            addListener(key, callback) {
                if (!currentUser || !userDataPath) return;
                const ref = database.ref(`${userDataPath}/${key}`);
                ref.on('value', (snapshot) => {
                    callback(snapshot.val());
                });
                firebaseListeners.push({ ref, key });
                console.log(`Firebase: "${key}" iÃ§in listener eklendi`);
            },

            clearListeners() {
                firebaseListeners.forEach(({ ref }) => ref.off());
                firebaseListeners = [];
                console.log('Firebase: TÃ¼m listener\'lar temizlendi');
            }
        };

        const originalLocalStorage = window.localStorage;
        window.localStorage = {
            getItem: function (key) {
                if (!currentUser) return originalLocalStorage.getItem(key);

                // Ã–nce cache'den kontrol et
                const cachedValue = window._firebaseCache?.[key];

                if (cachedValue !== undefined && cachedValue !== null) {
                    // localStorage string dÃ¶ndÃ¼rÃ¼r, cache'de obje olabilir
                    return typeof cachedValue === 'string' ? cachedValue : JSON.stringify(cachedValue);
                }

                return null;
            },

            setItem: function (key, value) {
                if (!currentUser) {
                    originalLocalStorage.setItem(key, value);
                    return;
                }

                // Cache'i gÃ¼ncelle
                if (!window._firebaseCache) window._firebaseCache = {};

                // DeÄŸeri parse et (eÄŸer JSON string ise)
                let processedValue = value;
                try {
                    // EÄŸer value bir JSON string ise parse et
                    if (typeof value === 'string') {
                        try {
                            processedValue = JSON.parse(value);
                        } catch {
                            // JSON deÄŸilse string olarak sakla
                            processedValue = value;
                        }
                    }
                } catch (e) {
                    processedValue = value;
                }

                window._firebaseCache[key] = processedValue;

                // Firebase'e asenkron kaydet
                FirebaseStorage.set(key, processedValue).catch(err => {
                    console.error(`localStorage.setItem Firebase hatasÄ± (${key}):`, err);
                });
            },

            removeItem: function (key) {
                if (!currentUser) {
                    originalLocalStorage.removeItem(key);
                    return;
                }
                if (window._firebaseCache) delete window._firebaseCache[key];
                FirebaseStorage.remove(key);
            },

            clear: function () {
                if (!currentUser) {
                    originalLocalStorage.clear();
                    return;
                }
                window._firebaseCache = {};
                if (userDataPath) {
                    database.ref(userDataPath).remove()
                        .then(() => console.log('âœ… Firebase: TÃ¼m veriler temizlendi'))
                        .catch(err => console.error('âŒ Firebase clear hatasÄ±:', err));
                }
            }
        };
        // ================================================================
        // GÃœNCELLENMÄ°Å GÄ°RÄ°Å & SENKRONÄ°ZASYON (BEKLEMELÄ° AÃ‡ILIÅ)
        // ================================================================

        // Kritik Veri AnahtarlarÄ± Listesi
        const CRITICAL_KEYS = [
            'evdeSaglikShifts_V19', 'evdeSaglikDevices_V1', 'evdeSaglikData_ULTIMATE_V18',
            'evdeSaglikStaff_ULTIMATE_V18', 'evdeSaglikNotes_ULTIMATE_V18', 'evdeSaglikApiKey_V18',
            'evdeSaglikDoctors_V18', 'evdeSaglikDocData_V18', 'evdeSaglikProcs_V18',
            'evdeSaglikAppPW_Enc_V1', 'evdeSaglikSpecList_V18', 'evdeSaglikQuickList_V18',
            'evdeSaglikLeaveRec_V18', 'evdeSaglikTeams_V19', 'evdeSaglikRoutines_V19',
            'evdeSaglikBudget_V19', 'evdeSaglikEmergency_V19', 'evdeSaglikBags_V19',
            'evdeSaglikGenNotesList_V1', 'evdeSaglikPhonebook_V1', 'evdeSaglikReminders_V1',
            'evdeSaglikLockedTabsConfig_V1', 'evdeSaglikDoctorRequests_V1'
        ];

        auth.onAuthStateChanged(async (user) => {
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app');
            const loadingEl = document.getElementById('auth-loading');

            // YÃ¼kleme mesajÄ±nÄ± Ã¶zelleÅŸtir
            const updateLoadingMsg = (msg) => {
                loadingEl.innerHTML = `
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-4 border-indigo-600 mb-2"></div>
            <p class="text-sm font-bold text-gray-700 animate-pulse">${msg}</p>
        `;
            };

            if (user) {
                console.log('ğŸ” Firebase: KullanÄ±cÄ± giriÅŸi baÅŸarÄ±lÄ±:', user.email);
                currentUser = user;
                userDataPath = 'evde_saglik_ortak_veri';

                // 1. ADIM: Login ekranÄ±nÄ± gizle ama App ekranÄ±nÄ± HENÃœZ AÃ‡MA
                // Sadece loading ekranÄ±nÄ± gÃ¶ster.
                authContainer.style.display = 'flex'; // Container kalsÄ±n, formlar gizlensin
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.querySelector('.border-b.mb-6')?.classList.add('hidden'); // Tab butonlarÄ±nÄ± gizle
                document.querySelector('.text-center.mb-8').style.display = 'none'; // Logoyu gizle veya bÄ±rakabilirsin

                loadingEl.classList.remove('hidden');
                updateLoadingMsg('Veriler Buluttan Ã‡ekiliyor...<br><span class="text-xs text-gray-500">LÃ¼tfen bekleyin</span>');

                try {
                    // 2. ADIM: TÃœM VERÄ°LERÄ° Ã‡EK VE BEKLE (Await)
                    console.log('ğŸ“¥ Firebase: Kritik veri senkronizasyonu baÅŸladÄ±...');

                    const promises = CRITICAL_KEYS.map(key => database.ref(`${userDataPath}/${key}`).once('value'));
                    const snapshots = await Promise.all(promises);

                    // 3. ADIM: Ã‡EKÄ°LEN VERÄ°LERÄ° Ã–NBELLEÄE VE LOCALSTORAGE'A YAZ
                    if (!window._firebaseCache) window._firebaseCache = {};

                    snapshots.forEach((snap, index) => {
                        const key = CRITICAL_KEYS[index];
                        const val = snap.val();

                        // Cache'e at
                        window._firebaseCache[key] = val;

                        // LocalStorage gÃ¼ncelle (Yedeklilik iÃ§in)
                        if (val !== null) {
                            const storeVal = (typeof val === 'object') ? JSON.stringify(val) : val;
                            originalLocalStorage.setItem(key, storeVal);
                        } else {
                            originalLocalStorage.removeItem(key);
                        }
                    });

                    console.log('âœ… Firebase: Ä°lk senkronizasyon tamamlandÄ±.');

                    // 4. ADIM: REALTIME LISTENER'LARI BAÅLAT (Bundan sonraki deÄŸiÅŸimler iÃ§in)
                    startRealtimeListeners();

                    // 5. ADIM: UYGULAMAYI BAÅLAT VE EKRANI AÃ‡
                    if (typeof loadAll === 'function') loadAll(); // Verileri global deÄŸiÅŸkenlere daÄŸÄ±t

                    // YÃ¼kleme ekranÄ±nÄ± kapat, Ana ekranÄ± aÃ§
                    authContainer.style.display = 'none';
                    loadingEl.classList.add('hidden');
                    appContainer.style.display = 'block';

                    // UI Render iÅŸlemleri
                    renderUI();
                    if (typeof renderShiftTable === 'function') renderShiftTable();
                    if (typeof renderDeviceTable === 'function') renderDeviceTable();
                    if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
                    if (typeof renderPhonebook === 'function') renderPhonebook();

                    console.log('ğŸš€ Sistem Tamamen HazÄ±r');

                    // Ã‡Ä±kÄ±ÅŸ butonu eklemesi (Mevcut kodunuzdaki gibi)
                    addLogoutButtonToHeader();

                } catch (error) {
                    console.error('âŒ Kritik Hata:', error);
                    updateLoadingMsg('BaÄŸlantÄ± HatasÄ±!<br><span class="text-xs text-red-500">Veriler yÃ¼klenemedi. SayfayÄ± yenileyin.</span>');
                    // Ä°sterseniz burada "Offline Devam Et" butonu Ã§Ä±kartabilirsiniz.
                    // Ama gÃ¼venlik istiyorsanÄ±z burada durmasÄ± daha iyidir.
                }

            } else {
                // Ã‡Ä±kÄ±ÅŸ YapÄ±lmÄ±ÅŸsa
                console.log('ğŸšª Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±');
                currentUser = null;
                userDataPath = null;

                appContainer.style.display = 'none';
                authContainer.style.display = 'flex';

                // Login formlarÄ±nÄ± geri getir
                document.getElementById('login-form').classList.remove('hidden');
                document.querySelector('.border-b.mb-6')?.classList.remove('hidden');
                document.querySelector('.text-center.mb-8').style.display = 'block';
                loadingEl.classList.add('hidden');
            }
        });

        // Realtime ListenerlarÄ± BaÅŸlatan YardÄ±mcÄ± Fonksiyon
        function startRealtimeListeners() {
            CRITICAL_KEYS.forEach(key => {
                // Eski listener'Ä± temizle
                database.ref(`${userDataPath}/${key}`).off();

                // Yeni listener ekle
                FirebaseStorage.addListener(key, (value) => {
                    // Sadece deÄŸiÅŸiklik olduÄŸunda Ã§alÄ±ÅŸÄ±r, ilk yÃ¼klemeyi zaten yukarÄ±da yaptÄ±k
                    if (!window._firebaseCache) window._firebaseCache = {};
                    window._firebaseCache[key] = value;

                    // DeÄŸiÅŸikliÄŸe gÃ¶re ilgili UI'Ä± gÃ¼ncelle
                    handleLiveUpdate(key, value);
                });
            });
        }

        // Manuel Senkronizasyon Fonksiyonu (Senkronize Et butonu iÃ§in)
        async function forceSyncData() {
            if (!currentUser || !userDataPath) {
                showToast('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!', 'warning');
                return;
            }

            // Senkronizasyon animasyonu
            const syncIcon = document.getElementById('sync-icon');
            if (syncIcon) syncIcon.classList.add('animate-spin');

            showToast('ğŸ”„ Veriler senkronize ediliyor...', 'info');
            console.log('ğŸ”„ Manuel senkronizasyon baÅŸlatÄ±ldÄ±...');

            try {
                // TÃ¼m kritik verileri Firebase'den Ã§ek
                for (const key of CRITICAL_KEYS) {
                    try {
                        const snapshot = await database.ref(`${userDataPath}/${key}`).once('value');
                        const value = snapshot.val();

                        // Cache'i gÃ¼ncelle
                        if (!window._firebaseCache) window._firebaseCache = {};
                        window._firebaseCache[key] = value;

                        // UI'Ä± gÃ¼ncelle
                        handleLiveUpdate(key, value);

                        console.log(`âœ… Senkronize edildi: ${key}`);
                    } catch (err) {
                        console.error(`âŒ Senkronizasyon hatasÄ± (${key}):`, err);
                    }
                }

                showToast('âœ… TÃ¼m veriler senkronize edildi!', 'success');
                console.log('âœ… Manuel senkronizasyon tamamlandÄ±');

            } catch (error) {
                console.error('âŒ Senkronizasyon hatasÄ±:', error);
                showToast('âŒ Senkronizasyon hatasÄ±!', 'error');
            } finally {
                // Animasyonu durdur
                if (syncIcon) syncIcon.classList.remove('animate-spin');
            }
        }

        // CanlÄ± veri geldiÄŸinde yapÄ±lacaklar (Switch-Case yapÄ±nÄ±z buraya taÅŸÄ±ndÄ±)
        function handleLiveUpdate(key, value) {
            console.log(`ğŸ”„ CanlÄ± GÃ¼ncelleme: ${key}`);
            switch (key) {
                // --- YENÄ° KÄ°LÄ°T KONTROL KODU ---
                case 'evdeSaglikLockedTabsConfig_V1':
                    // 1. Listeyi GÃ¼ncelle
                    if (typeof value === 'string') {
                        try { window.lockedTabsConfig = JSON.parse(value); } catch (e) { window.lockedTabsConfig = []; }
                    } else {
                        window.lockedTabsConfig = value || [];
                    }

                    // 2. HafÄ±zayÄ± Temizle (Eski izinleri iptal et)
                    if (window.unlockedSessionTabs) {
                        if (Array.isArray(window.lockedTabsConfig)) {
                            window.lockedTabsConfig.forEach(tabId => {
                                window.unlockedSessionTabs[tabId] = false;
                            });
                        }
                    }

                    // 3. SUÃ‡ÃœSTÃœ YAP (EÄŸer kullanÄ±cÄ± ÅŸu an o sekmedeyse dÄ±ÅŸarÄ± at!)
                    const currentTab = document.querySelector('.tab-content:not(.hidden)');
                    if (currentTab) {
                        const currentId = currentTab.id.replace('tab-', '');
                        // EÄŸer baktÄ±ÄŸÄ± sayfa artÄ±k kilitliyse
                        if (window.lockedTabsConfig.includes(currentId)) {
                            if (typeof switchTab === 'function') {
                                switchTab('personel'); // Ana sayfaya fÄ±rlat
                                showToast("Bu sekme yÃ¶netici tarafÄ±ndan kilitlendi!", "warning");
                            }
                        }
                    }
                    break;
                case 'evdeSaglikShifts_V19':
                    shiftList = value || [];
                    if (!document.getElementById('tab-nobet').classList.contains('hidden')) renderShiftTable();
                    break;
                case 'evdeSaglikAppPW_Enc_V1':
                    if (value) {
                        try {
                            appPassword = atob(value);
                            originalLocalStorage.setItem('evdeSaglikAppPW_Enc_V1', value);
                        } catch (e) { console.error(e); }
                    }
                    break;
                // ... DiÄŸer case'leriniz buraya aynen gelecek (Budget, Devices vb.)
                // Kod tekrarÄ± olmamasÄ± iÃ§in buraya sadece kritik olanlarÄ± yazdÄ±m, 
                // mevcut kodunuzdaki switch-case yapÄ±sÄ±nÄ± buraya kopyalayabilirsiniz.
                case 'evdeSaglikData_ULTIMATE_V18':
                    allRecords = value || {};
                    if (!document.getElementById('tab-personel').classList.contains('hidden')) renderUI();
                    break;
                case 'evdeSaglikBudget_V19':
                    budgetList = value || [];
                    if (!document.getElementById('tab-butce').classList.contains('hidden')) {
                        if (typeof renderBudgetHeader === 'function') renderBudgetHeader(); else renderBudget();
                    }
                    break;
                case 'evdeSaglikDoctorRequests_V1':
                    console.log('ğŸ”” Doktor talepleri gÃ¼ncelleniyor...', value);
                    // Global deÄŸiÅŸkeni gÃ¼ncelle (window scope)
                    if (Array.isArray(value)) {
                        window.doctorRequestsList = value;
                    } else if (value && typeof value === 'object') {
                        window.doctorRequestsList = Object.values(value);
                    } else {
                        window.doctorRequestsList = [];
                    }
                    // Her zaman listeyi render et (sekme aÃ§Ä±k olsun veya olmasÄ±n veriyi gÃ¼ncelle)
                    try {
                        if (typeof renderDoctorRequestsList === 'function') {
                            renderDoctorRequestsList();
                            console.log('âœ… Doktor talepleri listesi gÃ¼ncellendi:', window.doctorRequestsList.length, 'kayÄ±t');
                        }
                    } catch (e) {
                        console.error('renderDoctorRequestsList hatasÄ±:', e);
                    }
                    break;
                // Ä°htiyaÃ§ duyduÄŸunuz diÄŸer case bloklarÄ±nÄ± buraya ekleyin...
            }
        }

        function addLogoutButtonToHeader() {
            setTimeout(() => {
                const headerButtons = document.querySelector('.flex.items-center.gap-3');
                if (headerButtons && !document.querySelector('[onclick="logoutUser()"]')) {
                    const logoutBtn = document.createElement('button');
                    logoutBtn.onclick = logoutUser;
                    logoutBtn.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-red-100 text-red-700 hover:bg-red-200 transition-colors ml-2';
                    logoutBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg> <span>Ã‡Ä±kÄ±ÅŸ</span>';
                    headerButtons.appendChild(logoutBtn);
                }
            }, 1000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            ['login-email', 'login-password'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginUser(); });
            });

            ['register-email', 'register-password', 'register-password-confirm'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('keypress', (e) => { if (e.key === 'Enter') registerUser(); });
            });
        });
    </script>



    <div id="app" style="display: none;"
        class="max-w-[98%] mx-auto bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
        <div id="tomorrow-alert-box"
            class="hidden bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 relative" role="alert">
            <div class="flex items-center">
                <div class="py-1"><i data-lucide="bell-ring" class="w-6 h-6 mr-4 text-orange-600"></i></div>
                <div>
                    <p class="font-bold">YarÄ±n Ä°Ã§in PlanlanmÄ±ÅŸ Ä°ÅŸlemler Var!</p>
                    <p class="text-sm" id="tomorrow-alert-text">Detaylar yÃ¼kleniyor...</p>
                </div>
                <button onclick="document.getElementById('tomorrow-alert-box').classList.add('hidden')"
                    class="absolute top-0 bottom-0 right-0 px-4 py-3 text-orange-600 hover:text-orange-800">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <div class="flex justify-between items-center px-6 py-4 border-b bg-white">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i data-lucide="activity" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-900 tracking-tight">Evde SaÄŸlÄ±k YÃ¶netimi</h1>
                    <p class="text-xs text-gray-500 hidden md:block">Personel, Uzman ve Doktor Takip Sistemi</p>
                </div>
            </div>
            <div class="flex-1 mx-6 relative hidden md:block max-w-xl">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search"
                            class="w-4 h-4 text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <input type="text" id="global-search-input"
                        class="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-xl leading-5 bg-gray-50 text-gray-700 placeholder-gray-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-sm font-medium shadow-sm"
                        placeholder="HÄ±zlÄ± Ara... (Personel, Cihaz, NÃ¶bet, Ä°laÃ§)" autocomplete="off">

                    <div id="global-search-results"
                        class="absolute top-full left-0 right-0 bg-white border border-gray-200 shadow-xl rounded-b-xl z-[100] hidden max-h-[400px] overflow-y-auto custom-scrollbar">
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-activity-log" onclick="openActivityLogPanel()"
                    class="role-hide-viewer role-hide-user relative flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors"
                    title="Son Ä°ÅŸlemler">
                    ğŸ””
                    <span id="activity-badge"
                        class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-bold rounded-full w-4 h-4 flex items-center justify-center">0</span>
                </button>
                <button id="btn-user-management" onclick="openUserManagementModal()"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition-colors"
                    title="KullanÄ±cÄ± YÃ¶netimi">
                    ğŸ‘¥ Yetki
                </button>
                <button id="btn-theme-toggle"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors dark:bg-gray-700 dark:text-yellow-300"
                    title="KaranlÄ±k Mod">
                    <i data-lucide="moon" id="theme-icon" class="w-4 h-4"></i>
                </button>
                <button onclick="forceSyncData()"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition-colors border border-indigo-200"
                    title="Verileri Senkronize Et">
                    <i data-lucide="refresh-cw" id="sync-icon" class="w-4 h-4"></i>
                    <span class="hidden md:inline">Senkronize Et</span>
                </button>
                <button onclick="generateDailyReport()"
                    class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-bold bg-red-600 text-white hover:bg-red-700 transition shadow-sm ml-2"
                    title="GÃ¼nlÃ¼k Rapor Al">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span class="hidden md:inline">GÃ¼n Sonu Raporu</span>
                </button>
                <button id="btn-open-settings"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors"
                    title="API AyarlarÄ±">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                </button>
                <button onclick="lockSession()"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold bg-gray-800 text-white hover:bg-black transition-colors shadow-sm border border-gray-600"
                    title="Oturumu Kilitle (Shift+L)">
                    <i data-lucide="lock" class="w-4 h-4"></i>
                </button>
                <button id="btn-change-password"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors"
                    title="Åifre DeÄŸiÅŸtir">
                    <i data-lucide="key" class="w-4 h-4"></i>
                </button>
                <button onclick="openTabSettingsModal()"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-orange-100 text-orange-600 hover:bg-orange-200 transition-colors"
                    title="Sekme Kilit AyarlarÄ±">
                    <i data-lucide="shield-alert" class="w-4 h-4"></i>
                </button>
                <button id="lock-toggle"
                    class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-700 hover:bg-green-200 transition-colors">
                    <i data-lucide="unlock" id="lock-icon" class="w-3 h-3"></i>
                    <span id="lock-status">AÃ§Ä±k</span>
                </button>
            </div>
        </div>

        <div class="px-2 py-2 bg-gray-50 border-b flex flex-nowrap items-center gap-2 overflow-x-auto no-scrollbar">

            <div class="flex items-center gap-2 flex-shrink-0">
                <button id="open-entry-modal-btn"
                    class="mobile-icon-only flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-sm text-sm font-medium whitespace-nowrap">
                    <i data-lucide="edit-3" class="w-4 h-4"></i> <span>Veri / Hasta GiriÅŸi</span>
                </button>
                <button id="open-staff-modal-btn"
                    class="mobile-icon-only flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-sm font-medium whitespace-nowrap">
                    <i data-lucide="users" class="w-4 h-4"></i> <span>Personel & Doktor</span>
                </button>
            </div>

            <div class="flex items-center gap-2 ml-auto flex-shrink-0">
                <button id="btn-ai-report"
                    class="mobile-icon-only flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition shadow-sm text-sm font-bold border border-transparent whitespace-nowrap">
                    <i data-lucide="sparkles" class="w-4 h-4"></i> <span>AI Rapor</span>
                </button>

                <div class="flex items-center bg-white border border-gray-200 rounded-lg p-1 shadow-sm flex-shrink-0">
                    <button onclick="exportData('xlsx')"
                        class="mobile-icon-only flex items-center gap-1.5 px-3 py-1.5 rounded hover:bg-green-50 text-gray-600 hover:text-green-700 transition text-xs font-semibold border-r border-gray-100 whitespace-nowrap">
                        <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> <span>Excel</span>
                    </button>
                    <button onclick="exportData('pdf')"
                        class="mobile-icon-only flex items-center gap-1.5 px-3 py-1.5 rounded hover:bg-red-50 text-gray-600 hover:text-red-700 transition text-xs font-semibold whitespace-nowrap">
                        <i data-lucide="file-text" class="w-3.5 h-3.5"></i> <span>PDF</span>
                    </button>
                </div>

                <button onclick="triggerImportWithPassword()"
                    class="mobile-icon-only flex items-center gap-2 px-3 py-2 bg-blue-50 text-blue-700 border border-blue-100 rounded-lg hover:bg-blue-100 transition cursor-pointer text-xs font-bold whitespace-nowrap flex-shrink-0">
                    <i data-lucide="upload-cloud" class="w-4 h-4"></i> <span>YÃ¼kle</span>
                </button>

                <input type="file" id="import-file" accept=".xlsx, .csv" class="hidden">
            </div>
        </div>

        <div id="ust-menu"
            class="flex border-b bg-gray-50 px-2 w-full flex-nowrap gap-2 overflow-x-auto no-scrollbar items-center cursor-grab select-none">
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('hastatakip')">Hasta Takip</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('personel')">Personel Takip</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('uzman')">Uzman EÅŸleÅŸmeleri</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('analiz')">GeÃ§miÅŸ Analiz</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('rutinler')">GÃ¼nlÃ¼k Rutinler</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('acilcanta')">Acil Ã‡anta Takip</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('butce')">BÃ¼tÃ§e Takip</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('notlar')">Notlar</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('nobet')">NÃ¶bet Listesi</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('cihazlar')">Cihaz & Zimmet</button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('istatistik')">
                <i data-lucide="pie-chart" class="w-4 h-4 inline-block mr-1"></i> Ä°statistikler
            </button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('puantaj')">
                <i data-lucide="calculator" class="w-4 h-4 inline-block mr-1"></i> Puantaj
            </button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('rehber')">
                <i data-lucide="phone" class="w-4 h-4 inline-block mr-1"></i> Rehber
            </button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('takvim')">
                <i data-lucide="calendar" class="w-4 h-4 inline-block mr-1"></i> Takvim
            </button>
            <button
                class="tab-btn flex-shrink-0 px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 focus:outline-none whitespace-nowrap"
                onclick="switchTab('inrhesaplayici')">
                <i data-lucide="activity" class="w-4 h-4 inline-block mr-1"></i> Ä°NR HesaplayÄ±cÄ±
            </button>
        </div>

        <div class="p-6 min-h-[0px]">

            <div id="global-date-nav" class="flex items-center justify-center mb-6">
                <div class="flex items-center bg-white border rounded-full px-1 py-1 shadow-sm">
                    <button id="prev-week" class="p-1.5 hover:bg-gray-100 rounded-full transition text-gray-500"><i
                            data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span id="current-week-display"
                        class="px-4 text-sm font-semibold text-gray-700 min-w-[200px] text-center select-none"></span>
                    <button id="next-week" class="p-1.5 hover:bg-gray-100 rounded-full transition text-gray-500"><i
                            data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            </div>

            <div id="tab-personel" class="tab-content">
                <div
                    class="scroll-container rounded-xl border border-gray-200 shadow-sm mb-8 overflow-x-auto touch-pan-x">
                    <table id="tracking-table" class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50/50 border-b">
                            <tr id="tracking-head">
                                <th class="px-4 py-3 sticky-col-1 bg-gray-50 font-semibold">Personel</th>
                            </tr>
                        </thead>
                        <tbody id="tracking-body" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>

                <div id="team-tracking-section" class="mb-8">
                    <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
                        <i data-lucide="users" class="w-5 h-5 mr-2"></i> Ekip / Liste GÃ¶rev DaÄŸÄ±lÄ±mÄ±
                    </h3>
                    <div
                        class="scroll-container rounded-xl border border-gray-200 shadow-sm bg-white overflow-x-auto touch-pan-x">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-50/50 border-b">
                                <tr id="team-table-head">
                                    <th class="px-4 py-3 sticky-col-1 bg-gray-50 font-semibold border-r">Ekip / Liste
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="team-table-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-[10px] text-gray-400 uppercase font-bold">Hafta Hedef (Mod)</div>
                            <div id="weekly-mode-target" class="text-xl font-bold text-blue-600">-</div>
                        </div>
                        <div class="bg-white p-3 rounded border text-center">
                            <div class="text-[10px] text-gray-400 uppercase font-bold">Ay Hedef (Mod)</div>
                            <div id="monthly-mode-target" class="text-xl font-bold text-purple-600">-</div>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded border border-gray-200 bg-white">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-50 text-gray-500 uppercase font-semibold">
                                <tr>
                                    <th class="px-4 py-2 text-left">Personel</th>
                                    <th class="px-4 py-2 text-center bg-blue-50">Hafta SayÄ±</th>
                                    <th class="px-4 py-2 text-center bg-blue-50">Durum</th>
                                    <th class="px-4 py-2 text-center bg-purple-50">Ay SayÄ±</th>
                                    <th class="px-4 py-2 text-center bg-purple-50">Durum</th>
                                </tr>
                            </thead>
                            <tbody id="stats-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>

                <div class="border-t-4 border-indigo-100 pt-6 mt-8">
                    <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
                        <i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i> Doktor & TÄ±bbi Ä°ÅŸlem Takibi
                    </h3>

                    <div
                        class="scroll-container rounded-xl border border-gray-200 shadow-sm mb-6 bg-white overflow-x-auto touch-pan-x">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-50">
                                <tr id="doctor-table-head">
                                    <th class="px-4 py-3 sticky-col-1 bg-gray-50 font-semibold border-r">LÄ°STELER</th>
                                </tr>
                            </thead>
                            <tbody id="doctor-table-body" class="bg-white divide-y divide-gray-100"></tbody>
                        </table>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                            <div class="bg-gray-50 px-4 py-2 border-b font-bold text-xs text-gray-500 uppercase">
                                DÃ¶nemsel Ä°ÅŸlem Ã–zeti</div>
                            <table class="w-full text-xs">
                                <thead class="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Ä°ÅŸlem TÃ¼rÃ¼</th>
                                        <th class="px-4 py-2 text-center">Toplam SayÄ±</th>
                                    </tr>
                                </thead>
                                <tbody id="procedure-stats-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-8 mt-8 border-t-4 border-orange-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="calendar-off" class="w-5 h-5 mr-2 text-orange-600"></i> Raporlu / Ä°zinli
                        Personel YÃ¶netimi
                    </h3>

                    <div class="flex flex-wrap items-end gap-3 bg-gray-50 p-4 rounded-lg border border-gray-100 mb-4">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Personel</label>
                            <input type="text" id="leave-staff-input" list="staff-suggestions"
                                class="w-full p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-orange-500 outline-none"
                                placeholder="Ä°sim yazÄ±n veya listeden seÃ§in...">
                            <datalist id="staff-suggestions"></datalist>
                        </div>
                        <div class="w-32">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Durum</label>
                            <select id="leave-type-select" class="w-full p-2 border rounded text-sm bg-white">
                                <option value="Rapor">Raporlu</option>
                                <option value="Ä°zin">Ä°zinli</option>
                            </select>
                        </div>
                        <div class="w-36">
                            <label class="block text-xs font-bold text-gray-500 mb-1">BaÅŸlangÄ±Ã§</label>
                            <input type="date" id="leave-start-date" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="w-36">
                            <label class="block text-xs font-bold text-gray-500 mb-1">BitiÅŸ</label>
                            <input type="date" id="leave-end-date" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div>
                            <button id="add-leave-btn"
                                class="px-4 py-2 bg-orange-600 text-white rounded font-bold hover:bg-orange-700 text-sm shadow transition">
                                Ekle
                            </button>
                        </div>
                    </div>

                    <div class="overflow-hidden border rounded-lg">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-2">Personel</th>
                                    <th class="px-4 py-2">Durum</th>
                                    <th class="px-4 py-2">Tarih AralÄ±ÄŸÄ±</th>
                                    <th class="px-4 py-2 text-right">Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="leave-records-list" class="divide-y divide-gray-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-uzman" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-indigo-900">Uzman Birim EÅŸleÅŸme Ã‡izelgesi (AylÄ±k)</h2>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Bulunulan Ay</span>
                </div>
                <div class="scroll-container rounded-xl border border-gray-200 shadow-sm bg-white mb-8">
                    <table class="w-full text-sm text-left" id="specialist-table">
                        <thead class="text-xs text-gray-600 uppercase bg-gray-100 border-b"></thead>
                        <tbody id="specialist-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>

                <div class="flex justify-between items-center mb-4 border-t-4 border-gray-200 pt-6">
                    <h2 class="text-lg font-bold text-indigo-900 flex items-center">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2"></i> HaftalÄ±k Personel - Uzman EÅŸleÅŸme Matrisi
                    </h2>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Bulunulan Hafta</span>
                </div>
                <div class="scroll-container rounded-xl border border-gray-400 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left" id="weekly-spec-table">
                        <thead class="text-xs text-white uppercase bg-gray-800 border-b border-gray-600">
                        </thead>
                        <tbody id="weekly-spec-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-analiz" class="tab-content hidden">
                <div class="bg-indigo-50 p-4 rounded-xl mb-6">
                    <h3 class="text-sm font-bold text-indigo-900 mb-3">Tarih AralÄ±ÄŸÄ± ve Filtre Analizi</h3>
                    <div class="flex flex-col md:flex-row items-end gap-4">
                        <div><label class="text-xs font-bold text-gray-500">BaÅŸlangÄ±Ã§</label><input type="date"
                                id="analysis-start" class="block w-full p-2 border rounded text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-500">BitiÅŸ</label><input type="date"
                                id="analysis-end" class="block w-full p-2 border rounded text-sm"></div>

                        <div class="flex-1 min-w-[200px]">
                            <label class="text-xs font-bold text-gray-500">Analiz TÃ¼rÃ¼ / Filtre</label>
                            <select id="analysis-filter"
                                class="block w-full p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="all">TÃ¼mÃ¼ (Genel Ã–zet)</option>
                                <option value="leave_report" class="font-bold text-orange-600">Raporlu / Ä°zinli Listesi
                                </option>
                                <option value="shift_stats" class="font-bold text-indigo-700">NÃ¶bet Ä°statistikleri
                                </option>
                                <option value="all_specialists" class="font-bold text-purple-600">TÃ¼m UzmanlÄ±klar (Ã–zet)
                                </option>
                                <optgroup label="Doktor Verileri" id="filter-opt-doc"></optgroup>
                                <optgroup label="TÄ±bbi Ä°ÅŸlemler" id="filter-opt-proc"></optgroup>
                                <optgroup label="UzmanlÄ±klar" id="filter-opt-spec"></optgroup>
                            </select>
                        </div>

                        <button id="btn-run-analysis"
                            class="px-4 py-2 bg-indigo-600 text-white rounded text-sm font-bold shadow hover:bg-indigo-700">Analiz
                            Et</button>
                    </div>
                </div>
                <div id="analysis-results" class="hidden">
                    <div id="standard-analysis-container">
                        <div class="mb-6 overflow-x-auto border rounded bg-white">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-100 text-gray-600 uppercase">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Personel</th>
                                        <th id="analysis-staff-col-header" class="px-4 py-2 text-center">Toplam SayÄ±
                                        </th>
                                        <th class="px-4 py-2 text-center">Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="analysis-stats-body" class="divide-y"></tbody>
                            </table>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="border rounded-xl overflow-hidden shadow-sm bg-white">
                                <div class="bg-blue-50 px-4 py-2 text-xs font-bold text-blue-900 uppercase border-b">
                                    Doktor PerformansÄ±</div>
                                <table class="w-full text-xs">
                                    <thead class="bg-gray-50 text-gray-600 uppercase">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Doktor</th>
                                            <th id="analysis-doc-col-header" class="px-4 py-2 text-center">SayÄ±</th>
                                        </tr>
                                    </thead>
                                    <tbody id="analysis-doctor-stats-body" class="divide-y"></tbody>
                                </table>
                            </div>
                            <div class="border rounded-xl overflow-hidden shadow-sm bg-white">
                                <div class="bg-green-50 px-4 py-2 text-xs font-bold text-green-900 uppercase border-b">
                                    Ä°ÅŸlem DaÄŸÄ±lÄ±mÄ± (Genel)</div>
                                <table class="w-full text-xs">
                                    <tbody id="analysis-proc-stats-body" class="divide-y"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="scroll-container border rounded bg-white">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-gray-100 uppercase border-b">
                                    <tr id="analysis-table-head">
                                        <th class="px-4 py-2 sticky-col-1 bg-gray-100">Personel</th>
                                    </tr>
                                </thead>
                                <tbody id="analysis-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="leave-analysis-container"
                        class="hidden mb-6 border rounded-xl bg-white overflow-hidden shadow-sm">
                        <div class="bg-orange-50 px-4 py-3 border-b font-bold text-orange-800 flex items-center">
                            <i data-lucide="calendar-off" class="w-5 h-5 mr-2"></i> Ä°zin ve Rapor Listesi
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3">Personel</th>
                                    <th class="px-4 py-3 text-center">Durum</th>
                                    <th class="px-4 py-3 text-center">BaÅŸlangÄ±Ã§</th>
                                    <th class="px-4 py-3 text-center">BitiÅŸ</th>
                                    <th class="px-4 py-3 text-center">GÃ¼n SayÄ±sÄ±</th>
                                </tr>
                            </thead>
                            <tbody id="leave-analysis-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>

                    <div id="specialist-detail-container"
                        class="hidden mt-6 mb-6 border rounded-xl bg-white overflow-hidden shadow-sm border-purple-100">
                        <div
                            class="bg-purple-50 px-4 py-3 border-b border-purple-100 font-bold text-purple-900 flex items-center">
                            <i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i> UzmanlÄ±k EÅŸleÅŸme DetaylarÄ±
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-gray-50 text-gray-600 uppercase border-b">
                                    <tr>
                                        <th class="px-4 py-3 border-r">Personel</th>
                                        <th class="px-4 py-3 border-r">UzmanlÄ±k AlanÄ±</th>
                                        <th class="px-4 py-3 border-r text-center w-20">Toplam</th>
                                        <th class="px-4 py-3">Tarihler ve Zamanlar</th>
                                    </tr>
                                </thead>
                                <tbody id="specialist-detail-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <div id="tab-rutinler" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-4">
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                            <h3 class="text-lg font-bold text-indigo-900 mb-2 flex items-center">
                                <i data-lucide="list-todo" class="w-5 h-5 mr-2"></i> Yeni Rutin Ekle
                            </h3>
                            <div class="space-y-3">
                                <input type="text" id="new-routine-text"
                                    class="w-full p-3 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                    placeholder="Ã–rn: AtamalarÄ± Ã‡Ä±kar, Acil Ã‡anta KontrolÃ¼...">
                                <button onclick="addRoutine()"
                                    class="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-2">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Ekle
                                </button>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-bold text-gray-500 uppercase">Tamamlanma OranÄ±</span>
                                <span id="routine-progress-text" class="text-xs font-bold text-indigo-600">%0</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2.5">
                                <div id="routine-progress-bar"
                                    class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500"
                                    style="width: 0%"></div>
                            </div>
                        </div>
                        <button onclick="resetRoutines()"
                            class="w-full py-2 bg-white border border-gray-300 text-gray-600 rounded-lg text-sm font-bold hover:bg-gray-50 transition flex justify-center items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> TÃ¼mÃ¼nÃ¼ SÄ±fÄ±rla (Yeni GÃ¼n)
                        </button>
                    </div>
                    <div class="md:col-span-2">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">Takip Listesi</h3>
                                <span id="routine-count-badge"
                                    class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">0
                                    GÃ¶rev</span>
                            </div>
                            <div id="routine-list-container"
                                class="divide-y divide-gray-100 max-h-[500px] overflow-y-auto p-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-acilcanta" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                    <div class="md:col-span-1 space-y-4">

                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Aktif Ã‡anta
                                SeÃ§imi</label>
                            <div class="flex gap-2">
                                <div class="relative flex-grow">
                                    <select id="bag-selector" onchange="switchBag()"
                                        class="w-full p-2.5 bg-red-50 border border-red-200 text-red-900 text-sm rounded-lg font-bold outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                    </select>
                                    <i data-lucide="chevron-down"
                                        class="absolute right-3 top-3 w-4 h-4 text-red-400 pointer-events-none"></i>
                                </div>

                                <button onclick="addNewBag()"
                                    class="bg-gray-100 text-gray-600 hover:bg-gray-200 hover:text-gray-800 p-2.5 rounded-lg transition border border-gray-200 flex-shrink-0"
                                    title="Yeni Ã‡anta OluÅŸtur">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>

                                <button onclick="renameCurrentBag()"
                                    class="bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-800 p-2.5 rounded-lg transition border border-blue-200 flex-shrink-0"
                                    title="Ã‡anta Ä°smini DeÄŸiÅŸtir">
                                    <i data-lucide="pencil" class="w-5 h-5"></i>
                                </button>

                                <button onclick="deleteCurrentBag()"
                                    class="bg-white text-gray-400 hover:text-red-600 p-2.5 rounded-lg transition border border-gray-200 flex-shrink-0"
                                    title="Åu Anki Ã‡antayÄ± Sil">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <div class="bg-red-50 p-6 rounded-xl border border-red-100 shadow-sm">
                            <h3 class="text-lg font-bold text-red-900 mb-4 flex items-center">
                                <i data-lucide="briefcase-medical" class="w-5 h-5 mr-2"></i> Ã‡antaya Malzeme Ekle
                            </h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Malzeme / Ä°laÃ§ AdÄ±</label>
                                    <input type="text" id="em-name"
                                        class="w-full p-2.5 border border-red-200 rounded-lg text-sm focus:ring-2 focus:ring-red-500 outline-none"
                                        placeholder="Ã–rn: Adrenalin, Eldiven...">
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-1">Adet / Stok</label>
                                        <input type="number" id="em-count"
                                            class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none"
                                            placeholder="1">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-500 mb-1">UyarÄ± (GÃ¼n
                                            Kala)</label>
                                        <input type="number" id="em-alert-days"
                                            class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none"
                                            placeholder="Vars: 30" value="30">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Son Kullanma
                                        Tarihi</label>
                                    <input type="date" id="em-date"
                                        class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
                                    <textarea id="em-note"
                                        class="w-full p-2.5 border border-red-200 rounded-lg text-sm outline-none resize-none h-20"
                                        placeholder="Ã–rn: Ampul Ã§atlak olabilir, kontrol et..."></textarea>
                                </div>

                                <div class="flex gap-2">
                                    <button id="btn-em-save" onclick="addEmergencyItem()"
                                        class="flex-1 py-2.5 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition shadow-sm flex justify-center items-center gap-2 text-sm">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Listeye Ekle</span>
                                    </button>
                                    <button id="btn-em-cancel" onclick="cancelEmergencyEdit()"
                                        class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
                                        Ä°ptal
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-bold text-gray-500 uppercase">Kritik Stok / MiadÄ± Dolan</span>
                                <span id="em-alert-count"
                                    class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded-full">0</span>
                            </div>
                            <p class="text-[10px] text-gray-400">Son kullanma tarihi geÃ§enler kÄ±rmÄ±zÄ± ile iÅŸaretlenir.
                            </p>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <div
                            class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
                            <div
                                class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center flex-wrap gap-2">
                                <h3 class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="list"
                                        class="w-4 h-4"></i> Ã‡anta Envanteri</h3>

                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="openCopyModal()"
                                        class="text-[10px] bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1">
                                        <i data-lucide="copy" class="w-3 h-3"></i> Kopyala
                                    </button>

                                    <button onclick="exportEmergencyData()"
                                        class="text-[10px] bg-green-50 text-green-700 hover:bg-green-100 border border-green-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1">
                                        <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Excel (Tam Yedek)
                                    </button>

                                    <label
                                        class="text-[10px] bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1 cursor-pointer">
                                        <i data-lucide="upload-cloud" class="w-3 h-3"></i> Yedek YÃ¼kle
                                        <input type="file" onchange="importEmergencyData(event)" accept=".xlsx, .csv"
                                            class="hidden">
                                    </label>

                                    <button onclick="downloadEmergencyPDF()"
                                        class="text-[10px] bg-red-50 text-red-700 hover:bg-red-100 border border-red-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1">
                                        <i data-lucide="file-text" class="w-3 h-3"></i> PDF
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-y-auto flex-grow custom-scrollbar p-0">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 w-10 text-center">
                                                <input type="checkbox" id="select-all-em" onchange="toggleAllEm(this)"
                                                    class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                            </th>
                                            <th class="px-4 py-3">Malzeme</th>
                                            <th class="px-4 py-3 text-center">SKT</th>
                                            <th class="px-4 py-3 text-center">Adet</th>
                                            <th class="px-4 py-3 text-right">Ä°ÅŸlem</th>
                                        </tr>
                                    </thead>
                                    <tbody id="emergency-list-body" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-butce" class="tab-content hidden h-full">
                <div
                    class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-6 flex flex-wrap items-center gap-4 justify-between">
                    <div class="flex items-center gap-2">
                        <div class="bg-indigo-600 text-white p-2 rounded-lg"><i data-lucide="calendar-clock"
                                class="w-5 h-5"></i></div>
                        <div>
                            <h3 class="text-sm font-bold text-indigo-900">BÃ¼tÃ§e DÃ¶nemi</h3>
                            <p class="text-xs text-indigo-600">DÃ¶nem: AyÄ±n 15'i - 14'Ã¼</p>
                        </div>
                    </div>

                    <div class="flex items-center bg-white p-1 rounded-lg border border-indigo-200 shadow-sm">
                        <button onclick="changeBudgetMonth(-1)"
                            class="p-2 hover:bg-gray-100 rounded-lg text-indigo-600 transition">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <span id="budget-period-display"
                            class="px-4 text-sm font-bold text-indigo-900 min-w-[220px] text-center select-none">
                            YÃ¼kleniyor...
                        </span>
                        <button onclick="changeBudgetMonth(1)"
                            class="p-2 hover:bg-gray-100 rounded-lg text-indigo-600 transition">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="flex items-center gap-2">
                        <button onclick="downloadBudgetExcel()"
                            class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                            <span>Excel Rapor</span>
                        </button>

                        <button onclick="downloadBudgetPDF()"
                            class="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-bold shadow-sm">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            <span>PDF Rapor</span>
                        </button>

                        <label
                            class="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-bold shadow-sm cursor-pointer">
                            <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                            <span>YÃ¼kle</span>
                            <input type="file" onchange="importData(event)" accept=".xlsx, .csv" class="hidden">
                        </label>

                        <button onclick="lockSpecialTab('butce')"
                            class="flex items-center gap-2 px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition text-sm font-bold shadow-sm border border-red-200 ml-2"
                            title="Sekmeyi Kilitle">
                            <i data-lucide="lock" class="w-4 h-4"></i>
                            <span>Kilitle</span>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div
                        class="bg-white p-4 rounded-xl border border-green-200 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-bold text-green-600 uppercase tracking-wider">DÃ¶nem Gelir</p>
                            <h3 id="budget-income" class="text-2xl font-bold text-gray-800">0 â‚º</h3>
                        </div>
                        <div class="bg-green-100 p-2 rounded-lg text-green-600"><i data-lucide="trending-up"
                                class="w-6 h-6"></i></div>
                    </div>
                    <div
                        class="bg-white p-4 rounded-xl border border-red-200 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-bold text-red-600 uppercase tracking-wider">DÃ¶nem Gider</p>
                            <h3 id="budget-expense" class="text-2xl font-bold text-gray-800">0 â‚º</h3>
                        </div>
                        <div class="bg-red-100 p-2 rounded-lg text-red-600"><i data-lucide="trending-down"
                                class="w-6 h-6"></i></div>
                    </div>
                    <div
                        class="bg-white p-4 rounded-xl border border-blue-200 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-bold text-blue-600 uppercase tracking-wider">Net Kalan</p>
                            <h3 id="budget-balance" class="text-2xl font-bold text-gray-800">0 â‚º</h3>
                        </div>
                        <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="wallet"
                                class="w-6 h-6"></i></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm sticky top-4">
                            <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
                                <i data-lucide="plus-circle" class="w-4 h-4 mr-2 text-indigo-600"></i> HÄ±zlÄ± Ä°ÅŸlem Ekle
                            </h3>
                            <div class="space-y-3">
                                <div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="cursor-pointer">
                                            <input type="radio" name="budgetType" value="income" class="peer sr-only"
                                                checked>
                                            <div
                                                class="text-center py-2 border rounded-lg bg-gray-50 peer-checked:bg-green-600 peer-checked:text-white peer-checked:border-green-600 transition text-xs font-bold text-gray-500">
                                                GELÄ°R</div>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="budgetType" value="expense" class="peer sr-only">
                                            <div
                                                class="text-center py-2 border rounded-lg bg-gray-50 peer-checked:bg-red-600 peer-checked:text-white peer-checked:border-red-600 transition text-xs font-bold text-gray-500">
                                                GÄ°DER</div>
                                        </label>
                                    </div>
                                </div>
                                <input type="text" id="budget-desc"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition"
                                    placeholder="AÃ§Ä±klama (Ã–rn: Ä°LKER, Ã–MER, Ã‡AY, SU...)">
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-gray-400 text-sm">â‚º</span>
                                    <input type="number" id="budget-amount"
                                        class="w-full p-2.5 pl-7 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition"
                                        placeholder="0.00">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
                                    <input type="text" id="budget-note"
                                        class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition"
                                        placeholder="Ã–rn: Ã‡ay AlÄ±ndÄ±, Su AlÄ±ndÄ±...">
                                </div>
                                <input type="date" id="budget-entry-date"
                                    class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
                                <div class="flex gap-2">
                                    <button id="btn-budget-save" onclick="addBudgetItem()"
                                        class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm text-sm">Ekle</button>
                                    <button id="btn-budget-cancel" onclick="cancelBudgetEdit()"
                                        class="hidden px-3 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">Ä°ptal</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div
                            class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col h-[400px]">
                            <div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 text-xs uppercase">DÃ¶nem Hareketleri</h3>
                                <button onclick="clearBudget()"
                                    class="text-[10px] text-red-500 hover:text-red-700 font-bold bg-red-50 px-2 py-1 rounded">TEMÄ°ZLE</button>
                            </div>
                            <div class="overflow-y-auto flex-grow custom-scrollbar">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2">Tarih</th>
                                            <th class="px-4 py-2">AÃ§Ä±klama</th>
                                            <th class="px-4 py-2 text-right">Tutar</th>
                                            <th class="px-4 py-2 text-center w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="budget-list-body" class="divide-y divide-gray-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-notlar" class="tab-content hidden h-full">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                    <div class="lg:col-span-1">
                        <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 sticky top-4">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-lg font-bold text-indigo-900 flex items-center">
                                    <i data-lucide="sticky-note" class="w-5 h-5 mr-2"></i> Yeni Not
                                </h3>
                                <button onclick="lockSpecialTab('notlar')"
                                    class="flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition text-xs font-bold border border-red-200"
                                    title="Sekmeyi Kilitle">
                                    <i data-lucide="lock" class="w-3 h-3"></i> Kilitle
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">BaÅŸlÄ±k</label>
                                    <input type="text" id="gen-note-title"
                                        class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
                                        placeholder="Not BaÅŸlÄ±ÄŸÄ±...">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Ä°Ã§erik</label>
                                    <textarea id="gen-note-content"
                                        class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white resize-none h-32"
                                        placeholder="Notunuzu buraya yazÄ±n..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Renk SeÃ§imi</label>
                                    <div class="flex gap-2">
                                        <button onclick="selectNoteColor('yellow')"
                                            class="w-8 h-8 rounded-full bg-yellow-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
                                            data-color="yellow"></button>
                                        <button onclick="selectNoteColor('blue')"
                                            class="w-8 h-8 rounded-full bg-blue-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
                                            data-color="blue"></button>
                                        <button onclick="selectNoteColor('green')"
                                            class="w-8 h-8 rounded-full bg-green-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
                                            data-color="green"></button>
                                        <button onclick="selectNoteColor('red')"
                                            class="w-8 h-8 rounded-full bg-red-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
                                            data-color="red"></button>
                                        <button onclick="selectNoteColor('purple')"
                                            class="w-8 h-8 rounded-full bg-purple-200 hover:scale-110 transition ring-2 ring-offset-1 ring-transparent focus:ring-gray-400 note-color-btn"
                                            data-color="purple"></button>
                                    </div>
                                    <input type="hidden" id="selected-note-color" value="yellow">
                                </div>
                                <button onclick="addGeneralNote()"
                                    class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-2 text-sm mt-2">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Notu Kaydet
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl border border-gray-200 shadow-sm min-h-[500px] p-4">
                            <div class="flex justify-between items-center mb-4 pb-2 border-b">
                                <h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="grid"
                                        class="w-4 h-4"></i> NotlarÄ±m</h3>
                                <span id="note-count-badge"
                                    class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">0
                                    Not</span>
                            </div>
                            <div id="general-notes-grid" class="space-y-2 overflow-y-auto max-h-[600px] pr-1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-nobet" class="tab-content hidden h-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
            <div class="lg:col-span-1">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm sticky top-4">
                    <h3 class="text-sm font-bold text-gray-800 mb-4 flex items-center border-b pb-2">
                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2 text-indigo-600"></i> NÃ¶bet Yaz
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Tarih</label>
                            <input type="date" id="shift-date"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Personel</label>
                            <input type="text" id="shift-staff" list="staff-suggestions"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="Personel SeÃ§in...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">NÃ¶bet TÃ¼rÃ¼ / Saat</label>
                            <select id="shift-type"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
                                <option value="24 Saat">24 Saat</option>
                                <option value="16 Saat">16 Saat</option>
                                <option value="Gece">Gece</option>
                                <option value="GÃ¼ndÃ¼z">GÃ¼ndÃ¼z</option>
                                <option value="Ä°cap">Ä°cap</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
                            <input type="text" id="shift-note"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none"
                                placeholder="Ã–rn: Acil deÄŸiÅŸti...">
                        </div>
                        <button onclick="addShift()"
                            class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm text-sm mt-2">
                            Listeye Ekle
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div
                    class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[500px]">

                    <div class="bg-gray-50 px-4 py-3 border-b flex flex-wrap gap-2 justify-between items-center">
                        <div class="flex items-center gap-3">
                            <h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
                                <i data-lucide="list" class="w-4 h-4"></i> NÃ¶bet Listesi
                            </h3>

                            <div
                                class="flex items-center bg-white rounded-lg border border-gray-300 shadow-sm px-1 py-0.5 ml-2">
                                <button onclick="changeShiftMonth(-1)"
                                    class="p-1 hover:bg-gray-100 text-indigo-600 rounded transition"><i
                                        data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                <span id="shift-period-display"
                                    class="px-2 text-xs font-bold text-indigo-900 min-w-[120px] text-center select-none uppercase tracking-wide">...</span>
                                <button onclick="changeShiftMonth(1)"
                                    class="p-1 hover:bg-gray-100 text-indigo-600 rounded transition"><i
                                        data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                            <button onclick="openFairnessModal()"
                                class="flex items-center gap-1 px-2 py-1.5 bg-purple-50 text-purple-600 hover:bg-purple-100 hover:text-purple-700 border border-purple-200 rounded text-[10px] font-bold transition mr-1">
                                <i data-lucide="scale" class="w-3 h-3"></i> NÃ¶bet Analizi
                            </button>
                            <button onclick="downloadShiftPDF()"
                                class="flex items-center gap-1 px-2 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 border border-red-200 rounded text-[10px] font-bold transition">
                                <i data-lucide="file-text" class="w-3 h-3"></i> PDF
                            </button>
                            <span id="shift-count-badge"
                                class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-1 rounded-full font-bold">0
                                KayÄ±t</span>
                        </div>
                    </div>

                    <div class="overflow-y-auto flex-grow custom-scrollbar">
                        <table class="w-full text-sm text-left">
                            <thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 border-2 border-gray-600">Tarih</th>
                                    <th class="px-4 py-3 border-2 border-gray-600">Personel</th>
                                    <th class="px-4 py-3 text-center border-2 border-gray-600">TÃ¼r</th>
                                    <th class="px-4 py-3 text-right border-2 border-gray-600">Ä°ÅŸlem</th>
                                </tr>
                            </thead>
                            <tbody id="shift-list-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="tab-cihazlar" class="tab-content hidden h-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
            <div class="lg:col-span-1">
                <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm sticky top-4">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-sm font-bold text-gray-800 flex items-center">
                            <i data-lucide="stethoscope" class="w-4 h-4 mr-2 text-teal-600"></i> Cihaz TanÄ±mla
                        </h3>
                        <button onclick="lockSpecialTab('cihazlar')"
                            class="flex items-center gap-1 px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition text-xs font-bold border border-red-200"
                            title="Sekmeyi Kilitle">
                            <i data-lucide="lock" class="w-3 h-3"></i> Kilitle
                        </button>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">KÃ¼nye NumarasÄ±</label>
                        <input type="text" id="dev-tag-no"
                            class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-teal-500"
                            placeholder="Ã–rn: 10452">
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Cihaz AdÄ± / Marka</label>
                            <input type="text" id="dev-name"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-teal-500"
                                placeholder="Ã–rn: Tansiyon Aleti (Omron)">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Zimmetlenecek KiÅŸi / Konum</label>
                            <input type="text" id="dev-holder" list="staff-suggestions"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none focus:ring-2 focus:ring-teal-500"
                                placeholder="Personel veya 'Depo' yazÄ±n">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Sonraki Kalibrasyon/BakÄ±m
                                Tarihi</label>
                            <input type="date" id="dev-calib-date"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
                            <p class="text-[10px] text-gray-400 mt-1">* Tarih gelince sistem uyaracaktÄ±r.</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Cihaz Durumu</label>
                            <select id="dev-status"
                                class="w-full p-2.5 border rounded-lg text-sm bg-gray-50 outline-none">
                                <option value="SaÄŸlam">ğŸŸ¢ SaÄŸlam / KullanÄ±mda</option>
                                <option value="Serviste">ğŸŸ  Serviste / Tamirde</option>
                                <option value="ArÄ±zalÄ±">ğŸ”´ ArÄ±zalÄ± / KullanÄ±m DÄ±ÅŸÄ±</option>
                                <option value="Kayboldu">âš« KayÄ±p</option>
                            </select>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button id="btn-device-save" onclick="addDevice()"
                                class="flex-1 py-2.5 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 transition shadow-sm text-sm flex justify-center items-center gap-2">
                                <span>Envantere Ekle</span>
                            </button>
                            <button id="btn-device-cancel" onclick="cancelDeviceEdit()"
                                class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
                                Ä°ptal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div
                    class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden flex flex-col min-h-[500px]">
                    <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
                            <i data-lucide="table-2" class="w-4 h-4"></i> Envanter Listesi
                        </h3>
                        <span id="dev-count-badge"
                            class="bg-teal-100 text-teal-700 text-[10px] px-2 py-1 rounded-full font-bold">0
                            Cihaz</span>
                    </div>
                    <div class="overflow-y-auto flex-grow custom-scrollbar">
                        <table class="w-full text-sm text-left">
                            <thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
                                <tr>
                                    <th class="px-4 py-3">KÃ¼nye No</th>
                                    <th class="px-4 py-3">Cihaz</th>
                                    <th class="px-4 py-3">Zimmet</th>
                                    <th class="px-4 py-3">Kalibrasyon</th>
                                    <th class="px-4 py-3">Durum</th>
                                    <th class="px-4 py-3 text-right">Sil</th>
                                </tr>
                            </thead>
                            <tbody id="dev-list-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-hastatakip" class="tab-content hidden">
        <!-- Alt Sekme ButonlarÄ± -->
        <div class="flex border-b border-gray-200 mb-4">
            <button id="subtab-btn-islem" onclick="switchPatientSubTab('islem')"
                class="px-4 py-2 text-sm font-bold border-b-2 border-indigo-600 text-indigo-700 bg-indigo-50 rounded-t-lg mr-1 transition">
                <i data-lucide="calendar-plus" class="w-4 h-4 inline-block mr-1"></i> Ä°ÅŸlem Planla
            </button>
            <button id="subtab-btn-doktor" onclick="switchPatientSubTab('doktor')"
                class="px-4 py-2 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-t-lg transition">
                <i data-lucide="stethoscope" class="w-4 h-4 inline-block mr-1"></i> Doktor'a Ä°let
            </button>
        </div>

        <!-- Ä°ÅLEM PLANLA SEKMESÄ° (Mevcut) -->
        <div id="subtab-islem" class="subtab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 sticky top-4">
                        <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
                            <i data-lucide="calendar-plus" class="w-5 h-5 mr-2"></i> Ä°ÅŸlem Planla
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Hasta AdÄ± SoyadÄ±</label>
                                <input type="text" id="rem-patient"
                                    class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white"
                                    placeholder="Ã–rn: AyÅŸe Teyze">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">YapÄ±lacak Ä°ÅŸlem</label>
                                <select id="rem-proc"
                                    class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none">
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Planlanan Tarih</label>
                                <input type="date" id="rem-date"
                                    class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Not (Opsiyonel)</label>
                                <textarea id="rem-note"
                                    class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white resize-none h-20"
                                    placeholder="Ã–rn: 18 numara silikon sonda gÃ¶tÃ¼r..."></textarea>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button id="btn-rem-save" onclick="addPatientReminder()"
                                    class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-2 text-sm">
                                    <i data-lucide="save" class="w-4 h-4"></i> <span>Kaydet ve Planla</span>
                                </button>
                                <button id="btn-rem-cancel" onclick="cancelReminderEdit()"
                                    class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
                                    Ä°ptal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col min-h-[500px]">
                        <div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-4 h-4"></i> Ä°ÅŸlemler Listesi
                            </h3>
                            <span id="rem-count-badge"
                                class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-1 rounded-full font-bold">0
                                KayÄ±t</span>
                        </div>
                        <!-- Aktif/GeÃ§miÅŸ Sekme ButonlarÄ± -->
                        <div class="px-4 py-2 border-b bg-gray-50">
                            <div class="flex gap-2 p-1 bg-gray-100 rounded-lg mb-2">
                                <button id="rem-tab-active" onclick="switchRemTab('active')"
                                    class="flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-indigo-600 text-white transition">
                                    ğŸ“‹ Aktif Ä°ÅŸlemler
                                </button>
                                <button id="rem-tab-history" onclick="switchRemTab('history')"
                                    class="flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition">
                                    ğŸ“ GeÃ§miÅŸ
                                </button>
                            </div>
                            <div class="relative">
                                <i data-lucide="search"
                                    class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="rem-search-input" placeholder="Hasta veya iÅŸlem ara..."
                                    oninput="searchPatientReminders(this.value)"
                                    class="w-full pl-9 pr-8 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                            </div>
                        </div>
                        <div class="overflow-y-auto flex-grow custom-scrollbar">
                            <table class="w-full text-sm text-left">
                                <thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 border-2 border-gray-600 w-32">Tarih (Kalan GÃ¼n)</th>
                                        <th class="px-4 py-3 border-2 border-gray-600 w-40">Hasta</th>
                                        <th class="px-4 py-3 border-2 border-gray-600 w-32">Ä°ÅŸlem</th>
                                        <th class="px-4 py-3 text-right border-2 border-gray-600 w-48">YÃ¶net</th>
                                    </tr>
                                </thead>
                                <tbody id="reminder-list-body" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DOKTOR'A Ä°LET SEKMESÄ° (Yeni) -->
        <div id="subtab-doktor" class="subtab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 sticky top-4">
                        <h3 class="text-lg font-bold text-blue-900 mb-4 flex items-center">
                            <i data-lucide="stethoscope" class="w-5 h-5 mr-2"></i> Doktor'a Ä°let
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Hasta AdÄ± SoyadÄ±</label>
                                <input type="text" id="dr-patient"
                                    class="w-full p-2.5 border border-blue-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                                    placeholder="Ã–rn: Mehmet Bey">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Talebi / Ä°letilecek
                                    Konu</label>
                                <textarea id="dr-request"
                                    class="w-full p-2.5 border border-blue-200 rounded-lg text-sm bg-white resize-none h-24 outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="Ã–rn: Tansiyon kontrolÃ¼ gerekli, ilaÃ§ dozunu gÃ¶zden geÃ§irmeli..."></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Tarih</label>
                                <input type="date" id="dr-date"
                                    class="w-full p-2.5 border border-blue-200 rounded-lg text-sm bg-white outline-none">
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button id="btn-dr-save" onclick="addDoctorRequest()"
                                    class="flex-1 py-2.5 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-sm flex justify-center items-center gap-2 text-sm">
                                    <i data-lucide="send" class="w-4 h-4"></i> <span>Doktora Ä°let</span>
                                </button>
                                <button id="btn-dr-cancel" onclick="cancelDoctorRequestEdit()"
                                    class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
                                    Ä°ptal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl border border-blue-200 shadow-sm flex flex-col min-h-[500px]">
                        <div class="bg-blue-50 px-5 py-3 border-b border-blue-100 flex justify-between items-center">
                            <h3 class="font-bold text-blue-800 text-xs uppercase flex items-center gap-2">
                                <i data-lucide="clipboard-list" class="w-4 h-4"></i> Doktor Talepleri
                            </h3>
                            <span id="dr-count-badge"
                                class="bg-blue-100 text-blue-700 text-[10px] px-2 py-1 rounded-full font-bold">0
                                KayÄ±t</span>
                        </div>
                        <div id="doctor-requests-list" class="overflow-y-auto flex-grow custom-scrollbar p-3 space-y-2">
                            <!-- Talepler buraya dinamik olarak eklenecek -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-rehber" class="tab-content hidden h-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
            <div class="lg:col-span-1">
                <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 sticky top-4">
                    <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
                        <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Yeni KiÅŸi Ekle
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Ad Soyad</label>
                            <input type="text" id="ph-name"
                                class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="Ã–rn: Dr. Ahmet YÄ±lmaz">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Birim / Ãœnvan</label>
                            <input type="text" id="ph-role"
                                class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
                                placeholder="Ã–rn: BaÅŸhekimlik, NÃ¶betÃ§i...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Telefon NumarasÄ±</label>
                            <input type="tel" id="ph-num"
                                class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
                                placeholder="0555 123 45 67">
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button id="btn-ph-save" onclick="addContact()"
                                class="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm flex justify-center items-center gap-2 text-sm">
                                <i data-lucide="save" class="w-4 h-4"></i> <span>Rehbere Kaydet</span>
                            </button>
                            <button id="btn-ph-cancel" onclick="cancelEditContact()"
                                class="hidden px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition text-sm">
                                Ä°ptal
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col min-h-[500px]">
                    <div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center sticky top-0 z-10">
                        <h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
                            <i data-lucide="book-user" class="w-4 h-4"></i> Kurum Ä°Ã§i Rehber
                        </h3>
                        <div class="relative">
                            <input type="text" id="ph-search" oninput="renderPhonebook()" placeholder="Rehberde Ara..."
                                class="pl-8 pr-2 py-1 text-xs border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none w-48">
                            <i data-lucide="search" class="w-3 h-3 absolute left-2.5 top-2 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="p-4 overflow-y-auto flex-grow custom-scrollbar">
                        <div id="phonebook-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-istatistik" class="tab-content hidden">
        <div class="p-6">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-6 flex items-center">
                <i data-lucide="bar-chart-2" class="w-6 h-6 mr-2 text-indigo-600"></i> Performans ve Veri Analizi
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div
                    class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div class="text-xs font-bold text-gray-400 uppercase">Toplam Hasta (Bu Ay)</div>
                    <div id="stat-total-visit" class="text-3xl font-bold text-indigo-600 mt-2">0</div>
                </div>
                <div
                    class="bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div class="text-xs font-bold text-gray-400 uppercase">En YoÄŸun Personel</div>
                    <div id="stat-top-staff" class="text-xl font-bold text-emerald-600 mt-2">-</div>
                </div>
            </div>
            <div
                class="col-span-1 lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm mb-4 overflow-hidden opacity-80">
                <div
                    class="bg-gray-100 dark:bg-gray-700 px-4 py-2 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-gray-600 dark:text-gray-300 flex items-center">
                        <i data-lucide="history" class="w-4 h-4 mr-2"></i> GeÃ§en HaftanÄ±n NÃ¶betÃ§ileri
                    </h3>
                    <span
                        class="text-[10px] text-gray-500 bg-white dark:bg-gray-800 px-2 py-1 rounded-full shadow-sm font-bold border border-gray-200">GeÃ§en
                        Hafta</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <tbody id="stat-prev-week-shifts-body" class="divide-y divide-gray-100 dark:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <div
                class="col-span-1 lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl border-2 border-indigo-100 dark:border-indigo-900 shadow-md mb-4 overflow-hidden">
                <div
                    class="bg-purple-50 dark:bg-gray-700 px-4 py-3 border-b border-purple-100 dark:border-gray-600 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-purple-900 dark:text-purple-300 flex items-center">
                        <i data-lucide="calendar-clock" class="w-4 h-4 mr-2"></i> HaftanÄ±n NÃ¶betÃ§ileri
                    </h3>
                    <span
                        class="text-[10px] text-purple-600 dark:text-purple-400 bg-white dark:bg-gray-800 px-2 py-1 rounded-full shadow-sm font-bold">Mevcut
                        Hafta</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <tbody id="stat-weekly-shifts-body" class="divide-y divide-gray-100 dark:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>

            <div
                class="col-span-1 lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl border border-blue-100 dark:border-blue-900 shadow-sm mb-6 overflow-hidden">
                <div
                    class="bg-blue-50 dark:bg-gray-700 px-4 py-2 border-b border-blue-100 dark:border-gray-600 flex justify-between items-center">
                    <h3 class="text-xs font-bold text-blue-900 dark:text-blue-300 flex items-center">
                        <i data-lucide="calendar-days" class="w-4 h-4 mr-2"></i> Gelecek HaftanÄ±n NÃ¶betÃ§ileri
                    </h3>
                    <span
                        class="text-[10px] text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800 px-2 py-1 rounded-full shadow-sm font-bold border border-blue-100">Gelecek
                        Hafta</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left">
                        <tbody id="stat-next-week-shifts-body" class="divide-y divide-gray-100 dark:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 text-center">Personel Performans
                        (Ay PuanÄ±)</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="chart-staff-performance"></canvas>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 text-center">YapÄ±lan Ä°ÅŸlem
                        DaÄŸÄ±lÄ±mÄ±</h3>
                    <div class="relative h-64 w-full flex justify-center">
                        <canvas id="chart-visit-types"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                <h3 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 text-center">Doktor BazlÄ± DetaylÄ±
                    Performans (Sol: Hasta SayÄ±sÄ± | SaÄŸ: Ä°ÅŸlemler)</h3>
                <div class="relative h-80 w-full">
                    <canvas id="chart-doctor-details"></canvas>
                </div>
                <div id="doc-breakdown-area"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 border-t pt-4 dark:border-gray-700">
                </div>
            </div>
        </div>

        <div id="tab-rehber" class="tab-content hidden h-full">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full pt-2">
                <div class="lg:col-span-1">
                    <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-100 sticky top-4">
                        <h3 class="text-lg font-bold text-indigo-900 mb-4 flex items-center">
                            <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> Yeni KiÅŸi Ekle
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Ad Soyad</label>
                                <input type="text" id="ph-name"
                                    class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Ã–rn: Dr. Ahmet YÄ±lmaz">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Birim / Ãœnvan</label>
                                <input type="text" id="ph-role"
                                    class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
                                    placeholder="Ã–rn: BaÅŸhekimlik, NÃ¶betÃ§i...">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Telefon NumarasÄ±</label>
                                <input type="tel" id="ph-num"
                                    class="w-full p-2.5 border border-indigo-200 rounded-lg text-sm bg-white outline-none"
                                    placeholder="0555 123 45 67">
                            </div>
                            <button onclick="addContact()"
                                class="w-full py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition shadow-sm text-sm mt-2 flex justify-center items-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Rehbere Kaydet
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col min-h-[500px]">
                        <div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center sticky top-0 z-10">
                            <h3 class="font-bold text-gray-700 text-xs uppercase flex items-center gap-2">
                                <i data-lucide="book-user" class="w-4 h-4"></i> Kurum Ä°Ã§i Rehber
                            </h3>
                            <div class="relative">
                                <input type="text" id="ph-search" oninput="renderPhonebook()"
                                    placeholder="Rehberde Ara..."
                                    class="pl-8 pr-2 py-1 text-xs border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none w-48">
                                <i data-lucide="search" class="w-3 h-3 absolute left-2.5 top-2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="p-4 overflow-y-auto flex-grow custom-scrollbar">
                            <div id="phonebook-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-takvim" class="tab-content hidden h-full">
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[700px]">

            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl sticky top-0 z-20">
                <h2 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
                    <i data-lucide="calendar-days" class="w-6 h-6 text-indigo-600"></i> GÃ¶rsel Takvim
                </h2>

                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-xs font-bold text-gray-500 mr-4">
                        <span class="flex items-center"><span
                                class="w-3 h-3 bg-blue-100 border border-blue-300 rounded-full mr-1"></span> Hasta
                            Ä°ÅŸlemi</span>
                        <span class="flex items-center"><span
                                class="w-3 h-3 bg-purple-100 border border-purple-300 rounded-full mr-1"></span>
                            NÃ¶bet</span>
                    </div>

                    <div class="flex items-center bg-white border rounded-lg shadow-sm">
                        <button onclick="changeCalendarMonth(-1)"
                            class="p-2 hover:bg-gray-100 rounded-l-lg text-indigo-600 transition"><i
                                data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <span id="calendar-month-display"
                            class="px-4 font-bold text-indigo-900 w-40 text-center select-none uppercase tracking-wide">...</span>
                        <button onclick="changeCalendarMonth(1)"
                            class="p-2 hover:bg-gray-100 rounded-r-lg text-indigo-600 transition"><i
                                data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>

                    <button onclick="renderCalendar()"
                        class="p-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition"
                        title="Yenile">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="flex-grow flex flex-col p-4 overflow-y-auto bg-gray-100">
                <div class="grid grid-cols-7 mb-2">
                    <div class="text-center font-bold text-gray-500 text-xs uppercase py-2">Pazartesi</div>
                    <div class="text-center font-bold text-gray-500 text-xs uppercase py-2">SalÄ±</div>
                    <div class="text-center font-bold text-gray-500 text-xs uppercase py-2">Ã‡arÅŸamba</div>
                    <div class="text-center font-bold text-gray-500 text-xs uppercase py-2">PerÅŸembe</div>
                    <div class="text-center font-bold text-gray-500 text-xs uppercase py-2">Cuma</div>
                    <div class="text-center font-bold text-red-500 text-xs uppercase py-2">Cumartesi</div>
                    <div class="text-center font-bold text-red-500 text-xs uppercase py-2">Pazar</div>
                </div>

                <div id="calendar-grid" class="grid grid-cols-7 gap-2 flex-grow auto-rows-fr">
                </div>
            </div>
        </div>
    </div>

    <!-- Ä°NR HESAPLAYICI SEKMESÄ° (Uzman TÄ±p) -->
    <div id="tab-inrhesaplayici" class="tab-content hidden h-full">
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[600px]">
            <div
                class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-cyan-50 to-teal-50 rounded-t-xl sticky top-0 z-20">
                <h2 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
                    <i data-lucide="activity" class="w-6 h-6 text-cyan-600"></i> Uzman TÄ±p: AkÄ±llÄ± INR YÃ¶netim
                </h2>
                <div class="hidden md:block text-right text-xs text-cyan-600">
                    <p>Referans Tablet: <strong>5 mg</strong> (Coumadin)</p>
                    <p>GÃ¼venli INR AralÄ±ÄŸÄ±: 2.0 - 3.0</p>
                </div>
            </div>

            <div class="p-6 flex-grow overflow-auto">
                <!-- Disclaimer -->
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-6">
                    <div class="flex">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500 flex-shrink-0"></i>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <span class="font-bold">Dikkat:</span> Bu sistem <strong>1 Tam Tableti 5 mg</strong>
                                olarak kabul eder. OndalÄ±klÄ± giriÅŸler (Ã¶rn: 1.5) tablet sayÄ±sÄ± olarak iÅŸlem gÃ¶rÃ¼r (1.5
                                tablet = 7.5mg).
                            </p>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Input Section -->
                    <div class="bg-white rounded-xl p-6 border-2 border-cyan-200 shadow-sm">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4 flex items-center">
                            <i data-lucide="calculator" class="w-5 h-5 mr-2 text-cyan-600"></i> AkÄ±llÄ± Hasta Veri GiriÅŸi
                        </h3>

                        <div class="space-y-4">
                            <!-- INR Input -->
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Ã–lÃ§Ã¼len GÃ¼ncel INR
                                    DeÄŸeri</label>
                                <div class="relative">
                                    <input type="number" id="uzmanCurrentINR" placeholder="Ã–rn: 1.8"
                                        class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50 font-bold text-lg text-slate-700 focus:ring-2 focus:ring-cyan-500 outline-none"
                                        step="0.01">
                                    <span class="absolute right-3 top-3.5 text-slate-400 text-sm font-bold">INR</span>
                                </div>
                            </div>

                            <div class="border-t border-slate-200 my-4"></div>

                            <!-- Smart Text Area -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">
                                    Mevcut Ä°laÃ§ KullanÄ±mÄ±
                                    <span class="text-xs font-normal text-cyan-600 ml-2">(SayÄ±, buÃ§uk veya kelime
                                        kullanabilirsiniz)</span>
                                </label>
                                <div class="relative">
                                    <textarea id="uzmanDoseText" oninput="parsePrescriptionTextUzman()" rows="4"
                                        class="w-full p-4 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 placeholder-slate-400 font-medium focus:ring-2 focus:ring-cyan-500 outline-none"
                                        placeholder="Ã–rnekler:
- 3 gÃ¼n 1.5, 4 gÃ¼n 1
- 2 gÃ¼n 2 buÃ§uk, 5 gÃ¼n yarÄ±m
- 3 gÃ¼n tam, 4 gÃ¼n 0.5"></textarea>
                                    <div
                                        class="absolute right-2 bottom-2 text-xs text-slate-400 bg-white px-2 py-1 rounded border">
                                        <i data-lucide="sparkles" class="w-3 h-3 inline text-cyan-500"></i> AkÄ±llÄ±
                                        AlgÄ±lama
                                    </div>
                                </div>

                                <!-- Quick Reference Pill Sizes -->
                                <div
                                    class="flex space-x-2 mt-2 text-[10px] text-slate-500 justify-center flex-wrap gap-y-1">
                                    <span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">Tam = 1</span>
                                    <span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">YarÄ±m =
                                        0.5</span>
                                    <span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">BuÃ§uk =
                                        .5</span>
                                    <span class="bg-slate-100 px-2 py-1 rounded border border-slate-200">1.5 =
                                        7.5mg</span>
                                </div>
                            </div>

                            <!-- Parsed Status -->
                            <div id="uzmanParseStatus"
                                class="hidden bg-slate-100 p-3 rounded text-sm text-slate-600 mb-2 border border-slate-200">
                            </div>

                            <!-- Calculated Weekly Total Display -->
                            <div class="bg-cyan-50 p-4 rounded-lg border border-cyan-200 flex justify-between items-center"
                                id="uzmanTotalBox">
                                <div>
                                    <p class="text-xs text-cyan-700 font-bold uppercase">Hesaplanan Mevcut Doz</p>
                                    <p class="text-[10px] text-cyan-600">(HaftalÄ±k Toplam)</p>
                                </div>
                                <div class="text-right">
                                    <span id="uzmanTotalWeeklyMgDisplay"
                                        class="text-3xl font-extrabold text-cyan-800">0</span>
                                    <span class="text-sm text-cyan-700 font-medium">mg</span>
                                </div>
                                <input type="hidden" id="uzmanCurrentWeeklyDose" value="0">
                            </div>

                            <button onclick="calculateDoseUzman()"
                                class="w-full bg-cyan-700 hover:bg-cyan-800 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center shadow-lg mt-4">
                                <i data-lucide="pill" class="w-5 h-5 mr-2"></i> ReÃ§eteyi Hesapla
                            </button>
                        </div>
                    </div>

                    <!-- Result Section -->
                    <div class="bg-white rounded-xl p-6 border border-slate-300 shadow-sm" id="uzmanResultCard">
                        <div class="h-full flex flex-col justify-center items-center text-center text-slate-400"
                            id="uzmanEmptyState">
                            <i data-lucide="user-check" class="w-16 h-16 mb-4 opacity-30"></i>
                            <p class="mt-4 text-sm">SonuÃ§larÄ± gÃ¶rmek iÃ§in INR deÄŸerini ve hastanÄ±n mevcut kullanÄ±mÄ±nÄ±
                                yazÄ±nÄ±z.</p>
                        </div>

                        <div id="uzmanResultsContent" class="hidden space-y-4">
                            <div class="flex items-center justify-between border-b pb-2">
                                <h3 class="text-lg font-bold text-slate-700">Uzman Ã–nerisi</h3>
                                <span id="uzmanStatusBadge"
                                    class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-700">Durum</span>
                            </div>

                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="p-3 bg-slate-50 rounded-lg">
                                    <p class="text-xs text-slate-500">Mevcut HaftalÄ±k</p>
                                    <p class="text-xl font-bold text-slate-700" id="uzmanDisplayOldDose">-</p>
                                </div>
                                <div class="p-3 bg-cyan-50 rounded-lg border border-cyan-200 shadow-sm">
                                    <p class="text-xs text-cyan-600 font-bold">YENÄ° HaftalÄ±k Hedef</p>
                                    <p class="text-2xl font-extrabold text-cyan-800" id="uzmanDisplayNewDose">-</p>
                                </div>
                            </div>

                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <h4 class="text-sm font-bold text-yellow-800 mb-2"><i data-lucide="clipboard-list"
                                        class="w-4 h-4 inline mr-1"></i> Klinik Yorum & Aksiyon</h4>
                                <p id="uzmanActionText" class="text-sm text-yellow-900 leading-relaxed">...</p>
                            </div>

                            <!-- Sonraki Kan KontrolÃ¼ -->
                            <div id="uzmanNextTestBox" class="bg-blue-50 p-4 rounded-lg border border-blue-200 hidden">
                                <h4 class="text-sm font-bold text-blue-800 mb-2"><i data-lucide="calendar-clock"
                                        class="w-4 h-4 inline mr-1"></i> Sonraki Kan KontrolÃ¼ (INR)</h4>
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p id="uzmanNextTestText" class="text-sm text-blue-900 font-semibold">...</p>
                                        <p id="uzmanNextTestDate" class="text-lg font-bold text-blue-700 mt-1">...</p>
                                    </div>
                                    <div class="text-right">
                                        <span id="uzmanNextTestDays"
                                            class="text-3xl font-extrabold text-blue-800">-</span>
                                        <span class="text-sm text-blue-600 font-medium">gÃ¼n sonra</span>
                                    </div>
                                </div>
                                <p id="uzmanNextTestReason" class="text-xs text-blue-600 mt-2 italic"></p>
                            </div>

                            <!-- Daily Distribution -->
                            <div class="mt-4">
                                <h4 class="text-sm font-bold text-slate-700 mb-2 border-b border-slate-100 pb-1">
                                    Ã–nerilen GÃ¼nlÃ¼k DaÄŸÄ±lÄ±m</h4>
                                <div id="uzmanPillSchedule" class="grid grid-cols-7 gap-1 text-center text-xs"></div>

                                <div id="uzmanScheduleSummary"
                                    class="mt-3 bg-cyan-50 p-3 rounded-lg border border-cyan-100 text-center text-sm font-semibold text-cyan-800">
                                </div>

                                <p class="text-[10px] text-slate-400 text-center mt-2 italic">* DaÄŸÄ±lÄ±m 5mg tablet
                                    Ã¼zerinden yapÄ±lmÄ±ÅŸtÄ±r.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reference Table -->
                <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm mt-6">
                    <h3 class="text-lg font-bold text-slate-700 mb-4 border-b pb-2">HassaslaÅŸtÄ±rÄ±lmÄ±ÅŸ ReÃ§ete AlgoritmasÄ±
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr>
                                    <th class="px-4 py-3 rounded-l-lg">INR AralÄ±ÄŸÄ±</th>
                                    <th class="px-4 py-3">Risk Durumu</th>
                                    <th class="px-4 py-3 rounded-r-lg">Doz DeÄŸiÅŸimi & Aksiyon</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b">
                                    <td class="px-4 py-2 font-bold text-red-700">0 - 1.49</td>
                                    <td class="px-4 py-2">Kritik DÃ¼ÅŸÃ¼k</td>
                                    <td class="px-4 py-2 text-red-700 font-bold">%20 ArtÄ±r</td>
                                </tr>
                                <tr class="border-b bg-slate-50">
                                    <td class="px-4 py-2 font-bold text-orange-600">1.50 - 1.99</td>
                                    <td class="px-4 py-2">DÃ¼ÅŸÃ¼k</td>
                                    <td class="px-4 py-2 text-orange-600 font-bold">%10 ArtÄ±r</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="px-4 py-2 font-bold text-green-600">2.00 - 3.00</td>
                                    <td class="px-4 py-2">HEDEF ARALIK</td>
                                    <td class="px-4 py-2 text-green-700 font-bold">Doz DeÄŸiÅŸmez</td>
                                </tr>
                                <tr class="border-b bg-slate-50">
                                    <td class="px-4 py-2 font-bold text-yellow-600">3.01 - 3.60</td>
                                    <td class="px-4 py-2">Hafif YÃ¼ksek</td>
                                    <td class="px-4 py-2 text-yellow-600 font-bold">%10 Azalt</td>
                                </tr>
                                <tr class="border-b">
                                    <td class="px-4 py-2 font-bold text-orange-600">3.61 - 4.20</td>
                                    <td class="px-4 py-2">Orta YÃ¼ksek</td>
                                    <td class="px-4 py-2 text-orange-600 font-bold">%15 Azalt + 1 GÃ¼n Atla</td>
                                </tr>
                                <tr class="border-b bg-slate-50">
                                    <td class="px-4 py-2 font-bold text-red-600">4.21 - 5.00</td>
                                    <td class="px-4 py-2">Riskli YÃ¼ksek</td>
                                    <td class="px-4 py-2 text-red-600 font-bold">%20-25 Azalt + 2 GÃ¼n Atla</td>
                                </tr>
                                <tr>
                                    <td class="px-4 py-2 font-bold text-red-800">&gt; 5.00</td>
                                    <td class="px-4 py-2">TOKSÄ°K</td>
                                    <td class="px-4 py-2 text-red-800 font-bold">Ä°lacÄ± Kes / Doktora Git</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-puantaj" class="tab-content hidden h-full">
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-full min-h-[700px]">

            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl sticky top-0 z-20">
                <h2 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
                    <i data-lucide="calculator" class="w-6 h-6 text-indigo-600"></i> AylÄ±k Personel PuantajÄ±
                </h2>

                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-3 text-xs font-bold text-gray-500 mr-4">
                        <span class="flex items-center"><span
                                class="w-3 h-3 bg-green-100 border border-green-300 rounded mr-1"></span> 8 Saat
                            (Mesai)</span>
                        <span class="flex items-center"><span
                                class="w-3 h-3 bg-red-100 border border-red-300 rounded mr-1"></span> Rapor (R)</span>
                        <span class="flex items-center"><span
                                class="w-3 h-3 bg-orange-100 border border-orange-300 rounded mr-1"></span> Ä°zin
                            (Ä°)</span>
                    </div>

                    <div class="flex items-center bg-white border rounded-lg shadow-sm">
                        <button onclick="changePuantajMonth(-1)"
                            class="p-2 hover:bg-gray-100 rounded-l-lg text-indigo-600 transition"><i
                                data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <span id="puantaj-period-display"
                            class="px-4 font-bold text-indigo-900 w-40 text-center select-none uppercase tracking-wide">...</span>
                        <button onclick="changePuantajMonth(1)"
                            class="p-2 hover:bg-gray-100 rounded-r-lg text-indigo-600 transition"><i
                                data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>

                    <button onclick="downloadPuantajExcel()"
                        class="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-bold shadow-sm">
                        <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel
                    </button>
                </div>
            </div>

            <div class="flex-grow overflow-auto custom-scrollbar p-0">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs sticky top-0 z-10 shadow-sm"
                        id="puantaj-head">
                    </thead>
                    <tbody id="puantaj-body" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="note-read-modal"
        class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col modal-enter">
            <div class="p-4 border-b flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-yellow-800 flex items-center">
                    <i data-lucide="sticky-note" class="w-5 h-5 mr-2"></i> GÃ¼nÃ¼n Notu
                </h3>
                <button class="close-note-modal text-gray-400 hover:text-red-500"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <p id="note-read-date" class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider"></p>
                <p id="note-read-content" class="text-sm text-gray-700 leading-relaxed whitespace-pre-line"></p>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button
                    class="close-note-modal px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium">Kapat</button>
            </div>
        </div>
    </div>

    <div id="ai-report-modal"
        class="fixed inset-0 bg-black/70 z-[90] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col modal-enter border border-indigo-200">
            <div
                class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-indigo-50 to-purple-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-indigo-900 flex items-center">
                    <i data-lucide="bot" class="w-6 h-6 mr-3 text-purple-600"></i> AI Asistan & Analiz
                </h3>
                <button id="btn-close-ai-header" class="text-gray-400 hover:text-red-500"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>

            <div id="ai-chat-area" class="flex-grow overflow-y-auto p-6 bg-gray-50 space-y-4 text-sm text-gray-800">
            </div>

            <div class="p-4 border-t bg-white rounded-b-2xl">
                <div
                    class="flex gap-2 items-center bg-white border border-gray-300 rounded-xl px-3 py-2 shadow-sm focus-within:ring-2 focus-within:ring-indigo-500 transition-all">
                    <div class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600">
                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                    </div>
                    <input type="text" id="ai-user-input"
                        class="flex-grow outline-none text-sm text-gray-700 placeholder-gray-400"
                        placeholder="Verilerle ilgili bir soru sorun... (Ã–rn: Bu hafta en Ã§ok kim Ã§alÄ±ÅŸtÄ±?)">
                    <button id="btn-send-ai-query"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg transition-colors">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="text-[10px] text-center text-gray-400 mt-2">Gemini 2.5 Flash tarafÄ±ndan desteklenmektedir.
                </div>
            </div>
        </div>
    </div>


    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter">
            <div class="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800">Ayarlar</h3>
                <button id="btn-close-settings" class="text-gray-400 hover:text-red-500"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">Google Gemini API AnahtarÄ±</label>
                <input type="password" id="api-key-input"
                    class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                    placeholder="AI-xxxxxxxxxxxxxxxxxxx">
                <p class="text-xs text-gray-500 mt-2">AnahtarÄ±nÄ±z sadece tarayÄ±cÄ±nÄ±zÄ±n yerel hafÄ±zasÄ±nda saklanÄ±r.</p>
            </div>
            <div class="p-5 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button id="btn-save-api-key"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">Kaydet</button>
            </div>
        </div>
    </div>
    <div id="fairness-modal"
        class="fixed inset-0 bg-black/70 z-[90] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col modal-enter border border-indigo-200">
            <div
                class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-purple-50 to-indigo-50 rounded-t-2xl">
                <div>
                    <h3 class="text-xl font-bold text-indigo-900 flex items-center">
                        <i data-lucide="scale" class="w-6 h-6 mr-3 text-purple-600"></i> NÃ¶bet Analiz Raporu
                    </h3>
                    <p class="text-xs text-gray-500 mt-1">Hafta sonu ve resmi tatil yoÄŸunluk analizi</p>
                </div>
                <button onclick="closeFairnessModal()"
                    class="text-gray-400 hover:text-red-500 bg-white rounded-full p-1 border hover:bg-red-50 transition"><i
                        data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="p-5 bg-gray-50 border-b flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Analiz BaÅŸlangÄ±Ã§</label>
                    <input type="date" id="fair-start"
                        class="p-2 border rounded-lg text-sm shadow-sm focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Analiz BitiÅŸ</label>
                    <input type="date" id="fair-end"
                        class="p-2 border rounded-lg text-sm shadow-sm focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <button onclick="calculateFairness()"
                    class="px-5 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition shadow-md flex items-center gap-2">
                    <i data-lucide="calculator" class="w-4 h-4"></i> Hesapla
                </button>
            </div>

            <div class="flex-grow overflow-y-auto p-0">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0 z-10 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 font-extrabold border-b">Personel</th>
                            <th class="px-6 py-3 text-center border-b">Toplam NÃ¶bet</th>
                            <th class="px-6 py-3 text-center text-orange-600 bg-orange-50 border-b">Hafta Sonu</th>
                            <th class="px-6 py-3 text-center text-blue-600 bg-blue-50 border-b">Hafta Ä°Ã§i</th>
                            <th class="px-6 py-3 text-center border-b">Analiz Durumu</th>
                        </tr>
                    </thead>
                    <tbody id="fairness-body" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="5" class="p-10 text-center text-gray-400 italic">Tarih seÃ§ip "Hesapla" butonuna
                                basÄ±n.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="p-4 border-t bg-gray-50 text-[10px] text-gray-500 flex justify-end items-center rounded-b-2xl">
                <button onclick="printFairnessReport()"
                    class="text-indigo-600 font-bold hover:underline flex items-center gap-1">
                    <i data-lucide="printer" class="w-3 h-3"></i> Tabloyu YazdÄ±r
                </button>
            </div>
        </div>
    </div>

    <div id="change-pw-modal" class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col modal-enter">
            <div class="p-5 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-blue-800">Åifre DeÄŸiÅŸtir</h3>
                <button id="btn-close-pw" class="text-gray-400 hover:text-red-500"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-3">
                <input type="password" id="old-pw" class="w-full p-2 border rounded text-sm" placeholder="Eski Åifre">
                <input type="password" id="new-pw" class="w-full p-2 border rounded text-sm" placeholder="Yeni Åifre">
                <input type="password" id="new-pw-confirm" class="w-full p-2 border rounded text-sm"
                    placeholder="Yeni Åifre (Tekrar)">
                <p id="change-pw-error" class="text-xs text-red-500 hidden font-bold"></p>
            </div>
            <div class="p-5 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button id="btn-save-pw"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">DeÄŸiÅŸtir</button>
            </div>
        </div>
    </div>

    <div id="data-entry-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-[95%] max-h-[95vh] flex flex-col modal-enter">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800">Veri GiriÅŸi & Ekip Planlama</h3>
                <button class="close-modal text-gray-400 hover:text-red-500"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>

            <div class="p-5 overflow-y-auto flex-grow flex flex-col lg:flex-row gap-6">
                <div class="flex-grow lg:w-1/2">
                    <div class="mb-4 flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Tarih</label>
                            <input type="date" id="entry-date-picker"
                                class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-bold">
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded p-1 border border-gray-200">
                        <div
                            class="flex items-center px-2 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider bg-gray-100 rounded mb-1">
                            <span class="w-32">Personel</span>
                            <div class="flex-1 grid grid-cols-2 gap-1 text-center">
                                <div class="bg-gray-200 text-gray-600 rounded-l p-1">Ã–ÄŸleden Ã–nce</div>
                                <div class="bg-gray-300 text-gray-700 rounded-r p-1">Ã–ÄŸleden Sonra</div>
                            </div>
                            <span class="w-10 text-center text-red-600">Muay.</span>
                            <span class="w-16 text-center text-blue-600">Uzman</span>
                        </div>

                        <div
                            class="flex items-center px-2 py-1 text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-2">
                            <span class="w-32"></span>
                            <div class="flex-1 grid grid-cols-4 gap-1 text-center">
                                <span class="bg-gray-50 p-1">Merkez</span><span class="bg-gray-50 p-1">KÃ¶y</span>
                                <span class="bg-gray-100 p-1">Merkez</span><span class="bg-gray-100 p-1">KÃ¶y</span>
                            </div>
                            <span class="w-10"></span>
                            <span class="w-16"></span>
                        </div>

                        <div id="modal-staff-list" class="space-y-2"></div>
                    </div>
                </div>

                <div class="lg:w-1/4 flex flex-col gap-4">
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100">
                        <label class="block text-xs font-bold text-yellow-800 mb-2 flex items-center"><i
                                data-lucide="sticky-note" class="w-4 h-4 mr-1"></i> GÃ¼nÃ¼n Notu</label>
                        <textarea id="daily-note"
                            class="w-full h-20 p-2 border border-yellow-200 rounded text-sm focus:ring-2 focus:ring-yellow-500 bg-white resize-none"></textarea>
                    </div>

                    <div
                        class="bg-blue-50 rounded-xl border border-blue-200 p-3 flex-grow overflow-y-auto min-h-[200px]">
                        <h4 class="text-xs font-bold text-blue-900 uppercase mb-2 flex items-center"><i
                                data-lucide="stethoscope" class="w-4 h-4 mr-1"></i> Doktor Ä°ÅŸlemleri</h4>
                        <div id="modal-doctor-list" class="space-y-3"></div>
                    </div>
                </div>

                <div class="lg:w-1/4 flex flex-col gap-4">
                    <div
                        class="bg-indigo-50 rounded-xl border border-indigo-200 p-3 flex-grow overflow-y-auto min-h-[300px]">
                        <h4 class="text-xs font-bold text-indigo-900 uppercase mb-2 flex items-center">
                            <i data-lucide="users" class="w-4 h-4 mr-1"></i> Ekip / Liste EÅŸleÅŸtirme
                        </h4>
                        <p class="text-[10px] text-indigo-600 mb-3 leading-tight">AÅŸaÄŸÄ±daki listelere personel atamasÄ±
                            yapmak iÃ§in isimleri iÅŸaretleyin.</p>

                        <div id="modal-team-list" class="space-y-3"></div>
                    </div>
                </div>

            </div>

            <div class="p-4 border-t bg-white rounded-b-xl flex justify-end gap-2">
                <button
                    class="close-modal px-4 py-2 rounded border border-gray-200 text-gray-600 text-sm hover:bg-gray-50">Ä°ptal</button>
                <button id="save-entry-btn"
                    class="px-4 py-2 rounded bg-indigo-600 text-white text-sm font-bold shadow hover:bg-indigo-700">Kaydet</button>
            </div>
        </div>
    </div>

    <div id="staff-modal"
        class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[85vh] flex flex-col modal-enter">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800">YÃ¶netim Paneli</h3>
                <button class="close-staff-modal text-gray-400 hover:text-red-500"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
                    <h4 class="font-bold text-sm text-gray-700 mb-2">Personel Listesi</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-staff-name" placeholder="Ad Soyad"
                            class="w-1/2 p-2 border rounded text-xs">
                        <input type="text" id="new-staff-role" placeholder="Ãœnvan"
                            class="w-1/2 p-2 border rounded text-xs">
                        <button id="add-staff-btn"
                            class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 transition"><i
                                data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="staff-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
                </div>
                <div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
                    <h4 class="font-bold text-sm text-gray-700 mb-2">Doktor ve Ek</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-doctor-name" placeholder="Manuel Ä°sim Ekle"
                            class="flex-1 p-2 border rounded text-xs">
                        <button id="add-doctor-btn"
                            class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700 transition"><i
                                data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="doctor-management-list"
                        class="space-y-1 max-h-40 overflow-y-auto mb-2 border-b border-gray-100 pb-2"></div>
                    <h5 class="font-bold text-xs text-gray-500 uppercase mb-1">HÄ±zlÄ± Ekle</h5>
                    <div class="flex gap-2 mb-1">
                        <input type="text" id="new-quick-name" placeholder="Ä°sim Ekle"
                            class="flex-1 p-1 border rounded text-xs">
                        <button onclick="addQuickItem()"
                            class="bg-teal-600 text-white px-2 rounded hover:bg-teal-700 transition"><i
                                data-lucide="plus" class="w-3 h-3"></i></button>
                    </div>
                    <div id="doctor-staff-selection-list"
                        class="space-y-1 h-32 overflow-y-auto bg-gray-50 p-2 rounded border border-gray-100"></div>
                </div>
                <div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
                    <h4 class="font-bold text-sm text-gray-700 mb-2">Uzman Listesi</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-spec-name" placeholder="UzmanlÄ±k"
                            class="flex-1 p-2 border rounded text-xs">
                        <button id="add-spec-btn"
                            class="bg-purple-600 text-white px-3 rounded hover:bg-purple-700 transition"><i
                                data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="spec-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
                </div>
                <div class="border-b md:border-b-0 md:border-r border-gray-200 pb-4 md:pb-0 pr-0 md:pr-4">
                    <h4 class="font-bold text-sm text-gray-700 mb-2">Ä°ÅŸlem Listesi</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-proc-name" placeholder="Ä°ÅŸlem AdÄ±"
                            class="flex-1 p-2 border rounded text-xs">
                        <button id="add-proc-btn"
                            class="bg-green-600 text-white px-3 rounded hover:bg-green-700 transition"><i
                                data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="proc-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
                </div>
                <div>
                    <h4 class="font-bold text-sm text-indigo-700 mb-2">Ekip / Liste TanÄ±mlarÄ±</h4>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-team-name" placeholder="Liste AdÄ± (Ã–rn: Mavi Ekip)"
                            class="flex-1 p-2 border rounded text-xs">
                        <button id="add-team-btn"
                            class="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 transition"><i
                                data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div id="team-management-list" class="space-y-1 h-64 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="password-modal" class="fixed inset-0 bg-black/80 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs text-center">
            <h3 class="text-lg font-bold mb-1 text-gray-800">GÃ¼venlik</h3>
            <input type="password" id="password-input"
                class="w-full p-2 border rounded mb-4 text-center text-xl tracking-widest outline-none"
                placeholder="â€¢â€¢â€¢â€¢">
            <div class="grid grid-cols-2 gap-2">
                <button id="modal-cancel"
                    class="py-2 bg-gray-100 text-gray-600 rounded text-sm font-medium">Ä°ptal</button>
                <button id="modal-submit" class="py-2 bg-indigo-600 text-white rounded text-sm font-bold">GiriÅŸ</button>
            </div>
            <p id="password-error" class="text-red-500 text-xs mt-2 hidden">HatalÄ± parola!</p>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-[70] flex items-center text-sm font-medium">
        <span id="toast-msg">Ä°ÅŸlem BaÅŸarÄ±lÄ±</span>
    </div>

    <div id="copy-bag-modal"
        class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm flex flex-col modal-enter">
            <div class="p-4 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-indigo-900 flex items-center">
                    <i data-lucide="copy" class="w-5 h-5 mr-2"></i> Kopyala
                </h3>
                <button onclick="closeCopyModal()" class="text-gray-400 hover:text-red-500"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-5">
                <p class="text-sm text-gray-600 mb-3">SeÃ§ilen malzemeler hangi Ã§antalara kopyalansÄ±n?</p>
                <div id="copy-target-list" class="space-y-2 max-h-48 overflow-y-auto border rounded-lg p-2 bg-gray-50">
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button onclick="closeCopyModal()"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Ä°ptal</button>
                <button onclick="performCopy()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 shadow-sm">
                    Kopyala
                </button>
            </div>
        </div>
    </div>
    <script>
        // Ä°NR DOZ HESAPLAMA - DOÄAL DÄ°L AYRIÅTIRMA
        let currentWeeklyDose = 35; // VarsayÄ±lan 7*5=35 mg/hafta

        // HaftalÄ±k kullanÄ±mÄ± doÄŸal dilden ayrÄ±ÅŸtÄ±r - GLOBAL
        window.parseWeeklyUsage = function () {
            const tabletMg = parseFloat(document.getElementById('inr-tablet-mg')?.value) || 5;
            const usageText = document.getElementById('inr-weekly-usage')?.value?.toLowerCase().trim() || '';

            let weeklyTotal = 0;

            if (!usageText) {
                // BoÅŸsa varsayÄ±lan gÃ¼nde 1 tablet
                weeklyTotal = tabletMg * 7;
            } else {
                // DoÄŸal dil ayrÄ±ÅŸtÄ±rma
                weeklyTotal = parseNaturalLanguageDose(usageText, tabletMg);
            }

            currentWeeklyDose = weeklyTotal;

            // SonuÃ§larÄ± gÃ¼ncelle
            const totalEl = document.getElementById('inr-total-weekly');
            const avgEl = document.getElementById('inr-daily-avg');
            if (totalEl) totalEl.textContent = weeklyTotal.toFixed(1);
            if (avgEl) avgEl.textContent = (weeklyTotal / 7).toFixed(1);

            // Mevcut INR deÄŸerine gÃ¶re yeni doz hesapla
            const currentINR = parseFloat(document.getElementById('inr-current-value')?.value) || 2.5;
            // tabletMg zaten yukarÄ±da tanÄ±mlandÄ±, aynÄ± deÄŸeri kullanÄ±yoruz

            // INR'ye gÃ¶re doz Ã§arpanÄ± belirle
            let multiplier = 1.0;
            let recommendation = '';
            if (currentINR < 1) {
                multiplier = 1.5;
                recommendation = 'INR Ã§ok dÃ¼ÅŸÃ¼k - %50 doz artÄ±ÅŸÄ± Ã¶neriliyor';
            } else if (currentINR < 2) {
                multiplier = 1.2;
                recommendation = 'INR dÃ¼ÅŸÃ¼k - %20 doz artÄ±ÅŸÄ± Ã¶neriliyor';
            } else if (currentINR <= 3) {
                multiplier = 1.0;
                recommendation = 'INR hedefte - Mevcut dozu koruyun';
            } else if (currentINR <= 4) {
                multiplier = 0.8;
                recommendation = 'INR yÃ¼ksek - %20 doz azaltmasÄ± Ã¶neriliyor';
            } else {
                multiplier = 0;
                recommendation = 'âš ï¸ INR > 4 - Warfarin kesilmeli, doktora baÅŸvurun!';
            }

            const newWeeklyDose = weeklyTotal * multiplier;

            // SonuÃ§ tablosunu doldur
            updateResultTable(newWeeklyDose, tabletMg, recommendation);

            // INR doz hesaplamalarÄ±nÄ± gÃ¼ncelle
            calculateINRDose();

            // Toast mesajÄ± gÃ¶ster
            if (typeof showToast === 'function') {
                showToast('âœ… Doz hesaplandÄ±: ' + newWeeklyDose.toFixed(1) + ' mg/hafta', 'success');
            }

            // Lucide ikonlarÄ±nÄ± gÃ¼ncelle
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // SonuÃ§ tablosunu gÃ¼ncelle
        function updateResultTable(weeklyDose, tabletMg, recommendation) {
            const tableContainer = document.getElementById('inr-result-table');
            const tbody = document.getElementById('inr-result-tbody');
            const totalEl = document.getElementById('inr-result-total');

            if (!tableContainer || !tbody) return;

            // Tabloyu gÃ¶ster
            tableContainer.classList.remove('hidden');

            // DaÄŸÄ±lÄ±mÄ± hesapla - haftalÄ±k toplam tablet sayÄ±sÄ±
            let doseBreakdown = [];

            if (weeklyDose <= 0) {
                doseBreakdown = [{ days: 7, dose: 0, label: 'KullanmayÄ±n' }];
            } else {
                // HaftalÄ±k toplam tablet sayÄ±sÄ±nÄ± hesapla (0.25 hassasiyetinde)
                const weeklyTablets = weeklyDose / tabletMg;

                // MÃ¼mkÃ¼n olan doz seviyeleri (tablet cinsinden)
                const doseLevels = [
                    { tablets: 2, label: '2 tablet' },
                    { tablets: 1.5, label: '1Â½ tablet' },
                    { tablets: 1, label: '1 tablet (tam)' },
                    { tablets: 0.5, label: 'Â½ tablet (yarÄ±m)' },
                    { tablets: 0.25, label: 'Â¼ tablet (Ã§eyrek)' },
                    { tablets: 0, label: 'BoÅŸ (kullanmayÄ±n)' }
                ];

                // Greedy algoritma ile en uygun daÄŸÄ±lÄ±mÄ± bul
                let remainingTablets = weeklyTablets;
                let remainingDays = 7;

                for (var i = 0; i < doseLevels.length && remainingDays > 0; i++) {
                    var level = doseLevels[i];
                    if (level.tablets === 0) {
                        // Kalan gÃ¼nleri boÅŸ olarak ekle
                        if (remainingDays > 0) {
                            doseBreakdown.push({
                                days: remainingDays,
                                dose: 0,
                                label: level.label
                            });
                            remainingDays = 0;
                        }
                    } else if (remainingTablets >= level.tablets) {
                        // Bu seviyede kaÃ§ gÃ¼n kullanÄ±labilir?
                        var daysAtThisLevel = Math.floor(remainingTablets / level.tablets);
                        daysAtThisLevel = Math.min(daysAtThisLevel, remainingDays);

                        if (daysAtThisLevel > 0) {
                            doseBreakdown.push({
                                days: daysAtThisLevel,
                                dose: level.tablets * tabletMg,
                                label: level.label
                            });
                            remainingTablets -= daysAtThisLevel * level.tablets;
                            remainingDays -= daysAtThisLevel;
                        }
                    }
                }

                // Kalan gÃ¼nler varsa boÅŸ olarak ekle
                if (remainingDays > 0) {
                    doseBreakdown.push({
                        days: remainingDays,
                        dose: 0,
                        label: 'BoÅŸ (kullanmayÄ±n)'
                    });
                }
            }

            // Tabloyu doldur
            var calculatedTotal = 0;
            tbody.innerHTML = doseBreakdown.map(function (item) {
                var subtotal = item.days * item.dose;
                calculatedTotal += subtotal;
                return '<tr class="bg-white hover:bg-green-50">' +
                    '<td class="px-3 py-2 font-bold text-green-800">' + item.days + ' gÃ¼n</td>' +
                    '<td class="px-3 py-2 text-center">' + item.dose.toFixed(1) + ' mg</td>' +
                    '<td class="px-3 py-2 text-center font-semibold">' + item.label + '</td>' +
                    '<td class="px-3 py-2 text-right font-bold">' + subtotal.toFixed(1) + ' mg</td>' +
                    '</tr>';
            }).join('');

            // Toplam gÃ¼ncelle
            if (totalEl) {
                totalEl.textContent = calculatedTotal.toFixed(1) + ' mg';
            }

            // Ã–neri notu gÃ¼ncelle
            const noteP = tableContainer.querySelector('p.italic');
            if (noteP) {
                noteP.innerHTML = 'ğŸ’Š <strong>' + recommendation + '</strong>';
            }
        }

        // DoÄŸal dil ayrÄ±ÅŸtÄ±rÄ±cÄ±
        function parseNaturalLanguageDose(text, tabletMg) {
            let total = 0;
            let totalDays = 0;

            // TÃ¼rkÃ§e sayÄ± kelimeleri
            const numberWords = {
                'bir': 1, 'iki': 2, 'Ã¼Ã§': 3, 'dÃ¶rt': 4, 'beÅŸ': 5,
                'altÄ±': 6, 'yedi': 7, 'sekiz': 8, 'dokuz': 9, 'on': 10
            };

            // Miktar kelimeleri (tablet cinsinden)
            const amountWords = {
                'yarÄ±m': 0.5, 'buÃ§uk': 0.5, 'Ã§eyrek': 0.25,
                'tam': 1, 'bir': 1, '1': 1, 'tek': 1,
                '0.5': 0.5, '0,5': 0.5, '1/2': 0.5,
                '1.5': 1.5, '1,5': 1.5, 'birbuÃ§uk': 1.5,
                '2': 2, 'iki': 2, 'Ã§ift': 2,
                // BoÅŸ/kullanmayan gÃ¼nler
                'boÅŸ': 0, 'yok': 0, 'almadÄ±': 0, 'almadi': 0, 'kullanmadÄ±': 0,
                'kullanmadi': 0, 'hiÃ§': 0, 'hic': 0, '0': 0, 'sÄ±fÄ±r': 0, 'sifir': 0
            };

            // HergÃ¼n/gÃ¼nde kalÄ±plarÄ±
            if (text.match(/herg[Ã¼u]n|g[Ã¼u]nde|her\s*g[Ã¼u]n/)) {
                // "hergÃ¼n yarÄ±m", "gÃ¼nde 1 tablet" vb.
                let amount = 1;

                for (const [word, val] of Object.entries(amountWords)) {
                    if (text.includes(word)) {
                        amount = val;
                        break;
                    }
                }

                // SayÄ± kontrolÃ¼
                const numMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(tablet|tb|mg)?/);
                if (numMatch) {
                    const num = parseFloat(numMatch[1].replace(',', '.'));
                    if (numMatch[2] === 'mg') {
                        return num * 7; // Direkt mg olarak girilmiÅŸ
                    }
                    amount = num;
                }

                return amount * tabletMg * 7;
            }

            // GÃ¼n bazlÄ± kalÄ±plar: "4 gÃ¼n yarÄ±m 3 gÃ¼n tam", "2 gÃ¼n boÅŸ 5 gÃ¼n yarÄ±m"
            // GeniÅŸletilmiÅŸ regex - boÅŸ/yok/almadÄ± da yakalasÄ±n
            let regex = /(\d+)\s*g[Ã¼u]n\s*(yar[Ä±i]m|tam|buÃ§uk|Ã§eyrek|bo[ÅŸs]|yok|almad[Ä±i]|kullanmad[Ä±i]|hi[Ã§c]|s[Ä±i]f[Ä±i]r|[\d.,]+)/gi;
            let match;

            while ((match = regex.exec(text)) !== null) {
                const days = parseInt(match[1]);
                let amount = 1;

                const amountText = match[2].toLowerCase();

                // BoÅŸ/yok kontrolÃ¼
                if (amountText.match(/bo[ÅŸs]|yok|almad|kullanmad|hi[Ã§c]|s[Ä±i]f[Ä±i]r/)) {
                    amount = 0;
                } else if (amountText === 'yarÄ±m' || amountText === 'yarim') {
                    amount = 0.5;
                } else if (amountText === 'tam') {
                    amount = 1;
                } else if (amountText === 'buÃ§uk') {
                    amount = 0.5;
                } else if (amountText === 'Ã§eyrek') {
                    amount = 0.25;
                } else {
                    const parsedNum = parseFloat(amountText.replace(',', '.'));
                    if (!isNaN(parsedNum)) amount = parsedNum;
                }

                total += days * amount * tabletMg;
                totalDays += days;
            }

            // EÄŸer pattern bulunduysa ve toplam gÃ¼n 7 ise, hesaplamayÄ± dÃ¶ndÃ¼r
            if (totalDays > 0) {
                return total;
            }

            // EÄŸer pattern bulunamadÄ±ysa, basit sayÄ± ara
            const simpleMatch = text.match(/(\d+(?:[.,]\d+)?)/);
            if (simpleMatch) {
                const num = parseFloat(simpleMatch[1].replace(',', '.'));
                // EÄŸer bÃ¼yÃ¼k bir sayÄ±ysa (>10) muhtemelen haftalÄ±k mg
                if (num > 10) {
                    return num; // Direkt haftalÄ±k mg olarak kabul et
                }
                // Aksi halde gÃ¼nlÃ¼k tablet
                return num * tabletMg * 7;
            }

            // VarsayÄ±lan
            return tabletMg * 7;
        }

        // Ä°NR DOZ HESAPLAMA FONKSÄ°YONU
        function calculateINRDose() {
            const weeklyBase = currentWeeklyDose || 35;

            // Her INR aralÄ±ÄŸÄ± iÃ§in Ã§arpanlar (haftalÄ±k toplam iÃ§in)
            const multipliers = {
                '0-1': 1.5,   // %50 artÄ±ÅŸ (INR Ã§ok dÃ¼ÅŸÃ¼k, doz artÄ±ÅŸÄ± gerekli)
                '1-2': 1.2,   // %20 artÄ±ÅŸ (INR dÃ¼ÅŸÃ¼k)
                '2-3': 1.0,   // AynÄ± doz (hedef aralÄ±kta)
                '3-4': 0.8    // %20 azaltma (INR yÃ¼ksek)
            };

            // HaftalÄ±k dozlarÄ± hesapla
            Object.keys(multipliers).forEach(range => {
                const weeklyTotal = (weeklyBase * multipliers[range]).toFixed(1);
                const dailyAvg = (weeklyTotal / 7).toFixed(1);

                // GÃ¼nlÃ¼k daÄŸÄ±lÄ±mÄ± oluÅŸtur (gerÃ§ekÃ§i daÄŸÄ±lÄ±m)
                const distributions = generateDoseDistribution(parseFloat(weeklyTotal));

                // DOM gÃ¼ncelle
                const container = document.getElementById(`inr-dose-${range.replace('-', '-')}`);
                if (container) {
                    const daySpans = container.querySelectorAll('.inr-day-dose');
                    daySpans.forEach((span, idx) => {
                        span.textContent = distributions[idx] + ' mg';
                    });
                }

                const weeklySpan = document.getElementById(`inr-weekly-${range.replace('-', '-')}`);
                if (weeklySpan) {
                    weeklySpan.textContent = weeklyTotal;
                }
            });

            // Lucide ikonlarÄ±nÄ± gÃ¼ncelle
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // GerÃ§ekÃ§i gÃ¼nlÃ¼k daÄŸÄ±lÄ±m oluÅŸtur (hafta iÃ§i dalgalanma)
        function generateDoseDistribution(weeklyTotal) {
            const dailyAvg = weeklyTotal / 7;
            const distribution = [];

            // Warfarin genellikle 0.5 mg'lÄ±k tabletler halinde
            // BazÄ± gÃ¼nler daha yÃ¼ksek, bazÄ± gÃ¼nler daha dÃ¼ÅŸÃ¼k olabilir
            let remaining = weeklyTotal;

            for (let i = 0; i < 7; i++) {
                if (i === 6) {
                    // Son gÃ¼n kalanÄ± al
                    distribution.push(Math.round(remaining * 2) / 2);
                } else {
                    // Ortalamaya yakÄ±n ama Â±0.5 veya Â±1 mg deÄŸiÅŸkenlik
                    let dose = dailyAvg;
                    if (i % 2 === 0) {
                        dose = Math.ceil(dailyAvg * 2) / 2; // Yuvarlama yukarÄ±
                    } else {
                        dose = Math.floor(dailyAvg * 2) / 2; // Yuvarlama aÅŸaÄŸÄ±
                    }
                    dose = Math.max(0, dose); // Negatif olamaz
                    distribution.push(dose);
                    remaining -= dose;
                }
            }

            return distribution;
        }

        // Sayfa yÃ¼klendiÄŸinde hesapla
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(parseWeeklyUsage, 500);
        });

        // ============================================
        // UZMAN TIP - Ä°NR HESAPLAYICI FONKSÄ°YONLARI
        // ============================================

        function parsePrescriptionTextUzman() {
            var text = (document.getElementById('uzmanDoseText').value || '').toLocaleLowerCase('tr-TR');
            var totalDisplay = document.getElementById('uzmanTotalWeeklyMgDisplay');
            var hiddenInput = document.getElementById('uzmanCurrentWeeklyDose');
            var statusDiv = document.getElementById('uzmanParseStatus');

            // Ã–n iÅŸleme
            text = text.replace(/(\d)\s+buÃ§uk/g, "$1.5");
            text = text.replace(/(^|\s)buÃ§uk(?=\s|$)/g, "$10.5");
            text = text.replace(/(\d),(\d)/g, "$1.$2");

            var numberMap = {
                'bir': 1, 'iki': 2, 'Ã¼Ã§': 3, 'dÃ¶rt': 4, 'beÅŸ': 5, 'altÄ±': 6, 'yedi': 7,
                'tek': 1, 'her': 7, 'bÃ¼tÃ¼n': 7, 'haftanÄ±n': 7
            };

            var doseKeywordMap = {
                'tam': 1.0, 'tÃ¼m': 1.0,
                'yarÄ±m': 0.5, 'yarÄ±': 0.5,
                'Ã§eyrek': 0.25,
                'boÅŸ': 0, 'yok': 0, 'iÃ§miyor': 0, 'almÄ±yor': 0, 'pas': 0
            };

            var totalMg = 0;
            var totalDays = 0;
            var parsedHtml = [];

            var freqPart = "(?:\\d+(?:\\.\\d+)?|bir|iki|Ã¼Ã§|dÃ¶rt|beÅŸ|altÄ±|yedi|tek|her|bÃ¼tÃ¼n|haftanÄ±n)";
            var separator = "\\s*(?:gÃ¼n|tane|kere|defa|kez)?\\s*";
            var dosePart = "(?:\\d+(?:\\.\\d+)?|tam|tÃ¼m|yarÄ±m|yarÄ±|Ã§eyrek|boÅŸ|yok|iÃ§miyor|almÄ±yor|pas)";

            var regex = new RegExp("(" + freqPart + ")" + separator + "(" + dosePart + ")", 'g');

            var match;
            while ((match = regex.exec(text)) !== null) {
                var freqRaw = match[1];
                var doseRaw = match[2];

                var days = parseFloat(freqRaw);
                if (isNaN(days)) {
                    days = numberMap[freqRaw] || 0;
                }

                var tabletCount = parseFloat(doseRaw);
                if (isNaN(tabletCount)) {
                    tabletCount = doseKeywordMap[doseRaw];
                    if (tabletCount === undefined) tabletCount = 0;
                }

                var mg = tabletCount * 5;

                if (days > 0) {
                    var subTotal = days * mg;
                    totalMg += subTotal;
                    totalDays += days;

                    var displayDose = isNaN(parseFloat(doseRaw)) ? doseRaw : tabletCount + ' tablet';

                    parsedHtml.push('<div class="flex justify-between border-b border-slate-200 pb-1 last:border-0"><span><span class="font-bold text-slate-700">' + days + ' gÃ¼n</span> ' + displayDose + '</span><span class="text-slate-500 text-xs">(' + days + ' x ' + mg + 'mg = ' + subTotal + 'mg)</span></div>');
                }
            }

            if (totalDisplay) totalDisplay.innerText = totalMg;
            if (hiddenInput) hiddenInput.value = totalMg;

            if (parsedHtml.length > 0 && statusDiv) {
                statusDiv.classList.remove('hidden');
                var dayWarning = "";

                if (totalDays > 7) {
                    dayWarning = '<div class="mt-2 text-red-600 text-xs font-bold border-t border-red-200 pt-1">âš ï¸ UyarÄ±: Toplam ' + totalDays + ' gÃ¼n girildi. Hafta 7 gÃ¼ndÃ¼r.</div>';
                } else if (totalDays < 7 && totalDays > 0) {
                    dayWarning = '<div class="mt-2 text-orange-600 text-xs font-bold border-t border-orange-200 pt-1">â„¹ï¸ UyarÄ±: ' + totalDays + ' gÃ¼n girildi. Kalan gÃ¼nler boÅŸ mu?</div>';
                } else if (totalDays === 7) {
                    dayWarning = '<div class="mt-2 text-green-700 text-xs font-bold border-t border-green-200 pt-1">âœ… Tam hafta (7 gÃ¼n) algÄ±landÄ±.</div>';
                }

                statusDiv.innerHTML = '<div class="mb-1 text-xs font-bold text-slate-400 uppercase">AlgÄ±lanan ReÃ§ete</div><div class="space-y-1">' + parsedHtml.join('') + '</div>' + dayWarning;
            } else if (statusDiv) {
                statusDiv.classList.add('hidden');
            }
        }

        function calculateDoseUzman() {
            var currentDose = parseFloat(document.getElementById('uzmanCurrentWeeklyDose').value) || 0;
            var inr = parseFloat(document.getElementById('uzmanCurrentINR').value);

            var emptyState = document.getElementById('uzmanEmptyState');
            var resultsContent = document.getElementById('uzmanResultsContent');
            var resultCard = document.getElementById('uzmanResultCard');
            var displayOld = document.getElementById('uzmanDisplayOldDose');
            var displayNew = document.getElementById('uzmanDisplayNewDose');
            var statusBadge = document.getElementById('uzmanStatusBadge');
            var actionText = document.getElementById('uzmanActionText');

            if (isNaN(inr)) {
                alert("LÃ¼tfen geÃ§erli bir INR deÄŸeri giriniz.");
                return;
            }
            if (currentDose === 0) {
                if (!confirm("AlgÄ±lanan haftalÄ±k doz 0 mg. Hesaplamaya devam etmek istiyor musunuz?")) return;
            }

            if (emptyState) emptyState.classList.add('hidden');
            if (resultsContent) resultsContent.classList.remove('hidden');

            var newDose = currentDose;
            var status = "";
            var action = "";
            var badgeColor = "";

            if (inr >= 0 && inr <= 1.49) {
                newDose = currentDose * 1.20;
                status = "KRÄ°TÄ°K DÃœÅÃœK (<1.5)";
                badgeColor = "bg-red-100 text-red-800 border-red-200";
                if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-red-400 shadow-sm";
                action = "<strong>INR Ã§ok dÃ¼ÅŸÃ¼k.</strong> Kan yeterince sulanmamÄ±ÅŸ, pÄ±htÄ± riski var. HaftalÄ±k dozu <strong>%20 artÄ±rÄ±yoruz</strong>.";

            } else if (inr >= 1.50 && inr <= 1.99) {
                newDose = currentDose * 1.10;
                status = "DÃœÅÃœK (1.5-2.0)";
                badgeColor = "bg-orange-100 text-orange-800 border-orange-200";
                if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-orange-400 shadow-sm";
                action = "<strong>INR hedefin biraz altÄ±nda.</strong> KÃ¼Ã§Ã¼k bir destek gerekiyor. HaftalÄ±k dozu <strong>%10 artÄ±rÄ±yoruz</strong>.";

            } else if (inr >= 2.00 && inr <= 3.00) {
                newDose = currentDose;
                status = "HEDEF ARALIK";
                badgeColor = "bg-green-100 text-green-800 border-green-200";
                if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-green-400 shadow-sm";
                action = "<strong>MÃ¼kemmel.</strong> Tedavi tam kararÄ±nda iÅŸliyor. Doz deÄŸiÅŸtirmeden aynÄ± ÅŸekilde devam ediniz.";

            } else if (inr >= 3.01 && inr <= 3.60) {
                newDose = currentDose * 0.90;
                status = "HAFÄ°F YÃœKSEK (3.0-3.6)";
                badgeColor = "bg-yellow-100 text-yellow-800 border-yellow-200";
                if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-yellow-400 shadow-sm";
                action = "<strong>INR hafif yÃ¼ksek.</strong> Tedbir amaÃ§lÄ± hafif bir fren yapÄ±yoruz. HaftalÄ±k dozu <strong>%10 azaltÄ±yoruz</strong>.";

            } else if (inr >= 3.61 && inr <= 4.20) {
                newDose = currentDose * 0.85;
                status = "YÃœKSEK + DOZ ATLA";
                badgeColor = "bg-orange-100 text-orange-900 border-orange-200";
                if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-orange-500 shadow-sm";
                action = '<div class="mb-2 p-2 bg-red-100 border border-red-300 rounded text-red-800 font-bold">âš ï¸ DÄ°KKAT: Yeni doza baÅŸlamadan Ã¶nce BUGÃœN ilacÄ± ALMAYINIZ (1 GÃ¼n Pas).</div><p><strong>INR yÃ¼ksek seviyede.</strong> Kanama riskini dÃ¼ÅŸÃ¼rmek iÃ§in bugÃ¼n <strong>doz atlÄ±yoruz</strong>. YarÄ±ndan itibaren hesaplanan yeni doza (%15 azaltÄ±lmÄ±ÅŸ) baÅŸlayÄ±nÄ±z.</p>';

            } else if (inr >= 4.21 && inr <= 5.00) {
                newDose = currentDose * 0.75;
                status = "RÄ°SKLÄ° + 2 GÃœN ATLA";
                badgeColor = "bg-red-50 text-red-900 border-red-200";
                if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-red-500 shadow-sm";
                action = '<div class="mb-2 p-2 bg-red-100 border border-red-300 rounded text-red-800 font-bold">âš ï¸ DÄ°KKAT: Yeni doza baÅŸlamadan Ã¶nce BUGÃœN ve YARIN ilacÄ± ALMAYINIZ (2 GÃ¼n Pas).</div><p><strong>INR tehlikeli seviyeye yakÄ±n.</strong> Ciddi bir fren gerekiyor. 2 gÃ¼n ilaÃ§ almayÄ±p, sonraki gÃ¼n %25 azaltÄ±lmÄ±ÅŸ yeni doza baÅŸlayÄ±nÄ±z. Morluk takibi yapÄ±nÄ±z.</p>';

            } else if (inr > 5.00) {
                newDose = 0;
                status = "TOKSÄ°K (>5.0)";
                badgeColor = "bg-red-100 text-red-800 border-red-200";
                if (resultCard) resultCard.className = "bg-white rounded-xl p-6 border-2 border-red-600 shadow-sm";
                action = "<strong>INR Ã§ok yÃ¼ksek (>5.0).</strong> KANAMA RÄ°SKÄ°! <strong>Ä°lacÄ± derhal kesin</strong> ve doktorunuzla iletiÅŸime geÃ§in. K Vitamini gerekebilir.";
            }

            // Yuvarlama: 1.25mg'ye yuvarla (Ã‡eyrek tablet)
            if (inr <= 5.0) {
                newDose = Math.round(newDose / 1.25) * 1.25;
            }

            if (displayOld) displayOld.innerText = currentDose + " mg";
            if (displayNew) displayNew.innerText = inr > 5.0 ? "KESÄ°LDÄ°" : newDose + " mg";
            if (statusBadge) {
                statusBadge.innerText = status;
                statusBadge.className = 'px-3 py-1 rounded-full text-xs font-bold border ' + badgeColor;
            }
            if (actionText) actionText.innerHTML = action;

            // Sonraki Kan KontrolÃ¼ Hesaplama (ACCP/AHA KÄ±lavuzlarÄ±na gÃ¶re)
            var nextTestBox = document.getElementById('uzmanNextTestBox');
            var nextTestText = document.getElementById('uzmanNextTestText');
            var nextTestDate = document.getElementById('uzmanNextTestDate');
            var nextTestDays = document.getElementById('uzmanNextTestDays');
            var nextTestReason = document.getElementById('uzmanNextTestReason');

            var testDays = 7; // VarsayÄ±lan
            var testReason = "";

            // ACCP (American College of Chest Physicians) KÄ±lavuzuna gÃ¶re INR kontrol sÃ¼releri
            if (inr < 1.5) {
                testDays = 3; // Kritik dÃ¼ÅŸÃ¼k - Ã§ok sÄ±k kontrol
                testReason = "Kaynak: ACCP 2012 - Sub-terapÃ¶tik INR'de hÄ±zlÄ± yeniden deÄŸerlendirme Ã¶nerilir.";
            } else if (inr >= 1.5 && inr < 2.0) {
                testDays = 5; // DÃ¼ÅŸÃ¼k - sÄ±k kontrol
                testReason = "Kaynak: ACCP 2012 - Hedef altÄ± INR'de 1 hafta iÃ§inde kontrol Ã¶nerilir.";
            } else if (inr >= 2.0 && inr <= 3.0) {
                // Stabil ve hedef aralÄ±kta
                if (currentDose === newDose) {
                    testDays = 28; // 4 hafta - stabil hasta
                    testReason = "Kaynak: AHA/ACCP - Stabil INR'de 4 haftaya kadar aralÄ±k uzatÄ±labilir.";
                } else {
                    testDays = 7; // Doz deÄŸiÅŸikliÄŸi yoksa bile ilk kontrol
                    testReason = "Kaynak: ACCP 2012 - Hedef aralÄ±kta 1-2 hafta iÃ§inde doÄŸrulama Ã¶nerilir.";
                }
            } else if (inr > 3.0 && inr <= 3.6) {
                testDays = 5; // Hafif yÃ¼ksek - sÄ±k kontrol
                testReason = "Kaynak: ACCP 2012 - Hafif yÃ¼ksek INR'de 1 hafta iÃ§inde kontrol Ã¶nerilir.";
            } else if (inr > 3.6 && inr <= 4.2) {
                testDays = 3; // YÃ¼ksek - Ã§ok sÄ±k kontrol
                testReason = "Kaynak: ACCP 2012 - Doz atlama sonrasÄ± 2-3 gÃ¼n iÃ§inde kontrol Ã¶nerilir.";
            } else if (inr > 4.2 && inr <= 5.0) {
                testDays = 2; // Riskli yÃ¼ksek - gÃ¼nlÃ¼k takip gerekebilir
                testReason = "Kaynak: ACCP 2012 - INR > 4.5'ta sÄ±k kontrol, K vitamini deÄŸerlendirilmeli.";
            } else if (inr > 5.0) {
                testDays = 1; // Toksik - acil takip
                testReason = "Kaynak: ACCP 2012 - INR > 5'te gÃ¼nlÃ¼k takip, K vitamini ve doktor konsÃ¼ltasyonu gerekli.";
            }

            // Tarihi hesapla
            var today = new Date();
            var nextDate = new Date(today.getTime() + testDays * 24 * 60 * 60 * 1000);
            var dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            var formattedDate = nextDate.toLocaleDateString('tr-TR', dateOptions);

            if (nextTestBox) {
                nextTestBox.classList.remove('hidden');
                if (nextTestText) nextTestText.innerHTML = 'Ã–nerilen kontrol sÃ¼resi: <strong>' + testDays + ' gÃ¼n</strong>';
                if (nextTestDate) nextTestDate.textContent = formattedDate;
                if (nextTestDays) nextTestDays.textContent = testDays;
                if (nextTestReason) nextTestReason.textContent = testReason;
            }

            generateScheduleUzman(newDose);

            // Lucide ikonlarÄ±nÄ± gÃ¼ncelle
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function generateScheduleUzman(weeklyDose) {
            var container = document.getElementById('uzmanPillSchedule');
            var summaryContainer = document.getElementById('uzmanScheduleSummary');
            if (!container) return;

            container.innerHTML = "";
            if (summaryContainer) summaryContainer.innerHTML = "";

            if (weeklyDose === 0) {
                container.innerHTML = "<p class='col-span-7 text-center text-red-600 font-bold p-2 border border-red-200 bg-red-50 rounded'>BugÃ¼n Ä°laÃ§ AlÄ±mÄ±nÄ± Durdurun (PAS)</p>";
                if (summaryContainer) {
                    summaryContainer.innerHTML = "Ä°laÃ§ Kesilmeli";
                    summaryContainer.className = "mt-3 bg-red-50 p-3 rounded-lg border border-red-100 text-center text-sm font-bold text-red-800";
                }
                return;
            } else if (summaryContainer) {
                summaryContainer.className = "mt-3 bg-cyan-50 p-3 rounded-lg border border-cyan-100 text-center text-sm font-semibold text-cyan-800";
            }

            var dayNames = ["Pzt", "Sal", "Ã‡ar", "Per", "Cum", "Cmt", "Paz"];

            var totalQ = Math.round(weeklyDose / 1.25);
            var numQuarterDays = totalQ % 2;
            var remainingQ = totalQ - numQuarterDays;

            var daysAvailableForHalves = 7 - numQuarterDays;
            var halvesToDistribute = remainingQ / 2;

            var baseHalves = Math.floor(halvesToDistribute / daysAvailableForHalves);
            var extraHalves = halvesToDistribute % daysAvailableForHalves;

            var schedule = [0, 0, 0, 0, 0, 0, 0];

            for (var i = 0; i < numQuarterDays; i++) {
                schedule[6 - i] = 1.25;
            }

            for (var i = 0; i < daysAvailableForHalves; i++) {
                var dailyDose = baseHalves * 2.5;
                if (i < extraHalves) {
                    dailyDose += 2.5;
                }
                schedule[i] = dailyDose;
            }

            var counts = {};
            schedule.forEach(function (dose) {
                counts[dose] = (counts[dose] || 0) + 1;
            });

            var summaryParts = [];
            Object.keys(counts).sort(function (a, b) { return parseFloat(b) - parseFloat(a); }).forEach(function (doseVal) {
                var count = counts[doseVal];
                var dose = parseFloat(doseVal);
                var label = "";

                if (dose === 0) label = "BoÅŸ";
                else if (dose === 1.25) label = "Ã‡eyrek";
                else if (dose === 2.5) label = "YarÄ±m";
                else if (dose === 5) label = "Tam";
                else if (dose === 7.5) label = "1 Tam, 1 YarÄ±m";
                else if (dose === 10) label = "2 Tam";
                else label = dose + "mg";

                if (count > 0) {
                    summaryParts.push(count + ' gÃ¼n ' + label);
                }
            });

            if (summaryContainer) {
                summaryContainer.innerHTML = 'ğŸ“‹ Pratik Tarif: <strong>' + summaryParts.join(" + ") + '</strong>';
            }

            schedule.forEach(function (dose, index) {
                var pillText = "";
                var pillIcon = "";
                var pillClass = "text-cyan-800";

                if (dose === 0) { pillText = "BoÅŸ"; pillIcon = "ban"; pillClass = "text-slate-400"; }
                else if (dose === 5) { pillText = "1 Tam"; pillIcon = "circle"; }
                else if (dose === 2.5) { pillText = "YarÄ±m"; pillIcon = "circle-dot"; }
                else if (dose === 1.25) { pillText = "Ã‡eyrek"; pillIcon = "pie-chart"; }
                else if (dose === 7.5) { pillText = "1.5"; pillIcon = "pill"; }
                else if (dose === 10) { pillText = "2 Tam"; pillIcon = "pill"; }
                else { pillText = dose + " mg"; pillIcon = "pill"; }

                var dayDiv = document.createElement('div');
                dayDiv.className = "flex flex-col items-center bg-slate-50 p-2 rounded border border-slate-200 transition hover:bg-white hover:shadow-md hover:border-cyan-300";
                dayDiv.innerHTML = '<span class="font-bold text-slate-500 mb-1 text-[10px] uppercase tracking-wider">' + dayNames[index] + '</span><i data-lucide="' + pillIcon + '" class="w-5 h-5 ' + pillClass + ' mb-1"></i><span class="font-bold ' + pillClass + ' text-[10px] leading-tight text-center">' + pillText + '</span>';
                container.appendChild(dayDiv);
            });

            // Lucide ikonlarÄ±nÄ± gÃ¼ncelle
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        const LS_SHIFTS = 'evdeSaglikShifts_V19';
        let shiftList = [];
        const LS_DEVICES = 'evdeSaglikDevices_V1';
        let deviceList = [];
        let editingDeviceIndex = -1; // DÃ¼zenlenen cihazÄ±n sÄ±rasÄ±nÄ± tutacak
        let shiftCursorDate = new Date();
        const LS_DATA = 'evdeSaglikData_ULTIMATE_V18';
        const LS_STAFF = 'evdeSaglikStaff_ULTIMATE_V18';
        const LS_NOTES = 'evdeSaglikNotes_ULTIMATE_V18';
        const LS_API_KEY = 'evdeSaglikApiKey_V18';
        const LS_DOCTORS = 'evdeSaglikDoctors_V18';
        const LS_DOC_DATA = 'evdeSaglikDocData_V18';
        const LS_PROCS = 'evdeSaglikProcs_V18';
        const LS_APP_PASSWORD_ENC = 'evdeSaglikAppPW_Enc_V1';
        const LS_SPECIALISTS_LIST = 'evdeSaglikSpecList_V18';
        const LS_QUICK_LIST = 'evdeSaglikQuickList_V18';
        const LS_LEAVE_RECORDS = 'evdeSaglikLeaveRec_V18';
        const LS_TEAMS = 'evdeSaglikTeams_V19';
        const LS_ROUTINES = 'evdeSaglikRoutines_V19';
        const LS_BUDGET = 'evdeSaglikBudget_V19';
        const LS_EMERGENCY = 'evdeSaglikEmergency_V19';
        const LS_BAGS = 'evdeSaglikBags_V19';
        const LS_GENERAL_NOTES_LIST = 'evdeSaglikGenNotesList_V1';
        let generalNotesList = [];

        let appPassword = atob(localStorage.getItem(LS_APP_PASSWORD_ENC) || 'OTMwNjE4MA==');
        // --- YENÄ° EKLENENLER: Sekme Kilit AyarlarÄ± ---
        const LS_LOCKED_TABS_CONFIG = 'evdeSaglikLockedTabsConfig_V1';
        const LS_TAB_LOCK_PASS_CUSTOM = 'evdeSaglikTabLockPassCustom_V1';

        // VarsayÄ±lan kilitli sekmeler (Eskisi gibi kalsÄ±n istersen)
        window.lockedTabsConfig = ['butce', 'notlar', 'cihazlar'];
        window.unlockedSessionTabs = {};
        // VarsayÄ±lan ÅŸifre (3981)
        let customTabPassword = '3981';
        // --- YENÄ°: YÃ¶netim Paneli Åifresi ---
        // VarsayÄ±lan olarak '1234' olsun, sonra deÄŸiÅŸtirirsin
        let adminPanelPassword = '1234';
        const LS_ADMIN_PASS = 'evdeSaglikAdminPass_V1';
        // --- YENÄ°: AÃ§Ä±lÄ±ÅŸ Kilidi AyarÄ± ---
        const LS_STARTUP_LOCK_ENABLED = 'evdeSaglikStartupLock_V1';
        let startupLockEnabled = true; // VarsayÄ±lan olarak aÃ§Ä±k olsun

        const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
        const monthsTR = ["OCAK", "ÅUBAT", "MART", "NÄ°SAN", "MAYIS", "HAZÄ°RAN", "TEMMUZ", "AÄUSTOS", "EYLÃœL", "EKÄ°M", "KASIM", "ARALIK"];

        const defaultStaff = [{ name: "Okan Ay", role: "Evde SaÄŸlÄ±k Teknikeri" }, { name: "Mehmet Akkurt", role: "Evde SaÄŸlÄ±k Teknikeri" }, { name: "Atalay DurmuÅŸ", role: "HemÅŸire" }, { name: "Ã–zgÃ¼r Ã–zpek", role: "HemÅŸire" }, { name: "GÃ¼ndem Yakan Åahin", role: "HemÅŸire" }, { name: "Ä°lkay CoÅŸgun", role: "HemÅŸire" }, { name: "AyÅŸegÃ¼l Arda", role: "HemÅŸire" }, { name: "GÃ¼lin Tetik", role: "HemÅŸire" }];
        const defaultDoctors = [{ name: "Dr. AyÃ§a Asma SakallÄ±" }, { name: "Dr. Erdal Elmas" }];
        const defaultProcs = ["Pansuman", "Tetkik", "Sonda", "Enjeksiyon", "NG", "SÃ¼tÃ¼r Alma"];
        const defaultSpecialists = ["Diyabet HemÅŸiresi", "Beslenme HemÅŸiresi", "Fizyoterapist", "Psikolog", "Sosyal Hizmet UzmanÄ±", "Diyetisyen"];
        const defaultTeams = ["Nakil AracÄ±", "Evde SaÄŸlÄ±k 1", "Evde SaÄŸlÄ±k 2"];

        let staffList = [], doctorList = [], procList = [], specialistList = [], quickList = [], teamList = [], routineList = [], budgetList = [], emergencyList = [];
        let emergencyBags = ["Ana Ã‡anta"];
        let currentBag = "Ana Ã‡anta";
        let leaveRecords = [], allRecords = {}, docRecords = {}, allNotes = {};

        let currentWeekStart = new Date();
        let isEditing = false;
        let apiKey = "";

        // GLOBAL ACTIONS
        window.remItem = async (type, idx) => {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?')) return;
            if (type === 'staff') staffList.splice(idx, 1);
            else if (type === 'doc') { doctorList.splice(idx, 1); }
            else if (type === 'proc') procList.splice(idx, 1);
            else if (type === 'spec') specialistList.splice(idx, 1);
            else if (type === 'leave') leaveRecords.splice(idx, 1);
            else if (type === 'team') teamList.splice(idx, 1);
            await saveAll(); renderMgmtLists(); populateFilters(); renderLeaveRecords(); renderUI(); showToast('KayÄ±t Silindi');
        };

        window.moveItem = async (type, idx, dir) => {
            let list;
            if (type === 'staff') list = staffList;
            else if (type === 'doc') list = doctorList;
            else if (type === 'proc') list = procList;
            else if (type === 'spec') list = specialistList;
            else if (type === 'team') list = teamList;
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= list.length) return;
            [list[idx], list[newIdx]] = [list[newIdx], list[idx]];
            await saveAll(); renderMgmtLists();
        };

        window.toggleStaffInDocList = async (staffName, isChecked) => {
            if (isChecked) { if (!doctorList.some(d => d.name === staffName)) doctorList.push({ name: staffName }); }
            else { const idx = doctorList.findIndex(d => d.name === staffName); if (idx > -1) doctorList.splice(idx, 1); }
            await saveAll(); renderMgmtLists();
        };

        window.addQuickItem = async () => {
            const input = document.getElementById('new-quick-name');
            const name = input.value.trim();
            if (name) {
                if (staffList.some(s => s.name === name) || quickList.includes(name)) { showToast('Bu isim zaten listede var', 'error'); return; }
                quickList.push(name); input.value = ''; await saveAll(); renderMgmtLists(); showToast('HÄ±zlÄ± listeye eklendi');
            }
        };

        window.remQuickItem = async (idx) => {
            if (!confirm('Bu ismi hÄ±zlÄ± listeden silmek istiyor musunuz?')) return;
            quickList.splice(idx, 1); await saveAll(); renderMgmtLists();
        };

        function getLocalDateString(date) {
            const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`;
        }

        window.onload = () => {
            loadAll();
            loadReminders();
            setWeekToMonday(new Date());
            setupEventListeners();
            updateLockUI();
            populateFilters();

            if (typeof renderRoutines === 'function') renderRoutines();

            const t = new Date();
            const todayStr = getLocalDateString(t);
            const currentDay = t.getDate();
            const currentMonth = t.getMonth();
            const currentYear = t.getFullYear();

            let budgetStart, budgetEnd;
            if (currentDay >= 15) {
                budgetStart = new Date(currentYear, currentMonth, 15);
                budgetEnd = new Date(currentYear, currentMonth + 1, 14);
            } else {
                budgetStart = new Date(currentYear, currentMonth - 1, 15);
                budgetEnd = new Date(currentYear, currentMonth, 14);
            }

            const elBStart = document.getElementById('budget-start-date');
            const elBEnd = document.getElementById('budget-end-date');
            // Bu elemanlar HTML'de yoksa hata vermesin diye kontrol:
            if (elBStart) elBStart.value = getLocalDateString(budgetStart);
            if (elBEnd) elBEnd.value = getLocalDateString(budgetEnd);

            const elBEntry = document.getElementById('budget-entry-date');
            if (elBEntry) elBEntry.value = todayStr;

            if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
            else if (typeof renderBudget === 'function') renderBudget();

            const elStart = document.getElementById('analysis-start');
            const elEnd = document.getElementById('analysis-end');
            if (elStart) elStart.value = getLocalDateString(new Date(currentYear, currentMonth, 1));
            if (elEnd) elEnd.value = getLocalDateString(new Date(currentYear, currentMonth + 1, 0));

            if (document.getElementById('leave-start-date')) {
                document.getElementById('leave-start-date').value = todayStr;
                document.getElementById('leave-end-date').value = todayStr;
                // --- Ä°zin Tarihleri AyarÄ± ---
                if (document.getElementById('leave-start-date')) {
                    document.getElementById('leave-start-date').value = todayStr;
                    document.getElementById('leave-end-date').value = todayStr;
                } // Eksik parantez dÃ¼zeltildi
                // --- GÃœVENLÄ°K VE AÃ‡ILIÅ KÄ°LÄ°DÄ° MANTIÄI (Ä°PTAL EDÄ°LDÄ°) ---
                // Site aÃ§Ä±lÄ±ÅŸÄ±nda kilit sormamasÄ± iÃ§in hafÄ±zayÄ± temizliyoruz
                localStorage.removeItem('isSystemLocked');

                // Kilit ekranÄ± HTML'de aÃ§Ä±k geldiyse zorla gizliyoruz
                const lockScreen = document.getElementById('auto-lock-screen');
                if (lockScreen) {
                    lockScreen.classList.add('hidden');
                    lockScreen.classList.remove('flex');
                }

                console.log("GiriÅŸ kilidi devre dÄ±ÅŸÄ±, sistem aÃ§Ä±k baÅŸlatÄ±ldÄ±.");
            }; // <-- Bu sÃ¼slÃ¼ parantez muhtemelen DOMContentLoaded veya init fonksiyonunun kapanÄ±ÅŸÄ±, silme.

            if (typeof lucide !== 'undefined') lucide.createIcons();
            renderReminderProcs();
        };

        function loadAll() {
            try { deviceList = JSON.parse(localStorage.getItem(LS_DEVICES)) || []; } catch { deviceList = []; }
            try { shiftList = JSON.parse(localStorage.getItem(LS_SHIFTS)) || []; } catch { shiftList = []; }
            try { generalNotesList = JSON.parse(localStorage.getItem(LS_GENERAL_NOTES_LIST)) || []; } catch { generalNotesList = []; }
            try { allRecords = JSON.parse(localStorage.getItem(LS_DATA)) || {}; } catch { allRecords = {}; }
            try { docRecords = JSON.parse(localStorage.getItem(LS_DOC_DATA)) || {}; } catch { docRecords = {}; }
            try { const s = JSON.parse(localStorage.getItem(LS_STAFF)); staffList = (s && s.length) ? s : [...defaultStaff]; } catch { staffList = [...defaultStaff]; }
            try { const d = JSON.parse(localStorage.getItem(LS_DOCTORS)); doctorList = (d && d.length) ? d : [...defaultDoctors]; } catch { doctorList = [...defaultDoctors]; }
            try { const p = JSON.parse(localStorage.getItem(LS_PROCS)); procList = (p && p.length) ? p : [...defaultProcs]; } catch { procList = [...defaultProcs]; }
            try { const sp = JSON.parse(localStorage.getItem(LS_SPECIALISTS_LIST)); specialistList = (sp && sp.length) ? sp : [...defaultSpecialists]; } catch { specialistList = [...defaultSpecialists]; }
            try { const q = JSON.parse(localStorage.getItem(LS_QUICK_LIST)); quickList = (q && q.length) ? q : []; } catch { quickList = []; }
            try { const t = JSON.parse(localStorage.getItem(LS_TEAMS)); teamList = (t && t.length) ? t : [...defaultTeams]; } catch { teamList = [...defaultTeams]; }
            try { const l = JSON.parse(localStorage.getItem(LS_LEAVE_RECORDS)); leaveRecords = (l && l.length) ? l : []; } catch { leaveRecords = []; }
            try { allNotes = JSON.parse(localStorage.getItem(LS_NOTES)) || {}; } catch { allNotes = {}; }
            try { routineList = JSON.parse(localStorage.getItem(LS_ROUTINES)) || []; } catch { routineList = []; }
            try { budgetList = JSON.parse(localStorage.getItem(LS_BUDGET)) || []; } catch { budgetList = []; }
            try {
                emergencyBags = JSON.parse(localStorage.getItem(LS_BAGS));
                if (!emergencyBags || emergencyBags.length === 0) emergencyBags = ["Ana Ã‡anta"];
            } catch { emergencyBags = ["Ana Ã‡anta"]; }
            try { emergencyList = JSON.parse(localStorage.getItem(LS_EMERGENCY)) || []; } catch { emergencyList = []; }

            emergencyList.forEach(item => { if (!item.bagName) item.bagName = "Ana Ã‡anta"; });
            // Sekme Kilit AyarlarÄ±nÄ± YÃ¼kle
            try { lockedTabsConfig = JSON.parse(localStorage.getItem(LS_LOCKED_TABS_CONFIG)) || []; } catch { lockedTabsConfig = []; }
            try { customTabPassword = localStorage.getItem(LS_TAB_LOCK_PASS_CUSTOM) || '3981'; } catch { customTabPassword = '3981'; }
            // AÃ§Ä±lÄ±ÅŸ Kilidi AyarÄ±nÄ± YÃ¼kle
            try {
                let val = localStorage.getItem(LS_STARTUP_LOCK_ENABLED);
                startupLockEnabled = (val === null) ? true : JSON.parse(val);
            } catch { startupLockEnabled = true; }
            // YÃ¶netim Åifresini YÃ¼kle
            try { adminPanelPassword = localStorage.getItem(LS_ADMIN_PASS) || '1234'; } catch { adminPanelPassword = '1234'; }
            loadPhonebook(); //
        }

        async function saveAll() {
            // TÃ¼m Firebase kaydetme iÅŸlemlerini paralel olarak Ã§alÄ±ÅŸtÄ±r
            await Promise.all([
                FirebaseStorage.setItem(LS_DEVICES, JSON.stringify(deviceList)),
                FirebaseStorage.setItem(LS_SHIFTS, JSON.stringify(shiftList)),
                FirebaseStorage.setItem(LS_DATA, JSON.stringify(allRecords)),
                FirebaseStorage.setItem(LS_DOC_DATA, JSON.stringify(docRecords)),
                FirebaseStorage.setItem(LS_STAFF, JSON.stringify(staffList)),
                FirebaseStorage.setItem(LS_DOCTORS, JSON.stringify(doctorList)),
                FirebaseStorage.setItem(LS_PROCS, JSON.stringify(procList)),
                FirebaseStorage.setItem(LS_SPECIALISTS_LIST, JSON.stringify(specialistList)),
                FirebaseStorage.setItem(LS_QUICK_LIST, JSON.stringify(quickList)),
                FirebaseStorage.setItem(LS_TEAMS, JSON.stringify(teamList)),
                FirebaseStorage.setItem(LS_LEAVE_RECORDS, JSON.stringify(leaveRecords)),
                FirebaseStorage.setItem(LS_NOTES, JSON.stringify(allNotes)),
                FirebaseStorage.setItem(LS_EMERGENCY, JSON.stringify(emergencyList)),
                FirebaseStorage.setItem(LS_BAGS, JSON.stringify(emergencyBags)),
                FirebaseStorage.setItem(LS_BUDGET, JSON.stringify(budgetList)),
                FirebaseStorage.setItem(LS_GENERAL_NOTES_LIST, JSON.stringify(generalNotesList)),
                FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(phonebookList)),
                // YENÄ°LER
                FirebaseStorage.setItem(LS_LOCKED_TABS_CONFIG, JSON.stringify(lockedTabsConfig)),
                FirebaseStorage.setItem(LS_TAB_LOCK_PASS_CUSTOM, customTabPassword),
                FirebaseStorage.setItem(LS_STARTUP_LOCK_ENABLED, JSON.stringify(startupLockEnabled)),
                FirebaseStorage.setItem(LS_ADMIN_PASS, adminPanelPassword)
            ]);

            renderUI(); populateFilters();
        }

        // HELPER FUNCTIONS
        function safeGet(id) { const el = document.getElementById(id); return el; }
        function openSettingsModal() { safeGet('settings-modal').classList.remove('hidden'); safeGet('settings-modal').classList.add('flex'); safeGet('api-key-input').value = localStorage.getItem(LS_API_KEY) || ''; }
        function closeSettingsModal() { safeGet('settings-modal').classList.add('hidden'); safeGet('settings-modal').classList.remove('flex'); }
        function saveApiKey() { const key = safeGet('api-key-input').value.trim(); if (key) { FirebaseStorage.setItem(LS_API_KEY, key); showToast('API AnahtarÄ± kaydedildi.'); closeSettingsModal(); } else showToast('LÃ¼tfen geÃ§erli bir anahtar girin.', 'error'); }
        function closeAiModal() { document.getElementById('ai-report-modal').classList.add('hidden'); document.getElementById('ai-report-modal').classList.remove('flex'); }
        function openPwModal() { safeGet('change-pw-modal').classList.remove('hidden'); safeGet('change-pw-modal').classList.add('flex'); }
        function closePwModal() { safeGet('change-pw-modal').classList.add('hidden'); safeGet('change-pw-modal').classList.remove('flex'); safeGet('old-pw').value = ''; safeGet('new-pw').value = ''; safeGet('new-pw-confirm').value = ''; safeGet('change-pw-error').classList.add('hidden'); }
        // --- GÃœNCELLENMÄ°Å ÅÄ°FRE DEÄÄ°ÅTÄ°RME (MASKELÄ° KAYIT) ---
        function saveNewPw() {
            const old = safeGet('old-pw').value;
            const nw = safeGet('new-pw').value;
            const cf = safeGet('new-pw-confirm').value;
            const err = safeGet('change-pw-error');

            if (old !== appPassword) {
                err.textContent = "Eski ÅŸifre hatalÄ±!";
                err.classList.remove('hidden');
                return;
            }
            if (nw.length < 4) {
                err.textContent = "Yeni ÅŸifre en az 4 karakter olmalÄ±.";
                err.classList.remove('hidden');
                return;
            }
            if (nw !== cf) {
                err.textContent = "Yeni ÅŸifreler eÅŸleÅŸmiyor!";
                err.classList.remove('hidden');
                return;
            }

            // Åifreyi deÄŸiÅŸkene ata
            appPassword = nw;

            // Åifreyi maskeleyerek (btoa) hafÄ±zaya kaydet
            FirebaseStorage.setItem(LS_APP_PASSWORD_ENC, btoa(nw));

            showToast('Åifre baÅŸarÄ±yla deÄŸiÅŸtirildi.');
            closePwModal();
        }

        function populateFilters() {
            // HTML'deki select gruplarÄ±nÄ± al
            const docOpt = document.getElementById('filter-opt-doc');
            const procOpt = document.getElementById('filter-opt-proc');
            const specOpt = document.getElementById('filter-opt-spec');

            // Ä°zin formu iÃ§in kiÅŸi Ã¶neri listesi
            const staffDatalist = document.getElementById('staff-suggestions');

            // EÄŸer bu elemanlar sayfada yoksa hata vermesin diye durduruyoruz
            if (!docOpt || !procOpt || !specOpt) return;

            // 1. DOKTOR SEÃ‡ENEKLERÄ°NÄ° SIFIRLA VE YENÄ°LE
            // VarsayÄ±lan seÃ§enekleri korumak iÃ§in innerHTML'i Ã¶nce temizleyip sonra statik olanÄ± ekliyoruz
            docOpt.innerHTML = '<option value="doc_counts">Sadece Hasta SayÄ±larÄ±</option>';
            // Doktor listesindeki her iÅŸlem/prosedÃ¼r aslÄ±nda bir filtre olamaz, 
            // ama doktor verileri tablosunda filtreleme mantÄ±ÄŸÄ± farklÄ± iÅŸlediÄŸi iÃ§in burayÄ± sade bÄ±raktÄ±k.
            // EÄŸer her doktora Ã¶zel filtre istersen buraya doktorList dÃ¶ngÃ¼sÃ¼ eklenebilir.

            // 2. Ä°ÅLEM (PROSEDÃœR) SEÃ‡ENEKLERÄ°NÄ° SIFIRLA VE YENÄ°LE
            procOpt.innerHTML = '';
            procList.forEach(p => {
                // Value baÅŸÄ±na 'proc_' ekliyoruz ki analiz yaparken bunun bir iÅŸlem olduÄŸunu anlayalÄ±m
                procOpt.innerHTML += `<option value="proc_${p}">${p}</option>`;
            });

            // 3. UZMANLIK SEÃ‡ENEKLERÄ°NÄ° SIFIRLA VE YENÄ°LE
            specOpt.innerHTML = '';
            specialistList.forEach(s => {
                // Value baÅŸÄ±na 'spec_' ekliyoruz ki analiz yaparken bunun bir uzmanlÄ±k olduÄŸunu anlayalÄ±m
                specOpt.innerHTML += `<option value="spec_${s}">${s}</option>`;
            });

            // 4. Ä°ZÄ°N ALAN PERSONEL Ã–NERÄ° LÄ°STESÄ°NÄ° GÃœNCELLE
            if (staffDatalist) {
                staffDatalist.innerHTML = '';
                // Mevcut personelleri ekle
                staffList.forEach(s => { staffDatalist.innerHTML += `<option value="${s.name}">`; });

                // HÄ±zlÄ± listedeki (dÄ±ÅŸarÄ±dan gelen) isimleri ekle
                if (quickList && quickList.length > 0) {
                    quickList.forEach(q => {
                        // EÄŸer personel listesinde zaten varsa tekrar ekleme
                        if (!staffList.some(s => s.name === q)) staffDatalist.innerHTML += `<option value="${q}">`;
                    });
                }
            }
        }

        // --- GÃœNCELLENMÄ°Å IMPORT (GERÄ° YÃœKLEME - TAM KAPSAM) ---
        function importData(e) {
            if (!isEditing) {
                showToast("YÃ¼kleme yapmak iÃ§in kilidi aÃ§malÄ±sÄ±nÄ±z.", "error");
                e.target.value = '';
                safeGet('lock-toggle')?.click();
                return;
            }

            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // 1. AYARLAR
                if (workbook.SheetNames.includes("Ayarlar")) {
                    const configs = XLSX.utils.sheet_to_json(workbook.Sheets["Ayarlar"]);
                    const newStaff = [], newDocs = [], newProcs = [], newSpecs = [], newQuick = [], newTeams = [];
                    configs.forEach(c => {
                        if (c.Tip === 'Personel_Tanim') newStaff.push({ name: c.Deger1, role: c.Deger2 || 'Personel' });
                        if (c.Tip === 'Doktor_Tanim') newDocs.push({ name: c.Deger1 });
                        if (c.Tip === 'Islem_Tanim') newProcs.push(c.Deger1);
                        if (c.Tip === 'Uzman_Tanim') newSpecs.push(c.Deger1);
                        if (c.Tip === 'Hizli_Tanim') newQuick.push(c.Deger1);
                        if (c.Tip === 'Ekip_Tanim') newTeams.push(c.Deger1);
                    });
                    if (newStaff.length) staffList = newStaff;
                    if (newDocs.length) doctorList = newDocs;
                    if (newProcs.length) procList = newProcs;
                    if (newSpecs.length) specialistList = newSpecs;
                    if (newQuick.length) quickList = newQuick;
                    if (newTeams.length) teamList = newTeams;
                }

                // 2. Ä°ZÄ°NLER
                if (workbook.SheetNames.includes("Izinler")) {
                    const leaves = XLSX.utils.sheet_to_json(workbook.Sheets["Izinler"]);
                    leaveRecords = leaves.map(l => ({ staffName: l.Personel, type: l.Tur, startDate: l.Baslangic, endDate: l.Bitis }));
                }

                // 3. PERSONEL VERÄ°LERÄ°
                if (workbook.SheetNames.includes("Personel")) {
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets["Personel"]);
                    jsonData.forEach(row => {
                        const date = row['Tarih']; const name = row['Personel'];
                        if (date && name) {
                            if (!allRecords[date]) allRecords[date] = {};
                            let specialists = [];
                            if (row['Specialists_JSON']) { try { specialists = JSON.parse(row['Specialists_JSON']); } catch (e) { specialists = []; } }
                            allRecords[date][name] = {
                                mm: parseInt(row['OOM'] || 0), mk: parseInt(row['OOK'] || 0), am: parseInt(row['OSM'] || 0), ak: parseInt(row['OSK'] || 0), e: parseInt(row['Muayene'] || 0), specialists: specialists
                            };
                            if (row['Not']) allNotes[date] = row['Not'];
                        }
                    });
                }

                // 4. DOKTOR VERÄ°LERÄ°
                if (workbook.SheetNames.includes("Doktorlar")) {
                    const docData = XLSX.utils.sheet_to_json(workbook.Sheets["Doktorlar"]);
                    docData.forEach(row => {
                        const date = row['Tarih']; const docName = row['Doktor'];
                        if (date && docName) {
                            if (!docRecords[date]) docRecords[date] = {};
                            const procs = {};
                            procList.forEach(p => { if (row[p]) procs[p] = row[p]; });
                            docRecords[date][docName] = { pCount: row['Hasta_Sayisi'] || 0, procs: procs };
                        }
                    });
                }

                // 5. EKÄ°PLER
                if (workbook.SheetNames.includes("Ekipler")) {
                    const teamData = XLSX.utils.sheet_to_json(workbook.Sheets["Ekipler"]);
                    teamData.forEach(row => {
                        const d = row['Tarih']; const t = row['Ekip']; const pStr = row['Personeller'];
                        if (d && t && pStr) {
                            if (!allRecords[d]) allRecords[d] = {};
                            if (!allRecords[d].teams) allRecords[d].teams = {};
                            allRecords[d].teams[t] = pStr.split(',').map(s => s.trim());
                        }
                    });
                }

                // 6. BÃœTÃ‡E
                if (workbook.SheetNames.includes("Butce")) {
                    const rawBudget = XLSX.utils.sheet_to_json(workbook.Sheets["Butce"]);
                    if (rawBudget && rawBudget.length > 0) {
                        budgetList = rawBudget.map(r => ({
                            date: r.Tarih,
                            type: (r.Tur === 'Gelir' || r.Tur === 'income') ? 'income' : 'expense',
                            desc: r.Aciklama,
                            amount: r.Tutar,
                            note: r.Not || ''
                        }));
                    }
                }

                // 7. ACÄ°L Ã‡ANTA
                if (workbook.SheetNames.includes("Acil_Canta")) {
                    const rawEm = XLSX.utils.sheet_to_json(workbook.Sheets["Acil_Canta"]);
                    if (rawEm && rawEm.length > 0) {
                        emergencyList = rawEm.map(r => ({
                            bagName: r.Canta || "Ana Ã‡anta",
                            name: r.Malzeme,
                            date: r.SKT,
                            count: r.Adet,
                            alertDays: r.Uyari,
                            note: r.Not || ''
                        }));
                        const uniqueBags = [...new Set(emergencyList.map(item => item.bagName))];
                        emergencyBags = uniqueBags.length > 0 ? uniqueBags : ["Ana Ã‡anta"];
                        currentBag = emergencyBags[0];
                    }
                }

                // 8. GENEL NOTLAR
                if (workbook.SheetNames.includes("Genel_Notlar")) {
                    const rawNotes = XLSX.utils.sheet_to_json(workbook.Sheets["Genel_Notlar"]);
                    if (rawNotes && rawNotes.length > 0) {
                        generalNotesList = rawNotes.map(n => ({
                            date: n.Tarih,
                            title: n.Baslik,
                            content: n.Icerik,
                            color: n.Renk || 'yellow'
                        }));
                    }
                }

                // 9. NÃ–BET LÄ°STESÄ°
                if (workbook.SheetNames.includes("Nobet_Listesi")) {
                    const rawShifts = XLSX.utils.sheet_to_json(workbook.Sheets["Nobet_Listesi"]);
                    if (rawShifts && rawShifts.length > 0) {
                        shiftList = rawShifts.map(r => ({
                            date: r.Tarih,
                            staff: r.Personel,
                            type: r.Tur,
                            note: r.Not || ''
                        }));
                    }
                }

                // 10. CÄ°HAZ LÄ°STESÄ°
                if (workbook.SheetNames.includes("Cihaz_Zimmet")) {
                    const rawDevs = XLSX.utils.sheet_to_json(workbook.Sheets["Cihaz_Zimmet"]);
                    if (rawDevs && rawDevs.length > 0) deviceList = rawDevs;
                }

                // --- YENÄ° EKLENEN KISIMLAR (REHBER, HASTA TAKÄ°P, RUTÄ°NLER) ---

                // 11. REHBER
                if (workbook.SheetNames.includes("Rehber")) {
                    const rawPh = XLSX.utils.sheet_to_json(workbook.Sheets["Rehber"]);
                    if (rawPh && rawPh.length > 0) {
                        phonebookList = rawPh.map(r => ({
                            id: Date.now() + Math.random(), // Yeni ID ata
                            name: r.Ad_Soyad,
                            role: r.Birim,
                            num: r.Tel
                        }));
                    }
                }

                // 12. HASTA TAKÄ°P
                if (workbook.SheetNames.includes("Hasta_Takip")) {
                    const rawRem = XLSX.utils.sheet_to_json(workbook.Sheets["Hasta_Takip"]);
                    if (rawRem && rawRem.length > 0) {
                        patientReminders = rawRem.map(r => ({
                            id: Date.now() + Math.random(), // Yeni ID ata
                            name: r.Hasta,
                            proc: r.Islem,
                            date: r.Tarih,
                            note: r.Not || '',
                            status: r.Durum || 'pending'
                        }));
                    }
                }

                // 13. RUTÄ°NLER
                if (workbook.SheetNames.includes("Rutinler")) {
                    const rawRout = XLSX.utils.sheet_to_json(workbook.Sheets["Rutinler"]);
                    if (rawRout && rawRout.length > 0) {
                        routineList = rawRout.map(r => ({
                            text: r.Gorev,
                            completed: (r.Tamamlandi === 'Evet' || r.Tamamlandi === true)
                        }));
                    }
                }

                // --- KAYDET VE ARAYÃœZÃœ YENÄ°LE ---
                saveAll();
                // Ekstra kaydetmeler (Global saveAll hepsini kapsamÄ±yor olabilir diye garanti olsun)
                FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(phonebookList));
                FirebaseStorage.setItem(LS_PATIENT_REMINDERS, JSON.stringify(patientReminders));
                FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));

                // ArayÃ¼zleri yenile
                renderBagSelector(); renderEmergency();
                renderGeneralNotes();
                renderPhonebook();
                renderPatientReminders();
                if (typeof renderRoutines === 'function') renderRoutines();

                showToast("TÃ¼m veriler (Rehber ve Hasta Takip dahil) baÅŸarÄ±yla yÃ¼klendi.");
                safeGet('import-file').value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // --- GÃœNCELLENMÄ°Å EXPORT (YEDEKLEME - TAM KAPSAM) ---
        window.exportData = (type) => {
            // MEVCUT VERÄ° HAZIRLIÄI (DOKTORLAR Ä°Ã‡Ä°N)
            const docFlatData = [];
            Object.keys(docRecords).sort().forEach(date => {
                doctorList.forEach(doc => {
                    const r = docRecords[date][doc.name];
                    if (r && (r.pCount > 0 || (r.procs && Object.values(r.procs).some(v => v > 0)))) {
                        const row = { Tarih: date, Doktor: doc.name, Hasta_Sayisi: r.pCount };
                        procList.forEach(p => row[p] = (r.procs && r.procs[p]) ? r.procs[p] : 0);
                        docFlatData.push(row);
                    }
                });
            });

            if (type === 'xlsx') {
                // --- EXCEL YEDEKLEME KISMI ---
                const wb = XLSX.utils.book_new();

                // 1. Personel
                const flatData = [];
                Object.keys(allRecords).sort().forEach(date => {
                    staffList.forEach(s => {
                        const r = allRecords[date][s.name];
                        if (r) {
                            const total = r.mm + r.mk + r.am + r.ak + (r.e * 2) + (r.specialists ? r.specialists.length : 0);
                            if (total > 0 || (r.specialists && r.specialists.length > 0)) {
                                flatData.push({
                                    Tarih: date, Personel: s.name,
                                    OOM: r.mm, OOK: r.mk, OSM: r.am, OSK: r.ak, Muayene: r.e,
                                    Toplam: total, Not: allNotes[date] || '',
                                    Specialists_JSON: JSON.stringify(r.specialists || [])
                                });
                            }
                        }
                    });
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(flatData), "Personel");

                // 2. Doktorlar & Ä°zinler & Ekipler & BÃ¼tÃ§e
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(docFlatData), "Doktorlar");

                const leaveData = leaveRecords.map(l => ({ Personel: l.staffName, Tur: l.type, Baslangic: l.startDate, Bitis: l.endDate }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(leaveData), "Izinler");

                const teamData = [];
                Object.keys(allRecords).sort().forEach(date => {
                    const r = allRecords[date]; if (r.teams) { Object.keys(r.teams).forEach(tName => { const pList = r.teams[tName]; if (pList && pList.length > 0) { teamData.push({ Tarih: date, Ekip: tName, Personeller: pList.join(', ') }); } }); }
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(teamData), "Ekipler");

                const budgetSheetData = budgetList.map(item => ({ Tarih: item.date, Tur: item.type === 'income' ? 'Gelir' : 'Gider', Aciklama: item.desc, Tutar: item.amount, Not: item.note || '' }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(budgetSheetData), "Butce");

                // 3. Ayarlar (Listeler)
                const configData = [];
                staffList.forEach(s => configData.push({ Tip: 'Personel_Tanim', Deger1: s.name, Deger2: s.role }));
                doctorList.forEach(d => configData.push({ Tip: 'Doktor_Tanim', Deger1: d.name }));
                procList.forEach(p => configData.push({ Tip: 'Islem_Tanim', Deger1: p }));
                specialistList.forEach(s => configData.push({ Tip: 'Uzman_Tanim', Deger1: s }));
                quickList.forEach(q => configData.push({ Tip: 'Hizli_Tanim', Deger1: q }));
                teamList.forEach(t => configData.push({ Tip: 'Ekip_Tanim', Deger1: t }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(configData), "Ayarlar");

                // 4. DiÄŸer Mevcut Veriler
                if (emergencyList && emergencyList.length > 0) {
                    const emSheetData = emergencyList.map(i => ({ Canta: i.bagName, Malzeme: i.name, SKT: i.date, Adet: i.count, Uyari: i.alertDays, Not: i.note }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(emSheetData), "Acil_Canta");
                }
                if (generalNotesList && generalNotesList.length > 0) {
                    const notesSheetData = generalNotesList.map(n => ({ Tarih: n.date, Baslik: n.title, Icerik: n.content, Renk: n.color }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(notesSheetData), "Genel_Notlar");
                }
                if (shiftList && shiftList.length > 0) {
                    const shiftData = shiftList.map(s => ({ Tarih: s.date, Personel: s.staff, Tur: s.type, Not: s.note || '' }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shiftData), "Nobet_Listesi");
                }
                if (deviceList && deviceList.length > 0) {
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(deviceList), "Cihaz_Zimmet");
                }

                // --- YENÄ° EKLENEN KISIMLAR (BURADA) ---

                // A) REHBER YEDEÄÄ°
                if (phonebookList && phonebookList.length > 0) {
                    const phData = phonebookList.map(p => ({ Ad_Soyad: p.name, Birim: p.role, Tel: p.num }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(phData), "Rehber");
                }

                // B) HASTA TAKÄ°P YEDEÄÄ°
                if (patientReminders && patientReminders.length > 0) {
                    const remData = patientReminders.map(r => ({ Hasta: r.name, Islem: r.proc, Tarih: r.date, Not: r.note, Durum: r.status }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(remData), "Hasta_Takip");
                }

                // C) RUTÄ°NLER YEDEÄÄ°
                if (routineList && routineList.length > 0) {
                    const routData = routineList.map(r => ({ Gorev: r.text, Tamamlandi: r.completed ? 'Evet' : 'HayÄ±r' }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(routData), "Rutinler");
                }

                XLSX.writeFile(wb, `SaglikTakip_TamYedek_${new Date().toISOString().slice(0, 10)}.xlsx`);

            } else {
                // --- PDF RAPORLAMA KISMI (DEÄÄ°ÅÄ°KLÄ°K YOK) ---
                // Bu kÄ±sÄ±m Excel'i etkilemez, aynen korunuyor.

                const getRowColor = (index) => (index % 2 === 0) ? '#d1d5db' : '#e5e7eb';
                const getPdfDate = (dStr) => { if (!dStr) return '-'; const d = new Date(dStr); return d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', weekday: 'short' }); };
                const c = (text, index, align = 'left', color = '#000000', fontSize = 12, bold = false) => ({ text: text, fillColor: getRowColor(index), alignment: align, color: color, fontSize: fontSize, bold: bold, margin: [0, 3, 0, 3] });

                const staffBody = [[{ text: 'Tarih', style: 'tableHeader' }, { text: 'Personel', style: 'tableHeader' }, { text: 'Sabah', style: 'tableHeader', fillColor: '#c7d2fe', color: '#312e81' }, { text: 'Ã–ÄŸle', style: 'tableHeader', fillColor: '#fed7aa', color: '#7c2d12' }, { text: 'Uzman', style: 'tableHeader', fillColor: '#e9d5ff', color: '#581c87' }, { text: 'Personel Notu', style: 'tableHeader' }]];
                const sortedDates = Object.keys(allRecords).sort(); let staffRowIdx = 0;
                sortedDates.forEach(date => { staffList.forEach(s => { const r = allRecords[date][s.name]; if (r && (r.mm || r.mk || r.am || r.ak || r.e || (r.specialists && r.specialists.length > 0))) { let sabah = []; if (r.mm) sabah.push("Merkez"); if (r.mk) sabah.push("KÃ¶y"); if (r.e) sabah.push("Muayene"); let ogle = []; if (r.am) ogle.push("Merkez"); if (r.ak) ogle.push("KÃ¶y"); let uzman = []; if (r.specialists) r.specialists.forEach(sp => uzman.push(sp.name)); staffBody.push([c(getPdfDate(date), staffRowIdx), c(s.name, staffRowIdx, 'left', '#000000', 12, true), c(sabah.join(', ') || '-', staffRowIdx, 'center', sabah.length ? '#1e3a8a' : '#9ca3af', 11), c(ogle.join(', ') || '-', staffRowIdx, 'center', ogle.length ? '#9a3412' : '#9ca3af', 11), c(uzman.join(', ') || '-', staffRowIdx, 'center', uzman.length ? '#6b21a8' : '#9ca3af', 10), c(allNotes[date] && allNotes[date].includes(s.name) ? 'Not Var' : '-', staffRowIdx, 'center', '#4b5563', 11, false)]); staffRowIdx++; } }); });

                const docBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#1e40af' }, { text: 'Doktor', style: 'tableHeader', fillColor: '#1e40af' }, { text: 'Hasta SayÄ±sÄ±', style: 'tableHeader', fillColor: '#1e40af' }, { text: 'Ä°ÅŸlemler', style: 'tableHeader', fillColor: '#1e40af' }]];
                const docDates = Object.keys(docRecords).sort(); let docRowIdx = 0;
                docDates.forEach(date => { doctorList.forEach(doc => { const r = docRecords[date][doc.name]; if (r && (parseInt(r.pCount) > 0 || (r.procs && Object.values(r.procs).some(v => v > 0)))) { let procDetails = []; if (r.procs) Object.keys(r.procs).forEach(p => { if (r.procs[p] > 0) procDetails.push(`${p}: ${r.procs[p]}`); }); docBody.push([c(getPdfDate(date), docRowIdx), c(doc.name, docRowIdx, 'left', '#000000', 12, true), c(r.pCount, docRowIdx, 'center'), c(procDetails.join(', '), docRowIdx)]); docRowIdx++; } }); });

                const leaveBody = [[{ text: 'Personel', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'Durum', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'BaÅŸlangÄ±Ã§', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'BitiÅŸ', style: 'tableHeader', fillColor: '#c2410c' }, { text: 'SÃ¼re', style: 'tableHeader', fillColor: '#c2410c', alignment: 'center' }]];
                leaveRecords.forEach((l, idx) => { const start = new Date(l.startDate), end = new Date(l.endDate), diffTime = Math.abs(end - start), diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; leaveBody.push([c(l.staffName, idx, 'left', '#000000', 12, true), c(l.type, idx), c(getPdfDate(l.startDate), idx), c(getPdfDate(l.endDate), idx), { text: `${diffDays} GÃ¼n`, alignment: 'center', bold: true, fontSize: 12, fillColor: getRowColor(idx), margin: [0, 3, 0, 3] }]); });

                const emBody = [[{ text: 'Ã‡anta', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'Malzeme / Not', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'SKT', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'Adet', style: 'tableHeader', fillColor: '#991b1b' }]];
                emergencyList.forEach((em, idx) => { emBody.push([c(em.bagName || 'Ana Ã‡anta', idx), { stack: [{ text: em.name, bold: true, color: '#000000', fontSize: 12 }, em.note ? { text: `Not: ${em.note}`, fontSize: 10, italics: true, color: '#374151' } : ''], fillColor: getRowColor(idx), margin: [0, 3, 0, 3] }, c(getPdfDate(em.date), idx), c(em.count, idx, 'center', '#000000', 12, true)]); });

                const teamBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#4338ca' }, { text: 'Ekip AdÄ±', style: 'tableHeader', fillColor: '#4338ca' }, { text: 'Personeller', style: 'tableHeader', fillColor: '#4338ca' }]];
                let teamRowIdx = 0; sortedDates.forEach(date => { if (allRecords[date] && allRecords[date].teams) { Object.keys(allRecords[date].teams).forEach(tName => { const pList = allRecords[date].teams[tName]; if (pList && pList.length > 0) { teamBody.push([c(getPdfDate(date), teamRowIdx), c(tName, teamRowIdx, 'left', '#000000', 12, true), c(pList.join(', '), teamRowIdx)]); teamRowIdx++; } }); } });

                const notesBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#854d0e' }, { text: 'GÃ¼nÃ¼n Notu', style: 'tableHeader', fillColor: '#854d0e' }]];
                let noteRowIdx = 0; sortedDates.forEach(date => { if (allNotes[date]) { notesBody.push([c(getPdfDate(date), noteRowIdx, 'left', '#000000', 12, true), c(allNotes[date], noteRowIdx, 'left', '#1f2937', 12, false)]); noteRowIdx++; } });

                const genNotesBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#be185d' }, { text: 'BaÅŸlÄ±k', style: 'tableHeader', fillColor: '#be185d' }, { text: 'Ä°Ã§erik', style: 'tableHeader', fillColor: '#be185d' }]];
                if (generalNotesList && generalNotesList.length > 0) { generalNotesList.forEach((note, idx) => { genNotesBody.push([c(note.date, idx, 'left', '#000000', 10, true), c(note.title, idx, 'left', '#be185d', 11, true), c(note.content, idx, 'left', '#374151', 10)]); }); }
                else { genNotesBody.push([{ text: 'HenÃ¼z eklenmiÅŸ Ã¶nemli not bulunmamaktadÄ±r.', colSpan: 3, alignment: 'center', italics: true, color: '#9ca3af', margin: [0, 10, 0, 10] }, {}, {}]); }

                const shiftBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#312e81' }, { text: 'Personel', style: 'tableHeader', fillColor: '#312e81' }, { text: 'NÃ¶bet TÃ¼rÃ¼', style: 'tableHeader', fillColor: '#312e81' }, { text: 'Not', style: 'tableHeader', fillColor: '#312e81' }]];
                if (typeof shiftList !== 'undefined' && shiftList.length > 0) {
                    const sortedShifts = [...shiftList].sort((a, b) => a.date.localeCompare(b.date));
                    sortedShifts.forEach((s, idx) => {
                        shiftBody.push([c(getPdfDate(s.date), idx), c(s.staff, idx, 'left', '#000000', 11, true), c(s.type, idx, 'center'), c(s.note || '-', idx, 'left', '#4b5563', 10, !!s.note)]);
                    });
                } else { shiftBody.push([{ text: 'NÃ¶bet kaydÄ± yok.', colSpan: 4, alignment: 'center', italics: true, color: '#9ca3af', margin: [0, 10, 0, 10] }, {}, {}, {}]); }

                const docDefinition = {
                    pageOrientation: 'landscape',
                    content: [
                        { text: 'EVDE SAÄLIK HÄ°ZMETLERÄ° DETAYLI RAPORU', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
                        { text: `Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR')}`, style: 'subheader', alignment: 'center', margin: [0, 0, 0, 20] },
                        { text: '1. Personel GÃ¶rev Takip Listesi', style: 'sectionHeader', margin: [0, 10, 0, 10] },
                        { table: { headerRows: 1, widths: ['auto', 'auto', '*', '*', '*', 'auto'], body: staffBody.length > 1 ? staffBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 6, alignment: 'center' }, {}, {}, {}, {}, {}]] }, layout: 'noBorders' },
                        { text: '2. Doktor Performans ve TÄ±bbi Ä°ÅŸlemler', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
                        { table: { headerRows: 1, widths: ['auto', '*', 'auto', '*'], body: docBody.length > 1 ? docBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 4, alignment: 'center' }, {}, {}, {}]] }, layout: 'noBorders' },
                        { text: '3. Ekip / Liste DaÄŸÄ±lÄ±mÄ±', style: 'sectionHeader', margin: [0, 20, 0, 10] },
                        { table: { headerRows: 1, widths: ['auto', 'auto', '*'], body: teamBody.length > 1 ? teamBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 3, alignment: 'center' }, {}, {}]] }, layout: 'noBorders' },
                        { text: '4. Ä°zin ve Rapor DurumlarÄ±', style: 'sectionHeader', margin: [0, 20, 0, 10] },
                        { table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto', 'auto'], body: leaveBody.length > 1 ? leaveBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 5, alignment: 'center' }, {}, {}, {}, {}]] }, layout: 'noBorders' },
                        { text: '5. Acil Ã‡anta ve Stok Envanteri', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
                        { table: { headerRows: 1, widths: ['auto', '*', 'auto', 'auto'], body: emBody.length > 1 ? emBody : [[{ text: 'KayÄ±t bulunamadÄ±', colSpan: 4, alignment: 'center' }, {}, {}, {}]] }, layout: 'noBorders' },
                        { text: '6. GÃ¼nlÃ¼k Genel Notlar', style: 'sectionHeader', margin: [0, 20, 0, 10] },
                        { table: { headerRows: 1, widths: ['auto', '*'], body: notesBody.length > 1 ? notesBody : [[{ text: 'Bu tarih aralÄ±ÄŸÄ±nda not bulunamadÄ±.', colSpan: 2, alignment: 'center', italics: true, color: '#4b5563' }, {}]] }, layout: 'noBorders' },
                        { text: '7. Ã–nemli Notlar / HatÄ±rlatmalar', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
                        { table: { headerRows: 1, widths: ['auto', 'auto', '*'], body: genNotesBody }, layout: 'noBorders' },
                        { text: '8. Personel NÃ¶bet Ã‡izelgesi', style: 'sectionHeader', margin: [0, 20, 0, 10], pageBreak: 'before' },
                        { table: { headerRows: 1, widths: ['auto', '*', 'auto', '*'], body: shiftBody }, layout: 'noBorders' }
                    ],
                    styles: {
                        header: { fontSize: 22, bold: true, color: '#3730a3' },
                        subheader: { fontSize: 12, italics: true, color: '#6b7280' },
                        sectionHeader: { fontSize: 16, bold: true, color: '#111827', decoration: 'underline' },
                        tableHeader: { bold: true, fontSize: 13, color: 'white', fillColor: '#3730a3', alignment: 'center', margin: [0, 6, 0, 6] }
                    },
                    defaultStyle: { fontSize: 12 }
                };

                pdfMake.createPdf(docDefinition).download(`ESB_Genel_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
            }
        };

        function calculateMode(n) { if (n.length === 0) return 0; const f = {}; let max = 0, mode = n[0]; n.forEach(x => { f[x] = (f[x] || 0) + 1; if (f[x] > max) { max = f[x]; mode = x; } }); if (max === 1 && n.length > 1) return Math.round(n.reduce((a, b) => a + b, 0) / n.length); return mode; }
        function getStatusHtml(val, target) {
            const diff = val - target;
            // text-[10px] yerine text-xs yaptÄ±k, bÃ¶ylece daha okunaklÄ± oldu
            if (Math.abs(diff) >= 1) return diff < 0 ?
                `<span class="px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-700 block border border-red-200">EKSÄ°K (${diff})</span>` :
                `<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700 block border border-green-200">FAZLA (+${diff})</span>`;
            return `<span class="text-xs text-gray-400 font-bold">TAM</span>`;
        }

        // YENÄ° EKLENECEK FONKSÄ°YON
        function renderReminderProcs() {
            const select = document.getElementById('rem-proc');
            if (!select) return;

            // Mevcut listeyi temizle
            select.innerHTML = '';

            // Global procList (Ä°ÅŸlem Listesi) dizisindeki her iÅŸlemi ekle
            procList.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                select.appendChild(opt);
            });
        }

        // RENDER FUNCTIONS
        function renderUI() {
            const dates = getWeekDates(currentWeekStart);
            renderTable(dates); renderTeamTable(dates); renderStats(); renderSpecialistTab(); renderDoctorTable(dates); renderLeaveRecords(); renderRoutines();
            lucide.createIcons();
        }

        function renderTable(dates) {
            const thead = document.querySelector('#tracking-head'), tbody = document.getElementById('tracking-body');

            // BaÅŸlÄ±klarÄ± temizle
            thead.querySelectorAll(':not(.sticky-col-1)').forEach(e => e.remove());
            tbody.innerHTML = '';

            // --- GÃœN BAÅLIKLARI (Ãœst KÄ±sÄ±m) ---
            days.forEach(day => {
                const dStr = dates[day], d = new Date(dStr), note = allNotes[dStr];
                const noteIcon = note ? `<button onclick="openNoteModal('${dStr}')" class="ml-1 focus:outline-none"><i data-lucide="sticky-note" class="w-4 h-4 text-yellow-500 fill-yellow-100 hover:scale-110 transition"></i></button>` : '';

                // BURASI DEÄÄ°ÅTÄ°: border-2 ve border-gray-600 eklendi (KalÄ±n Ä±zgara baÅŸlÄ±k)
                thead.insertAdjacentHTML('beforeend', `<th class="px-2 py-2 bg-gray-100 text-center border-2 border-gray-600 min-w-[90px]"><div class="font-bold text-gray-800 text-xs flex justify-center items-center">${day} ${noteIcon}</div><div class="text-[10px] text-gray-600 font-bold">${d.getDate()}/${d.getMonth() + 1}</div></th>`);
            });

            // "SAYI" SÃ¼tunu BaÅŸlÄ±ÄŸÄ±
            thead.insertAdjacentHTML('beforeend', `<th class="px-2 py-2 bg-indigo-100 text-center font-bold text-indigo-900 text-xs sticky right-0 w-12 border-2 border-gray-600">SAYI</th>`);

            // --- SATIRLAR (GÃ¶vde) ---
            staffList.forEach((s, index) => {
                let t = 0;
                const bgClass = (index % 2 === 0) ? 'bg-white' : 'bg-gray-100';

                // BURASI DEÄÄ°ÅTÄ°: SatÄ±r ve Ä°sim hÃ¼cresine kalÄ±n Ã§erÃ§eveler (border-2 border-gray-600)
                let h = `<tr class="${bgClass} hover:bg-indigo-50 border-b-2 border-gray-600">
                <td class="px-4 py-2 font-bold text-gray-800 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs whitespace-nowrap shadow-sm">${s.name}</td>`;

                days.forEach(day => {
                    const k = dates[day], r = allRecords[k]?.[s.name] || { mm: 0, mk: 0, am: 0, ak: 0, e: 0, specialists: [] };
                    const leave = leaveRecords.find(l => l.staffName === s.name && k >= l.startDate && k <= l.endDate);

                    if (leave) {
                        // Ä°zinli/Raporlu HÃ¼cresi
                        const typeClass = leave.type === 'Rapor' ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800';
                        const typeText = leave.type === 'Rapor' ? 'RAPORLU' : 'Ä°ZÄ°NLÄ°';

                        // BURASI DEÄÄ°ÅTÄ°: border-2 border-gray-600
                        h += `<td class="px-1 py-1 text-center h-16 align-middle border-2 border-gray-600 relative"><div class="flex items-center justify-center w-full h-full p-1"><div class="w-full h-full flex items-center justify-center rounded border border-gray-400 font-bold text-[10px] tracking-wider transform -rotate-12 opacity-90 shadow-sm ${typeClass}">${typeText}</div></div></td>`;
                    } else {
                        const specCount = r.specialists ? r.specialists.length : 0;
                        const sc = r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount;
                        t += sc;

                        let c = '';
                        if (r.mm) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-blue-300 bg-blue-50 text-center font-bold leading-tight w-full text-blue-800">SABAH<br>MERKEZ</div>`;
                        if (r.mk) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-orange-300 bg-orange-50 text-center font-bold leading-tight w-full text-orange-800">SABAH<br>KÃ–Y</div>`;
                        if (r.am) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-indigo-300 bg-indigo-50 text-center font-bold leading-tight w-full text-indigo-800">Ã–ÄLEN<br>MERKEZ</div>`;
                        if (r.ak) c += `<div class="text-[9px] px-1 py-0.5 rounded mb-0.5 border border-orange-300 bg-orange-50 text-center font-bold leading-tight w-full text-orange-800">Ã–ÄLEN<br>KÃ–Y</div>`;
                        if (r.e) c += `<div class="text-[9px] px-1 py-0.5 rounded border border-red-300 bg-red-50 text-center font-bold w-full text-red-700">MUAYENE</div>`;
                        // ESKÄ°SÄ°NÄ° SÄ°L VE BUNU YAPIÅTIR
                        if (r.specialists) {
                            r.specialists.forEach(sp => {
                                const timeText = sp.time === 'Ã–Ã–' ? 'SABAH' : 'Ã–ÄLEN';
                                // text-[8px] yerine text-[10px] yaptÄ±k, paddingleri artÄ±rdÄ±k, ismi 5 harfe Ã§Ä±kardÄ±k
                                c += `<div class="text-[10px] px-1 py-1 rounded border border-green-300 bg-green-50 mt-1 text-center leading-tight w-full text-green-900 font-bold shadow-sm">
                                    <span class="block mb-0.5 text-green-700">${sp.name.substr(0, 5)}.</span>
                                    <span class="text-[9px] text-gray-500">${timeText}</span>
                                  </div>`;
                            });
                        }

                        // BURASI DEÄÄ°ÅTÄ°: Normal Veri HÃ¼cresi (border-2 border-gray-600)
                        // YENÄ° HALÄ°: h-16 yerine h-auto yaptÄ±k, py-1'i py-2 yaptÄ±k
                        h += `<td class="px-1 py-2 text-center h-auto min-h-[4rem] align-middle border-2 border-gray-600 relative"><div class="flex flex-col items-center justify-center w-full h-full">${c}</div></td>`;
                    }
                });
                // Toplam SayÄ± HÃ¼cresi
                h += `<td class="px-2 py-2 text-center font-bold text-sm text-indigo-900 bg-indigo-100 border-2 border-gray-600">${t}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', h);
            });
        }

        function renderTeamTable(dates) {
            const head = document.getElementById('team-table-head'), body = document.getElementById('team-table-body');

            // BaÅŸlÄ±klarÄ± temizle
            head.querySelectorAll('th:not(.sticky-col-1)').forEach(e => e.remove());
            body.innerHTML = '';

            // --- BAÅLIKLAR (Header) ---
            days.forEach(day => {
                const d = new Date(dates[day]);
                // BURASI DEÄÄ°ÅTÄ°: border-2 ve border-gray-600 (Koyu Ã§erÃ§eve baÅŸlÄ±klar)
                head.insertAdjacentHTML('beforeend', `<th class="px-2 py-2 bg-gray-100 text-center border-2 border-gray-600 min-w-[100px] text-[10px] text-gray-800 font-bold">${day}<br>${d.getDate()}/${d.getMonth() + 1}</th>`);
            });

            if (teamList.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">HenÃ¼z ekip tanÄ±mlanmamÄ±ÅŸ.</td></tr>';
                return;
            }

            // --- SATIRLAR (Rows) ---
            teamList.forEach((teamName, idx) => {
                const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50';

                // SatÄ±rÄ±n alt Ã§izgisi de kalÄ±nlaÅŸtÄ±rÄ±ldÄ±
                let row = `<tr class="${bgClass} hover:bg-indigo-50 border-b-2 border-gray-600">
                <td class="px-4 py-3 font-bold text-gray-800 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs shadow-sm">${teamName}</td>`;

                days.forEach(day => {
                    const dateKey = dates[day];
                    const teamData = allRecords[dateKey]?.teams?.[teamName] || [];

                    let cellContent = '-';
                    if (teamData.length > 0) {
                        // Ä°simleri biraz daha belirgin yaptÄ±m (indigo-800 ve font-bold)
                        cellContent = teamData.map(p => `<span class="block text-[10px] text-indigo-800 font-bold truncate border-b border-gray-300 pb-0.5 mb-0.5 last:border-0">â€¢ ${p}</span>`).join('');
                    }

                    // BURASI DEÄÄ°ÅTÄ°: HÃ¼cre Ã§erÃ§eveleri (border-2 border-gray-600)
                    row += `<td class="px-2 py-2 text-left border-2 border-gray-600 align-top h-16 overflow-y-auto">${cellContent}</td>`;
                });
                row += '</tr>';
                body.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderLeaveRecords() {
            const listEl = document.getElementById('leave-records-list'); if (!listEl) return; listEl.innerHTML = '';
            const sortedLeaves = [...leaveRecords].sort((a, b) => b.startDate.localeCompare(a.startDate));
            if (sortedLeaves.length === 0) { listEl.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 text-xs">HenÃ¼z kayÄ±t yok.</td></tr>'; return; }
            sortedLeaves.forEach((l, idx) => {
                const sDate = new Date(l.startDate), eDate = new Date(l.endDate); const typeClass = l.type === 'Rapor' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700';
                listEl.innerHTML += `<tr class="hover:bg-gray-50 group border-b last:border-0"><td class="px-4 py-2 font-medium text-gray-700">${l.staffName}</td><td class="px-4 py-2"><span class="text-[10px] px-2 py-1 rounded-full font-bold ${typeClass}">${l.type}</span></td><td class="px-4 py-2 text-gray-600 text-xs">${sDate.toLocaleDateString('tr-TR')} - ${eDate.toLocaleDateString('tr-TR')}</td><td class="px-4 py-2 text-right"><button onclick="remItem('leave', ${idx})" class="text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`;
            });
            lucide.createIcons();
        }

        function renderDoctorTable(dates) {
            const head = document.getElementById('doctor-table-head'), body = document.getElementById('doctor-table-body');

            // BaÅŸlÄ±klarÄ± temizle
            head.querySelectorAll('th:not(.sticky-col-1)').forEach(e => e.remove());
            body.innerHTML = '';

            // --- GÃœN BAÅLIKLARI ---
            days.forEach(day => {
                const d = new Date(dates[day]);
                // BURASI DEÄÄ°ÅTÄ°: border-2 ve border-gray-600 eklendi
                head.insertAdjacentHTML('beforeend', `<th class="px-3 py-2 bg-gray-100 text-center border-2 border-gray-600 min-w-[70px] text-[10px] text-gray-700 font-bold">${day}<br>${d.getDate()}/${d.getMonth() + 1}</th>`);
            });

            // TOPLAM SÃœTUNU BAÅLIÄI
            head.insertAdjacentHTML('beforeend', `<th class="px-3 py-2 bg-blue-100 text-center font-bold text-blue-900 text-xs border-2 border-gray-600">TOP. H.</th>`);

            // Veri HazÄ±rlÄ±ÄŸÄ±
            const procStats = {};
            procList.forEach(p => procStats[p] = 0);

            const activeDoctors = doctorList.filter(doc => {
                return days.some(day => {
                    const k = dates[day], rec = docRecords[k]?.[doc.name];
                    return rec && (parseInt(rec.pCount) > 0 || (rec.procs && Object.values(rec.procs).some(v => parseInt(v) > 0)));
                });
            });

            if (activeDoctors.length === 0) {
                body.innerHTML = '<tr><td colspan="8" class="p-6 text-center text-gray-500 text-sm bg-gray-50 border-2 border-gray-600 font-bold">Bu hafta iÃ§in kayÄ±tlÄ± veri bulunmamaktadÄ±r.</td></tr>';
            }

            // --- DOKTOR SATIRLARI ---
            activeDoctors.forEach((doc, idx) => {
                const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
                let totalPatients = 0;

                // SatÄ±r ve Ä°sim HÃ¼cresi (Sticky) - KalÄ±n Ã‡erÃ§eve
                let h = `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600">
                <td class="px-4 py-2 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs font-bold text-gray-800 shadow-sm">${doc.name}</td>`;

                days.forEach(day => {
                    const k = dates[day], rec = docRecords[k]?.[doc.name] || { pCount: 0, procs: {} };
                    const pCount = parseInt(rec.pCount) || 0;
                    totalPatients += pCount;

                    if (rec.procs) Object.keys(rec.procs).forEach(pk => { if (procStats[pk] !== undefined) procStats[pk] += (parseInt(rec.procs[pk]) || 0); });

                    let cellContent = '-';
                    if (pCount > 0 || (rec.procs && Object.values(rec.procs).some(v => v > 0))) {
                        let details = [];
                        if (rec.procs) Object.keys(rec.procs).forEach(pk => { if (rec.procs[pk] > 0) details.push(`${pk.substr(0, 3)}:${rec.procs[pk]}`); });
                        cellContent = `<div class="flex flex-col items-center"><span class="font-bold text-blue-700">${pCount} H.</span><span class="text-[12px] text-gray-600 font-semibold">${details.join(', ')}</span></div>`;
                    }

                    // Veri HÃ¼cresi - KalÄ±n Ã‡erÃ§eve
                    h += `<td class="px-1 py-1 text-center border-2 border-gray-600 align-middle">${cellContent}</td>`;
                });

                // SatÄ±r Sonu Toplam - KalÄ±n Ã‡erÃ§eve
                h += `<td class="px-2 py-2 text-center font-bold text-blue-800 bg-blue-100 border-2 border-gray-600">${totalPatients}</td></tr>`;
                body.insertAdjacentHTML('beforeend', h);
            });

            // --- ALTAKÄ° KÃœÃ‡ÃœK "Ä°ÅLEM Ã–ZETÄ°" TABLOSU (Onu da Grid YapÄ±yoruz) ---
            const psBody = document.getElementById('procedure-stats-body');
            psBody.innerHTML = '';

            // Bu kÃ¼Ã§Ã¼k tablonun baÅŸlÄ±ÄŸÄ±nÄ± da (HTML'de) grid yapmak iÃ§in:
            const summaryTable = psBody.closest('table');
            if (summaryTable) {
                summaryTable.querySelectorAll('thead th').forEach(th => {
                    th.classList.add('border-2', 'border-gray-600');
                    th.classList.remove('bg-gray-50');
                    th.classList.add('bg-gray-200'); // BaÅŸlÄ±ÄŸÄ± biraz koyulaÅŸtÄ±r
                });
            }

            Object.keys(procStats).forEach((proc, idx) => {
                if (procStats[proc] > 0) {
                    const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
                    psBody.innerHTML += `<tr class="border-b-2 border-gray-600 ${bgClass}">
                    <td class="px-4 py-1.5 font-bold text-gray-700 border-2 border-gray-600 text-xs">${proc}</td>
                    <td class="px-4 py-1.5 text-center font-bold text-green-700 border-2 border-gray-600 text-xs">${procStats[proc]}</td>
                </tr>`;
                }
            });
        }

        function renderEntryForm() {
            const dateInput = safeGet('entry-date-picker'); if (!dateInput.value) dateInput.value = getLocalDateString(new Date());
            const l = document.getElementById('modal-staff-list'), dl = document.getElementById('modal-doctor-list'), tl = document.getElementById('modal-team-list'), date = dateInput.value;
            const data = allRecords[date] || {}, docData = docRecords[date] || {}; l.innerHTML = ''; dl.innerHTML = ''; tl.innerHTML = '';
            staffList.forEach(s => {
                const r = data[s.name] || { mm: 0, mk: 0, am: 0, ak: 0, e: 0, specialists: [] }; const id = s.name.replace(/\s/g, '');
                let specCheckboxes = ''; specialistList.forEach(sp => { const isM = r.specialists?.some(i => i.name === sp && i.time === 'Ã–Ã–'), isA = r.specialists?.some(i => i.name === sp && i.time === 'Ã–S'); specCheckboxes += `<div class="flex justify-between py-1 border-b border-gray-100 last:border-0"><span class="text-[10px] text-gray-600">${sp}</span><div class="flex gap-2"><label class="flex items-center gap-1"><input type="checkbox" class="specialist-checkbox" data-staff="${s.name}" data-spec="${sp}" data-time="Ã–Ã–" ${isM ? 'checked' : ''}><span class="text-[9px]">S</span></label><label class="flex items-center gap-1"><input type="checkbox" class="specialist-checkbox" data-staff="${s.name}" data-spec="${sp}" data-time="Ã–S" ${isA ? 'checked' : ''}><span class="text-[9px]">Ã–</span></label></div></div>`; });
                l.innerHTML += `<div class="mb-2 border rounded overflow-hidden"><div class="flex justify-between p-2 bg-white hover:bg-gray-50"><div class="flex items-center gap-2 w-32"><button class="bg-blue-50 text-blue-600 p-1 rounded" onclick="toggleSpecPanel('${id}')"><i data-lucide="stethoscope" class="w-4 h-4"></i></button><span class="text-xs font-bold text-gray-700 truncate">${s.name}</span></div><div class="flex-1 grid grid-cols-4 gap-1 justify-items-center"><div class="col-span-2 grid grid-cols-2 gap-1 bg-gray-50 p-1 rounded w-full justify-items-center"><input type="checkbox" id="mm-${id}" class="custom-checkbox" ${r.mm ? 'checked' : ''} title="Ã–Ã–-Merkez"><input type="checkbox" id="mk-${id}" class="custom-checkbox" style="accent-color:#f97316" ${r.mk ? 'checked' : ''} title="Ã–Ã–-KÃ¶y"></div><div class="col-span-2 grid grid-cols-2 gap-1 bg-gray-200 p-1 rounded w-full justify-items-center"><input type="checkbox" id="am-${id}" class="custom-checkbox" ${r.am ? 'checked' : ''} title="Ã–S-Merkez"><input type="checkbox" id="ak-${id}" class="custom-checkbox" style="accent-color:#f97316" ${r.ak ? 'checked' : ''} title="Ã–S-KÃ¶y"></div></div><div class="w-10 flex justify-center"><input type="checkbox" id="e-${id}" class="custom-checkbox exam-checkbox" ${r.e ? 'checked' : ''}></div><div class="w-16 flex justify-center text-[10px] text-gray-400" id="count-${id}">${r.specialists ? r.specialists.length : 0} Uzm.</div></div><div id="spec-panel-${id}" class="hidden bg-gray-50 p-2 border-t">${specCheckboxes}</div></div>`;
            });
            doctorList.forEach((doc, idx) => {
                const rec = docData[doc.name] || { pCount: '', procs: {} }; let procInputs = '';
                procList.forEach(p => { const val = rec.procs ? (rec.procs[p] || '') : ''; procInputs += `<div class="flex items-center justify-between"><span class="text-[10px] text-gray-600">${p}</span><input type="number" class="w-12 p-1 border rounded text-xs text-center doc-proc-input" data-doc="${doc.name}" data-proc="${p}" value="${val}" min="0"></div>`; });
                dl.innerHTML += `<div class="bg-white border rounded p-3 mb-2 shadow-sm"><div class="flex justify-between items-center mb-2 border-b pb-2"><span class="font-bold text-sm text-blue-800">${doc.name}</span><div class="flex items-center gap-2"><span class="text-xs font-bold text-gray-500">H:</span><input type="number" id="pcount-${idx}" class="w-12 p-1 border rounded text-sm text-center font-bold text-blue-600 doc-pcount" data-doc="${doc.name}" value="${rec.pCount}" min="0"></div></div><div class="grid grid-cols-2 gap-x-4 gap-y-2">${procInputs}</div></div>`;
            });
            if (teamList.length === 0) tl.innerHTML = '<p class="text-xs text-gray-400 text-center italic">HenÃ¼z liste/ekip tanÄ±mlanmamÄ±ÅŸ.<br>YÃ¶netim panelinden ekleyebilirsiniz.</p>';
            teamList.forEach((teamName, i) => {
                const assignedStaff = allRecords[date]?.teams?.[teamName] || [];
                let staffCheckboxes = '';
                staffList.forEach(s => { const isChecked = assignedStaff.includes(s.name) ? 'checked' : ''; staffCheckboxes += `<label class="flex items-center p-1 hover:bg-gray-50 rounded cursor-pointer"><input type="checkbox" class="team-staff-checkbox mr-2 accent-indigo-600" data-team="${teamName}" value="${s.name}" ${isChecked}><span class="text-xs text-gray-700">${s.name}</span></label>`; });
                tl.innerHTML += `<div class="bg-white border border-indigo-100 rounded-lg shadow-sm overflow-hidden mb-2"><div class="bg-indigo-50 px-3 py-2 flex justify-between items-center cursor-pointer" onclick="toggleTeamBody('team-body-${i}')"><span class="font-bold text-xs text-indigo-800">${teamName}</span><i data-lucide="chevron-down" class="w-3 h-3 text-indigo-400"></i></div><div id="team-body-${i}" class="p-2 max-h-40 overflow-y-auto hidden">${staffCheckboxes}</div></div>`;
            });
            document.getElementById('daily-note').value = allNotes[date] || ''; lucide.createIcons();
        }
        window.toggleSpecPanel = (id) => { document.getElementById(`spec-panel-${id}`).classList.toggle('hidden'); };
        window.toggleTeamBody = (id) => { document.getElementById(id).classList.toggle('hidden'); };

        function renderMgmtLists() {
            const sl = document.getElementById('staff-management-list'), dl = document.getElementById('doctor-management-list'), pl = document.getElementById('proc-management-list'), spl = document.getElementById('spec-management-list'), dsl = document.getElementById('doctor-staff-selection-list'), tml = document.getElementById('team-management-list');
            const makeList = (list, type) => list.length ? list.map((item, i) => `<div class="flex justify-between items-center p-2 bg-gray-50 border rounded mb-1 text-xs"><span>${typeof item === 'object' ? item.name : item}</span><div class="flex gap-1"><button onclick="moveItem('${type}', ${i}, -1)" class="text-gray-500 hover:text-blue-600"><i data-lucide="arrow-up" class="w-3 h-3"></i></button><button onclick="moveItem('${type}', ${i}, 1)" class="text-gray-500 hover:text-blue-600"><i data-lucide="arrow-down" class="w-3 h-3"></i></button><button type="button" data-action="delete" data-type="${type}" data-index="${i}" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-3 h-3 pointer-events-none"></i></button></div></div>`).join('') : '<div class="text-xs text-gray-400 text-center p-2">Liste boÅŸ</div>';
            if (sl) sl.innerHTML = makeList(staffList, 'staff');
            if (dl) dl.innerHTML = makeList(doctorList, 'doc');
            if (pl) pl.innerHTML = makeList(procList, 'proc');
            if (spl) spl.innerHTML = makeList(specialistList, 'spec');
            if (tml) tml.innerHTML = makeList(teamList, 'team');
            if (dsl) {
                let html = '';
                if (staffList.length > 0) html += staffList.map(s => `<label class="flex justify-between items-center p-1.5 hover:bg-white rounded cursor-pointer border border-transparent hover:border-gray-200 transition"><div class="flex items-center"><input type="checkbox" class="custom-checkbox mr-2" onchange="toggleStaffInDocList('${s.name}', this.checked)" ${doctorList.some(d => d.name === s.name) ? 'checked' : ''}><span class="text-xs text-gray-700 font-medium select-none">${s.name}</span></div><span class="text-[10px] text-blue-500 bg-blue-50 px-1 rounded">Personel</span></label>`).join('');
                if (quickList.length > 0) html += quickList.map((q, qIdx) => `<div class="flex justify-between items-center p-1.5 hover:bg-white rounded border border-transparent hover:border-gray-200 transition"><label class="flex items-center cursor-pointer flex-1"><input type="checkbox" class="custom-checkbox mr-2" onchange="toggleStaffInDocList('${q}', this.checked)" ${doctorList.some(d => d.name === q) ? 'checked' : ''}><span class="text-xs text-gray-700 font-medium select-none">${q}</span></label><button onclick="remQuickItem(${qIdx})" class="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-50 ml-2"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`).join('');
                dsl.innerHTML = html || '<div class="text-xs text-gray-400 p-2">Liste boÅŸ</div>';
            }
            lucide.createIcons();
        }

        // --- GÃœNCELLENMÄ°Å SEKME DEÄÄ°ÅTÄ°RME (Ã–ZEL PAROLA KORUMALI) ---

        // Kilitli sekmelerin aÃ§Ä±k kalma durumu (Ram'de tutulur)


        window.switchTab = (tabId) => {
            // 1. DÄ°NAMÄ°K GÃœVENLÄ°K KONTROLÃœ
            // EÄŸer bu sekme kilitlenecekler listesindeyse VE henÃ¼z aÃ§Ä±lmadÄ±ysa
            // window. ekleyerek global deÄŸiÅŸkenlere bakmasÄ±nÄ± saÄŸla
            if (window.lockedTabsConfig.includes(tabId) && !window.unlockedSessionTabs[tabId]) {
                // Sekme adÄ±nÄ± bulalÄ±m (Buton textinden)
                let tabName = tabId.toUpperCase();

                const input = prompt(`ğŸ”’ "${tabName}" sekmesi kilitli.\nEriÅŸim iÃ§in sekme parolasÄ±nÄ± girin:`);
                if (input === null) return; // Ä°ptal etti

                if (input !== customTabPassword) {
                    return showToast("HatalÄ± parola! EriÅŸim reddedildi.", "error");
                }

                // DoÄŸru ise bu oturum iÃ§in kilidi aÃ§
                window.unlockedSessionTabs[tabId] = true;
                showToast("EriÅŸim izni verildi.");
            }

            // 2. STANDART SEKME DEÄÄ°ÅTÄ°RME
            document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('border-indigo-600', 'text-indigo-700');
                b.classList.add('border-transparent', 'text-gray-500');
            });

            if (event && event.target) {
                const btn = event.target.closest('.tab-btn');
                if (btn) {
                    btn.classList.remove('border-transparent', 'text-gray-500');
                    btn.classList.add('border-indigo-600', 'text-indigo-700');
                }
            }

            const globalNav = document.getElementById('global-date-nav');
            if (globalNav) {
                if (tabId === 'butce' || tabId === 'analiz' || tabId === 'rutinler' || tabId === 'acilcanta' || tabId === 'notlar' || tabId === 'nobet' || tabId === 'cihazlar' || tabId === 'istatistik' || tabId === 'rehber' || tabId === 'takvim' || tabId === 'hastatakip' || tabId === 'puantaj' || tabId === 'inrhesaplayici') {
                    globalNav.classList.add('hidden');
                } else {
                    globalNav.classList.remove('hidden');
                }
            }

            // --- BURASI EKSÄ°KTÄ°, O YÃœZDEN BOÅ GELÄ°YORDU ---
            if (tabId === 'puantaj') renderPuantaj(); // <--- BU SATIR Ã‡OK Ã–NEMLÄ°

            if (tabId === 'uzman') renderSpecialistTab();
            if (tabId === 'rutinler' && typeof renderRoutines === 'function') renderRoutines();
            if (tabId === 'acilcanta') { renderBagSelector(); renderEmergency(); }
            if (tabId === 'butce') renderBudgetHeader();
            if (tabId === 'notlar') renderGeneralNotes();
            if (tabId === 'nobet') renderShiftHeader();
            if (tabId === 'cihazlar') renderDeviceTable();
            if (tabId === 'istatistik') renderDashboard();
            if (tabId === 'hastatakip') renderReminderProcs();
            if (tabId === 'rehber') renderPhonebook();
            if (tabId === 'takvim') renderCalendar();
        };

        function setupEventListeners() {
            setupKeyboardShortcuts(); //
            const em = document.getElementById('data-entry-modal'), sm = document.getElementById('staff-modal'), pm = document.getElementById('password-modal');
            const toggle = (m, s) => { m.classList.toggle('hidden', !s); m.classList.toggle('flex', s); };

            safeGet('open-entry-modal-btn').onclick = () => checkLock(() => { toggle(em, 1); renderEntryForm(); });
            safeGet('open-staff-modal-btn').onclick = () => checkLock(() => { toggle(sm, 1); renderMgmtLists(); });
            document.querySelectorAll('.close-modal,.close-staff-modal').forEach(b => b.onclick = () => { toggle(em, 0); toggle(sm, 0); });

            safeGet('save-entry-btn').onclick = async () => {
                const date = document.getElementById('entry-date-picker').value; if (!date) return showToast('Tarih?', 'error');
                if (!allRecords[date]) allRecords[date] = {};
                staffList.forEach(s => {
                    const id = s.name.replace(/\s/g, '');
                    const entry = { mm: document.getElementById(`mm-${id}`).checked ? 1 : 0, mk: document.getElementById(`mk-${id}`).checked ? 1 : 0, am: document.getElementById(`am-${id}`).checked ? 1 : 0, ak: document.getElementById(`ak-${id}`).checked ? 1 : 0, e: document.getElementById(`e-${id}`).checked ? 1 : 0, specialists: [] };
                    const specPanel = document.getElementById(`spec-panel-${id}`);
                    if (specPanel) specPanel.querySelectorAll('.specialist-checkbox').forEach(cb => { if (cb.checked) entry.specialists.push({ name: cb.dataset.spec, time: cb.dataset.time }); });
                    allRecords[date][s.name] = entry;
                });
                if (!docRecords[date]) docRecords[date] = {};
                document.querySelectorAll('.doc-pcount').forEach(inp => {
                    const docName = inp.dataset.doc; const procs = {};
                    document.querySelectorAll(`.doc-proc-input[data-doc="${docName}"]`).forEach(pi => procs[pi.dataset.proc] = pi.value);
                    docRecords[date][docName] = { pCount: inp.value, procs };
                });
                if (!allRecords[date].teams) allRecords[date].teams = {};
                const teamTemp = {};
                document.querySelectorAll('.team-staff-checkbox').forEach(cb => { if (cb.checked) { if (!teamTemp[cb.dataset.team]) teamTemp[cb.dataset.team] = []; teamTemp[cb.dataset.team].push(cb.value); } });
                allRecords[date].teams = teamTemp;

                const note = document.getElementById('daily-note').value; if (note) allNotes[date] = note; else delete allNotes[date];
                await saveAll(); showToast('Kaydedildi'); toggle(em, 0);
            };

            safeGet('add-staff-btn').onclick = async () => { const n = safeGet('new-staff-name').value.trim(); const r = safeGet('new-staff-role').value.trim() || 'Personel'; if (n) { staffList.push({ name: n, role: r }); await saveAll(); renderMgmtLists(); safeGet('new-staff-name').value = ''; showToast('Personel eklendi'); } };
            safeGet('add-doctor-btn').onclick = async () => { const n = safeGet('new-doctor-name').value.trim(); if (n) { doctorList.push({ name: n }); await saveAll(); renderMgmtLists(); safeGet('new-doctor-name').value = ''; showToast('Doktor eklendi'); } };
            safeGet('add-proc-btn').onclick = async () => { const n = safeGet('new-proc-name').value.trim(); if (n) { procList.push(n); await saveAll(); renderMgmtLists(); safeGet('new-proc-name').value = ''; showToast('Ä°ÅŸlem eklendi'); } };
            safeGet('add-spec-btn').onclick = async () => { const n = safeGet('new-spec-name').value.trim(); if (n) { specialistList.push(n); await saveAll(); renderMgmtLists(); safeGet('new-spec-name').value = ''; showToast('UzmanlÄ±k eklendi'); } };
            safeGet('add-team-btn').onclick = async () => { const n = safeGet('new-team-name').value.trim(); if (n) { teamList.push(n); await saveAll(); renderMgmtLists(); safeGet('new-team-name').value = ''; showToast('Ekip eklendi'); } };
            safeGet('add-leave-btn').onclick = async () => {
                const sName = safeGet('leave-staff-input').value.trim(), type = safeGet('leave-type-select').value, sDate = safeGet('leave-start-date').value, eDate = safeGet('leave-end-date').value;
                if (!sName || !sDate || !eDate) { showToast('Eksik bilgi', 'error'); return; }
                leaveRecords.push({ staffName: sName, type: type, startDate: sDate, endDate: eDate }); await saveAll(); showToast('Ä°zin eklendi');
            };

            document.addEventListener('click', (e) => { const btn = e.target.closest('button[data-action="delete"]'); if (btn) { const type = btn.dataset.type; const idx = parseInt(btn.dataset.index); remItem(type, idx); } });

            safeGet('lock-toggle').onclick = () => { if (isEditing) { isEditing = false; updateLockUI(); } else { toggle(pm, 1); document.getElementById('password-input').focus(); } };
            safeGet('modal-submit').onclick = () => { if (document.getElementById('password-input').value === adminPanelPassword) { isEditing = true; updateLockUI(); toggle(pm, 0); document.getElementById('password-input').value = ''; } else document.getElementById('password-error').classList.remove('hidden'); };
            safeGet('modal-cancel').onclick = () => { toggle(pm, 0); document.getElementById('password-input').value = ''; };
            safeGet('prev-week').onclick = () => changeWeek(-7); safeGet('next-week').onclick = () => changeWeek(7);
            safeGet('entry-date-picker').onchange = renderEntryForm;
            safeGet('import-file').onchange = importData;
            document.querySelectorAll('.close-note-modal').forEach(b => b.onclick = () => { document.getElementById('note-read-modal').classList.add('hidden'); document.getElementById('note-read-modal').classList.remove('flex'); });

            safeGet('btn-open-settings').onclick = openSettingsModal;
            safeGet('btn-close-settings').onclick = closeSettingsModal;
            safeGet('btn-save-api-key').onclick = saveApiKey;
            safeGet('btn-change-password').onclick = openPwModal;
            safeGet('btn-close-pw').onclick = closePwModal;
            safeGet('btn-save-pw').onclick = saveNewPw;
            safeGet('btn-ai-report').onclick = generateAIReport;
            safeGet('btn-close-ai-header').onclick = closeAiModal;
            safeGet('btn-run-analysis').onclick = runAnalysis;
            const btnSend = document.getElementById('btn-send-ai-query'); if (btnSend) btnSend.onclick = sendAIQuery;
            const inputAI = document.getElementById('ai-user-input'); if (inputAI) inputAI.addEventListener('keypress', function (e) { if (e.key === 'Enter') sendAIQuery(); });
        }

        function runAnalysis() {
            const sDate = document.getElementById('analysis-start').value, eDate = document.getElementById('analysis-end').value, filterVal = document.getElementById('analysis-filter').value;
            if (!sDate || !eDate) return showToast("Tarih seÃ§in", "error");

            // --- NÃ–BET ANALÄ°ZÄ° BLOÄU (GÃœNCELLENMÄ°Å) ---
            if (filterVal === 'shift_stats') {
                document.getElementById('standard-analysis-container').classList.add('hidden');
                document.getElementById('leave-analysis-container').classList.add('hidden');

                const detContainer = document.getElementById('specialist-detail-container');
                detContainer.classList.remove('hidden');

                const headerEl = detContainer.firstElementChild;
                if (headerEl) {
                    headerEl.className = "bg-indigo-50 px-4 py-3 border-b border-indigo-100 font-bold text-indigo-900 flex items-center";
                    headerEl.innerHTML = '<i data-lucide="calendar-clock" class="w-5 h-5 mr-2"></i> NÃ¶bet Performans Raporu';
                }

                const detBody = document.getElementById('specialist-detail-body');
                detBody.innerHTML = '';

                const stats = {};
                // 1. Ã–nce tarihleri kronolojik sÄ±raya dizelim (KarmaÅŸayÄ± Ã¶nler)
                const filteredShifts = shiftList
                    .filter(s => s.date >= sDate && s.date <= eDate)
                    .sort((a, b) => a.date.localeCompare(b.date));

                if (filteredShifts.length === 0) {
                    detBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda nÃ¶bet kaydÄ± bulunmamaktadÄ±r.</td></tr>';
                    return;
                }

                filteredShifts.forEach(s => {
                    let cleanStaff = s.staff ? s.staff.trim() : "Bilinmeyen";
                    if (!stats[cleanStaff]) stats[cleanStaff] = {};
                    if (!stats[cleanStaff][s.type]) stats[cleanStaff][s.type] = { count: 0, dates: [] };

                    stats[cleanStaff][s.type].count++;

                    const dObj = new Date(s.date);
                    // GÃ¼n adÄ±nÄ± kÄ±saltÄ±lmÄ±ÅŸ al (Pzt, Sal, Ã‡ar...)
                    const dayName = dObj.toLocaleDateString('tr-TR', { weekday: 'short' });
                    const dateStr = `${dObj.getDate()}/${dObj.getMonth() + 1}`;

                    // ÅÄ±k bir etiket oluÅŸtur (Tarih + GÃ¼n)
                    const badgeHtml = `
                    <span class="inline-flex items-center gap-1 bg-gray-50 border border-gray-200 text-gray-700 px-1.5 py-0.5 rounded text-[10px] mx-0.5 mb-1 whitespace-nowrap shadow-sm hover:bg-indigo-50 hover:border-indigo-200 transition">
                        <span class="font-bold">${dateStr}</span>
                        <span class="text-indigo-600 text-[9px] border-l border-gray-300 pl-1">${dayName}</span>
                    </span>`;

                    stats[cleanStaff][s.type].dates.push(badgeHtml);
                });

                Object.keys(stats).sort().forEach(staff => {
                    const types = stats[staff];
                    Object.keys(types).forEach(type => {
                        const data = types[type];
                        detBody.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b-2 border-gray-600">
                            <td class="px-4 py-2 font-bold text-gray-700 border-2 border-gray-600 text-xs">${staff}</td>
                            <td class="px-4 py-2 text-gray-600 border-2 border-gray-600 text-xs font-medium">${type}</td>
                            <td class="px-4 py-2 text-center font-extrabold text-indigo-700 border-2 border-gray-600 text-sm bg-indigo-50/30">${data.count}</td>
                            <td class="px-4 py-2 text-[10px] text-gray-500 leading-relaxed border-2 border-gray-600 flex flex-wrap gap-0.5 items-center">
                                ${data.dates.join('')}
                            </td>
                        </tr>
                    `;
                    });
                });
                lucide.createIcons();
                return;
            }

            // -----------------------------------------------------
            // --- STANDART ANALÄ°Z BAÅLIYOR ---
            document.getElementById('analysis-results').classList.remove('hidden');

            // !!! BURASI YENÄ°: Sabit HTML BaÅŸlÄ±klarÄ±nÄ± JS ile Zorla KalÄ±nlaÅŸtÄ±r !!!
            setTimeout(() => {
                document.querySelectorAll('#standard-analysis-container table thead th').forEach(th => {
                    th.classList.add('border-2', 'border-gray-600');
                    th.classList.remove('border-b'); // Eski ince Ã§izgiyi sil
                });
            }, 50); // HTML render olduktan hemen sonra Ã§alÄ±ÅŸsÄ±n

            const dRange = []; let curr = new Date(sDate); const end = new Date(eDate);
            while (curr <= end) { dRange.push(getLocalDateString(curr)); curr.setDate(curr.getDate() + 1); }

            // --- Ä°ZÄ°N RAPORU ---
            if (filterVal === 'leave_report') {
                document.getElementById('standard-analysis-container').classList.add('hidden');
                document.getElementById('leave-analysis-container').classList.remove('hidden'); document.getElementById('specialist-detail-container').classList.add('hidden');

                // Ä°zin Tablosu BaÅŸlÄ±klarÄ±nÄ± KalÄ±nlaÅŸtÄ±r
                const leaveTable = document.querySelector('#leave-analysis-container table');
                if (leaveTable) leaveTable.querySelectorAll('thead th').forEach(th => th.classList.add('border-2', 'border-gray-600'));

                const tbody = document.getElementById('leave-analysis-body'); tbody.innerHTML = '';
                const filteredLeaves = leaveRecords.filter(l => { return (l.startDate <= eDate && l.endDate >= sDate); }).sort((a, b) => a.startDate.localeCompare(b.startDate));

                if (filteredLeaves.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda izin/rapor kaydÄ± bulunamadÄ±.</td></tr>';
                } else {
                    filteredLeaves.forEach(l => {
                        const s = new Date(l.startDate), e = new Date(l.endDate), diffDays = Math.ceil(Math.abs(e - s) / (1000 * 60 * 60 * 24)) + 1; const typeClass = l.type === 'Rapor' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700';
                        // Ä°zin Tablosu HÃ¼creleri (Grid)
                        tbody.innerHTML += `<tr class="border-b-2 border-gray-600 hover:bg-gray-50"><td class="px-4 py-3 font-medium text-gray-700 border-2 border-gray-600">${l.staffName}</td><td class="px-4 py-3 text-center border-2 border-gray-600"><span class="px-2 py-1 rounded text-xs font-bold ${typeClass}">${l.type}</span></td><td class="px-4 py-3 text-center text-gray-600 border-2 border-gray-600">${s.toLocaleDateString('tr-TR')}</td><td class="px-4 py-3 text-center text-gray-600 border-2 border-gray-600">${e.toLocaleDateString('tr-TR')}</td><td class="px-4 py-3 text-center font-bold text-gray-700 border-2 border-gray-600">${diffDays} GÃ¼n</td></tr>`;
                    });
                }
                return;
            }

            // --- GENEL GÃ–RÃœNÃœM ---
            document.getElementById('standard-analysis-container').classList.remove('hidden'); document.getElementById('leave-analysis-container').classList.add('hidden');

            // UZMANLIK DETAY TABLOSU
            if (filterVal === 'all_specialists') {
                document.getElementById('specialist-detail-container').classList.remove('hidden');
                const detBody = document.getElementById('specialist-detail-body');
                detBody.innerHTML = ''; const detailMap = {};

                // BaÅŸlÄ±klarÄ± kalÄ±nlaÅŸtÄ±r
                document.querySelectorAll('#specialist-detail-container table th').forEach(th => th.classList.add('border-2', 'border-gray-600'));

                staffList.forEach(s => { dRange.forEach(dStr => { const r = allRecords[dStr]?.[s.name]; if (r && r.specialists && r.specialists.length > 0) { if (!detailMap[s.name]) detailMap[s.name] = {}; r.specialists.forEach(sp => { if (!detailMap[s.name][sp.name]) { detailMap[s.name][sp.name] = { count: 0, items: [] }; } const dObj = new Date(dStr); const timeLabel = sp.time === 'Ã–Ã–' ? 'S' : 'Ã–'; const timeColor = sp.time === 'Ã–Ã–' ? 'text-blue-600' : 'text-orange-600'; detailMap[s.name][sp.name].count++; detailMap[s.name][sp.name].items.push(`<span class="${timeColor} font-semibold">${dObj.getDate()}/${dObj.getMonth() + 1}(${timeLabel})</span>`); }); } }); });
                let hasData = false;
                Object.keys(detailMap).sort().forEach(sName => {
                    Object.keys(detailMap[sName]).sort().forEach(spName => {
                        hasData = true; const data = detailMap[sName][spName];
                        detBody.innerHTML += `<tr class="hover:bg-gray-50 border-b-2 border-gray-600"><td class="px-4 py-2 font-medium text-gray-700 border-2 border-gray-600">${sName}</td><td class="px-4 py-2 text-gray-600 border-2 border-gray-600">${spName}</td><td class="px-4 py-2 text-center font-bold text-purple-700 border-2 border-gray-600">${data.count}</td><td class="px-4 py-2 text-xs text-gray-500 leading-relaxed border-2 border-gray-600">${data.items.join(', ')}</td></tr>`;
                    });
                });
                if (!hasData) detBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400 border-2 border-gray-600">Bu tarih aralÄ±ÄŸÄ±nda uzman eÅŸleÅŸmesi bulunamadÄ±.</td></tr>';
            } else { document.getElementById('specialist-detail-container').classList.add('hidden'); }

            // --- VERÄ° HESAPLAMA (ANA TABLO) ---
            const stats = staffList.map(s => { let t = 0; dRange.forEach(d => { const r = allRecords[d]?.[s.name]; if (r) { if (filterVal === 'all') { const specCount = r.specialists ? r.specialists.length : 0; t += r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount; } else if (filterVal.startsWith('spec_')) { const specName = filterVal.replace('spec_', ''); if (r.specialists) { t += r.specialists.filter(sp => sp.name === specName).length; } } else if (filterVal === 'all_specialists') { t += r.specialists ? r.specialists.length : 0; } } }); return { name: s.name, t }; });
            let staffColHeader = "Toplam SayÄ±"; if (filterVal.startsWith('spec_')) staffColHeader += ` (${filterVal.replace('spec_', '')})`; else if (filterVal === 'all_specialists') staffColHeader = "Toplam UzmanlÄ±k";
            document.getElementById('analysis-staff-col-header').innerText = staffColHeader;

            const mode = calculateMode(stats.map(s => s.t));
            const statBody = document.getElementById('analysis-stats-body');
            statBody.innerHTML = '';

            if (filterVal === 'all' || filterVal.startsWith('spec_') || filterVal === 'all_specialists') {
                stats.forEach((st, idx) => {
                    const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
                    // ANA Ã–ZET TABLOSU (Grid)
                    statBody.innerHTML += `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 border-2 border-gray-600 font-bold text-gray-700">${st.name}</td><td class="px-4 py-2 text-center font-bold border-2 border-gray-600">${st.t}</td><td class="px-4 py-2 text-center border-2 border-gray-600">${filterVal === 'all' ? getStatusHtml(st.t, mode) : '-'}</td></tr>`;
                });
            } else { statBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-400 text-xs border-2 border-gray-600">Bu filtre iÃ§in personel verisi bulunmamaktadÄ±r.</td></tr>'; }

            // --- GÃœNLÃœK DETAY (Ã‡ARÅAF) TABLOSU ---
            const hRow = document.getElementById('analysis-table-head'), bRow = document.getElementById('analysis-table-body');
            hRow.querySelectorAll('th:not(.sticky-col-1)').forEach(e => e.remove()); bRow.innerHTML = '';

            // Detay Tablosu BaÅŸlÄ±k Stili
            const stickyTh = hRow.querySelector('.sticky-col-1');
            if (stickyTh) { stickyTh.classList.add('border-2', 'border-gray-600', 'bg-gray-200'); stickyTh.classList.remove('bg-gray-100'); }

            if (filterVal === 'all' || filterVal.startsWith('spec_') || filterVal === 'all_specialists') {
                dRange.forEach(dStr => {
                    const d = new Date(dStr);
                    // Detay Tablosu GÃ¼n BaÅŸlÄ±klarÄ± (Grid)
                    hRow.insertAdjacentHTML('beforeend', `<th class="px-2 py-1 bg-gray-200 text-center min-w-[60px] text-[10px] border-2 border-gray-600 font-bold text-gray-700">${days[d.getDay() - 1]}<br>${d.getDate()}/${d.getMonth() + 1}</th>`);
                });
                staffList.forEach((s, idx) => {
                    const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
                    // Detay Tablosu SatÄ±rlarÄ± (Grid)
                    let h = `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 sticky-col-1 ${bgClass} border-2 border-gray-600 text-xs font-bold text-gray-800 shadow-sm">${s.name}</td>`;
                    dRange.forEach(dStr => {
                        const d = new Date(dStr); const r = allRecords[dStr]?.[s.name] || { mm: 0, mk: 0, am: 0, ak: 0, e: 0, specialists: [] };
                        let sum = 0; if (filterVal === 'all') { const specCount = r.specialists ? r.specialists.length : 0; sum = r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount; } else if (filterVal.startsWith('spec_')) { const specName = filterVal.replace('spec_', ''); if (r.specialists) sum = r.specialists.filter(sp => sp.name === specName).length; } else if (filterVal === 'all_specialists') { sum = r.specialists ? r.specialists.length : 0; }
                        // Detay Tablosu HÃ¼creleri (Grid)
                        h += `<td class="px-1 text-center text-xs border-2 border-gray-600 ${sum ? 'text-indigo-600 font-extrabold' : 'text-gray-300'}">${sum || '-'}</td>`;
                    }); bRow.insertAdjacentHTML('beforeend', h + `</tr>`);
                });
            } else { bRow.innerHTML = '<tr><td class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">Bu filtre iÃ§in detay verisi gÃ¶sterilmemektedir.</td></tr>'; }

            // --- DOKTOR PERFORMANS TABLOSU ---
            const docStatsBody = document.getElementById('analysis-doctor-stats-body'), procStatsBody = document.getElementById('analysis-proc-stats-body');
            docStatsBody.innerHTML = ''; procStatsBody.innerHTML = ''; const periodProcStats = {}; procList.forEach(p => periodProcStats[p] = 0);
            let docHeader = "SayÄ±";
            if (filterVal === 'doc_counts') docHeader = "Hasta SayÄ±sÄ±"; else if (filterVal.startsWith('proc_')) docHeader = filterVal.replace('proc_', '');
            document.getElementById('analysis-doc-col-header').innerText = docHeader;
            let docIdx = 0;

            if (!filterVal.startsWith('spec_') && filterVal !== 'all_specialists') {
                doctorList.forEach((doc) => {
                    let valToShow = 0;
                    dRange.forEach(d => {
                        const r = docRecords[d]?.[doc.name];
                        if (r) {
                            if (filterVal === 'all' || filterVal === 'doc_counts') valToShow += parseInt(r.pCount) || 0;
                            else if (filterVal.startsWith('proc_')) { const pName = filterVal.replace('proc_', ''); valToShow += parseInt(r.procs?.[pName]) || 0; }
                            if (filterVal === 'all' && r.procs) { Object.keys(r.procs).forEach(pk => { const v = parseInt(r.procs[pk]) || 0; if (periodProcStats[pk] !== undefined) periodProcStats[pk] += v; }); }
                        }
                    });
                    const bgClass = (docIdx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
                    // DOKTOR TABLOSU (Grid)
                    docStatsBody.innerHTML += `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 font-medium border-2 border-gray-600">${doc.name}</td><td class="px-4 py-2 text-center text-blue-600 font-bold border-2 border-gray-600">${valToShow}</td></tr>`; docIdx++;
                });
            } else { docStatsBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">Bu filtre iÃ§in doktor verisi bulunmamaktadÄ±r.</td></tr>'; }

            // --- Ä°ÅLEM DAÄILIM TABLOSU ---
            if (filterVal === 'all') {
                let procIdx = 0;
                Object.keys(periodProcStats).forEach((proc) => {
                    if (periodProcStats[proc] > 0) {
                        const bgClass = (procIdx % 2 === 0) ? 'bg-white' : 'bg-gray-100';
                        // Ä°ÅLEM TABLOSU (Grid)
                        procStatsBody.innerHTML += `<tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600"><td class="px-4 py-2 font-medium border-2 border-gray-600">${proc}</td><td class="px-4 py-2 text-center font-bold text-green-600 border-2 border-gray-600">${periodProcStats[proc]}</td></tr>`; procIdx++;
                    }
                });
            } else { procStatsBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-gray-400 text-xs border-2 border-gray-600">Sadece "TÃ¼mÃ¼" seÃ§eneÄŸinde genel daÄŸÄ±lÄ±m gÃ¶sterilir.</td></tr>'; }
        }

        function checkLock(cb) { if (isEditing) cb(); else document.getElementById('lock-toggle').click(); }
        function renderStats() {
            const tbody = document.getElementById('stats-body');
            tbody.innerHTML = '';

            // --- BAÅLIKLARI GÃœNCELLEME (Otomatik) ---
            // Tablo baÅŸlÄ±ÄŸÄ± HTML'de sabit olduÄŸu iÃ§in, bÃ¼tÃ¼nlÃ¼k bozulmasÄ±n diye buradan mÃ¼dahale ediyoruz.
            const table = tbody.closest('table');
            if (table) {
                table.querySelectorAll('thead th').forEach(th => {
                    th.classList.add('border-2', 'border-gray-600'); // KalÄ±n Ã§erÃ§eve ekle
                    th.classList.remove('border-b'); // Eski ince Ã§izgiyi kaldÄ±r
                });
            }

            // --- HESAPLAMALAR ---
            const mStr = getLocalDateString(new Date()).slice(0, 7);
            const wDates = Object.values(getWeekDates(currentWeekStart));

            const stats = staffList.map(staff => {
                let w = 0, m = 0;
                Object.keys(allRecords).forEach(d => {
                    const r = allRecords[d][staff.name];
                    if (r) {
                        const specCount = r.specialists ? r.specialists.length : 0;
                        const v = r.mm + r.mk + r.am + r.ak + (r.e * 2) + specCount;
                        if (wDates.includes(d)) w += v;
                        if (d.startsWith(mStr)) m += v;
                    }
                });
                return { name: staff.name, w, m };
            });

            const wMode = calculateMode(stats.map(s => s.w));
            const mMode = calculateMode(stats.map(s => s.m));

            const elW = document.getElementById('weekly-mode-target');
            const elM = document.getElementById('monthly-mode-target');
            if (elW) elW.innerText = wMode;
            if (elM) elM.innerText = mMode;

            // --- SATIRLARI OLUÅTUR ---
            stats.forEach((st, idx) => {
                const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-100';

                // BURASI DEÄÄ°ÅTÄ°: Her hÃ¼creye (td) ve satÄ±ra (tr) kalÄ±n Ã§erÃ§eve (border-2 border-gray-600)
                tbody.innerHTML += `
            <tr class="${bgClass} hover:bg-gray-200 border-b-2 border-gray-600">
                <td class="px-4 py-2 font-bold text-gray-700 text-sm border-2 border-gray-600">${st.name}</td>
                <td class="px-4 py-2 text-center font-bold text-gray-700 bg-blue-50 text-xs border-2 border-gray-600">${st.w}</td>
                <td class="px-4 py-2 text-center border-2 border-gray-600">${getStatusHtml(st.w, wMode)}</td>
                <td class="px-4 py-2 text-center font-bold text-indigo-700 bg-purple-50 text-xs border-2 border-gray-600">${st.m}</td>
                <td class="px-4 py-2 text-center border-2 border-gray-600">${getStatusHtml(st.m, mMode)}</td>
            </tr>`;
            });
        }

        function renderSpecialistTab() {
            // --- 1. TABLO (ÃœST KISIM): HAFTALIK GÃœNLÃœK DETAY ---

            // BaÅŸlÄ±ÄŸÄ± Dinamik Olarak GÃ¼ncelle
            const titleEl = document.querySelector('#tab-uzman h2');
            if (titleEl) titleEl.innerText = "Uzman Birim EÅŸleÅŸme Ã‡izelgesi (HaftalÄ±k)";

            const thead = document.querySelector('#specialist-table thead');
            const tbody = document.getElementById('specialist-body');

            if (thead && tbody) {
                thead.innerHTML = '';

                // Tablo BaÅŸlÄ±klarÄ±
                let headerRow = `<tr class="bg-gray-100 border-b"><th class="px-4 py-3 text-xs font-semibold text-gray-600 uppercase bg-gray-50 border-r sticky-col-1 border-2 border-gray-600">Tarih</th>`;
                specialistList.forEach(spec => {
                    headerRow += `<th class="px-4 py-3 text-xs font-bold text-gray-700 uppercase text-center border-l min-w-[120px] border-2 border-gray-600">${spec}</th>`;
                });
                headerRow += `</tr>`;
                thead.innerHTML = headerRow;

                tbody.innerHTML = '';

                // SEÃ‡Ä°LÄ° HAFTANIN TARÄ°HLERÄ°NÄ° OLUÅTUR (7 GÃœN)
                const dates = [];
                let tempDate = new Date(currentWeekStart);
                for (let i = 0; i < 7; i++) {
                    dates.push(getLocalDateString(tempDate));
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                dates.forEach((d, index) => {
                    const bgClass = (index % 2 === 0) ? 'bg-white' : 'bg-gray-100';

                    // Tarih Formatlama (Ã–rn: 22 AralÄ±k Pazartesi)
                    const dateObj = new Date(d);
                    const dateStr = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });

                    // Hafta sonu kontrolÃ¼ (Renklendirme iÃ§in)
                    const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                    const dateClass = isWeekend ? 'text-red-600 font-bold' : 'text-gray-700 font-medium';

                    let row = `<tr class="${bgClass} border-b-2 border-gray-600 hover:bg-indigo-50">
                    <td class="px-4 py-2 text-xs ${dateClass} whitespace-nowrap ${bgClass} sticky-col-1 border-r border-2 border-gray-600">${dateStr}</td>`;

                    specialistList.forEach(spec => {
                        let content = '-';
                        // TÃ¼m personeli tara, o gÃ¼n o uzmanlÄ±kta kim var bul
                        staffList.forEach(s => {
                            const r = allRecords[d] ? allRecords[d][s.name] : null;
                            if (r && r.specialists) {
                                r.specialists.forEach(sp => {
                                    if (sp.name === spec) {
                                        const timeText = sp.time === 'Ã–Ã–' ? 'SABAH' : 'Ã–ÄLEN';
                                        const timeColor = sp.time === 'Ã–Ã–' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-orange-50 text-orange-700 border-orange-200';

                                        const newContent = `<div class="mb-1 bg-white border rounded p-1 shadow-sm flex items-center justify-between gap-2">
                                        <span class="font-bold text-gray-800 block text-[10px] truncate">${s.name}</span> 
                                        <span class="text-[9px] px-1.5 py-0.5 rounded-full font-bold border ${timeColor}">${timeText}</span>
                                    </div>`;

                                        if (content === '-') content = newContent; else content += newContent;
                                    }
                                });
                            }
                        });
                        row += `<td class="px-2 py-2 text-center text-xs border-l border-2 border-gray-600 align-top">${content}</td>`;
                    });
                    row += `</tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }

            // --- 2. YENÄ° HAFTALIK Ã–ZET TABLO (ALT KISIM) ---
            // (BurasÄ± zaten haftalÄ±ktÄ±, sadece 7 gÃ¼n kuralÄ±na uyduÄŸundan emin oluyoruz)
            const weeklyBody = document.getElementById('weekly-spec-body');
            const weeklyHead = document.querySelector('#weekly-spec-table thead');

            if (weeklyBody && weeklyHead) {
                weeklyBody.innerHTML = '';
                weeklyHead.innerHTML = '';

                const startD = typeof currentWeekStart !== 'undefined' ? currentWeekStart : new Date();
                // HaftanÄ±n tarihlerini hesapla (7 gÃ¼n)
                const weekDatesObj = {};
                const daysArr = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
                let tDate = new Date(startD);
                for (let i = 0; i < 7; i++) {
                    weekDatesObj[daysArr[i]] = getLocalDateString(tDate);
                    tDate.setDate(tDate.getDate() + 1);
                }

                // BAÅLIK
                let wHeader = `<tr class="bg-gray-800 text-white border-b border-gray-600"><th class="px-4 py-3 text-xs font-bold uppercase sticky-col-1 bg-gray-800 border-r border-gray-500 text-left">Personel</th>`;
                if (specialistList && specialistList.length > 0) {
                    specialistList.forEach(sp => {
                        wHeader += `<th class="px-2 py-3 text-center border-r border-gray-600 text-xs min-w-[100px]">${sp}</th>`;
                    });
                } else {
                    wHeader += `<th class="px-2 py-3 text-center text-xs">UzmanlÄ±k Yok</th>`;
                }
                wHeader += '</tr>';
                weeklyHead.innerHTML = wHeader;

                // GÃ–VDE
                if (staffList && staffList.length > 0) {
                    staffList.forEach((s, idx) => {
                        const rowBg = (idx % 2 === 0) ? 'bg-gray-300' : 'bg-gray-100';
                        const borderColor = 'border-gray-400';

                        let rowHtml = `<tr class="${rowBg} border-b ${borderColor} hover:bg-indigo-200 transition">`;
                        rowHtml += `<td class="px-4 py-3 font-bold text-gray-900 text-xs sticky-col-1 ${rowBg} border-r ${borderColor}">${s.name}</td>`;

                        if (specialistList && specialistList.length > 0) {
                            specialistList.forEach(sp => {
                                let count = 0;
                                let dateDetails = [];

                                Object.entries(weekDatesObj).forEach(([dayName, dateStr]) => {
                                    if (allRecords[dateStr] && allRecords[dateStr][s.name]) {
                                        const r = allRecords[dateStr][s.name];
                                        if (r.specialists && Array.isArray(r.specialists)) {
                                            const matches = r.specialists.filter(item => item.name === sp);
                                            if (matches.length > 0) {
                                                count += matches.length;
                                                const dObj = new Date(dateStr);
                                                const shortDate = `${dObj.getDate()}/${dObj.getMonth() + 1}`;
                                                const shortDay = dayName.slice(0, 3);
                                                dateDetails.push(`${shortDate} ${shortDay}`);
                                            }
                                        }
                                    }
                                });

                                let cellContent = '';
                                if (count > 0) {
                                    cellContent = `
                                    <div class="flex flex-col items-center justify-center gap-1">
                                        <span class="font-extrabold text-white text-xs bg-indigo-600 px-3 py-1 rounded shadow-sm">${count}</span>
                                        <span class="text-[9px] text-gray-700 font-bold text-center leading-tight bg-white/50 px-1 py-0.5 rounded border border-gray-300 w-full">
                                            ${dateDetails.join('<br>')}
                                        </span>
                                    </div>
                                `;
                                } else {
                                    cellContent = `<span class="text-gray-400 font-bold opacity-50">-</span>`;
                                }
                                rowHtml += `<td class="px-2 py-3 text-center border-r ${borderColor} align-middle">${cellContent}</td>`;
                            });
                        } else {
                            rowHtml += `<td class="px-2 py-3 text-center text-gray-500 italic">-</td>`;
                        }
                        rowHtml += '</tr>';
                        weeklyBody.insertAdjacentHTML('beforeend', rowHtml);
                    });
                } else {
                    weeklyBody.innerHTML = `<tr><td colspan="${specialistList.length + 1}" class="p-6 text-center text-gray-500 font-bold bg-gray-100">Personel listesi boÅŸ.</td></tr>`;
                }
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        window.openNoteModal = (dateStr) => { const modal = document.getElementById('note-read-modal'); const noteContent = allNotes[dateStr] || "Not bulunamadÄ±."; const d = new Date(dateStr); document.getElementById('note-read-date').innerText = d.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('note-read-content').innerText = noteContent; modal.classList.remove('hidden'); modal.classList.add('flex'); };
        function updateLockUI() { const b = document.getElementById('lock-toggle'), i = document.getElementById('lock-icon'), t = document.getElementById('lock-status'); if (isEditing) { b.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-700"; i.setAttribute('data-lucide', 'unlock'); t.innerText = "AÃ§Ä±k"; } else { b.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-red-100 text-red-700"; i.setAttribute('data-lucide', 'lock'); t.innerText = "Kilitli"; } lucide.createIcons(); }
        function showToast(m, t = 's') { const b = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; b.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => b.classList.add('translate-y-20', 'opacity-0'), 3000); }
        function formatDateTR(dStr) { return new Date(dStr).toLocaleDateString('tr-TR'); }
        function getWeekDates(d) {
            const m = new Date(d), day = m.getDay(), diff = m.getDate() - day + (day === 0 ? -6 : 1); const dates = {}; const monday = new Date(m.setDate(diff)); for (let i = 0; i < 7; i++) {
                const temp = new Date(monday);
                temp.setDate(monday.getDate() + i);
                dates[days[i]] = getLocalDateString(temp);
            }
            return dates;
        }
        function changeWeek(d) { const date = new Date(currentWeekStart); date.setDate(date.getDate() + d); setWeekToMonday(date); }
        function setWeekToMonday(d) {
            const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); currentWeekStart = new Date(d.setDate(diff)); const end = new Date(currentWeekStart); end.setDate(end.getDate() + 6);

            document.getElementById('current-week-display').innerText = `${currentWeekStart.getDate()} ${currentWeekStart.toLocaleDateString('tr-TR', { month: 'short' })} - ${end.getDate()} ${end.toLocaleDateString('tr-TR', { month: 'long' })}`;
            renderUI();
        }

        // --- TELEFON REHBERÄ° MODÃœLÃœ (GÃœNCELLENMÄ°Å VERSÄ°YON) ---
        const LS_PHONEBOOK = 'evdeSaglikPhonebook_V1';
        let phonebookList = [];
        let editingContactId = null; // DÃ¼zenleme modu iÃ§in deÄŸiÅŸken

        // 1. YÃ¼kleme Fonksiyonu
        function loadPhonebook() {
            try { phonebookList = JSON.parse(localStorage.getItem(LS_PHONEBOOK)) || []; } catch { phonebookList = []; }

            // Eskiden kalma ID'si olmayan kayÄ±t varsa onlara ID verelim (Hata Ã¶nleyici)
            phonebookList.forEach(p => { if (!p.id) p.id = Date.now() + Math.random(); });

            renderPhonebook();
        }

        // 2. KiÅŸi Ekleme ve GÃ¼ncelleme
        window.addContact = async () => {
            const name = document.getElementById('ph-name').value.trim();
            const role = document.getElementById('ph-role').value.trim();
            const num = document.getElementById('ph-num').value.trim();

            if (!name || !num) return showToast("Ä°sim ve numara zorunlu!", "error");

            if (editingContactId) {
                // --- GÃœNCELLEME Ä°ÅLEMÄ° ---
                const idx = phonebookList.findIndex(p => p.id === editingContactId);
                if (idx > -1) {
                    phonebookList[idx].name = name;
                    phonebookList[idx].role = role;
                    phonebookList[idx].num = num;
                    showToast("KiÅŸi gÃ¼ncellendi.");
                    cancelEditContact(); // Moddan Ã§Ä±k
                }
            } else {
                // --- YENÄ° KAYIT ---
                phonebookList.push({
                    id: Date.now(), // Benzersiz ID
                    name,
                    role,
                    num
                });
                showToast("KiÅŸi eklendi.");
                addActivityLog('contact', 'Rehbere kiÅŸi eklendi', name);
                // Formu temizle
                document.getElementById('ph-name').value = '';
                document.getElementById('ph-num').value = '';
                document.getElementById('ph-role').value = '';
                askForBackup();
            }

            // Ä°sme gÃ¶re sÄ±rala
            phonebookList.sort((a, b) => a.name.localeCompare(b.name));

            // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
            await FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(phonebookList));
            renderPhonebook();
        };

        // 3. DÃ¼zenleme Modunu BaÅŸlat
        window.startEditContact = (id) => {
            const item = phonebookList.find(p => p.id === id);
            if (!item) return;

            // Formu doldur
            document.getElementById('ph-name').value = item.name;
            document.getElementById('ph-role').value = item.role;
            document.getElementById('ph-num').value = item.num;

            editingContactId = id;

            // ButonlarÄ± ayarla
            const btnSave = document.getElementById('btn-ph-save');
            const btnCancel = document.getElementById('btn-ph-cancel');

            btnSave.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>';
            btnSave.classList.replace('bg-indigo-600', 'bg-orange-600');
            btnSave.classList.replace('hover:bg-indigo-700', 'hover:bg-orange-700');

            btnCancel.classList.remove('hidden');
            document.getElementById('ph-name').focus();
        };

        // 4. DÃ¼zenlemeyi Ä°ptal Et
        window.cancelEditContact = () => {
            document.getElementById('ph-name').value = '';
            document.getElementById('ph-role').value = '';
            document.getElementById('ph-num').value = '';

            editingContactId = null;

            const btnSave = document.getElementById('btn-ph-save');
            const btnCancel = document.getElementById('btn-ph-cancel');

            btnSave.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Rehbere Kaydet</span>';
            btnSave.classList.replace('bg-orange-600', 'bg-indigo-600');
            btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-indigo-700');

            btnCancel.classList.add('hidden');
        };

        // 5. KiÅŸi Silme
        window.deleteContact = async (id) => {
            if (confirm("Bu kiÅŸiyi silmek istiyor musunuz?")) {
                phonebookList = phonebookList.filter(p => p.id !== id);

                // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
                await FirebaseStorage.setItem(LS_PHONEBOOK, JSON.stringify(phonebookList));
                renderPhonebook();
                showToast("Silindi.");

                // EÄŸer dÃ¼zenlenen kiÅŸi silindiyse formu sÄ±fÄ±rla
                if (editingContactId === id) cancelEditContact();
            }
        };

        // 6. Listeyi Ekrana Basma
        window.renderPhonebook = () => {
            const grid = document.getElementById('phonebook-grid');
            const searchVal = document.getElementById('ph-search') ? document.getElementById('ph-search').value.toLowerCase() : "";

            if (!grid) return;
            grid.innerHTML = '';

            const filteredList = phonebookList.filter(p =>
                p.name.toLowerCase().includes(searchVal) ||
                (p.role && p.role.toLowerCase().includes(searchVal)) ||
                p.num.includes(searchVal)
            );

            if (filteredList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-400 p-8 italic border-2 border-dashed border-gray-200 rounded-xl">KayÄ±t bulunamadÄ±.</div>';
                return;
            }

            filteredList.forEach((p) => {
                grid.innerHTML += `
                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition flex items-center justify-between group">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-sm flex-shrink-0">
                            ${p.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-bold text-gray-800 text-sm truncate" title="${p.name}">${p.name}</h4>
                            <p class="text-xs text-gray-500 truncate">${p.role || 'Personel'}</p>
                            <p class="text-xs font-mono text-gray-600 font-bold mt-0.5">${p.num}</p>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center flex-shrink-0">
                        <button onclick="startEditContact(${p.id})" class="p-2 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg transition" title="DÃ¼zenle">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                        <a href="tel:${p.num}" class="p-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition" title="Ara">
                            <i data-lucide="phone" class="w-4 h-4"></i>
                        </a>
                        <button onclick="deleteContact(${p.id})" class="p-2 bg-gray-50 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Sil">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        // AI REPORT
        function prepareAIContext() {
            const dates = Object.keys(allRecords).sort();
            let reportData = { summary: "Bu veri seti Evde SaÄŸlÄ±k Hizmetleri gÃ¼nlÃ¼k detaylÄ± dÃ¶kÃ¼mÃ¼dÃ¼r. BÃ¼tÃ§e/Kasa gelir-gider ve Acil Ã‡anta dahildir.", daily_details: {}, budget_records: [] };
            dates.forEach(d => {
                let dayLog = { staff: [], doctors: [], notes: "" }; let hasActivity = false;
                if (allNotes[d]) { dayLog.notes = allNotes[d]; hasActivity = true; }
                staffList.forEach(s => { const r = allRecords[d]?.[s.name]; if (r) { const score = r.mm + r.mk + r.am + r.ak + (r.e * 2) + (r.specialists?.length || 0); if (score > 0) { let details = []; if (r.mm) details.push("Sabah:Merkez"); if (r.mk) details.push("Sabah:KÃ¶y"); if (r.am) details.push("Ã–ÄŸle:Merkez"); if (r.ak) details.push("Ã–ÄŸle:KÃ¶y"); if (r.e) details.push("Muayene"); if (r.specialists && r.specialists.length > 0) r.specialists.forEach(sp => details.push(`Uzman:${sp.name}`)); dayLog.staff.push(`${s.name} (${details.join(', ')})`); hasActivity = true; } } });
                doctorList.forEach(doc => { const r = docRecords[d]?.[doc.name]; if (r) { const pCount = parseInt(r.pCount) || 0; let procTxt = []; if (r.procs) Object.entries(r.procs).forEach(([k, v]) => { if (v > 0) procTxt.push(`${k}: ${v}`); }); if (pCount > 0 || procTxt.length > 0) { dayLog.doctors.push(`${doc.name}: ${pCount} Hasta, Ä°ÅŸlemler: [${procTxt.join(', ')}]`); hasActivity = true; } } });
                if (hasActivity) reportData.daily_details[d] = dayLog;
            });
            if (typeof budgetList !== 'undefined' && budgetList.length > 0) { reportData.budget_records = budgetList.sort((a, b) => a.date.localeCompare(b.date)).map(item => `Tarih: ${item.date}, Ä°ÅŸlem: ${item.type === 'income' ? 'GELÄ°R' : 'GÄ°DER'}, Tutar: ${item.amount} TL, AÃ§Ä±klama: ${item.desc}`); }
            if (typeof emergencyList !== 'undefined' && emergencyList.length > 0) { reportData.emergency_inventory = emergencyList.map(item => `${item.bagName}: ${item.name} (${item.count} Adet) - SKT: ${item.date || 'Yok'} - Durum: ${item.alertDays} gÃ¼n uyarÄ±`); }
            return JSON.stringify(reportData);
        }

        function appendAIMessage(role, text) { const chatArea = document.getElementById('ai-chat-area'), isBot = role === 'bot', icon = isBot ? 'bot' : 'user', bgClass = isBot ? 'bg-white border border-gray-200' : 'bg-indigo-600 text-white', align = isBot ? 'justify-start' : 'justify-end', textColor = isBot ? 'text-gray-700' : 'text-white', formattedText = (typeof marked !== 'undefined' && isBot) ? marked.parse(text) : text; chatArea.insertAdjacentHTML('beforeend', `<div class="flex ${align} mb-4"><div class="flex max-w-[85%] ${isBot ? 'flex-row' : 'flex-row-reverse'} gap-3"><div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isBot ? 'bg-purple-100 text-purple-600' : 'bg-indigo-800 text-indigo-200'}"><i data-lucide="${icon}" class="w-5 h-5"></i></div><div class="p-3.5 rounded-2xl shadow-sm prose prose-sm max-w-none ${bgClass} ${textColor}">${formattedText}</div></div></div>`); chatArea.scrollTop = chatArea.scrollHeight; if (typeof lucide !== 'undefined') lucide.createIcons(); }

        async function generateAIReport() {
            const userKey = localStorage.getItem(LS_API_KEY); if (!userKey && !apiKey) { showToast("API AnahtarÄ± eksik.", "error"); openSettingsModal(); return; }
            const modal = document.getElementById('ai-report-modal'), chatArea = document.getElementById('ai-chat-area'); modal.classList.remove('hidden'); modal.classList.add('flex'); chatArea.innerHTML = ''; appendAIMessage('bot', '_Verileriniz analiz ediliyor..._');
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey || apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Analist ol. Veriler: ${prepareAIContext()}. KÄ±sa Ã¶zet geÃ§.` }] }] }) });
                const data = await response.json(); if (data.error) throw new Error(data.error.message); appendAIMessage('bot', data.candidates[0].content.parts[0].text);
            } catch (error) { appendAIMessage('bot', `**Hata:** ${error.message}`); }
        }

        async function sendAIQuery() {
            const inputEl = document.getElementById('ai-user-input'), question = inputEl.value.trim(), userKey = localStorage.getItem(LS_API_KEY); if (!question || !userKey) return;
            inputEl.value = ''; appendAIMessage('user', question);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey || apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: `Veri: ${prepareAIContext()}. Soru: "${question}". Cevapla.` }] }] }) });
                const data = await response.json(); if (data.error) throw new Error(data.error.message); appendAIMessage('bot', data.candidates[0].content.parts[0].text);
            } catch (error) { appendAIMessage('bot', `âš ï¸ Hata: ${error.message}`); }
        }

        // ROUTINES
        function renderRoutines() {
            const listContainer = document.getElementById('routine-list-container'),
                progressBar = document.getElementById('routine-progress-bar'),
                progressText = document.getElementById('routine-progress-text'),
                badge = document.getElementById('routine-count-badge');

            if (!listContainer) return;

            // 1. ADIM: Ã‡akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in ebeveyn div'deki bÃ¶lme Ã§izgilerini kaldÄ±rÄ±yoruz
            listContainer.classList.remove('divide-y', 'divide-gray-100');
            // Listeyi biraz daha rahatlatmak iÃ§in boÅŸluk ekleyelim
            listContainer.classList.add('space-y-2');

            listContainer.innerHTML = '';

            if (routineList.length === 0) {
                // Liste boÅŸsa uyarÄ± kutusu
                listContainer.innerHTML = '<div class="p-8 text-center text-gray-400 flex flex-col items-center border-2 border-gray-600 bg-gray-50 rounded"><i data-lucide="clipboard-list" class="w-12 h-12 mb-2 opacity-20"></i><p class="text-sm">HenÃ¼z rutin eklenmemiÅŸ.</p></div>';
            } else {
                // 2. ADIM: Her bir maddeyi oluÅŸturup HTML string olarak topluyoruz
                // BÃ¶ylece dÃ¶ngÃ¼ hatasÄ± olmadan hepsi ekrana basÄ±lÄ±r.
                const listHTML = routineList.map((r, idx) => {
                    const isChecked = r.completed ? 'checked' : '';
                    const textClass = r.completed ? 'text-gray-400 line-through' : 'text-gray-700 font-medium';
                    const bgClass = r.completed ? 'bg-gray-50' : 'bg-white';

                    // BURASI Ã–NEMLÄ°: border-2 ve border-gray-600 her eleman iÃ§in eklendi
                    return `
                <div class="flex items-center justify-between p-3 hover:bg-indigo-50 transition group ${bgClass} border-2 border-gray-600">
                    <label class="flex items-center gap-3 cursor-pointer flex-grow select-none">
                        <input type="checkbox" onchange="toggleRoutine(${idx})" class="peer h-5 w-5 cursor-pointer rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked}>
                        <span class="text-sm ${textClass}">${r.text}</span>
                    </label>
                    <button onclick="deleteRoutine(${idx})" class="text-gray-300 hover:text-red-500">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>`;
                }).join('');

                listContainer.innerHTML = listHTML;
            }

            // Ä°statistikleri gÃ¼ncelle
            const total = routineList.length, completed = routineList.filter(r => r.completed).length, percent = total === 0 ? 0 : Math.round((completed / total) * 100);
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (progressText) progressText.innerText = `%${percent}`;
            if (badge) badge.innerText = `${completed}/${total} GÃ¶rev`;

            lucide.createIcons();
        }
        window.addRoutine = async () => {
            const val = document.getElementById('new-routine-text').value.trim();
            if (!val) return showToast("Rutin adÄ± yazÄ±n.", "error");
            routineList.push({ text: val, completed: false });
            document.getElementById('new-routine-text').value = '';
            await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
            renderRoutines();
            showToast("Eklendi.");
            addActivityLog('routine', 'Rutin eklendi', text);
        };
        window.toggleRoutine = async (idx) => {
            if (routineList[idx]) {
                routineList[idx].completed = !routineList[idx].completed;
                await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
                renderRoutines();
            }
        };
        window.deleteRoutine = async (idx) => {
            if (confirm("Silinsin mi?")) {
                routineList.splice(idx, 1);
                await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
                renderRoutines();
            }
        };
        window.resetRoutines = async () => {
            if (confirm("TÃ¼m tikler kaldÄ±rÄ±lsÄ±n mÄ±?")) {
                routineList.forEach(r => r.completed = false);
                await FirebaseStorage.setItem(LS_ROUTINES, JSON.stringify(routineList));
                renderRoutines();
                showToast("SÄ±fÄ±rlandÄ±.");
            }
        };

        // BUDGET (TEKÄ°L VE GÃœNCEL)
        let budgetCursorDate = new Date(); let currentBudgetStartStr = ""; let currentBudgetEndStr = "";
        window.renderBudgetHeader = function () {
            const y = budgetCursorDate.getFullYear(), m = budgetCursorDate.getMonth(), d = budgetCursorDate.getDate();
            let startDate, endDate;
            if (d < 15) { startDate = new Date(y, m - 1, 15); endDate = new Date(y, m, 14); } else { startDate = new Date(y, m, 15); endDate = new Date(y, m + 1, 14); }
            currentBudgetStartStr = getLocalDateString(startDate); currentBudgetEndStr = getLocalDateString(endDate);
            const options = { month: 'long', day: 'numeric' }, startTxt = startDate.toLocaleDateString('tr-TR', options).toUpperCase(), endTxt = endDate.toLocaleDateString('tr-TR', { ...options, year: 'numeric' }).toUpperCase();
            const displayEl = document.getElementById('budget-period-display'); if (displayEl) displayEl.innerText = `${startTxt} - ${endTxt}`;
            renderBudget();
        };
        window.changeBudgetMonth = function (direction) { budgetCursorDate.setMonth(budgetCursorDate.getMonth() + direction); renderBudgetHeader(); };

        window.renderBudget = function () {
            const listBody = document.getElementById('budget-list-body'),
                elIncome = document.getElementById('budget-income'),
                elExpense = document.getElementById('budget-expense'),
                elBalance = document.getElementById('budget-balance');

            const sDate = typeof currentBudgetStartStr !== 'undefined' ? currentBudgetStartStr : document.getElementById('budget-start-date')?.value;
            const eDate = typeof currentBudgetEndStr !== 'undefined' ? currentBudgetEndStr : document.getElementById('budget-end-date')?.value;

            if (!listBody) return;
            listBody.innerHTML = '';

            let totalInc = 0, totalExp = 0, hasData = false;
            if (!budgetList) budgetList = [];

            const sortedList = [...budgetList].sort((a, b) => b.date.localeCompare(a.date));

            sortedList.forEach((item, idx) => {
                if (item.date >= sDate && item.date <= eDate) {
                    hasData = true;
                    const isInc = item.type === 'income';
                    const amount = parseFloat(item.amount);
                    if (isInc) totalInc += amount; else totalExp += amount;

                    const originalIndex = budgetList.indexOf(item);

                    // DEÄÄ°ÅÄ°KLÄ°K BURADA: Her <td> hÃ¼cresine 'border-2 border-gray-600' eklendi.
                    listBody.innerHTML += `
                <tr class="hover:bg-indigo-50/50 group transition border-b-2 border-gray-600">
                    <td class="px-4 py-3 text-gray-500 text-xs font-mono border-2 border-gray-600">
                        ${formatDateTR(item.date)}
                    </td>
                    <td class="px-4 py-3 font-medium text-gray-700 border-2 border-gray-600">
                        ${item.desc}
                        ${item.note ? `<div class="text-[10px] text-gray-400 italic mt-0.5"><i data-lucide="sticky-note" class="w-3 h-3 inline mr-1"></i>${item.note}</div>` : ''}
                    </td>
                    <td class="px-4 py-3 text-right font-bold border-2 border-gray-600 ${isInc ? 'text-green-600' : 'text-red-600'}">
                        ${isInc ? '+' : '-'}${amount.toLocaleString('tr-TR')} â‚º
                    </td>
                    <td class="px-4 py-3 text-center border-2 border-gray-600">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="startEditBudget(${originalIndex})" class="text-gray-400 hover:text-orange-600 transition p-1">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button onclick="delBudgetItem(${originalIndex})" class="text-gray-400 hover:text-red-600 transition p-1">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
                }
            });

            if (!hasData) {
                // BoÅŸ veri uyarÄ±sÄ±na da Ã§erÃ§eve ekledik
                listBody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 text-xs flex flex-col items-center border-2 border-gray-600 bg-gray-50"><i data-lucide="filter-x" class="w-8 h-8 mb-2 opacity-20"></i>Bu dÃ¶nemde kayÄ±t yok.</td></tr>';
            }

            const balance = totalInc - totalExp;
            if (elIncome) elIncome.innerText = `${totalInc.toLocaleString('tr-TR')} â‚º`;
            if (elExpense) elExpense.innerText = `${totalExp.toLocaleString('tr-TR')} â‚º`;
            if (elBalance) {
                elBalance.innerText = `${balance.toLocaleString('tr-TR')} â‚º`;
                elBalance.className = `text-2xl font-bold ${balance >= 0 ? 'text-gray-800' : 'text-red-600'}`;
            }

            lucide.createIcons();
        };

        let editingBudgetIndex = -1;
        window.startEditBudget = function (idx) {
            const item = budgetList[idx]; if (!item) return;
            document.getElementById('budget-desc').value = item.desc; document.getElementById('budget-amount').value = item.amount; document.getElementById('budget-entry-date').value = item.date; document.getElementById('budget-note').value = item.note || '';
            const radios = document.getElementsByName('budgetType'); radios.forEach(r => { if (r.value === item.type) r.checked = true; });
            editingBudgetIndex = idx;
            const btnSave = document.getElementById('btn-budget-save'); const btnCancel = document.getElementById('btn-budget-cancel');
            btnSave.innerText = "GÃ¼ncelle"; btnSave.classList.replace('bg-indigo-600', 'bg-orange-600'); btnSave.classList.replace('hover:bg-indigo-700', 'hover:bg-orange-700'); btnCancel.classList.remove('hidden'); document.getElementById('budget-desc').focus();
        };
        window.cancelBudgetEdit = function () {
            document.getElementById('budget-desc').value = ''; document.getElementById('budget-amount').value = ''; document.getElementById('budget-note').value = ''; editingBudgetIndex = -1;
            const btnSave = document.getElementById('btn-budget-save'); const btnCancel = document.getElementById('btn-budget-cancel');
            btnSave.innerText = "Ekle"; btnSave.classList.replace('bg-orange-600', 'bg-indigo-600'); btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-indigo-700'); btnCancel.classList.add('hidden');
        };
        // --- GÃœNCELLENMÄ°Å BÃœTÃ‡E EKLEME VE SÄ°LME (PAROLA KORUMALI) ---

        window.addBudgetItem = async function () {
            // 1. GÃœVENLÄ°K KONTROLÃœ
            const inputPw = prompt("BÃ¼tÃ§e verisi girmek/dÃ¼zenlemek iÃ§in parola:");
            if (inputPw === null) return; // Ä°ptal'e basarsa dur
            if (inputPw !== appPassword) return showToast("HatalÄ± parola!", "error");

            // 2. MEVCUT Ä°ÅLEMLER
            const typeRadio = document.querySelector('input[name="budgetType"]:checked');
            const type = typeRadio ? typeRadio.value : 'expense';
            const desc = document.getElementById('budget-desc').value.trim();
            const amount = document.getElementById('budget-amount').value;
            const date = document.getElementById('budget-entry-date').value;
            const note = document.getElementById('budget-note').value.trim();

            if (!desc || !amount || !date) { showToast("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.", "error"); return; }

            if (editingBudgetIndex > -1) {
                budgetList[editingBudgetIndex] = { type, desc, amount, date, note };
                showToast("KayÄ±t gÃ¼ncellendi.");
                cancelBudgetEdit();
            } else {
                budgetList.push({ type, desc, amount, date, note });
                showToast("Ä°ÅŸlem eklendi.");
                addActivityLog('budget', type === 'income' ? 'Gelir eklendi' : 'Gider eklendi', `${desc} - ${amount}â‚º`);
                // Formu temizle
                document.getElementById('budget-desc').value = '';
                document.getElementById('budget-amount').value = '';
                document.getElementById('budget-note').value = '';
            }

            // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
            await FirebaseStorage.setItem(LS_BUDGET, JSON.stringify(budgetList));
            if (typeof renderBudgetHeader === 'function') renderBudgetHeader(); else renderBudget();
        };

        window.delBudgetItem = async function (idx) {
            if (confirm("Bu iÅŸlemi silmek istiyor musunuz?")) {
                // 1. GÃœVENLÄ°K KONTROLÃœ
                const inputPw = prompt("Silme iÅŸlemini onaylamak iÃ§in parola:");
                if (inputPw === null) return; // Ä°ptal
                if (inputPw !== appPassword) return showToast("HatalÄ± parola! Silinemedi.", "error");

                // 2. SÄ°LME Ä°ÅLEMÄ°
                budgetList.splice(idx, 1);

                // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
                await FirebaseStorage.setItem(LS_BUDGET, JSON.stringify(budgetList));
                if (typeof renderBudgetHeader === 'function') renderBudgetHeader(); else renderBudget();
                showToast("KayÄ±t silindi.");
            }
        };

        window.downloadBudgetExcel = function () {
            if (!budgetList || budgetList.length === 0) return showToast("Ä°ndirilecek veri yok.", "error");
            const budgetData = budgetList.map(item => ({ Tarih: item.date, Tur: item.type === 'income' ? 'Gelir' : 'Gider', Kategori_Aciklama: item.desc, Not: item.note || '', Tutar: parseFloat(item.amount) }));
            const wb = XLSX.utils.book_new(), ws = XLSX.utils.json_to_sheet(budgetData); ws['!cols'] = [{ wch: 15 }, { wch: 10 }, { wch: 30 }, { wch: 30 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, ws, "Butce_Raporu"); XLSX.writeFile(wb, `Butce_Raporu_${new Date().toISOString().slice(0, 10)}.xlsx`);
        };
        window.downloadBudgetPDF = function () {
            if (!budgetList || budgetList.length === 0) return showToast("Raporlanacak veri yok.", "error");
            const sDate = typeof currentBudgetStartStr !== 'undefined' ? currentBudgetStartStr : document.getElementById('budget-start-date')?.value;
            const eDate = typeof currentBudgetEndStr !== 'undefined' ? currentBudgetEndStr : document.getElementById('budget-end-date')?.value;
            const filteredList = budgetList.filter(item => item.date >= sDate && item.date <= eDate).sort((a, b) => a.date.localeCompare(b.date));
            if (filteredList.length === 0) return showToast("Bu tarih aralÄ±ÄŸÄ±nda veri yok.", "error");
            let totalInc = 0, totalExp = 0;
            const tableBody = [[{ text: 'Tarih', style: 'tableHeader', fillColor: '#3730a3' }, { text: 'AÃ§Ä±klama / Not', style: 'tableHeader', fillColor: '#3730a3' }, { text: 'TÃ¼r', style: 'tableHeader', fillColor: '#3730a3' }, { text: 'Tutar', style: 'tableHeader', fillColor: '#3730a3', alignment: 'right' }]];
            filteredList.forEach((item, idx) => {
                const amount = parseFloat(item.amount), isInc = item.type === 'income'; if (isInc) totalInc += amount; else totalExp += amount;
                const rowColor = isInc ? '#dcfce7' : '#fee2e2', textColor = isInc ? '#166534' : '#991b1b', sign = isInc ? '+' : '-', typeText = isInc ? 'GELÄ°R' : 'GÄ°DER';
                tableBody.push([{ text: formatDateTR(item.date), fillColor: rowColor, style: 'tableRow' }, { stack: [{ text: item.desc }, item.note ? { text: `(Not: ${item.note})`, fontSize: 8, italics: true, color: '#4b5563' } : ''], fillColor: rowColor, style: 'tableRow' }, { text: typeText, fillColor: rowColor, color: textColor, bold: true, style: 'tableRow', alignment: 'center' }, { text: `${sign}${amount.toLocaleString('tr-TR')} â‚º`, fillColor: rowColor, color: textColor, bold: true, style: 'tableRow', alignment: 'right' }]);
            });
            const balance = totalInc - totalExp, balanceColor = balance >= 0 ? '#166534' : '#991b1b';
            const docDefinition = { content: [{ text: 'BÃ¼tÃ§e ve Harcama Raporu', style: 'header', color: '#3730a3' }, { text: `DÃ¶nem: ${formatDateTR(sDate)} - ${formatDateTR(eDate)}`, style: 'subheader', margin: [0, 5, 0, 20] }, { style: 'summaryTable', table: { widths: ['*', '*', '*'], body: [[{ text: 'TOPLAM GELÄ°R', style: 'summaryHeader', fillColor: '#dcfce7', color: '#166534' }, { text: 'TOPLAM GÄ°DER', style: 'summaryHeader', fillColor: '#fee2e2', color: '#991b1b' }, { text: 'NET DURUM', style: 'summaryHeader', fillColor: '#e0e7ff', color: '#3730a3' }], [{ text: `${totalInc.toLocaleString('tr-TR')} â‚º`, style: 'summaryValue', color: '#166534' }, { text: `${totalExp.toLocaleString('tr-TR')} â‚º`, style: 'summaryValue', color: '#991b1b' }, { text: `${balance.toLocaleString('tr-TR')} â‚º`, style: 'summaryValue', color: balanceColor, bold: true }]] }, layout: 'noBorders' }, { text: 'Ä°ÅŸlem DetaylarÄ±', style: 'smallHeader', margin: [0, 20, 0, 10] }, { table: { headerRows: 1, widths: ['auto', '*', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' }], styles: { header: { fontSize: 20, bold: true, alignment: 'center' }, subheader: { fontSize: 12, italics: true, alignment: 'center', color: '#6b7280' }, smallHeader: { fontSize: 14, bold: true, color: '#374151', decoration: 'underline' }, tableHeader: { bold: true, fontSize: 11, color: 'white', margin: [0, 5, 0, 5] }, tableRow: { fontSize: 10, margin: [0, 3, 0, 3] }, summaryHeader: { bold: true, fontSize: 10, alignment: 'center', margin: [0, 5, 0, 0] }, summaryValue: { fontSize: 16, bold: true, alignment: 'center', margin: [0, 0, 0, 10] } } };
            pdfMake.createPdf(docDefinition).download(`Butce_Raporu_${sDate}_${eDate}.pdf`);
        };

        // EMERGENCY BAG
        let editingEmergencyIndex = -1;
        function renderBagSelector() {
            const selector = document.getElementById('bag-selector'); if (!selector) return;
            selector.innerHTML = '';
            emergencyBags.forEach(bag => { const option = document.createElement('option'); option.value = bag; option.text = bag; if (bag === currentBag) option.selected = true; selector.appendChild(option); });
        }
        window.switchBag = function () { currentBag = document.getElementById('bag-selector').value; cancelEmergencyEdit(); if (document.getElementById('select-all-em')) document.getElementById('select-all-em').checked = false; renderEmergency(); };
        window.addNewBag = function () {
            const newName = prompt("Yeni Ã‡anta AdÄ±:"); if (newName && newName.trim() !== "") { if (emergencyBags.includes(newName)) return showToast("Bu isim zaten var.", "error"); emergencyBags.push(newName.trim()); currentBag = newName.trim(); saveAll(); renderBagSelector(); renderEmergency(); showToast("Yeni Ã§anta oluÅŸturuldu."); }
        };
        window.deleteCurrentBag = function () {
            if (emergencyBags.length <= 1) return showToast("En az bir Ã§anta kalmak zorunda.", "error");
            const itemsInBag = emergencyList.filter(i => i.bagName === currentBag).length;
            if (confirm(`"${currentBag}" ve iÃ§indeki ${itemsInBag} malzeme silinecek. Emin misiniz?`)) { emergencyList = emergencyList.filter(i => i.bagName !== currentBag); emergencyBags = emergencyBags.filter(b => b !== currentBag); currentBag = emergencyBags[0]; saveAll(); renderBagSelector(); renderEmergency(); showToast("Silindi."); }
        };
        window.renameCurrentBag = function () {
            const newName = prompt("Yeni isim:", currentBag); if (newName && newName.trim() !== "" && newName !== currentBag) { const trimmed = newName.trim(); if (emergencyBags.includes(trimmed)) return showToast("Zaten var.", "error"); const idx = emergencyBags.indexOf(currentBag); if (idx !== -1) emergencyBags[idx] = trimmed; emergencyList.forEach(item => { if (item.bagName === currentBag) item.bagName = trimmed; }); currentBag = trimmed; saveAll(); renderBagSelector(); renderEmergency(); showToast("DeÄŸiÅŸtirildi."); }
        };

        function renderEmergency() {
            const tbody = document.getElementById('emergency-list-body'), alertBadge = document.getElementById('em-alert-count'); if (!tbody) return; tbody.innerHTML = '';
            const today = new Date(); today.setHours(0, 0, 0, 0); let alertCount = 0;
            const filteredItems = emergencyList.map((item, index) => ({ ...item, originalIndex: index })).filter(item => item.bagName === currentBag);
            if (filteredItems.length === 0) tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400 text-sm">"${currentBag}" boÅŸ. Malzeme ekleyiniz.</td></tr>`;
            else {
                filteredItems.forEach((item) => {
                    let dateText = '-', dateClass = 'text-gray-600', rowClass = 'hover:bg-gray-50'; const warningThreshold = parseInt(item.alertDays) || 30;
                    if (item.date) { const d = new Date(item.date); dateText = d.toLocaleDateString('tr-TR'); if (d < today) { dateClass = 'text-red-600 font-bold'; dateText += ' (DOLDU!)'; rowClass = 'bg-red-50 hover:bg-red-100'; alertCount++; } else { const diffDays = Math.ceil(Math.abs(d - today) / (1000 * 60 * 60 * 24)); if (diffDays <= warningThreshold) { dateClass = 'text-orange-600 font-bold'; dateText += ` (${diffDays} gÃ¼n)`; rowClass = 'bg-orange-50 hover:bg-orange-100'; alertCount++; } } }
                    tbody.innerHTML += `<tr class="${rowClass} border-b last:border-0 transition group"><td class="px-4 py-3 text-center"><input type="checkbox" class="em-item-checkbox w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" value="${item.originalIndex}"></td><td class="px-4 py-3 font-medium text-gray-700">${item.name}${item.note ? `<div class="text-[10px] text-gray-400 italic mt-0.5"><i data-lucide="sticky-note" class="w-3 h-3 inline mr-1"></i>${item.note}</div>` : ''}</td><td class="px-4 py-3 text-center text-xs ${dateClass}">${dateText}</td><td class="px-4 py-3 text-center font-bold text-gray-700">${item.count}<div class="text-[9px] text-gray-400 font-normal">UyarÄ±: ${warningThreshold} gÃ¼n</div></td><td class="px-4 py-3 text-right"><div class="flex justify-end items-center gap-1"><button onclick="moveEmergencyItem(${item.originalIndex}, -1)" class="text-gray-400 hover:text-blue-600 p-1 hover:bg-blue-50 rounded transition"><i data-lucide="arrow-up" class="w-4 h-4"></i></button><button onclick="moveEmergencyItem(${item.originalIndex}, 1)" class="text-gray-400 hover:text-blue-600 p-1 hover:bg-blue-50 rounded transition"><i data-lucide="arrow-down" class="w-4 h-4"></i></button><div class="w-px h-4 bg-gray-300 mx-1"></div><button onclick="startEditEmergency(${item.originalIndex})" class="text-gray-400 hover:text-orange-600 p-1 hover:bg-orange-50 rounded transition"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteEmergency(${item.originalIndex})" class="text-gray-400 hover:text-red-600 p-1 hover:bg-red-50 rounded transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></td></tr>`;
                });
            }
            if (alertBadge) alertBadge.innerText = alertCount; lucide.createIcons();
        }

        window.toggleAllEm = function (source) { document.querySelectorAll('.em-item-checkbox').forEach(cb => cb.checked = source.checked); };
        window.openCopyModal = function () {
            if (document.querySelectorAll('.em-item-checkbox:checked').length === 0) return showToast("SeÃ§im yapÄ±n.", "error");
            const targetList = document.getElementById('copy-target-list'), otherBags = emergencyBags.filter(b => b !== currentBag); targetList.innerHTML = '';
            if (otherBags.length === 0) targetList.innerHTML = '<p class="text-xs text-red-500 p-2">BaÅŸka Ã§anta yok.</p>'; else otherBags.forEach(bag => { targetList.innerHTML += `<label class="flex items-center gap-2 p-2 hover:bg-white rounded border border-transparent hover:border-gray-200 cursor-pointer"><input type="checkbox" class="copy-target-checkbox w-4 h-4 text-indigo-600 rounded" value="${bag}"><span class="text-sm font-medium text-gray-700">${bag}</span></label>`; });
            document.getElementById('copy-bag-modal').classList.remove('hidden'); document.getElementById('copy-bag-modal').classList.add('flex');
        };
        window.closeCopyModal = function () { document.getElementById('copy-bag-modal').classList.add('hidden'); document.getElementById('copy-bag-modal').classList.remove('flex'); };
        window.performCopy = function () {
            const selected = Array.from(document.querySelectorAll('.em-item-checkbox:checked')).map(cb => parseInt(cb.value));
            const targets = Array.from(document.querySelectorAll('.copy-target-checkbox:checked')).map(cb => cb.value);
            if (targets.length === 0) return showToast("Hedef seÃ§mediniz!", "error");
            selected.forEach(idx => { const item = emergencyList[idx]; if (item) targets.forEach(tBag => { const newItem = JSON.parse(JSON.stringify(item)); newItem.bagName = tBag; emergencyList.push(newItem); }); });
            saveAll(); closeCopyModal(); showToast("KopyalandÄ±."); document.querySelectorAll('.em-item-checkbox').forEach(cb => cb.checked = false); if (document.getElementById('select-all-em')) document.getElementById('select-all-em').checked = false;
        };

        window.moveEmergencyItem = function (idx, dir) {
            const currentIndices = emergencyList.map((item, i) => ({ item, i })).filter(obj => obj.item.bagName === currentBag).map(obj => obj.i);
            const localPos = currentIndices.indexOf(idx), newLocalPos = localPos + dir;
            if (newLocalPos < 0 || newLocalPos >= currentIndices.length) return;
            const targetIdx = currentIndices[newLocalPos];[emergencyList[idx], emergencyList[targetIdx]] = [emergencyList[targetIdx], emergencyList[idx]];
            saveAll(); renderEmergency();
        };

        window.startEditEmergency = function (idx) {
            const item = emergencyList[idx]; if (!item) return;
            document.getElementById('em-name').value = item.name; document.getElementById('em-date').value = item.date; document.getElementById('em-count').value = item.count; document.getElementById('em-note').value = item.note || ''; document.getElementById('em-alert-days').value = item.alertDays || 30;
            editingEmergencyIndex = idx; const btnSave = document.getElementById('btn-em-save'), btnCancel = document.getElementById('btn-em-cancel');
            btnSave.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>'; btnSave.classList.replace('bg-red-600', 'bg-orange-600'); btnSave.classList.replace('hover:bg-red-700', 'hover:bg-orange-700'); btnCancel.classList.remove('hidden'); document.getElementById('em-name').focus(); lucide.createIcons();
        };
        window.cancelEmergencyEdit = function () {
            document.getElementById('em-name').value = ''; document.getElementById('em-date').value = ''; document.getElementById('em-count').value = ''; document.getElementById('em-note').value = ''; document.getElementById('em-alert-days').value = '30';
            editingEmergencyIndex = -1; const btnSave = document.getElementById('btn-em-save'), btnCancel = document.getElementById('btn-em-cancel');
            btnSave.innerHTML = '<i data-lucide="plus-circle" class="w-4 h-4"></i> <span>Listeye Ekle</span>'; btnSave.classList.replace('bg-orange-600', 'bg-red-600'); btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-red-700'); btnCancel.classList.add('hidden'); lucide.createIcons();
        };
        window.addEmergencyItem = async function () {
            const inputPw = prompt("Veri girmek/gÃ¼ncellemek iÃ§in lÃ¼tfen ana parolayÄ± girin:"); if (inputPw === null) return; if (inputPw !== appPassword) return showToast("HatalÄ± parola!", "error");
            const name = document.getElementById('em-name').value.trim(), date = document.getElementById('em-date').value, count = document.getElementById('em-count').value, note = document.getElementById('em-note').value.trim(), alertDays = document.getElementById('em-alert-days').value;
            if (!name) return showToast("Malzeme adÄ± giriniz.", "error");
            const itemData = { name, date, count: count || 1, note: note || '', alertDays: alertDays || 30, bagName: currentBag };
            if (editingEmergencyIndex > -1) { emergencyList[editingEmergencyIndex] = { ...itemData, bagName: emergencyList[editingEmergencyIndex].bagName }; showToast("GÃ¼ncellendi."); cancelEmergencyEdit(); }
            else { emergencyList.push(itemData); showToast("Eklendi."); addActivityLog('emergency', 'Acil Ã§antaya malzeme eklendi', name); document.getElementById('em-name').value = ''; document.getElementById('em-count').value = ''; document.getElementById('em-note').value = ''; document.getElementById('em-name').focus(); }

            // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
            await saveAll();
            renderEmergency();
        };
        window.deleteEmergency = async function (idx) {
            if (confirm("Ã‡antadan Ã§Ä±karmak istiyor musunuz?")) {
                const inputPw = prompt("Silmek iÃ§in parola:"); if (inputPw === null) return; if (inputPw !== appPassword) return showToast("HatalÄ± parola!", "error");
                if (idx === editingEmergencyIndex) cancelEmergencyEdit(); emergencyList.splice(idx, 1);

                // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
                await saveAll();
                renderEmergency();
                showToast("Silindi.");
            }
        };
        window.exportEmergencyData = function () {
            if (emergencyList.length === 0) return showToast("Liste boÅŸ.", "error");
            const data = emergencyList.map(i => ({ Canta: i.bagName || 'Ana Ã‡anta', Malzeme: i.name, Not: i.note || '', SKT: i.date || 'Belirtilmedi', Adet: i.count, UyarÄ±_Gun: i.alertDays || 30 }));
            const wb = XLSX.utils.book_new(), ws = XLSX.utils.json_to_sheet(data); ws['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 30 }, { wch: 15 }, { wch: 10 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, ws, "Acil_Canta_Yedek"); XLSX.writeFile(wb, `Acil_Canta_TAM_YEDEK_${new Date().toISOString().slice(0, 10)}.xlsx`);
        };
        window.importEmergencyData = function (e) {
            const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result), workbook = XLSX.read(data, { type: 'array' });
                let sheetName = workbook.SheetNames.find(n => n.includes("Acil_Canta")); if (!sheetName) sheetName = workbook.SheetNames[0];
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                if (jsonData && jsonData.length > 0) {
                    if (confirm("TAMAM -> Mevcut listeyi SÄ°L ve yÃ¼kle.\nÄ°PTAL -> Mevcuta EKLE.")) { emergencyList = []; emergencyBags = ["Ana Ã‡anta"]; }
                    let importCount = 0; jsonData.forEach(row => { const bag = row['Canta'] || row['Ã‡anta'] || "Ana Ã‡anta"; if (!emergencyBags.includes(bag)) emergencyBags.push(bag); emergencyList.push({ bagName: bag, name: row['Malzeme'] || row['Ä°laÃ§'] || 'Bilinmeyen', note: row['Not'] || '', date: row['SKT'] === 'Belirtilmedi' ? '' : (row['SKT'] || ''), count: row['Adet'] || row['Stok'] || 1, alertDays: row['UyarÄ±_Gun'] || 30 }); importCount++; });
                    saveAll(); FirebaseStorage.setItem(LS_BAGS, JSON.stringify(emergencyBags)); renderBagSelector(); if (!emergencyBags.includes(currentBag)) currentBag = emergencyBags[0]; document.getElementById('bag-selector').value = currentBag; renderEmergency(); showToast(`${importCount} kayÄ±t yÃ¼klendi.`);
                } else showToast("Veri bulunamadÄ±.", "error"); e.target.value = '';
            }; reader.readAsArrayBuffer(file);
        };
        window.downloadEmergencyPDF = function () {
            const filtered = emergencyList.filter(i => i.bagName === currentBag); if (!filtered || filtered.length === 0) return showToast("Veri yok.", "error");
            const now = new Date(), dateStr = now.toLocaleDateString('tr-TR'), tableBody = [[{ text: 'Malzeme / Ä°laÃ§ AdÄ±', style: 'tableHeader', fillColor: '#991b1b' }, { text: 'Son Kull. Tarihi', style: 'tableHeader', fillColor: '#991b1b', alignment: 'center' }, { text: 'Durum / Kalan GÃ¼n', style: 'tableHeader', fillColor: '#991b1b', alignment: 'center' }, { text: 'Stok', style: 'tableHeader', fillColor: '#991b1b', alignment: 'center' }]];
            filtered.forEach((item) => {
                const warningThreshold = parseInt(item.alertDays) || 30; let sktText = '-', statusText = 'Normal', rowColor = '#ffffff', textColor = '#374151', statusColor = '#166534';
                if (item.date) { const d = new Date(item.date); sktText = d.toLocaleDateString('tr-TR'); const today = new Date(); today.setHours(0, 0, 0, 0); if (d < today) { rowColor = '#fee2e2'; textColor = '#991b1b'; statusText = 'MÄ°ADI DOLDU!'; statusColor = '#991b1b'; } else { const diffDays = Math.ceil(Math.abs(d - today) / (1000 * 60 * 60 * 24)); if (diffDays <= warningThreshold) { rowColor = '#ffedd5'; textColor = '#c2410c'; statusText = `${diffDays} GÃ¼n KaldÄ±`; statusColor = '#c2410c'; } else statusText = `${diffDays} GÃ¼n Var`; } }
                tableBody.push([{ stack: [{ text: item.name, bold: true, color: textColor }, item.note ? { text: `Not: ${item.note}`, fontSize: 8, italics: true, color: '#6b7280' } : ''], fillColor: rowColor, margin: [0, 5, 0, 5] }, { text: sktText, alignment: 'center', fillColor: rowColor, color: textColor, bold: true, margin: [0, 5, 0, 0] }, { text: statusText, alignment: 'center', fillColor: rowColor, color: statusColor, bold: true, margin: [0, 5, 0, 0] }, { text: item.count, alignment: 'center', fillColor: rowColor, color: textColor, bold: true, margin: [0, 5, 0, 0] }]);
            });
            const docDefinition = { content: [{ stack: [{ text: currentBag.toUpperCase() + ' RAPORU', style: 'header', color: '#991b1b' }, { text: 'Acil Ã‡anta Envanter Takip', style: 'subheader', margin: [0, 2, 0, 0] }, { text: `Rapor Tarihi: ${dateStr}`, fontSize: 10, color: '#6b7280', margin: [0, 5, 0, 20], alignment: 'center' }] }, { table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto'], body: tableBody }, layout: 'lightHorizontalLines' }], styles: { header: { fontSize: 18, bold: true, alignment: 'center' }, subheader: { fontSize: 12, italics: true, alignment: 'center', color: '#4b5563' }, tableHeader: { bold: true, fontSize: 11, color: 'white', margin: [0, 6, 0, 6] } } };
            pdfMake.createPdf(docDefinition).download(`${currentBag}_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        };
        // --- GENEL NOTLAR FONKSÄ°YONLARI ---
        let selectedColor = 'yellow';

        window.selectNoteColor = (color) => {
            selectedColor = color;
            document.getElementById('selected-note-color').value = color;
            // GÃ¶rsel seÃ§im efekti
            document.querySelectorAll('.note-color-btn').forEach(btn => {
                if (btn.dataset.color === color) {
                    btn.classList.add('ring-2', 'ring-gray-400');
                } else {
                    btn.classList.remove('ring-2', 'ring-gray-400');
                }
            });
        };

        // --- GÃœNCELLENMÄ°Å NOT SÄ°STEMÄ° (LÄ°STE GÃ–RÃœNÃœMÃœ) ---

        // 1. Yeni Not Ekleme (Tarih formatÄ±nÄ± gÃ¼n ismini iÃ§erecek ÅŸekilde gÃ¼ncelledik)
        window.addGeneralNote = async () => {
            const title = document.getElementById('gen-note-title').value.trim();
            const content = document.getElementById('gen-note-content').value.trim();

            if (!title && !content) return showToast("BaÅŸlÄ±k veya iÃ§erik giriniz.", "error");

            // Tarih formatÄ±: 20 AralÄ±k Cumartesi 14:30
            const now = new Date();
            const dateStr = now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' }) + ' ' +
                now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            const newNote = {
                title: title || 'BaÅŸlÄ±ksÄ±z Not',
                content: content,
                color: selectedColor, // Global deÄŸiÅŸkenden gelen renk
                date: dateStr
            };

            generalNotesList.unshift(newNote); // En baÅŸa ekle

            // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
            await saveAll();
            renderGeneralNotes();

            // Formu temizle
            document.getElementById('gen-note-title').value = '';
            document.getElementById('gen-note-content').value = '';
            showToast("Not listeye eklendi.");
            addActivityLog('note', 'Not eklendi', title);
        };

        // 2. NotlarÄ± Listeleme (Accordion YapÄ±sÄ±)
        window.renderGeneralNotes = () => {
            const grid = document.getElementById('general-notes-grid');
            const badge = document.getElementById('note-count-badge');
            if (!grid) return;

            grid.innerHTML = '';
            badge.innerText = `${generalNotesList.length} Not`;

            if (generalNotesList.length === 0) {
                grid.innerHTML = '<div class="flex flex-col items-center justify-center text-gray-400 py-10"><i data-lucide="list" class="w-12 h-12 mb-2 opacity-20"></i><p class="text-sm">Listeniz boÅŸ.</p></div>';
                return;
            }

            // Renk kodlarÄ± (Liste baÅŸlÄ±ÄŸÄ± iÃ§in sol kenar rengi ve hafif arka plan)
            const colorStyles = {
                'yellow': 'border-l-4 border-yellow-400 bg-yellow-50 hover:bg-yellow-100',
                'blue': 'border-l-4 border-blue-400 bg-blue-50 hover:bg-blue-100',
                'green': 'border-l-4 border-green-400 bg-green-50 hover:bg-green-100',
                'red': 'border-l-4 border-red-400 bg-red-50 hover:bg-red-100',
                'purple': 'border-l-4 border-purple-400 bg-purple-50 hover:bg-purple-100'
            };

            generalNotesList.forEach((note, idx) => {
                const styleClass = colorStyles[note.color] || colorStyles['yellow'];

                grid.innerHTML += `
                <div class="border border-gray-200 rounded-lg overflow-hidden shadow-sm transition-all duration-300">
                    <div onclick="toggleNote(${idx})" class="cursor-pointer p-3 flex justify-between items-center ${styleClass} select-none">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-800 text-sm flex items-center gap-2">
                                <i id="chevron-${idx}" data-lucide="chevron-right" class="w-4 h-4 text-gray-400 transition-transform duration-300"></i>
                                ${note.title}
                            </span>
                            <span class="text-[10px] text-gray-500 pl-6 pt-0.5">(${note.date})</span>
                        </div>
                        
                        <button onclick="deleteGeneralNoteWithStop(event, ${idx})" class="text-gray-400 hover:text-red-600 p-1.5 rounded-full hover:bg-white transition" title="Notu Sil">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div id="note-content-${idx}" class="hidden bg-white border-t border-gray-100 p-4">
                        <p class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${note.content}</p>
                    </div>
                </div>
            `;
            });
            lucide.createIcons();
        };

        // 3. AÃ§/Kapa Fonksiyonu (Accordion MantÄ±ÄŸÄ±)
        window.toggleNote = (idx) => {
            const contentDiv = document.getElementById(`note-content-${idx}`);
            const chevron = document.getElementById(`chevron-${idx}`);

            if (contentDiv.classList.contains('hidden')) {
                contentDiv.classList.remove('hidden');
                chevron.classList.add('rotate-90'); // Oku aÅŸaÄŸÄ± Ã§evir
            } else {
                contentDiv.classList.add('hidden');
                chevron.classList.remove('rotate-90'); // Oku saÄŸa Ã§evir
            }
        };

        // --- GÃœNCELLENMÄ°Å NOT SÄ°LME (PAROLA KORUMALI) ---
        window.deleteGeneralNoteWithStop = async (e, idx) => {
            e.stopPropagation(); // TÄ±klayÄ±nca notun detayÄ±nÄ± aÃ§masÄ±nÄ± engeller

            if (confirm("Bu not silinsin mi?")) {
                // GÃœVENLÄ°K KONTROLÃœ
                const inputPw = prompt("Notu silmek iÃ§in lÃ¼tfen parola girin:");

                if (inputPw === null) return; // Ä°ptale basarsa iÅŸlem yapma
                if (inputPw !== appPassword) return showToast("HatalÄ± parola! Silinemedi.", "error");

                // SÄ°LME Ä°ÅLEMÄ°
                generalNotesList.splice(idx, 1);

                // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
                await saveAll();
                renderGeneralNotes();
                showToast("Not baÅŸarÄ±yla silindi.");
            }
        };
        // --- OTO-YEDEKLEME SÄ°STEMÄ° ---

        // 1. Yedekleme Sorusu Soran Fonksiyon
        window.askForBackup = () => {
            // Ä°ÅŸlemlerin ekrana yansÄ±masÄ± iÃ§in Ã§ok kÄ±sa bekleyip soruyoruz
            setTimeout(() => {
                if (confirm("âœ… Veri kaydedildi.\n\nGÃ¼venlik iÃ§in YEDEK DOSYASI (Excel) ÅŸimdi indirilsin mi?")) {
                    exportData('xlsx');
                }
            }, 400);
        };

        // 2. saveAll Fonksiyonunu GÃ¼ncelliyoruz (TÃ¼m sistemi kapsasÄ±n diye)
        // NOT: Bu duplicate fonksiyon kaldÄ±rÄ±ldÄ±, yukarÄ±daki async saveAll() kullanÄ±lacak

        // 3. BÃ¼tÃ§e Ekleme Fonksiyonunu GÃ¼ncelliyoruz (ParolalÄ± + Yedek Soru)
        // NOT: Bu duplicate fonksiyon kaldÄ±rÄ±ldÄ±, yukarÄ±daki async addBudgetItem() kullanÄ±lacak

        // 4. BÃ¼tÃ§e Silme Fonksiyonunu GÃ¼ncelliyoruz (ParolalÄ± + Yedek Soru)
        // NOT: Bu duplicate fonksiyon kaldÄ±rÄ±ldÄ±, yukarÄ±daki async delBudgetItem() kullanÄ±lacak
        // --- SEKME KÄ°LÄ°TLEME FONKSÄ°YONU ---
        window.lockSpecialTab = (tabId) => {
            // Kilidi kapat
            unlockedSpecialTabs[tabId] = false;

            // KullanÄ±cÄ±yÄ± bilgilendir
            showToast("Sekme kilitlendi. Ana ekrana dÃ¶nÃ¼lÃ¼yor.");

            // GÃ¼venlik iÃ§in hemen personel (ana) sekmesine at
            switchTab('personel');
        };
        // --- NÃ–BET (SHIFT) MODÃœLÃœ FONKSÄ°YONLARI ---

        window.renderShiftHeader = function () {
            const d = shiftCursorDate;
            // Ay ismini yazdÄ±r (Ã–rn: ARALIK 2025)
            const monthName = monthsTR[d.getMonth()];
            const year = d.getFullYear();

            const displayEl = document.getElementById('shift-period-display');
            if (displayEl) displayEl.innerText = `${monthName} ${year}`;

            // Input tarihini seÃ§ili aya ayarla (kolaylÄ±k olsun diye)
            const dateInput = document.getElementById('shift-date');
            if (dateInput && !dateInput.value) {
                // BugÃ¼nÃ¼n tarihini formatla, ama cursor'daki ay seÃ§ili olsun
                const now = new Date();
                if (now.getMonth() === d.getMonth() && now.getFullYear() === d.getFullYear()) {
                    dateInput.value = getLocalDateString(now);
                } else {
                    // O ayÄ±n 1'ini ayarla
                    const firstDay = new Date(d.getFullYear(), d.getMonth(), 1);
                    // Timezone farkÄ±nÄ± dÃ¼zeltmek iÃ§in basit yÃ¶ntem
                    const offset = firstDay.getTimezoneOffset();
                    const adjDate = new Date(firstDay.getTime() - (offset * 60 * 1000));
                    dateInput.value = adjDate.toISOString().split('T')[0];
                }
            }

            renderShiftTable();
        };

        window.changeShiftMonth = function (direction) {
            shiftCursorDate.setMonth(shiftCursorDate.getMonth() + direction);
            renderShiftHeader();
        };

        window.renderShiftTable = function () {
            const tbody = document.getElementById('shift-list-body');
            const badge = document.getElementById('shift-count-badge');
            if (!tbody) return;
            tbody.innerHTML = '';

            // SeÃ§ili ay ve yÄ±la gÃ¶re filtrele
            const selectedMonth = shiftCursorDate.getMonth();
            const selectedYear = shiftCursorDate.getFullYear();

            const filteredShifts = shiftList.filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === selectedMonth && d.getFullYear() === selectedYear;
            });

            // Tarihe gÃ¶re sÄ±rala
            filteredShifts.sort((a, b) => a.date.localeCompare(b.date));

            if (filteredShifts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 text-xs flex flex-col items-center"><i data-lucide="calendar-off" class="w-8 h-8 mb-2 opacity-20"></i>Bu ay nÃ¶bet kaydÄ± yok.</td></tr>';
                if (badge) badge.innerText = "0 KayÄ±t";
                return;
            }

            filteredShifts.forEach((s) => {
                // Orjinal listedeki indexini bul (silme iÅŸlemi iÃ§in)
                const originalIndex = shiftList.indexOf(s);

                // Tarih formatÄ± (GÃ¼n adÄ± dahil)
                const dObj = new Date(s.date);
                const dateStr = dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'short' });

                // Renkler (Hafta sonu kÄ±rmÄ±zÄ±msÄ± olsun mesela)
                const isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6);
                const dateClass = isWeekend ? 'text-red-600 font-bold' : 'text-gray-600 font-medium';

                // BURAYI KOMPLE DEÄÄ°ÅTÄ°R
                tbody.innerHTML += `
                <tr class="hover:bg-indigo-50/50 group transition border-b-2 border-gray-600">
                    <td class="px-4 py-3 text-xs ${dateClass} border-2 border-gray-600 border-r-2">${dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', weekday: 'short' })}</td>
                    
                    <td class="px-4 py-3 font-bold text-gray-700 border-2 border-gray-600 border-r-2">
                        ${s.staff}
                        ${s.note ? `<div class="text-[10px] text-gray-400 font-normal italic border-t border-gray-300 mt-1 pt-0.5">${s.note}</div>` : ''}
                    </td>
                    
                    <td class="px-4 py-3 text-center border-2 border-gray-600 border-r-2">
                        <span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-[10px] font-bold border border-indigo-200 shadow-sm">${s.type}</span>
                    </td>
                    
                    <td class="px-4 py-3 text-right border-2 border-gray-600">
                        <button onclick="deleteShift(${idx})" class="text-gray-400 hover:text-red-600 transition p-1.5 hover:bg-red-50 rounded border border-transparent hover:border-red-200">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `;
            });

            if (badge) badge.innerText = `${filteredShifts.length} KayÄ±t`;
            lucide.createIcons();
        };

        window.addShift = async function () {
            // GÃ¼venlik: EÄŸer 'lock-toggle' aÃ§Ä±ksa ve isEditing false ise engelle (isteÄŸe baÄŸlÄ±, ÅŸimdilik direkt ekleyelim)

            const date = document.getElementById('shift-date').value;
            const staff = document.getElementById('shift-staff').value.trim();
            const type = document.getElementById('shift-type').value;
            const note = document.getElementById('shift-note').value.trim();

            if (!date || !staff) return showToast("Tarih ve Personel seÃ§iniz.", "error");

            shiftList.push({
                date: date,
                staff: staff,
                type: type,
                note: note
            });

            // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
            await saveAll();
            renderShiftTable();

            // Personel ismini temizleme, seri giriÅŸ iÃ§in kalsÄ±n mÄ±? Genelde kalmasÄ± iyidir.
            // Sadece notu temizleyelim.
            document.getElementById('shift-note').value = '';
            showToast("NÃ¶bet eklendi.");
            addActivityLog('shift', 'NÃ¶bet eklendi', `${staff} - ${date} (${type})`);
        };

        window.deleteShift = async function (idx) {
            if (confirm("Bu nÃ¶bet kaydÄ±nÄ± silmek istiyor musunuz?")) {
                shiftList.splice(idx, 1);

                // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
                await saveAll();
                renderShiftTable();
                showToast("Silindi.");
            }
        };

        window.downloadShiftPDF = function () {
            const d = shiftCursorDate;
            const monthName = monthsTR[d.getMonth()];
            const year = d.getFullYear();

            // Filtreli liste
            const selectedMonth = d.getMonth();
            const selectedYear = d.getFullYear();
            const filteredShifts = shiftList.filter(s => {
                const dateObj = new Date(s.date);
                return dateObj.getMonth() === selectedMonth && dateObj.getFullYear() === selectedYear;
            }).sort((a, b) => a.date.localeCompare(b.date));

            if (filteredShifts.length === 0) return showToast("Bu ay iÃ§in veri yok.", "error");

            const tableBody = [
                [
                    { text: 'Tarih', style: 'tableHeader', fillColor: '#3730a3' },
                    { text: 'Personel', style: 'tableHeader', fillColor: '#3730a3' },
                    { text: 'NÃ¶bet TÃ¼rÃ¼', style: 'tableHeader', fillColor: '#3730a3' },
                    { text: 'Not', style: 'tableHeader', fillColor: '#3730a3' }
                ]
            ];

            filteredShifts.forEach((s, idx) => {
                const dateObj = new Date(s.date);
                const dateStr = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', weekday: 'long' });
                const rowColor = (idx % 2 === 0) ? '#ffffff' : '#f3f4f6';

                tableBody.push([
                    { text: dateStr, fillColor: rowColor, style: 'tableRow' },
                    { text: s.staff, fillColor: rowColor, style: 'tableRow', bold: true },
                    { text: s.type, fillColor: rowColor, style: 'tableRow', alignment: 'center' },
                    { text: s.note || '-', fillColor: rowColor, style: 'tableRow', italics: true, color: '#6b7280' }
                ]);
            });

            const docDefinition = {
                content: [
                    { text: `NÃ–BET Ã‡Ä°ZELGESÄ° - ${monthName} ${year}`, style: 'header', color: '#3730a3', alignment: 'center', margin: [0, 0, 0, 20] },
                    {
                        table: {
                            headerRows: 1,
                            widths: ['auto', '*', 'auto', '*'],
                            body: tableBody
                        },
                        layout: 'lightHorizontalLines'
                    }
                ],
                styles: {
                    header: { fontSize: 18, bold: true },
                    tableHeader: { bold: true, fontSize: 11, color: 'white', margin: [0, 6, 0, 6] },
                    tableRow: { fontSize: 10, margin: [0, 4, 0, 4] }
                }
            };

            pdfMake.createPdf(docDefinition).download(`Nobet_Listesi_${monthName}_${year}.pdf`);
        };
        // --- NÃ–BET FONKSÄ°YONLARI ---
        window.renderShiftHeader = function () {
            const d = shiftCursorDate;
            document.getElementById('shift-period-display').innerText = `${monthsTR[d.getMonth()]} ${d.getFullYear()}`;
            const dateInput = document.getElementById('shift-date');
            if (dateInput && !dateInput.value) {
                const now = new Date();
                dateInput.value = (now.getMonth() === d.getMonth() && now.getFullYear() === d.getFullYear()) ? getLocalDateString(now) : getLocalDateString(new Date(d.getFullYear(), d.getMonth(), 1));
            }
            renderShiftTable();
        };
        window.changeShiftMonth = function (dir) { shiftCursorDate.setMonth(shiftCursorDate.getMonth() + dir); renderShiftHeader(); };
        window.renderShiftTable = function () {
            const tbody = document.getElementById('shift-list-body'), badge = document.getElementById('shift-count-badge'); if (!tbody) return; tbody.innerHTML = '';
            const m = shiftCursorDate.getMonth(), y = shiftCursorDate.getFullYear();
            const filtered = shiftList.filter(s => { const d = new Date(s.date); return d.getMonth() === m && d.getFullYear() === y; }).sort((a, b) => a.date.localeCompare(b.date));
            if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 text-xs">KayÄ±t yok.</td></tr>'; if (badge) badge.innerText = "0 KayÄ±t"; return; }
            filtered.forEach((s) => {
                const idx = shiftList.indexOf(s), dObj = new Date(s.date), isWeekend = (dObj.getDay() === 0 || dObj.getDay() === 6);
                tbody.innerHTML += `<tr class="hover:bg-indigo-50 border-b last:border-0"><td class="px-4 py-3 text-xs ${isWeekend ? 'text-red-600 font-bold' : 'text-gray-600'}">${dObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', weekday: 'short' })}</td><td class="px-4 py-3 font-bold text-gray-700">${s.staff}${s.note ? `<div class="text-[10px] text-gray-400 font-normal">${s.note}</div>` : ''}</td><td class="px-4 py-3 text-center"><span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-[10px] font-bold">${s.type}</span></td><td class="px-4 py-3 text-right"><button onclick="deleteShift(${idx})" class="text-gray-300 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`;
            });
            if (badge) badge.innerText = `${filtered.length} KayÄ±t`; lucide.createIcons();
        };
        // NOT: Duplicate addShift ve deleteShift fonksiyonlarÄ± kaldÄ±rÄ±ldÄ±, yukarÄ±daki async versiyonlar kullanÄ±lacak
        // --- CÄ°HAZ / ZÄ°MMET FONKSÄ°YONLARI ---
        window.renderDeviceTable = function () {
            const tbody = document.getElementById('dev-list-body');
            const badge = document.getElementById('dev-count-badge');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (deviceList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400 text-xs">KayÄ±tlÄ± cihaz yok.</td></tr>';
                if (badge) badge.innerText = "0 Cihaz";
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            deviceList.forEach((d, idx) => {
                let calibStatusHtml = '<span class="text-gray-400">-</span>';
                if (d.calibDate) {
                    const cDate = new Date(d.calibDate);
                    const isExpired = cDate < today;
                    const isClose = (cDate - today) / (1000 * 60 * 60 * 24) < 7;

                    let dateColor = "text-gray-600";
                    let icon = "";

                    if (isExpired) {
                        dateColor = "text-red-600 font-bold";
                        icon = '<i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1 text-red-600"></i>';
                    } else if (isClose) {
                        dateColor = "text-orange-600 font-bold";
                        icon = '<i data-lucide="clock" class="w-3 h-3 inline mr-1 text-orange-600"></i>';
                    }
                    calibStatusHtml = `<span class="${dateColor} text-xs">${icon}${new Date(d.calibDate).toLocaleDateString('tr-TR')}</span>`;
                }

                let statusClass = "bg-gray-100 text-gray-700";
                if (d.status.includes("SaÄŸlam")) statusClass = "bg-teal-100 text-teal-800";
                if (d.status.includes("ArÄ±zalÄ±")) statusClass = "bg-red-100 text-red-800";
                if (d.status.includes("Serviste")) statusClass = "bg-orange-100 text-orange-800";
                if (d.status.includes("Kayboldu")) statusClass = "bg-gray-800 text-white";

                tbody.innerHTML += `
                <tr class="hover:bg-teal-50/30 border-b last:border-0 group transition">
                    <td class="px-4 py-3 font-bold text-teal-700 text-xs font-mono">${d.tagNo || '-'}</td>
                    <td class="px-4 py-3 font-medium text-gray-700">${d.name}</td>
                    <td class="px-4 py-3 font-bold text-gray-600">${d.holder}</td>
                    <td class="px-4 py-3">${calibStatusHtml}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-[10px] font-bold ${statusClass}">${d.status}</span></td>
                    <td class="px-4 py-3 text-right">
                        <div class="flex justify-end items-center gap-2">
                            <button onclick="startEditDevice(${idx})" class="text-gray-400 hover:text-orange-600 transition p-1" title="DÃ¼zenle">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteDevice(${idx})" class="text-gray-400 hover:text-red-600 transition p-1" title="Sil">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            });

            if (badge) badge.innerText = `${deviceList.length} Cihaz`;
            lucide.createIcons();
        };

        window.addDevice = async function () {
            const tagNo = document.getElementById('dev-tag-no').value.trim();
            const name = document.getElementById('dev-name').value.trim();
            const holder = document.getElementById('dev-holder').value.trim();
            const calibDate = document.getElementById('dev-calib-date').value;
            const status = document.getElementById('dev-status').value;

            if (!name || !holder) return showToast("Cihaz adÄ± ve Zimmet kiÅŸisi zorunludur.", "error");

            const deviceObj = { tagNo, name, holder, calibDate, status };

            if (editingDeviceIndex > -1) {
                // DÃ¼zenleme Modu
                deviceList[editingDeviceIndex] = deviceObj;
                showToast("Cihaz bilgileri gÃ¼ncellendi.");
                cancelDeviceEdit(); // Moddan Ã§Ä±k
            } else {
                // Yeni Ekleme Modu
                deviceList.push(deviceObj);
                showToast("Cihaz eklendi.");
                addActivityLog('device', 'Cihaz eklendi', `${name} â†’ ${holder}`);
                // Formu temizle
                document.getElementById('dev-tag-no').value = '';
                document.getElementById('dev-name').value = '';
                document.getElementById('dev-name').focus();
            }

            // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
            await saveAll();
            renderDeviceTable();
            showToast("Cihaz eklendi");
        };

        window.startEditDevice = function (idx) {
            const item = deviceList[idx];
            if (!item) return;

            // Formu doldur
            document.getElementById('dev-tag-no').value = item.tagNo || '';
            document.getElementById('dev-name').value = item.name;
            document.getElementById('dev-holder').value = item.holder;
            document.getElementById('dev-calib-date').value = item.calibDate || '';
            document.getElementById('dev-status').value = item.status;

            // Modu aktif et
            editingDeviceIndex = idx;

            // ButonlarÄ± gÃ¼ncelle
            const btnSave = document.getElementById('btn-device-save');
            const btnCancel = document.getElementById('btn-device-cancel');

            btnSave.innerHTML = '<span>GÃ¼ncelle</span>';
            btnSave.classList.replace('bg-teal-600', 'bg-orange-600');
            btnSave.classList.replace('hover:bg-teal-700', 'hover:bg-orange-700');

            btnCancel.classList.remove('hidden');

            // YukarÄ± kaydÄ±r (Mobil iÃ§in)
            document.getElementById('dev-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        window.cancelDeviceEdit = function () {
            // Formu temizle
            document.getElementById('dev-tag-no').value = '';
            document.getElementById('dev-name').value = '';
            document.getElementById('dev-holder').value = '';
            document.getElementById('dev-calib-date').value = '';
            document.getElementById('dev-status').value = 'SaÄŸlam';

            // Modu kapat
            editingDeviceIndex = -1;

            // ButonlarÄ± eski haline getir
            const btnSave = document.getElementById('btn-device-save');
            const btnCancel = document.getElementById('btn-device-cancel');

            btnSave.innerHTML = '<span>Envantere Ekle</span>';
            btnSave.classList.replace('bg-orange-600', 'bg-teal-600');
            btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-teal-700');

            btnCancel.classList.add('hidden');
        };

        window.deleteDevice = async function (idx) {
            if (confirm("Bu cihaz kaydÄ±nÄ± silmek istiyor musunuz?")) {
                deviceList.splice(idx, 1);

                // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
                await saveAll();
                renderDeviceTable();
                showToast("Silindi.");
            }
        };
        // --- Ä°STATÄ°STÄ°K PANOSU JS ---
        let chartInstances = {}; // Grafikleri hafÄ±zada tutmak iÃ§in

        window.renderDashboard = function () {
            // --- 1. TARÄ°H AYARLARI ---
            const now = new Date();
            const currentMonth = getLocalDateString(now).slice(0, 7); // "2025-12"

            // --- 2. VERÄ°LERÄ° HAZIRLA ---
            let totalPatientsThisMonth = 0;
            const procStats = {};
            procList.forEach(p => procStats[p] = 0);

            // Doktor Detay YapÄ±sÄ±
            const doctorDetailedStats = {};
            const allEncounteredProcs = new Set();

            doctorList.forEach(d => {
                doctorDetailedStats[d.name] = { patients: 0, procs: {} };
            });

            // --- 3. DOKTOR VE Ä°ÅLEM VERÄ°LERÄ°NÄ° HESAPLA ---
            Object.keys(docRecords).forEach(date => {
                if (date.startsWith(currentMonth)) {
                    doctorList.forEach(doc => {
                        const rec = docRecords[date][doc.name];
                        if (rec) {
                            // A) Hasta SayÄ±sÄ±
                            const pCount = parseInt(rec.pCount) || 0;
                            if (pCount > 0) {
                                totalPatientsThisMonth += pCount;
                                if (doctorDetailedStats[doc.name]) doctorDetailedStats[doc.name].patients += pCount;
                            }

                            // B) Ä°ÅŸlem SayÄ±larÄ±
                            if (rec.procs) {
                                Object.entries(rec.procs).forEach(([procName, count]) => {
                                    const val = parseInt(count) || 0;
                                    if (val > 0) {
                                        if (procStats[procName] === undefined) procStats[procName] = 0;
                                        procStats[procName] += val;

                                        if (doctorDetailedStats[doc.name]) {
                                            if (!doctorDetailedStats[doc.name].procs[procName]) doctorDetailedStats[doc.name].procs[procName] = 0;
                                            doctorDetailedStats[doc.name].procs[procName] += val;
                                            allEncounteredProcs.add(procName);
                                        }
                                    }
                                });
                            }
                        }
                    });
                }
            });

            // --- 4. PERSONEL PERFORMANS VERÄ°LERÄ° ---
            const staffStats = {};
            Object.keys(allRecords).forEach(date => {
                if (!date.startsWith(currentMonth)) return;
                staffList.forEach(s => {
                    const r = allRecords[date][s.name];
                    if (r) {
                        const specCount = r.specialists ? r.specialists.length : 0;
                        const dailyScore = (r.mm || 0) + (r.mk || 0) + (r.am || 0) + (r.ak || 0) + ((r.e || 0) * 2) + specCount;
                        if (dailyScore > 0) staffStats[s.name] = (staffStats[s.name] || 0) + dailyScore;
                    }
                });
            });

            // --- 5. KARTLARI GÃœNCELLE ---
            document.getElementById('stat-total-visit').innerText = totalPatientsThisMonth;

            let maxScore = 0;
            Object.values(staffStats).forEach(score => { if (score > maxScore) maxScore = score; });
            let topPerformers = [];
            if (maxScore > 0) {
                Object.entries(staffStats).forEach(([name, score]) => { if (score === maxScore) topPerformers.push(name); });
            }
            const topStaffText = topPerformers.length > 0 ? `${topPerformers.join(', ')} (${maxScore})` : "-";
            const elTopStaff = document.getElementById('stat-top-staff');
            elTopStaff.innerText = topStaffText;
            elTopStaff.classList.replace(topPerformers.length > 2 ? 'text-xl' : 'text-sm', topPerformers.length > 2 ? 'text-sm' : 'text-xl');

            // --- 6. GRAFÄ°KLERÄ° Ã‡Ä°Z ---
            if (chartInstances['staff']) chartInstances['staff'].destroy();
            if (chartInstances['types']) chartInstances['types'].destroy();
            if (chartInstances['docDetail']) chartInstances['docDetail'].destroy();

            const colors = [
                'rgba(59, 130, 246, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(16, 185, 129, 0.7)',
                'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)',
                'rgba(245, 158, 11, 0.7)', 'rgba(6, 182, 212, 0.7)'
            ];

            // Grafik 1
            const ctxStaff = document.getElementById('chart-staff-performance').getContext('2d');
            chartInstances['staff'] = new Chart(ctxStaff, {
                type: 'bar',
                data: {
                    labels: Object.keys(staffStats),
                    datasets: [{
                        label: 'Bu Ayki Performans PuanÄ±',
                        data: Object.values(staffStats),
                        backgroundColor: 'rgba(79, 70, 229, 0.7)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            // Grafik 2 (Pasta - SayÄ±lÄ± Etiketler)
            const activeProcs = []; const activeCounts = [];
            Object.entries(procStats).forEach(([name, count]) => {
                if (count > 0) { activeProcs.push(`${name} (${count})`); activeCounts.push(count); }
            });
            const ctxTypes = document.getElementById('chart-visit-types').getContext('2d');
            chartInstances['types'] = new Chart(ctxTypes, {
                type: 'doughnut',
                data: {
                    labels: activeProcs.length ? activeProcs : ['Veri Yok'],
                    datasets: [{
                        data: activeCounts.length ? activeCounts : [1],
                        backgroundColor: activeCounts.length ? colors : ['#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });

            // Grafik 3 (Doktor Detay)
            const docNames = Object.keys(doctorDetailedStats);
            const docDatasets = [];

            // Hasta SayÄ±sÄ±
            docDatasets.push({
                label: 'Toplam Hasta',
                data: docNames.map(name => doctorDetailedStats[name].patients),
                backgroundColor: 'rgba(30, 64, 175, 0.8)',
                stack: 'Patients',
            });

            // Ä°ÅŸlemler
            let colorIdx = 0;
            Array.from(allEncounteredProcs).forEach(procName => {
                docDatasets.push({
                    label: procName,
                    data: docNames.map(name => doctorDetailedStats[name].procs[procName] || 0),
                    backgroundColor: colors[colorIdx % colors.length],
                    stack: 'Procedures',
                });
                colorIdx++;
            });

            const ctxDocDetail = document.getElementById('chart-doctor-details').getContext('2d');
            chartInstances['docDetail'] = new Chart(ctxDocDetail, {
                type: 'bar',
                data: { labels: docNames, datasets: docDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { beginAtZero: true, stacked: true } },
                    plugins: { tooltip: { mode: 'index', intersect: false } }
                }
            });

            // --- 7. DETAY KARTLARINI OLUÅTUR (HTML) ---
            const breakdownArea = document.getElementById('doc-breakdown-area');
            breakdownArea.innerHTML = ''; // Temizle

            Object.entries(doctorDetailedStats).forEach(([docName, stats]) => {
                // Sadece verisi olan doktorlarÄ± gÃ¶sterelim
                if (stats.patients === 0 && Object.keys(stats.procs).length === 0) return;

                // Ä°ÅŸlem Listesi HTML'i HazÄ±rla
                let procsHtml = '';
                Object.entries(stats.procs).forEach(([pName, pCount]) => {
                    if (pCount > 0) {
                        procsHtml += `<span class="inline-block bg-gray-100 dark:bg-gray-700 rounded px-2 py-1 text-xs mr-1 mb-1 text-gray-700 dark:text-gray-300">${pName} <b>(${pCount})</b></span>`;
                    }
                });

                if (procsHtml === '') procsHtml = '<span class="text-xs text-gray-400">Ä°ÅŸlem yok</span>';

                const cardHtml = `
                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-3 border border-gray-100 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-2 border-b pb-1 dark:border-gray-700">
                        <h4 class="font-bold text-sm text-indigo-700 dark:text-indigo-400">${docName}</h4>
                        <span class="text-xs font-bold bg-blue-100 text-blue-800 px-2 py-0.5 rounded">H: ${stats.patients}</span>
                    </div>
                    <div class="flex flex-wrap">
                        ${procsHtml}
                    </div>
                </div>
            `;
                breakdownArea.innerHTML += cardHtml;
            });
            // --- 8. NÃ–BET Ã‡Ä°ZELGESÄ° MODÃœLÃœ (3 HAFTALIK) ---

            // YardÄ±mcÄ± Fonksiyon: Belirli bir baÅŸlangÄ±Ã§ tarihine gÃ¶re tabloyu doldurur
            const renderWeekTable = (startDate, containerId, emptyMsg) => {
                const tbody = document.getElementById(containerId);
                if (!tbody) return;

                tbody.innerHTML = '';

                // 7 GÃ¼nlÃ¼k Tarih Listesi OluÅŸtur
                const targetDates = [];
                let tempDate = new Date(startDate);
                for (let i = 0; i < 7; i++) {
                    targetDates.push(getLocalDateString(tempDate));
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                // NÃ¶betleri SÃ¼z
                const weekShifts = shiftList.filter(s => targetDates.includes(s.date));
                weekShifts.sort((a, b) => a.date.localeCompare(b.date));

                if (weekShifts.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-400 italic text-[10px]">${emptyMsg}</td></tr>`;
                } else {
                    weekShifts.forEach(s => {
                        const d = new Date(s.date);
                        const dayName = d.toLocaleDateString('tr-TR', { weekday: 'long' });
                        const dateDisplay = d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
                        const isWeekend = (d.getDay() === 0 || d.getDay() === 6);

                        // Hafta sonu rengi
                        const rowBg = isWeekend ? 'bg-orange-50/40 dark:bg-orange-900/10' : 'hover:bg-gray-50 dark:hover:bg-gray-700';
                        const dateColor = isWeekend ? 'text-orange-700 dark:text-orange-400' : 'text-gray-700 dark:text-gray-200';

                        // TÃ¼r Rengi
                        let badgeClass = "bg-indigo-100 text-indigo-700 border-indigo-200";
                        if (s.type === 'Ä°cap') badgeClass = "bg-yellow-100 text-yellow-700 border-yellow-200";
                        if (s.type === '24 Saat' || s.type === 'Gece') badgeClass = "bg-red-100 text-red-700 border-red-200";

                        tbody.innerHTML += `
                        <tr class="${rowBg} transition border-b border-gray-100 dark:border-gray-700 last:border-0">
                            <td class="px-4 py-2 w-1/3">
                                <div class="flex flex-col">
                                    <span class="font-bold text-[11px] ${dateColor}">${dayName}</span>
                                    <span class="text-[9px] text-gray-400">${dateDisplay}</span>
                                </div>
                            </td>
                            <td class="px-4 py-2 w-1/3">
                                <div class="flex items-center gap-2">
                                    <div class="w-5 h-5 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 font-bold text-[9px] shadow-sm">
                                        ${s.staff.charAt(0)}
                                    </div>
                                    <span class="font-bold text-gray-800 dark:text-gray-100 text-xs truncate max-w-[120px]">${s.staff}</span>
                                </div>
                                ${s.note ? `<div class="text-[9px] text-gray-400 italic mt-0.5 ml-7 truncate max-w-[150px]">${s.note}</div>` : ''}
                            </td>
                            <td class="px-4 py-2 w-1/3 text-right">
                                <span class="px-1.5 py-0.5 rounded text-[9px] font-bold border ${badgeClass} shadow-sm">
                                    ${s.type}
                                </span>
                            </td>
                        </tr>
                    `;
                    });
                }
            };

            // 1. MEVCUT HAFTA (Current Week)
            renderWeekTable(currentWeekStart, 'stat-weekly-shifts-body', 'Bu hafta nÃ¶bet yok.');

            // 2. GEÃ‡EN HAFTA (Previous Week)
            const prevWeekStart = new Date(currentWeekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            renderWeekTable(prevWeekStart, 'stat-prev-week-shifts-body', 'GeÃ§en hafta nÃ¶bet yok.');

            // 3. GELECEK HAFTA (Next Week)
            const nextWeekStart = new Date(currentWeekStart);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);
            renderWeekTable(nextWeekStart, 'stat-next-week-shifts-body', 'Gelecek hafta nÃ¶bet yok.');
        };
        // --- KARANLIK MOD MANTIÄI ---
        const themeBtn = document.getElementById('btn-theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const htmlEl = document.documentElement;

        // Sayfa yÃ¼klendiÄŸinde hafÄ±zayÄ± kontrol et
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlEl.classList.add('dark');
            themeIcon.setAttribute('data-lucide', 'sun'); // Ä°konu GÃ¼neÅŸ yap
        } else {
            htmlEl.classList.remove('dark');
            themeIcon.setAttribute('data-lucide', 'moon'); // Ä°konu Ay yap
        }

        // Butona tÄ±klama olayÄ±
        if (themeBtn) {
            themeBtn.addEventListener('click', function () {
                if (htmlEl.classList.contains('dark')) {
                    htmlEl.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                    themeIcon.setAttribute('data-lucide', 'moon');
                } else {
                    htmlEl.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                    themeIcon.setAttribute('data-lucide', 'sun');
                }
                lucide.createIcons(); // Ä°konu yenile
            });
        }
        // --- GLOBAL ARAMA (SPOTLIGHT SEARCH) MANTIÄI ---
        const searchInput = document.getElementById('global-search-input');
        const searchResults = document.getElementById('global-search-results');

        if (searchInput) {
            // 1. Arama YapÄ±ldÄ±kÃ§a Ã‡alÄ±ÅŸ
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if (query.length < 2) { // 2 harften azsa arama yapma
                    searchResults.classList.add('hidden');
                    return;
                }
                const results = performGlobalSearch(query);
                renderGlobalSearchResults(results);
            });

            // 2. DÄ±ÅŸarÄ± TÄ±klayÄ±nca Kapat
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                }
            });

            // 3. Kutuya TÄ±klayÄ±nca (EÄŸer veri varsa) AÃ§
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim().length >= 2) searchResults.classList.remove('hidden');
            });
        }

        // --- GELÄ°ÅTÄ°RÄ°LMÄ°Å GLOBAL ARAMA (HER ÅEY DAHÄ°L) ---
        function performGlobalSearch(q) {
            // Arama terimlerini parÃ§ala (Ã–rn: "Ahmet Sonda" -> ["ahmet", "sonda"])
            // BÃ¶ylece kelime sÄ±rasÄ± fark etmeksizin sonuÃ§ bulabiliriz.
            const terms = q.toLowerCase().split(' ').filter(t => t.trim() !== '');

            let hits = [];

            // YardÄ±mcÄ± Fonksiyon: Bir objenin iÃ§inde arama terimlerinin hepsi geÃ§iyor mu?
            const checkMatch = (textSource) => {
                const text = textSource.toLowerCase();
                return terms.every(term => text.includes(term));
            };

            // 1. PERSONEL ARAMASI
            staffList.forEach(s => {
                if (checkMatch(s.name + " " + s.role))
                    hits.push({ type: 'Personel', title: s.name, sub: s.role, icon: 'user', color: 'text-blue-600', bg: 'bg-blue-100', action: () => switchTab('personel') });
            });

            // 2. DOKTOR ARAMASI
            doctorList.forEach(d => {
                if (checkMatch(d.name + " Doktor"))
                    hits.push({ type: 'Doktor', title: d.name, sub: 'Doktor Listesi', icon: 'stethoscope', color: 'text-indigo-600', bg: 'bg-indigo-100', action: () => switchTab('personel') });
            });

            // 3. CÄ°HAZ & ZÄ°MMET
            deviceList.forEach(d => {
                if (checkMatch((d.name || '') + " " + (d.tagNo || '') + " " + (d.holder || '') + " " + (d.status || ''))) {
                    hits.push({ type: 'Cihaz', title: d.name, sub: `${d.tagNo || 'No Yok'} - ${d.holder}`, icon: 'activity', color: 'text-teal-600', bg: 'bg-teal-100', action: () => switchTab('cihazlar') });
                }
            });

            // 4. NÃ–BET LÄ°STESÄ°
            shiftList.forEach(s => {
                if (checkMatch((s.staff || '') + " " + (s.note || '') + " " + (s.type || ''))) {
                    const d = new Date(s.date);
                    hits.push({
                        type: 'NÃ¶bet', title: s.staff, sub: `${d.toLocaleDateString('tr-TR')} (${s.type})`, icon: 'calendar-clock', color: 'text-purple-600', bg: 'bg-purple-100',
                        action: () => {
                            shiftCursorDate = new Date(s.date); // O aya git
                            switchTab('nobet');
                        }
                    });
                }
            });

            // 5. GENEL NOTLAR
            generalNotesList.forEach(n => {
                if (checkMatch((n.title || '') + " " + (n.content || ''))) {
                    hits.push({ type: 'Not', title: n.title, sub: n.date, icon: 'sticky-note', color: 'text-yellow-600', bg: 'bg-yellow-100', action: () => { switchTab('notlar'); } });
                }
            });

            // 6. ACÄ°L Ã‡ANTA MALZEMELERÄ°
            emergencyList.forEach(i => {
                if (checkMatch((i.name || '') + " " + (i.bagName || '') + " " + (i.note || ''))) {
                    hits.push({
                        type: 'Acil Ã‡anta', title: i.name, sub: `${i.bagName} (Stok: ${i.count})`, icon: 'briefcase-medical', color: 'text-red-600', bg: 'bg-red-100',
                        action: () => {
                            currentBag = i.bagName; // Ã‡antayÄ± seÃ§
                            if (document.getElementById('bag-selector')) document.getElementById('bag-selector').value = i.bagName;
                            switchTab('acilcanta');
                        }
                    });
                }
            });

            // --- YENÄ° EKLENEN ARAMA KAPSAMLARI ---

            // 7. HASTA TAKÄ°P & Ä°ÅLEMLER
            if (typeof patientReminders !== 'undefined') {
                patientReminders.forEach(r => {
                    if (checkMatch((r.name || '') + " " + (r.proc || '') + " " + (r.note || ''))) {
                        hits.push({
                            type: 'Hasta Ä°ÅŸlemi', title: r.name, sub: `${r.proc} - ${formatDateTR(r.date)}`, icon: 'calendar-plus', color: 'text-indigo-600', bg: 'bg-indigo-50',
                            action: () => switchTab('hastatakip')
                        });
                    }
                });
            }

            // 8. BÃœTÃ‡E HAREKETLERÄ°
            if (typeof budgetList !== 'undefined') {
                budgetList.forEach(b => {
                    if (checkMatch((b.desc || '') + " " + (b.note || '') + " " + (b.amount || '') + " " + (b.type === 'income' ? 'Gelir' : 'Gider'))) {
                        hits.push({
                            type: 'BÃ¼tÃ§e', title: b.desc, sub: `${b.amount} TL (${b.type === 'income' ? 'Gelir' : 'Gider'})`, icon: 'wallet', color: 'text-green-600', bg: 'bg-green-50',
                            action: () => {
                                // O tarihin olduÄŸu aya git
                                budgetCursorDate = new Date(b.date);
                                switchTab('butce');
                            }
                        });
                    }
                });
            }

            // 9. RUTÄ°NLER
            if (typeof routineList !== 'undefined') {
                routineList.forEach(r => {
                    if (checkMatch(r.text || '')) {
                        hits.push({ type: 'Rutin', title: r.text, sub: r.completed ? 'TamamlandÄ±' : 'Bekliyor', icon: 'list-todo', color: 'text-gray-600', bg: 'bg-gray-100', action: () => switchTab('rutinler') });
                    }
                });
            }

            // 10. Ä°ZÄ°NLER
            if (typeof leaveRecords !== 'undefined') {
                leaveRecords.forEach(l => {
                    if (checkMatch((l.staffName || '') + " " + (l.type || ''))) {
                        hits.push({ type: 'Ä°zin/Rapor', title: l.staffName, sub: `${l.type} (${formatDateTR(l.startDate)})`, icon: 'calendar-off', color: 'text-orange-600', bg: 'bg-orange-50', action: () => switchTab('personel') });
                    }
                });
            }

            // 11. TELEFON REHBERÄ° (EÄŸer eklendiyse)
            if (typeof phonebookList !== 'undefined') {
                phonebookList.forEach(p => {
                    if (checkMatch((p.name || '') + " " + (p.role || '') + " " + (p.num || ''))) {
                        hits.push({ type: 'Rehber', title: p.name, sub: `${p.num} - ${p.role}`, icon: 'phone', color: 'text-green-600', bg: 'bg-green-50', action: () => switchTab('rehber') });
                    }
                });
            }

            return hits;
        }

        function renderGlobalSearchResults(results) {
            searchResults.innerHTML = '';
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="p-4 text-sm text-gray-400 text-center italic">EÅŸleÅŸen kayÄ±t bulunamadÄ±.</div>';
                searchResults.classList.remove('hidden');
                return;
            }

            // SonuÃ§larÄ± Listele (Maksimum 8 tane gÃ¶sterelim ki ekran dolmasÄ±n)
            results.slice(0, 8).forEach(res => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer transition group';
                item.innerHTML = `
                <div class="${res.bg} ${res.color} p-2 rounded-lg group-hover:scale-110 transition-transform"><i data-lucide="${res.icon}" class="w-5 h-5"></i></div>
                <div>
                    <div class="text-sm font-bold text-gray-800">${res.title}</div>
                    <div class="text-xs text-gray-500 flex items-center gap-1.5">
                        <span class="font-semibold ${res.color} bg-white border px-1.5 rounded text-[10px] uppercase tracking-wide">${res.type}</span>
                        <span>${res.sub}</span>
                    </div>
                </div>
            `;
                item.onclick = () => {
                    res.action(); // Ä°lgili sekmeye git
                    searchResults.classList.add('hidden'); // Listeyi kapat
                    searchInput.value = ''; // Kutuyu temizle
                };
                searchResults.appendChild(item);
            });

            // EÄŸer Ã§ok sonuÃ§ varsa altÄ±na not dÃ¼ÅŸ
            if (results.length > 8) {
                searchResults.insertAdjacentHTML('beforeend', `<div class="p-2 text-center text-[10px] text-gray-400 font-medium bg-gray-50 uppercase tracking-wider">${results.length - 8} kayÄ±t daha var...</div>`);
            }

            searchResults.classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        // --- GÃœNLÃœK PDF RAPOR MODÃœLÃœ ---
        window.generateDailyReport = function () {
            // 1. BugÃ¼nÃ¼n Tarihini ve Verilerini HazÄ±rla
            const today = new Date();
            const dateKey = getLocalDateString(today); // "2025-12-20" formatÄ± (Senin sistemindeki fonksiyon)
            const dateDisplay = today.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Ä°statistikler
            let totalStaff = staffList.length;
            let activeStaff = 0;
            let totalPoints = 0;
            let onLeave = 0;

            // 2. Tablo GÃ¶vdesini OluÅŸtur
            // BaÅŸlÄ±k SatÄ±rÄ±
            let tableBody = [
                [
                    { text: 'Personel AdÄ±', style: 'tableHeader', fillColor: '#f3f4f6' },
                    { text: 'Sabah GÃ¶revi', style: 'tableHeader', fillColor: '#f3f4f6' },
                    { text: 'Ã–ÄŸle GÃ¶revi', style: 'tableHeader', fillColor: '#f3f4f6' },
                    { text: 'Durum / Puan', style: 'tableHeader', fillColor: '#f3f4f6' }
                ]
            ];

            // Personel Listesini DÃ¶n
            staffList.forEach(s => {
                const r = allRecords[dateKey]?.[s.name]; // O gÃ¼nkÃ¼ kayÄ±t
                const leave = leaveRecords.find(l => l.staffName === s.name && dateKey >= l.startDate && dateKey <= l.endDate);

                let row = [];

                if (leave) {
                    // Ä°ZÄ°NLÄ° Ä°SE
                    onLeave++;
                    const typeText = leave.type === 'Rapor' ? 'RAPORLU' : 'Ä°ZÄ°NLÄ°';
                    const color = leave.type === 'Rapor' ? '#fee2e2' : '#ffedd5'; // KÄ±rmÄ±zÄ±msÄ± veya Turuncumsu

                    row = [
                        { text: s.name, style: 'cellText' },
                        { text: typeText, colSpan: 2, alignment: 'center', style: 'cellText', fillColor: color, color: '#991b1b', bold: true },
                        {}, // colSpan olduÄŸu iÃ§in boÅŸ
                        { text: '-', alignment: 'center', style: 'cellText' }
                    ];
                } else if (r) {
                    // Ã‡ALIÅIYORSA
                    activeStaff++;

                    // Puan HesabÄ±
                    const specCount = r.specialists ? r.specialists.length : 0;
                    const score = (r.mm || 0) + (r.mk || 0) + (r.am || 0) + (r.ak || 0) + ((r.e || 0) * 2) + specCount;
                    totalPoints += score;

                    // Sabah Durumu Metni
                    let morningText = [];
                    if (r.mm) morningText.push("Merkez");
                    if (r.mk) morningText.push("KÃ¶y");
                    if (morningText.length === 0) morningText.push("-");

                    // Ã–ÄŸle Durumu Metni
                    let noonText = [];
                    if (r.am) noonText.push("Merkez");
                    if (r.ak) noonText.push("KÃ¶y");
                    if (noonText.length === 0) noonText.push("-");

                    // Muayene Varsa Ekle
                    let statusText = score.toString();
                    if (r.e > 0) statusText += ` (${r.e} Muayene)`;

                    row = [
                        { text: s.name, style: 'cellText', bold: true },
                        { text: morningText.join(' + '), style: 'cellText' },
                        { text: noonText.join(' + '), style: 'cellText' },
                        { text: statusText, alignment: 'center', style: 'cellText', bold: true, color: score > 0 ? '#166534' : '#000' }
                    ];
                } else {
                    // VERÄ° YOKSA (BOÅ)
                    row = [
                        { text: s.name, style: 'cellText', color: '#9ca3af' },
                        { text: '-', alignment: 'center', style: 'cellText', color: '#9ca3af' },
                        { text: '-', alignment: 'center', style: 'cellText', color: '#9ca3af' },
                        { text: '0', alignment: 'center', style: 'cellText', color: '#9ca3af' }
                    ];
                }
                tableBody.push(row);
            });

            // 3. PDF TanÄ±mlamasÄ± (Design)
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 40, 40, 40],
                content: [
                    // BAÅLIK
                    { text: 'EVDE SAÄLIK HÄ°ZMETLERÄ° BÄ°RÄ°MÄ°', style: 'mainHeader', alignment: 'center' },
                    { text: 'GÃœNLÃœK FAALÄ°YET VE PERSONEL DURUM RAPORU', style: 'subHeader', alignment: 'center', margin: [0, 5, 0, 20] },

                    // TARÄ°H VE Ã–ZET KUTUSU
                    {
                        style: 'summaryBox',
                        table: {
                            widths: ['*', '*', '*', '*'],
                            body: [[
                                { text: `Rapor Tarihi:\n${dateDisplay}`, style: 'summaryItem', fillOpacity: 0.5 },
                                { text: `Toplam Personel:\n${totalStaff}`, style: 'summaryItem' },
                                { text: `Aktif/Ä°zinli:\n${activeStaff} / ${onLeave}`, style: 'summaryItem' },
                                { text: `GÃ¼nlÃ¼k Toplam Puan:\n${totalPoints}`, style: 'summaryItem', bold: true }
                            ]]
                        },
                        layout: 'noBorders',
                        margin: [0, 0, 0, 20]
                    },

                    // ANA TABLO
                    {
                        table: {
                            headerRows: 1,
                            widths: ['35%', '25%', '25%', '15%'],
                            body: tableBody
                        },
                        layout: {
                            fillColor: function (rowIndex) { return (rowIndex % 2 === 0) ? null : '#f9fafb'; }, // SatÄ±rlarÄ± kÄ±rÃ§Ä±llÄ± yap
                            hLineWidth: function (i, node) { return (i === 0 || i === node.table.body.length) ? 2 : 1; },
                            vLineWidth: function (i, node) { return (i === 0 || i === node.table.widths.length) ? 2 : 1; },
                            hLineColor: function (i) { return (i === 0) ? '#1f2937' : '#e5e7eb'; },
                            vLineColor: function (i) { return '#e5e7eb'; }
                        }
                    },

                    // Ä°MZA ALANI
                    {
                        margin: [0, 40, 0, 0],
                        columns: [
                            {
                                width: '*',
                                stack: [
                                    { text: '', alignment: 'center', bold: true, decoration: 'underline' },
                                    { text: '\n\n..........................................', alignment: 'center', color: '#d1d5db' },
                                    { text: '', alignment: 'center', fontSize: 8, color: '#6b7280' }
                                ]
                            },
                            {
                                width: '*',
                                stack: [
                                    { text: '', alignment: 'center', bold: true, decoration: 'underline' },
                                    { text: '\n\n..........................................', alignment: 'center', color: '#d1d5db' },
                                    { text: '', alignment: 'center', fontSize: 8, color: '#6b7280' }
                                ]
                            }
                        ]
                    },

                    // ALT BÄ°LGÄ°
                    { text: 'Bu rapor Evde SaÄŸlÄ±k Takip Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.', style: 'footer', alignment: 'center', margin: [0, 30, 0, 0] }
                ],

                // STÄ°LLER
                styles: {
                    mainHeader: { fontSize: 16, bold: true, color: '#111827' },
                    subHeader: { fontSize: 12, color: '#4b5563', bold: true },
                    tableHeader: { bold: true, fontSize: 10, color: '#1f2937', margin: [0, 5, 0, 5] },
                    cellText: { fontSize: 9, color: '#374151', margin: [0, 4, 0, 4] },
                    summaryItem: { fontSize: 10, alignment: 'center', color: '#374151' },
                    footer: { fontSize: 8, color: '#9ca3af', italics: true }
                }
            };

            // PDF OLUÅTUR VE Ä°NDÄ°R
            pdfMake.createPdf(docDefinition).download(`Gunluk_Rapor_${dateKey}.pdf`);
            showToast("GÃ¼nlÃ¼k rapor PDF olarak indiriliyor...");
        };
        // --- HASTA TAKÄ°P & HATIRLATICI MODÃœLÃœ ---
        const LS_PATIENT_REMINDERS = 'evdeSaglikReminders_V1';
        window.patientReminders = window.patientReminders || [];

        // 1. Verileri YÃ¼kle (Bunu window.onload iÃ§ine de ekleyeceÄŸiz birazdan)
        function loadReminders() {
            try {
                window.patientReminders = JSON.parse(localStorage.getItem(LS_PATIENT_REMINDERS)) || [];
            } catch { window.patientReminders = []; }
            renderPatientReminders();
            checkTomorrowAlert(); // Sayfa aÃ§Ä±lÄ±nca kontrol et
        }

        // --- BURADAN KOPYALA ---

        // 1. GLOBAL DEÄÄ°ÅKEN (Hangi kaydÄ± dÃ¼zenlediÄŸimizi tutar)
        let editingReminderId = -1;

        // 2. GÃœNCELLENMÄ°Å KAYDETME FONKSÄ°YONU (Hem Yeni KayÄ±t Hem DÃ¼zenleme Yapar)
        window.addPatientReminder = async () => {
            const pName = document.getElementById('rem-patient').value.trim();
            const pProc = document.getElementById('rem-proc').value;
            const pDate = document.getElementById('rem-date').value;
            const pNote = document.getElementById('rem-note').value.trim();

            if (!pName || !pDate) return showToast("Hasta adÄ± ve tarih zorunlu!", "error");

            if (editingReminderId > -1) {
                // --- GÃœNCELLEME MODU ---
                // Listede dÃ¼zenlenen kaydÄ± bul
                const idx = patientReminders.findIndex(r => r.id === editingReminderId);
                if (idx > -1) {
                    // KullanÄ±cÄ± bilgisini al
                    const userEmail = currentUser?.email || 'Bilinmeyen';
                    // Sadece verileri gÃ¼ncelle, ID ve Status aynÄ± kalsÄ±n
                    patientReminders[idx].name = pName;
                    patientReminders[idx].proc = pProc;
                    patientReminders[idx].date = pDate;
                    patientReminders[idx].note = pNote;
                    patientReminders[idx].lastModifiedBy = userEmail;
                    patientReminders[idx].lastModifiedAt = new Date().toISOString();

                    showToast("KayÄ±t gÃ¼ncellendi.");
                    cancelReminderEdit(); // Moddan Ã§Ä±k ve formu temizle
                }
            } else {
                // --- YENÄ° EKLEME MODU ---
                // KullanÄ±cÄ± bilgisini al
                const userEmail = currentUser?.email || 'Bilinmeyen';
                patientReminders.push({
                    id: Date.now(),
                    name: pName,
                    proc: pProc,
                    date: pDate,
                    note: pNote,
                    status: 'pending', // VarsayÄ±lan durum
                    createdBy: userEmail,
                    createdAt: new Date().toISOString()
                });
                showToast("Ä°ÅŸlem planlandÄ±.");
                addActivityLog('reminder', 'Hasta planlandÄ±', pName + ' - ' + pProc);

                // Formu temizle
                document.getElementById('rem-patient').value = '';
                document.getElementById('rem-note').value = '';
            }

            // Tarihe gÃ¶re sÄ±rala ve kaydet
            patientReminders.sort((a, b) => a.date.localeCompare(b.date));

            // Ã–nce Firebase'e kaydet, sonra UI'Ä± gÃ¼ncelle
            await saveReminders();
        };

        // 3. DÃœZENLEMEYÄ° BAÅLATAN FONKSÄ°YON (Listeden 'DÃ¼zenle'ye basÄ±nca Ã§alÄ±ÅŸÄ±r)
        window.startEditReminder = (id) => {
            const item = patientReminders.find(r => r.id === id);
            if (!item) return;

            // Formu seÃ§ilen kaydÄ±n bilgileriyle doldur
            document.getElementById('rem-patient').value = item.name;
            document.getElementById('rem-proc').value = item.proc;
            document.getElementById('rem-date').value = item.date;
            document.getElementById('rem-note').value = item.note || '';

            // Modu aktif et (ID'yi hafÄ±zaya al)
            editingReminderId = id;

            // ButonlarÄ± deÄŸiÅŸtir (Kaydet -> GÃ¼ncelle yap)
            const btnSave = document.getElementById('btn-rem-save');
            const btnCancel = document.getElementById('btn-rem-cancel');

            btnSave.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>';
            btnSave.classList.replace('bg-indigo-600', 'bg-orange-600');
            btnSave.classList.replace('hover:bg-indigo-700', 'hover:bg-orange-700');

            btnCancel.classList.remove('hidden'); // Ä°ptal butonunu gÃ¶ster

            // YukarÄ± kaydÄ±r
            document.getElementById('rem-patient').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('rem-patient').focus();
            lucide.createIcons();
        };

        // 4. DÃœZENLEMEYÄ° Ä°PTAL EDEN FONKSÄ°YON
        window.cancelReminderEdit = () => {
            // Formu temizle
            document.getElementById('rem-patient').value = '';
            document.getElementById('rem-note').value = '';

            // Modu kapat
            editingReminderId = -1;

            // ButonlarÄ± eski haline getir
            const btnSave = document.getElementById('btn-rem-save');
            const btnCancel = document.getElementById('btn-rem-cancel');

            btnSave.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> <span>Kaydet ve Planla</span>';
            btnSave.classList.replace('bg-orange-600', 'bg-indigo-600');
            btnSave.classList.replace('hover:bg-orange-700', 'hover:bg-indigo-700');

            btnCancel.classList.add('hidden'); // Ä°ptal butonunu gizle
            lucide.createIcons();
        };

        // --- BURADA BÄ°TÄ°R ---

        // 3. KayÄ±t Sil
        window.deleteReminder = async (id) => {
            if (confirm("Bu planÄ± silmek istiyor musunuz?")) {
                patientReminders = patientReminders.filter(r => r.id !== id);
                await saveReminders();
                showToast("Silindi.");
            }
        };

        // 4. Kaydet ve Listele
        async function saveReminders() {
            await FirebaseStorage.setItem(LS_PATIENT_REMINDERS, JSON.stringify(patientReminders));
            renderPatientReminders();
            checkTomorrowAlert();
        }

        // --- GÃœNCELLENMÄ°Å HASTA TAKÄ°P LÄ°STELEME VE YÃ–NETÄ°M FONKSÄ°YONLARI ---

        // Sekme state'i
        window.remActiveTab = 'active';

        // Sekme deÄŸiÅŸtirme fonksiyonu
        window.switchRemTab = function (tab) {
            window.remActiveTab = tab;

            // Buton stillerini gÃ¼ncelle
            const activeBtn = document.getElementById('rem-tab-active');
            const historyBtn = document.getElementById('rem-tab-history');

            if (tab === 'active') {
                activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-indigo-600 text-white transition';
                historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
            } else {
                activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
                historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-indigo-600 text-white transition';
            }

            renderPatientReminders();
        };

        // Arama fonksiyonu
        window.remSearchTerm = '';
        function searchPatientReminders(term) {
            window.remSearchTerm = term.toLowerCase();
            renderPatientReminders();
        }

        // 5. Listeyi Ekrana Bas (GÃœNCELLENDÄ°: Butonlar ve Durum YÃ¶netimi Eklendi)
        function renderPatientReminders() {
            const patientReminders = window.patientReminders || [];
            const tbody = document.getElementById('reminder-list-body');
            const badge = document.getElementById('rem-count-badge');
            if (!tbody) return;

            tbody.innerHTML = '';

            // BUGÃœNÃœN TARÄ°HÄ° (Saat sÄ±fÄ±rlanmÄ±ÅŸ)
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Arama filtresi uygula
            const searchTerm = window.remSearchTerm || '';
            const currentTab = window.remActiveTab || 'active';
            let filteredReminders = patientReminders;

            // Sekme filtreleme: Aktif veya GeÃ§miÅŸ
            if (currentTab === 'active') {
                // Aktif: TamamlanmamÄ±ÅŸ ve iptal edilmemiÅŸ iÅŸlemler
                filteredReminders = filteredReminders.filter(r => {
                    const status = r.status || 'pending';
                    return status !== 'completed' && status !== 'cancelled';
                });
            } else {
                // GeÃ§miÅŸ: TamamlanmÄ±ÅŸ veya iptal edilmiÅŸ iÅŸlemler
                filteredReminders = filteredReminders.filter(r => {
                    const status = r.status || 'pending';
                    return status === 'completed' || status === 'cancelled';
                });
            }

            // Arama filtresi uygula
            if (searchTerm) {
                filteredReminders = filteredReminders.filter(r => {
                    const patientMatch = r.name && r.name.toLowerCase().includes(searchTerm);
                    const procMatch = r.proc && r.proc.toLowerCase().includes(searchTerm);
                    const noteMatch = r.note && r.note.toLowerCase().includes(searchTerm);
                    return patientMatch || procMatch || noteMatch;
                });
            }

            if (filteredReminders.length === 0) {
                const emptyMessage = currentTab === 'active'
                    ? (searchTerm ? 'SonuÃ§ bulunamadÄ±.' : 'Aktif iÅŸlem yok.')
                    : (searchTerm ? 'SonuÃ§ bulunamadÄ±.' : 'GeÃ§miÅŸ iÅŸlem yok.');
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400 italic border-2 border-gray-600">${emptyMessage}</td></tr>`;
                if (badge) badge.innerText = filteredReminders.length + " KayÄ±t";
                return;
            }

            filteredReminders.forEach(r => {
                // --- DÃœZELTME BURADA YAPILDI ---
                // Tarihi string'den (YYYY-MM-DD) parÃ§alayarak oluÅŸturuyoruz ki saat farkÄ± olmasÄ±n
                const dParts = r.date.split('-'); // ["2025", "12", "21"]
                const rDate = new Date(dParts[0], dParts[1] - 1, dParts[2]); // Ay 0'dan baÅŸlar
                rDate.setHours(0, 0, 0, 0);

                const diffTime = rDate.getTime() - today.getTime();
                // Math.ceil yerine Math.round kullanÄ±yoruz, tam gÃ¼n farkÄ±nÄ± bulmak iÃ§in
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
                // -------------------------------

                let statusBadge = '';
                let rowClass = 'hover:bg-gray-50';
                let statusStyle = '';

                if (r.status === 'completed') {
                    statusBadge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold border border-green-200 block text-center mt-1">TAMAMLANDI</span>`;
                    rowClass = 'bg-green-50/60 opacity-75';
                    statusStyle = 'line-through text-gray-400';
                } else if (r.status === 'cancelled') {
                    statusBadge = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold border border-red-200 block text-center mt-1">Ä°PTAL EDÄ°LDÄ°</span>`;
                    rowClass = 'bg-gray-100 text-gray-400';
                    statusStyle = 'line-through';
                } else {
                    // Ertelendi bilgisi ekle
                    let postponedInfo = '';
                    if (r.postponedFrom) {
                        postponedInfo = `<span class="text-amber-600 font-bold text-[10px] block mt-1">â³ (${formatDateTR(r.postponedFrom)} tarihinden ertelendi)</span>`;
                        rowClass = 'bg-amber-50';
                    }

                    // Sadece ertelendi bilgisi gÃ¶ster, BUGÃœN/YARIN vb. kaldÄ±rÄ±ldÄ±
                    statusBadge = postponedInfo;

                    // SatÄ±r rengi ayarla
                    if (!r.postponedFrom) {
                        if (diffDays < 0) {
                            rowClass = 'bg-red-50';
                        } else if (diffDays === 0) {
                            rowClass = 'bg-green-50 border-green-200';
                        } else if (diffDays === 1) {
                            rowClass = 'bg-orange-50 border-orange-200';
                        }
                    }
                }

                let actionButtons = '';
                if (r.status !== 'completed' && r.status !== 'cancelled') {
                    actionButtons = `
                    <div class="flex flex-wrap gap-1 justify-end">
                        <button onclick="startEditReminder(${r.id})" class="flex items-center gap-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded border border-blue-200 text-[10px] font-bold transition" title="DÃ¼zenle"><i data-lucide="edit-3" class="w-3 h-3"></i> DÃ¼z.</button>
                        
                        <button onclick="updateStatus(${r.id}, 'completed')" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded border border-green-200 text-[10px] font-bold transition" title="TamamlandÄ±"><i data-lucide="check" class="w-3 h-3"></i> Tamam</button>
                        <button onclick="document.getElementById('picker-${r.id}').showPicker()" class="flex items-center gap-1 bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded border border-orange-200 text-[10px] font-bold transition" title="Ertele"><i data-lucide="calendar-clock" class="w-3 h-3"></i> Ertele</button>
                        <input type="date" id="picker-${r.id}" class="invisible absolute" style="width:0; height:0; top:0; left:0;" onchange="handlePostpone(${r.id}, this.value)">
                        <button onclick="updateStatus(${r.id}, 'cancelled')" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded border border-red-200 text-[10px] font-bold transition" title="Ä°ptal"><i data-lucide="x" class="w-3 h-3"></i> Ä°ptal</button>
                    </div>
                `;
                } else {
                    actionButtons = `
                    <div class="flex justify-end">
                        <button onclick="updateStatus(${r.id}, 'pending')" class="text-gray-400 hover:text-indigo-600 text-[10px] underline">Durumu Geri Al</button>
                        <button onclick="deleteReminder(${r.id})" class="ml-2 text-red-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                }

                tbody.innerHTML += `
                <tr class="${rowClass} border-b-2 border-gray-600 transition group">
                    <td class="px-4 py-3 border-2 border-gray-600 w-32">
                        <div class="font-bold text-gray-700 text-xs ${statusStyle}">${formatDateTR(r.date)}</div>
                        ${statusBadge}
                    </td>
                    
                    <td class="px-4 py-3 font-medium text-gray-800 border-2 border-gray-600 w-72 ${statusStyle}">
    <div class="flex items-center gap-2">
        <span class="truncate font-bold" title="${r.name}">${r.name}</span>
        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${diffDays === 0 ? 'bg-green-100 text-green-700' : diffDays < 0 ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}">${diffDays === 0 ? 'BugÃ¼n' : diffDays === 1 ? 'YarÄ±n' : diffDays === -1 ? 'DÃ¼n' : diffDays > 1 ? diffDays + ' gÃ¼n sonra' : Math.abs(diffDays) + ' gÃ¼n Ã¶nce'}</span>
    </div>
    ${r.note && !r.note.includes('tarihinden ertelendi') ? `<div class="text-xs text-gray-700 italic mt-1 border-t border-gray-300 pt-1 whitespace-normal leading-snug">${r.note}</div>` : ''}
    <div class="text-[10px] text-gray-400 mt-1">
        <i data-lucide="user" class="w-2.5 h-2.5 inline mr-0.5"></i>
        Ekl: ${r.createdBy || 'Bilinmiyor'}
    </div>
    ${r.lastModifiedBy ? `
    <div class="text-[10px] text-blue-500 mt-0.5">
        <i data-lucide="edit-3" class="w-2.5 h-2.5 inline mr-0.5"></i>
        Son: ${r.lastModifiedBy} ${r.lastModifiedAt ? 'â€¢ ' + new Date(r.lastModifiedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : ''}
    </div>
    ` : ''}
</td>
                    
                    <td class="px-4 py-3 border-2 border-gray-600 ${statusStyle}">
                         <span class="px-2 py-1 bg-white border border-gray-300 rounded text-[10px] font-bold text-gray-600 shadow-sm block w-fit">${r.proc}</span>
                    </td>
                    <td class="px-4 py-3 text-right border-2 border-gray-600 w-48 align-middle">
                        ${actionButtons}
                    </td>
                </tr>
            `;
            });
            if (badge) badge.innerText = `${filteredReminders.length} KayÄ±t`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // YENÄ°: Durum GÃ¼ncelleme (TamamlandÄ± / Ä°ptal / Bekliyor)
        window.updateStatus = async (id, newStatus) => {
            const item = patientReminders.find(r => r.id === id);
            if (item) {
                item.status = newStatus;
                await saveReminders();

                let msg = "Durum gÃ¼ncellendi.";
                if (newStatus === 'completed') msg = "Ä°ÅŸlem tamamlandÄ± olarak iÅŸaretlendi.";
                if (newStatus === 'cancelled') msg = "Ä°ÅŸlem iptal edildi.";
                showToast(msg);
            }
        };

        // YENÄ°: Erteleme Fonksiyonu (Tarih SeÃ§ilince Ã‡alÄ±ÅŸÄ±r)
        window.handlePostpone = async (id, newDate) => {
            if (!newDate) return;
            const item = patientReminders.find(r => r.id === id);
            if (item) {
                // KullanÄ±cÄ± bilgisini al
                const userEmail = currentUser?.email || 'Bilinmeyen';
                const oldDateStr = formatDateTR(item.date);
                item.postponedFrom = item.date; // Eski tarihi sakla
                item.date = newDate;
                item.status = 'pending'; // Durumu tekrar bekliyor yap
                item.lastModifiedBy = userEmail;
                item.lastModifiedAt = new Date().toISOString();

                // Otomatik not dÃ¼ÅŸelim ki unutulmasÄ±n
                const autoNote = `(${oldDateStr} tarihinden ertelendi)`;
                if (!item.note.includes('ertelendi')) {
                    item.note = item.note ? item.note + ' ' + autoNote : autoNote;
                }

                // Listeyi yeniden tarihe gÃ¶re sÄ±rala
                patientReminders.sort((a, b) => a.date.localeCompare(b.date));

                await saveReminders();
                showToast(`Ä°ÅŸlem ${formatDateTR(newDate)} tarihine ertelendi.`);
            }
        };

        // 6. YARININ KONTROLÃœ (UYARI SÄ°STEMÄ°)
        function checkTomorrowAlert() {
            const alertBox = document.getElementById('tomorrow-alert-box');
            const alertText = document.getElementById('tomorrow-alert-text');
            if (!alertBox) return;

            // YarÄ±nÄ±n tarihini bul (String formatÄ±nda: YYYY-MM-DD)
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = getLocalDateString(tomorrow);

            // YarÄ±na ait kayÄ±tlarÄ± bul
            const tomorrowTasks = patientReminders.filter(r => r.date === tomorrowStr);

            if (tomorrowTasks.length > 0) {
                // UyarÄ±yÄ± gÃ¶ster
                alertBox.classList.remove('hidden');

                // MesajÄ± oluÅŸtur
                const names = tomorrowTasks.map(t => `<b>${t.name}</b> (${t.proc})`).join(', ');
                alertText.innerHTML = `${tomorrowTasks.length} hasta iÃ§in iÅŸlem gÃ¶rÃ¼nÃ¼yor: ${names}`;
            } else {
                // UyarÄ±yÄ± gizle
                alertBox.classList.add('hidden');
            }
        }

        function quickAction(type) {
            toggleFab(); // Ã–nce menÃ¼yÃ¼ kapat

            if (type === 'note') {
                switchTab('notlar');
                setTimeout(() => {
                    document.getElementById('gen-note-title').focus();
                    showToast("Not baÅŸlÄ±ÄŸÄ±na odaklandÄ±");
                }, 300);
            }
            else if (type === 'patient') {
                switchTab('hastatakip');
                setTimeout(() => {
                    document.getElementById('rem-patient').focus();
                    showToast("Hasta adÄ± giriÅŸine odaklandÄ±");
                }, 300);
            }
            else if (type === 'emergency') {
                // Ana Ã§antayÄ± seÃ§ip odakla
                currentBag = "Ana Ã‡anta";
                if (document.getElementById('bag-selector')) document.getElementById('bag-selector').value = currentBag;
                switchTab('acilcanta');
                setTimeout(() => {
                    document.getElementById('em-name').focus();
                    showToast("Malzeme adÄ±na odaklandÄ±");
                }, 300);
            }
        }
        // --- GÃ–RSEL TAKVÄ°M MODÃœLÃœ ---
        let calendarCursor = new Date();

        window.renderCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const display = document.getElementById('calendar-month-display');

            if (!grid) return;

            // Ay ismini yazdÄ±r
            const y = calendarCursor.getFullYear();
            const m = calendarCursor.getMonth();
            display.innerText = `${monthsTR[m]} ${y}`;

            grid.innerHTML = '';

            // AyÄ±n ilk gÃ¼nÃ¼ ve toplam gÃ¼n sayÄ±sÄ±
            const firstDay = new Date(y, m, 1);
            const lastDay = new Date(y, m + 1, 0);

            // Pazartesi'den baÅŸlamasÄ± iÃ§in index ayarÄ± (Pazar 0 -> 7 olsun)
            let startDayIndex = firstDay.getDay();
            if (startDayIndex === 0) startDayIndex = 7;

            const totalDays = lastDay.getDate();

            // 1. BOÅ KUTULAR (AyÄ±n 1'inden Ã¶nceki gÃ¼nler)
            for (let i = 1; i < startDayIndex; i++) {
                grid.innerHTML += `<div class="bg-gray-200/50 rounded-lg border border-transparent"></div>`;
            }

            // 2. DOLU GÃœNLER
            const todayStr = getLocalDateString(new Date()); // BugÃ¼nÃ¼n tarihi (renklendirme iÃ§in)

            for (let d = 1; d <= totalDays; d++) {
                // O gÃ¼nÃ¼n tarihi string formatÄ±nda (YYYY-MM-DD)
                const currentDateObj = new Date(y, m, d);
                // Timezone farkÄ±nÄ± dÃ¼zelt (JS Date objesi bazen saat farkÄ±ndan gÃ¼nÃ¼ kaydÄ±rÄ±r)
                const currentStr = new Date(currentDateObj.getTime() - (currentDateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

                // A) Hasta Ä°ÅŸlemlerini Bul
                const dayReminders = patientReminders.filter(r => r.date === currentStr);

                // B) NÃ¶betÃ§iyi Bul
                const dayShifts = shiftList.filter(s => s.date === currentStr);

                // TasarÄ±m ayarlarÄ±
                const isToday = (currentStr === todayStr);
                const boxClass = isToday ? 'bg-indigo-50 border-2 border-indigo-400 shadow-md' : 'bg-white border border-gray-200 hover:border-indigo-300';
                const dateColor = isToday ? 'text-indigo-700 bg-indigo-100 px-2 rounded' : 'text-gray-700';

                let cellContent = `
                <div class="${boxClass} rounded-lg p-2 flex flex-col gap-1 min-h-[100px] transition overflow-hidden group relative">
                    <div class="flex justify-between items-start">
                        <span class="text-sm font-bold ${dateColor}">${d}</span>
                        ${dayReminders.length + dayShifts.length > 0 ? `<span class="text-[9px] text-gray-400 font-bold">${dayReminders.length + dayShifts.length} KayÄ±t</span>` : ''}
                    </div>
                    
                    <div class="flex-grow flex flex-col gap-1 overflow-y-auto custom-scrollbar max-h-[120px]">
            `;

                // NÃ¶betÃ§ileri Ekle (Mor Etiket)
                dayShifts.forEach(s => {
                    let badgeColor = "bg-purple-100 text-purple-700 border-purple-200";
                    if (s.type === 'Ä°cap') badgeColor = "bg-yellow-50 text-yellow-700 border-yellow-200";

                    cellContent += `
                    <div class="flex items-center gap-1 px-1.5 py-1 rounded text-[10px] font-bold border ${badgeColor} cursor-pointer hover:opacity-80" onclick="shiftCursorDate=new Date('${s.date}'); switchTab('nobet');" title="NÃ¶betÃ§i: ${s.staff} (${s.type})">
                        <i data-lucide="moon" class="w-3 h-3"></i>
                        <span class="truncate">${s.staff.split(' ')[0]}</span>
                    </div>
                `;
                });

                // Hasta Ä°ÅŸlemlerini Ekle (Mavi Etiket)
                dayReminders.forEach(r => {
                    const statusClass = r.status === 'completed' ? 'opacity-50 line-through' : '';
                    const itemColor = r.status === 'completed' ? 'bg-green-50 text-green-700 border-green-100' : 'bg-blue-50 text-blue-700 border-blue-100';

                    cellContent += `
                    <div class="flex items-center gap-1 px-1.5 py-1 rounded text-[10px] font-bold border ${itemColor} ${statusClass} cursor-pointer hover:opacity-80" onclick="switchTab('hastatakip')" title="${r.name} - ${r.proc}">
                        <i data-lucide="activity" class="w-3 h-3"></i>
                        <span class="truncate">${r.name.split(' ')[0]}</span>
                    </div>
                `;
                });

                cellContent += `</div></div>`; // KapanÄ±ÅŸ
                grid.innerHTML += cellContent;
            }

            lucide.createIcons();
        };

        window.changeCalendarMonth = (dir) => {
            calendarCursor.setMonth(calendarCursor.getMonth() + dir);
            renderCalendar();
        };
        // --- NÃ–BET ADALET ANALÄ°ZÄ° FONKSÄ°YONLARI ---

        function openFairnessModal() {
            const modal = document.getElementById('fairness-modal');
            const startInp = document.getElementById('fair-start');
            const endInp = document.getElementById('fair-end');

            // VarsayÄ±lan olarak bu yÄ±lÄ± seÃ§
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), 0, 1); // 1 Ocak
            const lastDay = new Date(now.getFullYear(), 11, 31); // 31 AralÄ±k

            if (!startInp.value) startInp.value = getLocalDateString(firstDay);
            if (!endInp.value) endInp.value = getLocalDateString(lastDay);

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeFairnessModal() {
            const modal = document.getElementById('fairness-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- NÃ–BET ADALET ANALÄ°ZÄ° (GÃœNCELLENDÄ°: PUAN GÄ°ZLENDÄ°) ---
        function calculateFairness() {
            const sDate = document.getElementById('fair-start').value;
            const eDate = document.getElementById('fair-end').value;
            const tbody = document.getElementById('fairness-body');

            if (!sDate || !eDate) return showToast("Tarih aralÄ±ÄŸÄ± seÃ§in.", "error");

            const filteredShifts = shiftList.filter(s => s.date >= sDate && s.date <= eDate);
            const stats = {};

            staffList.forEach(p => { stats[p.name] = { total: 0, weekend: 0, weekday: 0, score: 0 }; });

            filteredShifts.forEach(s => {
                if (!stats[s.staff]) stats[s.staff] = { total: 0, weekend: 0, weekday: 0, score: 0 };

                const d = new Date(s.date);
                const isWeekend = (d.getDay() === 0 || d.getDay() === 6);

                stats[s.staff].total += 1;

                if (isWeekend) {
                    stats[s.staff].weekend += 1;
                    stats[s.staff].score += 2.5;
                } else {
                    stats[s.staff].weekday += 1;
                    stats[s.staff].score += 1.0;
                }
            });

            // Yine de puana gÃ¶re sÄ±ralayalÄ±m ki en yorulan en Ã¼stte Ã§Ä±ksÄ±n
            const sortedStaff = Object.keys(stats).sort((a, b) => stats[b].score - stats[a].score);

            const totalScore = Object.values(stats).reduce((acc, curr) => acc + curr.score, 0);
            const avgScore = sortedStaff.length > 0 ? totalScore / sortedStaff.length : 0;

            tbody.innerHTML = '';

            if (sortedStaff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400">Veri bulunamadÄ±.</td></tr>';
                return;
            }

            sortedStaff.forEach((name, index) => {
                const data = stats[name];

                // Durum Belirleme
                let statusBadge = '';
                const diff = data.score - avgScore;

                if (data.total === 0) {
                    statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-gray-100 text-gray-500">NÃ–BETSÄ°Z</span>';
                } else if (diff > 5) {
                    statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-red-100 text-red-700 flex items-center justify-center gap-1 w-fit mx-auto"><i data-lucide="arrow-up" class="w-3 h-3"></i> YOÄUN</span>';
                } else if (diff < -5) {
                    statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-green-100 text-green-700 flex items-center justify-center gap-1 w-fit mx-auto"><i data-lucide="arrow-down" class="w-3 h-3"></i> RAHAT</span>';
                } else {
                    statusBadge = '<span class="px-2 py-1 rounded text-[10px] font-bold bg-blue-50 text-blue-600 flex items-center justify-center w-fit mx-auto">DENGELÄ°</span>';
                }

                let rankIcon = `<span class="font-bold text-gray-400 text-xs w-6 inline-block text-center">${index + 1}.</span>`;
                if (index === 0) rankIcon = 'ğŸ¥‡';
                if (index === 1) rankIcon = 'ğŸ¥ˆ';
                if (index === 2) rankIcon = 'ğŸ¥‰';

                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                tbody.innerHTML += `
                <tr class="${rowClass} hover:bg-purple-50 transition border-b border-gray-100">
                    <td class="px-6 py-3 font-bold text-gray-700 flex items-center gap-2 border-r border-gray-100">
                        ${rankIcon} ${name}
                    </td>
                    <td class="px-6 py-3 text-center font-bold text-gray-800 border-r border-gray-100">${data.total}</td>
                    <td class="px-6 py-3 text-center font-bold text-orange-600 bg-orange-50/30 border-r border-gray-100">${data.weekend}</td>
                    <td class="px-6 py-3 text-center text-blue-600 bg-blue-50/30 border-r border-gray-100">${data.weekday}</td>
                    <td class="px-6 py-3 text-center">${statusBadge}</td>
                </tr>
            `;
            });
            lucide.createIcons();
        }
        // --- GÃœNCELLENMÄ°Å VE SORUNSUZ YAZDIRMA FONKSÄ°YONU ---
        function printFairnessReport() {
            // 1. YazdÄ±rma iÃ§in geÃ§ici bir stil oluÅŸturuyoruz
            const printStyle = document.createElement('style');
            printStyle.innerHTML = `
            @media print {
                /* Sayfadaki her ÅŸeyi gizle */
                body * {
                    visibility: hidden;
                }
                /* Sadece ModalÄ± ve iÃ§indekileri gÃ¶ster */
                #fairness-modal, #fairness-modal * {
                    visibility: visible;
                }
                /* ModalÄ± kaÄŸÄ±da tam oturt */
                #fairness-modal {
                    position: fixed;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background: white;
                    z-index: 9999;
                    display: block !important;
                    padding: 20px;
                    overflow: visible !important;
                }
                /* Ä°Ã§erik taÅŸmasÄ±nÄ± engelle, tÃ¼m listeyi dÃ¶k */
                #fairness-modal .overflow-y-auto {
                    overflow: visible !important;
                    height: auto !important;
                    max-height: none !important;
                }
                /* Gereksiz butonlarÄ±, filtreleri ve kapat tuÅŸunu gizle */
                #fairness-modal button, 
                #fairness-modal input, 
                #fairness-modal label,
                #fairness-modal .bg-gray-50 { /* Filtre ve alt barÄ± gizler */
                    display: none !important;
                }
                /* BaÅŸlÄ±ÄŸÄ± dÃ¼zelt ve gÃ¶ster */
                #fairness-modal h3 {
                    display: block !important;
                    font-size: 20px;
                    color: black !important;
                    margin-bottom: 20px;
                    border-bottom: 2px solid black;
                    padding-bottom: 10px;
                }
                /* Tablo renklerini kaÄŸÄ±t dostu yap */
                table {
                    width: 100% !important;
                    border-collapse: collapse;
                }
                th, td {
                    border: 1px solid #ddd !important;
                    padding: 8px !important;
                    color: black !important;
                }
                thead th {
                    background-color: #f3f4f6 !important;
                    -webkit-print-color-adjust: exact;
                }
            }
        `;
            document.head.appendChild(printStyle);

            // 2. YazdÄ±r
            window.print();

            // 3. Ä°ÅŸ bitince stili temizle (Hemen silersek yazdÄ±rma diyaloÄŸu bozulabilir, az bekletiyoruz)
            setTimeout(() => {
                document.head.removeChild(printStyle);
            }, 1000);
        }
        // ============================================================
        // --- TAM OTO-KÄ°LÄ°T VE GÃœVENLÄ°K SÄ°STEMÄ° (TEMÄ°Z VERSÄ°YON) ---
        // ============================================================

        let idleTimer;
        // DÄ°KKAT: Test iÃ§in 5000 (5 saniye) ayarlÄ±.
        // Normal kullanÄ±m iÃ§in Ã¶rneÄŸin 10 dakika istersen: 600000 yap.
        const IDLE_LIMIT = 900000;

        function setupAutoLock() {
            // Fare, klavye ve dokunma hareketlerini dinle
            const events = ['mousemove', 'mousedown', 'keypress', 'touchmove', 'scroll', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetIdleTimer, true);
            });

            // SayacÄ± baÅŸlat
            resetIdleTimer();
            console.log("Oto-Kilit Sistemi Aktif.");
        }

        function resetIdleTimer() {
            const lockScreen = document.getElementById('auto-lock-screen');

            // EÄŸer ekran zaten kilitliyse sayacÄ± sÄ±fÄ±rlama
            if (lockScreen && !lockScreen.classList.contains('hidden')) return;

            // Mevcut sayacÄ± iptal et ve yeniden baÅŸlat
            clearTimeout(idleTimer);
            idleTimer = setTimeout(lockSession, IDLE_LIMIT);
        }

        function lockSession() {
            localStorage.setItem('isSystemLocked', 'yes');
            const lockScreen = document.getElementById('auto-lock-screen');
            if (lockScreen) {
                // Kilit ekranÄ±nÄ± aÃ§
                lockScreen.classList.remove('hidden');
                lockScreen.classList.add('flex');

                // DÃ¼zenleme modunu kapat (GÃ¼venlik)
                isEditing = false;

                // Kilit butonunun gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ gÃ¼ncelle
                if (typeof updateLockUI === 'function') {
                    updateLockUI();
                } else {
                    // updateLockUI fonksiyonu yoksa manuel gÃ¼ncelle
                    const lockBtn = document.getElementById('lock-toggle');
                    if (lockBtn) {
                        const lockIcon = document.getElementById('lock-icon');
                        const lockStatus = document.getElementById('lock-status');
                        lockBtn.className = "flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold bg-red-100 text-red-700";
                        if (lockIcon) lockIcon.setAttribute('data-lucide', 'lock');
                        if (lockStatus) lockStatus.innerText = "Kilitli";
                    }
                }
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        function unlockSession() {
            const input = document.getElementById('session-pass-input');

            // GLOBAL appPassword DEÄÄ°ÅKENÄ°NÄ° KONTROL ET
            if (input.value === appPassword) {
                localStorage.removeItem('isSystemLocked');
                const lockScreen = document.getElementById('auto-lock-screen');
                lockScreen.classList.add('hidden');
                lockScreen.classList.remove('flex');
                input.value = '';

                resetIdleTimer(); // SayacÄ± sÄ±fÄ±rla
                showToast("Oturum aÃ§Ä±ldÄ±.");
            } else {
                showToast("HatalÄ± Parola!", "error");
                input.value = '';
                input.focus();
            }
        }


        function handleEnterUnlock(e) {
            if (e.key === 'Enter') unlockSession();
        }

        // --- KÄ°LÄ°T EKRANINDAN ÅÄ°FRE DEÄÄ°ÅTÄ°RME ---
        window.openPwModalFromLock = function () {
            if (typeof openPwModal === 'function') {
                openPwModal();
                // Pencereyi kilit ekranÄ±nÄ±n (z-999) Ã¼zerine Ã§Ä±karmak iÃ§in z-index'i artÄ±r
                const pwModal = document.getElementById('change-pw-modal');
                if (pwModal) pwModal.style.zIndex = "1001";
            }
        };

        // Sistemi BaÅŸlat
        setupAutoLock();
        // --- MANUEL KÄ°LÄ°TLEME KISAYOLU (Shift + L) ---
        document.addEventListener('keydown', (e) => {
            // Shift + L tuÅŸlarÄ±na basÄ±ldÄ±ysa
            if (e.shiftKey && (e.key === 'L' || e.key === 'l')) {
                // EÄŸer yazÄ± yazÄ±yorsan (input iÃ§indysen) Ã§alÄ±ÅŸma
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;

                e.preventDefault(); // TarayÄ±cÄ± kÄ±sayolunu engelle
                lockSession(); // KÄ°LÄ°TLE
                showToast("Ekran kilitlendi.");
            }
        });
        // ===============================================
        // --- SPOTLIGHT ARAMA SÄ°STEMÄ° (JS KODLARI) ---
        // ===============================================

        // 1. Arama Penceresini AÃ§
        function openSpotlight() {
            const modal = document.getElementById('spotlight-modal');
            const input = document.getElementById('spotlight-input');

            // Kilitliyse aÃ§ma
            const lockScreen = document.getElementById('auto-lock-screen');
            if (lockScreen && !lockScreen.classList.contains('hidden')) return;

            if (modal && input) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                input.value = '';
                // Ä°mleci odakla
                setTimeout(() => input.focus(), 100);
            }
        }

        // 2. Arama Penceresini Kapat
        function closeSpotlight(e) {
            if (e && e.target.id !== 'spotlight-modal' && e.type === 'click') return;
            const modal = document.getElementById('spotlight-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // 3. Klavye KÄ±sayollarÄ± (Ctrl + Space / Ctrl + K)
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {

                // Spotlight KÄ±sayolu (Ctrl + Space VEYA Ctrl + K)
                const isCtrlK = (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k';
                const isCtrlSpace = (e.ctrlKey || e.metaKey) && e.code === 'Space';

                if (isCtrlK || isCtrlSpace) {
                    e.preventDefault(); // TarayÄ±cÄ±yÄ± durdur
                    openSpotlight();
                    return;
                }

                // ESC TuÅŸu (Kapat)
                if (e.key === 'Escape') {
                    closeSpotlight();
                    // AÃ§Ä±k olan diÄŸer pencereleri de kapat
                    document.querySelectorAll('.fixed').forEach(m => {
                        if (!m.classList.contains('hidden') && m.id !== 'toast' && m.id !== 'auto-lock-screen') {
                            m.classList.add('hidden');
                            m.classList.remove('flex');
                        }
                    });
                }

                // Shift + L (Kilitle)
                if (e.shiftKey && e.key.toLowerCase() === 'l') {
                    if (document.activeElement.tagName === 'INPUT') return;
                    e.preventDefault();
                    if (typeof lockSession === 'function') lockSession();
                }
            });
        }

        // ================================================================
        // --- ULTIMATE SPOTLIGHT ARAMA MOTORU (TÃœM VERÄ°TABANI) ---
        // ================================================================
        function handleSpotlightSearch() {
            const input = document.getElementById('spotlight-input');
            if (!input) return;

            // TÃ¼rkÃ§e karakter uyumlu kÃ¼Ã§Ã¼k harfe Ã§evirme
            const query = input.value.toLocaleLowerCase('tr').trim();
            const resultsDiv = document.getElementById('spotlight-results');

            // 2 harften azsa arama yapma
            if (query.length < 2) {
                resultsDiv.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm flex flex-col items-center"><i data-lucide="keyboard" class="w-8 h-8 mb-2 opacity-20"></i><p>Aramak iÃ§in en az 2 harf yaz...</p></div>';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            let html = '';
            let totalCount = 0;

            // ---------------------------------------------------------
            // 1. HASTA TARAMASI (DeÄŸiÅŸken: patientReminders)
            // ---------------------------------------------------------
            if (typeof patientReminders !== 'undefined' && Array.isArray(patientReminders)) {
                const found = patientReminders.filter(p =>
                    (p.name && p.name.toLocaleLowerCase('tr').includes(query)) ||
                    (p.note && p.note.toLocaleLowerCase('tr').includes(query)) ||
                    (p.proc && p.proc.toLocaleLowerCase('tr').includes(query))
                );

                if (found.length > 0) {
                    html += `<div class="sticky top-0 z-10 px-4 py-2 bg-indigo-50 text-[10px] font-bold text-indigo-600 uppercase border-y border-indigo-100 flex justify-between">
                        <span>HASTA TAKÄ°P LÄ°STESÄ°</span>
                        <span class="bg-indigo-200 px-1.5 rounded text-indigo-800">${found.length}</span>
                     </div>`;
                    found.forEach(p => {
                        totalCount++;
                        html += `
                <div onclick="goToResult('hastatakip', '${p.name.replace(/'/g, "\\'")}')" class="group flex items-center gap-3 p-3 px-4 hover:bg-indigo-50 cursor-pointer border-b border-gray-50 transition-colors">
                    <div class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-indigo-600 group-hover:text-white transition">
                        <i data-lucide="user" class="w-4 h-4"></i>
                    </div>
                    <div class="min-w-0">
                        <div class="font-bold text-gray-800 text-sm truncate">${p.name}</div>
                        <div class="text-xs text-gray-500 truncate">${p.proc || 'Ä°ÅŸlem yok'} â€¢ ${formatDateTR(p.date)}</div>
                    </div>
                </div>`;
                    });
                }
            }

            // ---------------------------------------------------------
            // 2. REHBER TARAMASI (DeÄŸiÅŸken: phonebookList VEYA phoneBook)
            // ---------------------------------------------------------
            // Ä°ki ihtimali de kontrol ediyoruz, hangisi doluysa onu kullanÄ±r.
            let contacts = [];
            if (typeof phonebookList !== 'undefined' && Array.isArray(phonebookList)) contacts = phonebookList;
            else if (typeof phoneBook !== 'undefined' && Array.isArray(phoneBook)) contacts = phoneBook;

            const foundContacts = contacts.filter(c =>
                (c.name && c.name.toLocaleLowerCase('tr').includes(query)) ||
                (c.num && c.num.includes(query)) ||
                (c.title && c.title.toLocaleLowerCase('tr').includes(query))
            );

            if (foundContacts.length > 0) {
                html += `<div class="sticky top-0 z-10 px-4 py-2 bg-green-50 text-[10px] font-bold text-green-600 uppercase border-y border-green-100 flex justify-between">
                    <span>REHBER & Ä°LETÄ°ÅÄ°M</span>
                    <span class="bg-green-200 px-1.5 rounded text-green-800">${foundContacts.length}</span>
                 </div>`;
                foundContacts.forEach(c => {
                    totalCount++;
                    html += `
            <div onclick="goToResult('rehber', '${c.name.replace(/'/g, "\\'")}')" class="group flex items-center gap-3 p-3 px-4 hover:bg-green-50 cursor-pointer border-b border-gray-50 transition-colors">
                <div class="bg-green-100 text-green-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-green-600 group-hover:text-white transition">
                    <i data-lucide="phone" class="w-4 h-4"></i>
                </div>
                <div class="min-w-0">
                    <div class="font-bold text-gray-800 text-sm truncate">${c.name}</div>
                    <div class="text-xs text-gray-500 truncate">${c.num} â€¢ ${c.title || 'Personel'}</div>
                </div>
            </div>`;
                });
            }

            // ---------------------------------------------------------
            // 3. NÃ–BET TARAMASI (DeÄŸiÅŸken: shiftList)
            // ---------------------------------------------------------
            if (typeof shiftList !== 'undefined' && Array.isArray(shiftList)) {
                const foundShifts = shiftList.filter(s =>
                    (s.staff && s.staff.toLocaleLowerCase('tr').includes(query)) ||
                    (s.note && s.note.toLocaleLowerCase('tr').includes(query))
                );

                if (foundShifts.length > 0) {
                    html += `<div class="sticky top-0 z-10 px-4 py-2 bg-purple-50 text-[10px] font-bold text-purple-600 uppercase border-y border-purple-100 flex justify-between">
                        <span>NÃ–BET LÄ°STESÄ°</span>
                        <span class="bg-purple-200 px-1.5 rounded text-purple-800">${foundShifts.length}</span>
                     </div>`;
                    // Listeyi boÄŸmamak iÃ§in ilk 5 sonucu gÃ¶sterelim
                    foundShifts.slice(0, 5).forEach(s => {
                        totalCount++;
                        html += `
                <div onclick="goToResult('nobet', null)" class="group flex items-center gap-3 p-3 px-4 hover:bg-purple-50 cursor-pointer border-b border-gray-50 transition-colors">
                    <div class="bg-purple-100 text-purple-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-purple-600 group-hover:text-white transition">
                        <i data-lucide="moon" class="w-4 h-4"></i>
                    </div>
                    <div class="min-w-0">
                        <div class="font-bold text-gray-800 text-sm truncate">${s.staff}</div>
                        <div class="text-xs text-gray-500 truncate">${formatDateTR(s.date)} â€¢ ${s.type}</div>
                    </div>
                </div>`;
                    });
                }
            }

            // ---------------------------------------------------------
            // 4. BÃœTÃ‡E TARAMASI (DeÄŸiÅŸken: budgetList)
            // ---------------------------------------------------------
            if (typeof budgetList !== 'undefined' && Array.isArray(budgetList)) {
                const foundBudget = budgetList.filter(b =>
                    (b.desc && b.desc.toLocaleLowerCase('tr').includes(query)) ||
                    (b.category && b.category.toLocaleLowerCase('tr').includes(query))
                );

                if (foundBudget.length > 0) {
                    html += `<div class="sticky top-0 z-10 px-4 py-2 bg-orange-50 text-[10px] font-bold text-orange-600 uppercase border-y border-orange-100 flex justify-between">
                        <span>BÃœTÃ‡E / MUHASEBE</span>
                        <span class="bg-orange-200 px-1.5 rounded text-orange-800">${foundBudget.length}</span>
                     </div>`;
                    foundBudget.slice(0, 3).forEach(b => {
                        totalCount++;
                        const isInc = b.type === 'income';
                        html += `
                <div onclick="goToResult('butce', null)" class="group flex items-center gap-3 p-3 px-4 hover:bg-orange-50 cursor-pointer border-b border-gray-50 transition-colors">
                    <div class="${isInc ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} w-8 h-8 rounded-lg flex items-center justify-center shrink-0">
                        <i data-lucide="${isInc ? 'trending-up' : 'trending-down'}" class="w-4 h-4"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <div class="font-bold text-gray-800 text-sm truncate">${b.desc}</div>
                        <div class="text-xs text-gray-500 truncate">${formatDateTR(b.date)}</div>
                    </div>
                    <div class="font-mono font-bold text-sm ${isInc ? 'text-green-600' : 'text-red-600'}">
                        ${b.amount}â‚º
                    </div>
                </div>`;
                    });
                }
            }

            // ---------------------------------------------------------
            // 5. NOTLAR TARAMASI (DeÄŸiÅŸken: generalNotesList)
            // ---------------------------------------------------------
            if (typeof generalNotesList !== 'undefined' && Array.isArray(generalNotesList)) {
                const foundNotes = generalNotesList.filter(n =>
                    (n.title && n.title.toLocaleLowerCase('tr').includes(query)) ||
                    (n.content && n.content.toLocaleLowerCase('tr').includes(query))
                );

                if (foundNotes.length > 0) {
                    html += `<div class="sticky top-0 z-10 px-4 py-2 bg-yellow-50 text-[10px] font-bold text-yellow-600 uppercase border-y border-yellow-100 flex justify-between">
                        <span>NOTLAR</span>
                        <span class="bg-yellow-200 px-1.5 rounded text-yellow-800">${foundNotes.length}</span>
                     </div>`;
                    foundNotes.forEach(n => {
                        totalCount++;
                        html += `
                <div onclick="goToResult('notlar', null)" class="group flex items-center gap-3 p-3 px-4 hover:bg-yellow-50 cursor-pointer border-b border-gray-50 transition-colors">
                    <div class="bg-yellow-100 text-yellow-600 w-8 h-8 rounded-lg flex items-center justify-center shrink-0 group-hover:bg-yellow-600 group-hover:text-white transition">
                        <i data-lucide="sticky-note" class="w-4 h-4"></i>
                    </div>
                    <div class="min-w-0">
                        <div class="font-bold text-gray-800 text-sm truncate">${n.title}</div>
                        <div class="text-xs text-gray-500 truncate line-clamp-1">${n.content.substring(0, 60)}...</div>
                    </div>
                </div>`;
                    });
                }
            }

            // ---------------------------------------------------------
            // SONUÃ‡ YOKSA
            // ---------------------------------------------------------
            if (totalCount === 0) {
                html = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                <i data-lucide="search-x" class="w-16 h-16 mb-4 text-gray-200"></i>
                <h3 class="font-bold text-gray-500 text-sm">HiÃ§bir ÅŸey bulamadÄ±m patron!</h3>
                <p class="text-xs mt-1 text-gray-400">"${input.value}" ile ilgili kayÄ±t yok.</p>
            </div>`;
            }

            resultsDiv.innerHTML = html;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        // --- SEKME AYARLARI YÃ–NETÄ°MÄ° ---

        function openTabSettingsModal() {
            // 1. GÃ¼venlik: Ana yÃ¶netici ÅŸifresini sor (BaÅŸkasÄ± gelip kilidi kaldÄ±rmasÄ±n)
            const input = prompt("GÃ¼venlik ayarlarÄ±nÄ± deÄŸiÅŸtirmek iÃ§in ANA YÃ–NETÄ°CÄ° parolasÄ±nÄ± girin:");
            if (input === null) return;
            if (input !== appPassword) return showToast("HatalÄ± Ana Parola!", "error");

            const modal = document.getElementById('tab-settings-modal');
            const grid = document.getElementById('tab-selection-grid');
            const passInput = document.getElementById('setting-tab-pass');

            // Mevcut ÅŸifreyi gÃ¶ster
            passInput.value = customTabPassword;
            // AÃ§Ä±lÄ±ÅŸ kilidi ayarÄ±nÄ± gÃ¶ster
            document.getElementById('setting-startup-lock').checked = startupLockEnabled;
            // YÃ¶netim ÅŸifresini kutuya yaz
            const adminPassInput = document.getElementById('setting-admin-pass');
            if (adminPassInput) adminPassInput.value = adminPanelPassword;
            // YÃ¶netim ÅŸifresini gÃ¶ster
            document.getElementById('setting-admin-pass').value = adminPanelPassword;

            // Sekme listesini oluÅŸtur (id ve gÃ¶rÃ¼nen ad)
            const tabs = [
                { id: 'hastatakip', name: 'Hasta Takip' },
                { id: 'personel', name: 'Personel Takip' },
                { id: 'uzman', name: 'Uzman EÅŸleÅŸme' },
                { id: 'analiz', name: 'GeÃ§miÅŸ Analiz' },
                { id: 'rutinler', name: 'GÃ¼nlÃ¼k Rutinler' },
                { id: 'acilcanta', name: 'Acil Ã‡anta' },
                { id: 'butce', name: 'BÃ¼tÃ§e Takip' },
                { id: 'notlar', name: 'Notlar' },
                { id: 'nobet', name: 'NÃ¶bet Listesi' },
                { id: 'cihazlar', name: 'Cihaz & Zimmet' },
                { id: 'istatistik', name: 'Ä°statistikler' },
                { id: 'puantaj', name: 'Puantaj' },
                { id: 'rehber', name: 'Rehber' },
                { id: 'takvim', name: 'Takvim' }
            ];

            grid.innerHTML = '';
            tabs.forEach(tab => {
                const isLocked = lockedTabsConfig.includes(tab.id);
                grid.innerHTML += `
            <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-orange-50 transition ${isLocked ? 'border-orange-300 bg-orange-50' : 'border-gray-200'}">
                <input type="checkbox" onchange="toggleTabLock('${tab.id}')" class="w-4 h-4 text-orange-600 rounded border-gray-300 focus:ring-orange-500" ${isLocked ? 'checked' : ''}>
                <span class="text-xs font-bold ${isLocked ? 'text-orange-700' : 'text-gray-600'}">${tab.name}</span>
            </label>
        `;
            });

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function updateAdminPassword() {
            const newVal = document.getElementById('setting-admin-pass').value.trim();
            if (newVal.length < 3) return showToast("Åifre en az 3 karakter olmalÄ±!", "error");

            adminPanelPassword = newVal;
            await FirebaseStorage.setItem(LS_ADMIN_PASS, adminPanelPassword); // LS_ADMIN_PASS tanÄ±mlÄ± olmalÄ±
            showToast("YÃ¶netim ÅŸifresi baÅŸarÄ±yla deÄŸiÅŸtirildi.");
        }

        async function updateTabPassword() {
            const newVal = document.getElementById('setting-tab-pass').value.trim();
            if (newVal.length < 3) return showToast("Åifre Ã§ok kÄ±sa!", "error");

            customTabPassword = newVal;
            await FirebaseStorage.setItem(LS_TAB_LOCK_PASS_CUSTOM, customTabPassword);
            showToast("Sekme ÅŸifresi gÃ¼ncellendi.");
        }

        async function toggleTabLock(tabId) {
            // Listede varsa Ã§Ä±kar, yoksa ekle
            if (lockedTabsConfig.includes(tabId)) {
                lockedTabsConfig = lockedTabsConfig.filter(t => t !== tabId);
            } else {
                lockedTabsConfig.push(tabId);
            }

            // Kaydet
            await FirebaseStorage.setItem(LS_LOCKED_TABS_CONFIG, JSON.stringify(lockedTabsConfig));

            // UI'Ä± anlÄ±k gÃ¼ncelle (gÃ¶rsel efekt iÃ§in)
            openTabSettingsModalCheckboxesOnly();
            showToast("Ayarlar gÃ¼ncellendi.");
        }

        // CheckboxlarÄ± yeniden render etmek iÃ§in yardÄ±mcÄ± (ModalÄ± kapatmadan)
        function openTabSettingsModalCheckboxesOnly() {
            const grid = document.getElementById('tab-selection-grid');
            // Sadece classlarÄ± gÃ¼ncellemek daha performanslÄ± olur ama
            // basitlik iÃ§in burayÄ± tekrar render etmiyoruz, kullanÄ±cÄ± zaten tÄ±klayÄ±nca gÃ¶rÃ¼yor.
            // Ancak gÃ¶rsel renk deÄŸiÅŸimi iÃ§in listeyi yenilemek istersen grid.innerHTML kÄ±smÄ±nÄ± buraya taÅŸÄ±yabiliriz.
            // Åimdilik gerek yok, CSS zaten checked durumuna gÃ¶re stil veriyor.
        }

        // --- YÃ–NETÄ°M ÅÄ°FRESÄ°NÄ° KAYDETME FONKSÄ°YONU BAÅLANGICI ---
        async function updateAdminPassword() {
            // 1. Kutudaki yeni ÅŸifreyi al
            const newVal = document.getElementById('setting-admin-pass').value.trim();

            // 2. Kontrol et (Ã‡ok kÄ±sa olmasÄ±n)
            if (newVal.length < 3) return showToast("Åifre en az 3 karakter olmalÄ±!", "error");

            // 3. DeÄŸiÅŸkeni gÃ¼ncelle
            adminPanelPassword = newVal;

            // 4. Buluta (Firebase) kaydet
            await FirebaseStorage.setItem(LS_ADMIN_PASS, adminPanelPassword);

            // 5. Bilgi ver
            showToast("YÃ¶netim ÅŸifresi baÅŸarÄ±yla deÄŸiÅŸtirildi.");
        }
        // --- YÃ–NETÄ°M ÅÄ°FRESÄ°NÄ° KAYDETME FONKSÄ°YONU BÄ°TÄ°ÅÄ° ---
        // --- PUANTAJ MODÃœLÃœ ---
        let puantajCursorDate = new Date();

        // 1. Sekme AÃ§Ä±ldÄ±ÄŸÄ±nda Ã‡alÄ±ÅŸacak Fonksiyon
        // (Bunu switchTab fonksiyonuna eklemeyi unutma!)
        window.renderPuantaj = function () {
            renderPuantajHeader();
            renderPuantajTable();
        }

        window.renderPuantajHeader = function () {
            const d = puantajCursorDate;
            document.getElementById('puantaj-period-display').innerText = `${monthsTR[d.getMonth()]} ${d.getFullYear()}`;
        }

        window.changePuantajMonth = function (dir) {
            puantajCursorDate.setMonth(puantajCursorDate.getMonth() + dir);
            renderPuantajHeader();
            renderPuantajTable();
        }

        window.renderPuantajTable = function () {
            const thead = document.getElementById('puantaj-head');
            const tbody = document.getElementById('puantaj-body');
            if (!thead || !tbody) return;

            thead.innerHTML = '';
            tbody.innerHTML = '';

            const y = puantajCursorDate.getFullYear();
            const m = puantajCursorDate.getMonth();

            // ÅU ANKÄ° ZAMAN BÄ°LGÄ°LERÄ°
            const now = new Date();
            // Sadece tarih karÅŸÄ±laÅŸtÄ±rmasÄ± iÃ§in saati sÄ±fÄ±rlanmÄ±ÅŸ "BugÃ¼n"
            const todayMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            const daysInMonth = new Date(y, m + 1, 0).getDate();

            // --- BAÅLIK OLUÅTURMA (DeÄŸiÅŸmedi) ---
            let headerHtml = `<tr>
        <th class="px-4 py-3 bg-gray-100 sticky left-0 z-20 border-r border-gray-300 font-bold text-gray-800 shadow-sm min-w-[150px]">Personel</th>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateObj = new Date(y, m, d);
                const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'short' });
                const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                const colorClass = isWeekend ? 'text-red-600 bg-red-50' : 'text-gray-600';

                headerHtml += `<th class="px-1 py-2 text-center border-r border-gray-200 min-w-[36px] ${colorClass}">
            <div class="flex flex-col items-center">
                <span class="text-[10px]">${dayName}</span>
                <span class="text-sm font-bold">${d}</span>
            </div>
        </th>`;
            }
            headerHtml += `<th class="px-4 py-3 bg-indigo-50 text-indigo-800 text-center font-bold sticky right-0 z-10 shadow-sm border-l border-indigo-100">TOPLAM</th></tr>`;
            thead.innerHTML = headerHtml;

            // --- SATIRLARI OLUÅTURMA ---
            staffList.forEach((s, idx) => {
                const bgClass = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50/50';
                let rowHtml = `<tr class="${bgClass} hover:bg-indigo-50/30 transition group border-b border-gray-100">
            <td class="px-4 py-2 font-bold text-gray-700 sticky left-0 z-10 ${bgClass} border-r border-gray-200 shadow-sm whitespace-nowrap text-xs">${s.name}</td>`;

                let totalHours = 0;

                for (let d = 1; d <= daysInMonth; d++) {
                    const loopDate = new Date(y, m, d);
                    const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const isWeekend = (loopDate.getDay() === 0 || loopDate.getDay() === 6);

                    // ZAMAN KONTROLÃœ (Gelecek mi? BugÃ¼n mÃ¼?)
                    let isFutureData = false;

                    if (loopDate > todayMid) {
                        // EÄŸer dÃ¶ngÃ¼deki gÃ¼n bugÃ¼nden sonraysa -> GELECEK
                        isFutureData = true;
                    } else if (loopDate.getTime() === todayMid.getTime()) {
                        // EÄŸer dÃ¶ngÃ¼deki gÃ¼n tam BUGÃœN ise ve saat 17:00 olmadÄ±ysa -> HENÃœZ DOLMADI
                        if (now.getHours() < 17) {
                            isFutureData = true;
                        }
                    }

                    // Verileri Ã‡ek
                    const leave = leaveRecords.find(l => l.staffName === s.name && dateStr >= l.startDate && dateStr <= l.endDate);
                    const shift = shiftList.find(sh => sh.staff === s.name && sh.date === dateStr);

                    let cellContent = '';
                    let cellClass = '';

                    // EÄER GELECEK TARÄ°HSE VEYA BUGÃœN MESAÄ° BÄ°TMEDÄ°YSE -> BOÅ GÃ–STER
                    if (isFutureData) {
                        cellContent = '-';
                        cellClass = 'text-gray-200 bg-gray-50'; // Ã‡ok silik gri
                    }
                    else {
                        // GEÃ‡MÄ°Å VEYA BUGÃœN MESAÄ° BÄ°TÄ°MÄ° -> VERÄ°YÄ° HESAPLA
                        if (leave) {
                            if (leave.type === 'Rapor') {
                                cellContent = 'R'; cellClass = 'bg-red-100 text-red-700';
                            } else {
                                cellContent = 'Ä°'; cellClass = 'bg-orange-100 text-orange-700';
                            }
                        } else {
                            if (!isWeekend) {
                                cellContent = '8'; cellClass = 'bg-green-50 text-green-700';
                                totalHours += 8;
                            } else {
                                if (shift) {
                                    cellContent = '8'; cellClass = 'bg-purple-100 text-purple-700 ring-1 ring-purple-200';
                                    totalHours += 8;
                                } else {
                                    cellContent = '-'; cellClass = 'text-gray-300 bg-gray-50';
                                }
                            }
                        }
                    }

                    rowHtml += `<td class="px-1 py-1 text-center border-r border-gray-100">
                <div class="w-full h-8 flex items-center justify-center rounded text-xs ${cellClass}">
                    ${cellContent}
                </div>
            </td>`;
                }

                rowHtml += `<td class="px-4 py-2 text-center font-bold text-indigo-700 bg-indigo-50 border-l border-indigo-100 sticky right-0 z-10">${totalHours}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', rowHtml);
            });
        }

        // Excel Ä°ndirme (Puantaj iÃ§in Ã¶zel)
        window.downloadPuantajExcel = function () {
            const wb = XLSX.utils.book_new();
            const ws_data = [];
            const d = puantajCursorDate;

            // ÅU ANKÄ° ZAMAN BÄ°LGÄ°LERÄ°
            const now = new Date();
            const todayMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // BaÅŸlÄ±k
            const header = ["Personel"];
            const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
            for (let i = 1; i <= daysInMonth; i++) header.push(i.toString());
            header.push("TOPLAM");
            ws_data.push(header);

            staffList.forEach(s => {
                let row = [s.name];
                let total = 0;
                for (let i = 1; i <= daysInMonth; i++) {
                    const loopDate = new Date(d.getFullYear(), d.getMonth(), i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const isWeekend = (loopDate.getDay() === 0 || loopDate.getDay() === 6);

                    // ZAMAN KONTROLÃœ
                    let isFutureData = false;
                    if (loopDate > todayMid) isFutureData = true;
                    else if (loopDate.getTime() === todayMid.getTime() && now.getHours() < 17) isFutureData = true;

                    const leave = leaveRecords.find(l => l.staffName === s.name && dateStr >= l.startDate && dateStr <= l.endDate);
                    const shift = shiftList.find(sh => sh.staff === s.name && sh.date === dateStr);

                    if (isFutureData) {
                        row.push(''); // Excel'de hÃ¼cre boÅŸ kalsÄ±n
                    } else {
                        if (leave) {
                            row.push(leave.type === 'Rapor' ? 'R' : 'Ä°');
                        } else if (!isWeekend) {
                            row.push(8); total += 8;
                        } else {
                            if (shift) { row.push(8); total += 8; }
                            else { row.push(''); }
                        }
                    }
                }
                row.push(total);
                ws_data.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Puantaj");
            XLSX.writeFile(wb, `Puantaj_${monthsTR[d.getMonth()]}_${d.getFullYear()}.xlsx`);
        }
    </script>
    <div id="auto-lock-screen"
        class="hidden fixed inset-0 bg-gray-900/95 z-[999] hidden flex-col items-center justify-center text-center backdrop-blur-sm transition-opacity duration-500">
        <div class="bg-white/10 p-6 rounded-full mb-6 border-4 border-white/20 animate-pulse">
            <i data-lucide="lock" class="w-12 h-12 text-white"></i>
        </div>

        <h2 class="text-2xl font-bold text-white mb-2 tracking-tight">Oturum Kilitlendi</h2>
        <p class="text-gray-400 mb-6 text-sm">Devam etmek iÃ§in ana parolayÄ± giriniz.</p>

        <div class="flex flex-col gap-3 w-full max-w-[280px]">
            <input type="password" id="session-pass-input" placeholder="Parola"
                class="p-3 rounded-xl text-gray-800 text-center text-lg font-bold tracking-widest outline-none border-4 border-white/10 focus:border-indigo-500 transition shadow-xl"
                onkeypress="handleEnterUnlock(event)">

            <button onclick="unlockSession()"
                class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                <i data-lucide="key" class="w-4 h-4"></i> Kilidi AÃ§
            </button>
        </div>


        <button onclick="openPwModalFromLock()"
            class="mt-4 text-xs text-gray-400 hover:text-white underline transition flex items-center justify-center gap-1 w-full">
            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Åifre DeÄŸiÅŸtir
        </button>
    </div>

    <p class="mt-8 text-[10px] text-gray-600 opacity-50">GÃ¼venlik Modu Aktif</p>
    </div>
    <div id="spotlight-modal"
        class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[2000] hidden items-start justify-center pt-[10vh]"
        onclick="closeSpotlight(event)">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden transform transition-all scale-100 ring-1 ring-gray-900/5"
            onclick="event.stopPropagation()">

            <div class="relative border-b border-gray-100">
                <div class="absolute left-4 top-4 text-indigo-500">
                    <i data-lucide="search" class="w-6 h-6"></i>
                </div>
                <input type="text" id="spotlight-input"
                    class="w-full py-4 pl-12 pr-12 text-lg text-gray-800 outline-none placeholder-gray-400 bg-transparent font-medium"
                    placeholder="Ne aramak istiyorsun? (Hasta, NÃ¶bet, BÃ¼tÃ§e...)" oninput="handleSpotlightSearch()"
                    autocomplete="off">
                <button onclick="closeSpotlight()"
                    class="absolute right-4 top-4 text-xs font-bold text-gray-400 border border-gray-200 rounded px-2 py-1 hover:bg-gray-50 transition">ESC</button>
            </div>

            <div id="spotlight-results" class="max-h-[60vh] overflow-y-auto custom-scrollbar bg-gray-50/30">
                <div class="p-10 text-center text-gray-400 text-sm flex flex-col items-center">
                    <i data-lucide="command" class="w-8 h-8 mb-2 opacity-20"></i>
                    <p>Aramaya baÅŸlamak iÃ§in yazÄ±n...</p>
                </div>
            </div>

            <div class="bg-gray-50 px-4 py-2 text-[10px] text-gray-400 flex justify-between border-t border-gray-100">
                <span class="flex items-center gap-1"><i data-lucide="corner-down-left" class="w-3 h-3"></i>
                    <b>Enter</b> seÃ§</span>
                <span class="flex items-center gap-1"><i data-lucide="move-vertical" class="w-3 h-3"></i> <b>YÃ¶n
                        TuÅŸlarÄ±</b> gezin</span>
            </div>
        </div>
    </div>
    <script>
        // MENÃœ SÃœRÃœKLEME Ã–ZELLÄ°ÄÄ° (DRAG TO SCROLL)
        const menu = document.getElementById('ust-menu');
        let isDown = false;
        let startX;
        let scrollLeft;

        menu.addEventListener('mousedown', (e) => {
            isDown = true;
            menu.classList.add('cursor-grabbing'); // Tutma ikonu
            menu.classList.remove('cursor-grab');
            startX = e.pageX - menu.offsetLeft;
            scrollLeft = menu.scrollLeft;
        });

        menu.addEventListener('mouseleave', () => {
            isDown = false;
            menu.classList.remove('cursor-grabbing');
            menu.classList.add('cursor-grab');
        });

        menu.addEventListener('mouseup', () => {
            isDown = false;
            menu.classList.remove('cursor-grabbing');
            menu.classList.add('cursor-grab');
        });

        menu.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - menu.offsetLeft;
            const walk = (x - startX) * 2; // KaydÄ±rma hÄ±zÄ± (2x idealdir)
            menu.scrollLeft = scrollLeft - walk;
        });
        async function forceSyncData() {
            if (!currentUser || !userDataPath) {
                showToast("Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z.", "error");
                return;
            }

            const syncIcon = document.getElementById('sync-icon');
            if (syncIcon) syncIcon.classList.add('animate-spin'); // DÃ¶nme animasyonu ekle
            showToast("Veriler buluttan Ã§ekiliyor...", "info");

            // Ã‡ekilecek tÃ¼m veri anahtarlarÄ±
            const keys = [
                'evdeSaglikShifts_V19', 'evdeSaglikDevices_V1', 'evdeSaglikData_ULTIMATE_V18',
                'evdeSaglikStaff_ULTIMATE_V18', 'evdeSaglikNotes_ULTIMATE_V18', 'evdeSaglikApiKey_V18',
                'evdeSaglikDoctors_V18', 'evdeSaglikDocData_V18', 'evdeSaglikProcs_V18',
                'evdeSaglikAppPW_Enc_V1', 'evdeSaglikSpecList_V18', 'evdeSaglikQuickList_V18',
                'evdeSaglikLeaveRec_V18', 'evdeSaglikTeams_V19', 'evdeSaglikRoutines_V19',
                'evdeSaglikBudget_V19', 'evdeSaglikEmergency_V19', 'evdeSaglikBags_V19',
                'evdeSaglikGenNotesList_V1', 'evdeSaglikPhonebook_V1', 'evdeSaglikReminders_V1',
                'evdeSaglikLockedTabsConfig_V1', 'evdeSaglikTabLockPassCustom_V1',
                'evdeSaglikStartupLock_V1', 'evdeSaglikAdminPass_V1'
            ];

            try {
                // TÃ¼m verileri paralel olarak Ã§ek (Daha hÄ±zlÄ±)
                const promises = keys.map(key => database.ref(`${userDataPath}/${key}`).once('value'));
                const snapshots = await Promise.all(promises);

                // Ã–nbelleÄŸi ve Yerel HafÄ±zayÄ± GÃ¼ncelle
                if (!window._firebaseCache) window._firebaseCache = {};

                snapshots.forEach((snap, index) => {
                    const key = keys[index];
                    const val = snap.val();

                    // 1. RAM Cache GÃ¼ncelle
                    window._firebaseCache[key] = val;

                    // 2. LocalStorage GÃ¼ncelle (KalÄ±cÄ±lÄ±k iÃ§in)
                    if (val !== null) {
                        const storeVal = (typeof val === 'object') ? JSON.stringify(val) : val;
                        originalLocalStorage.setItem(key, storeVal);
                    } else {
                        originalLocalStorage.removeItem(key);
                    }
                });

                // 3. Global DeÄŸiÅŸkenleri Yeniden YÃ¼kle
                loadAll();

                // 4. TÃ¼m ArayÃ¼zÃ¼ Yenile
                renderUI();
                renderShiftTable();
                renderDeviceTable();
                if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
                renderPhonebook();
                renderPatientReminders();
                if (typeof renderRoutines === 'function') renderRoutines();
                renderBagSelector();
                renderEmergency();
                renderGeneralNotes();

                showToast("TÃ¼m veriler baÅŸarÄ±yla gÃ¼ncellendi!");

            } catch (error) {
                console.error("Sync HatasÄ±:", error);
                showToast("Senkronizasyon sÄ±rasÄ±nda hata oluÅŸtu!", "error");
            } finally {
                if (syncIcon) syncIcon.classList.remove('animate-spin'); // Animasyonu durdur
            }
        }
        // ================================================================
        // OTOMATÄ°K ARKA PLAN SENKRONÄ°ZASYON SÄ°STEMÄ°
        // ================================================================

        // Takip edilecek veriler ve veritabanÄ± yollarÄ±
        const SYNC_KEYS = [
            'evdeSaglikShifts_V19', 'evdeSaglikDevices_V1', 'evdeSaglikData_ULTIMATE_V18',
            'evdeSaglikStaff_ULTIMATE_V18', 'evdeSaglikNotes_ULTIMATE_V18',
            'evdeSaglikDoctors_V18', 'evdeSaglikDocData_V18', 'evdeSaglikProcs_V18',
            'evdeSaglikSpecList_V18', 'evdeSaglikQuickList_V18', 'evdeSaglikLeaveRec_V18',
            'evdeSaglikTeams_V19', 'evdeSaglikRoutines_V19', 'evdeSaglikBudget_V19',
            'evdeSaglikEmergency_V19', 'evdeSaglikBags_V19', 'evdeSaglikGenNotesList_V1',
            'evdeSaglikPhonebook_V1', 'evdeSaglikReminders_V1', 'evdeSaglikApiKey_V18',
            'evdeSaglikAppPW_Enc_V1', 'evdeSaglikLockedTabsConfig_V1'
        ];

        // Bu fonksiyonu auth.onAuthStateChanged iÃ§inde "GiriÅŸ BaÅŸarÄ±lÄ±" kÄ±smÄ±na ekle
        function startRealtimeListeners() {
            console.log("ğŸ“¡ Arka plan senkronizasyonu baÅŸlatÄ±ldÄ±...");

            SYNC_KEYS.forEach(key => {
                // Ã‡akÄ±ÅŸma olmamasÄ± iÃ§in Ã¶nce eski dinleyiciyi kapat
                try { database.ref(`${userDataPath}/${key}`).off(); } catch (e) { }

                // CanlÄ± dinleyiciyi (listener) aÃ§
                database.ref(`${userDataPath}/${key}`).on('value', (snapshot) => {
                    const value = snapshot.val();

                    // 1. Veriyi Cache ve LocalStorage'a kaydet
                    updateLocalData(key, value);

                    // 2. Ä°lgili Global DeÄŸiÅŸkeni GÃ¼ncelle
                    updateGlobalVariable(key, value);

                    // 3. Sadece Ä°lgili EkranÄ± Yenile (Performans iÃ§in akÄ±llÄ± yÃ¶nlendirme)
                    triggerSpecificRender(key);
                });
            });
        }

        // Veriyi hafÄ±zaya yazar
        function updateLocalData(key, value) {
            if (!window._firebaseCache) window._firebaseCache = {};
            window._firebaseCache[key] = value;

            if (value !== null) {
                const storeVal = (typeof value === 'object') ? JSON.stringify(value) : value;
                originalLocalStorage.setItem(key, storeVal);
            } else {
                originalLocalStorage.removeItem(key);
            }
        }

        // Hangi veri geldiyse, sadece onunla ilgili fonksiyonu Ã§alÄ±ÅŸtÄ±rÄ±r
        function triggerSpecificRender(key) {
            // Sayfa ilk yÃ¼klenirken (initial load) gereksiz render yapmasÄ±n diye kontrol eklenebilir
            // Ancak veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ iÃ§in her deÄŸiÅŸikliÄŸi yansÄ±tÄ±yoruz.

            //console.log(`ğŸ”„ Veri DeÄŸiÅŸti: ${key}`); // Test iÃ§in aÃ§abilirsin

            switch (key) {
                // NÃ¶bet Listesi
                case 'evdeSaglikShifts_V19':
                    if (typeof renderShiftTable === 'function') renderShiftTable();
                    break;

                // Cihazlar
                case 'evdeSaglikDevices_V1':
                    if (typeof renderDeviceTable === 'function') renderDeviceTable();
                    break;

                // BÃ¼tÃ§e
                case 'evdeSaglikBudget_V19':
                    if (typeof renderBudgetHeader === 'function') renderBudgetHeader();
                    else if (typeof renderBudget === 'function') renderBudget();
                    break;

                // Rehber
                case 'evdeSaglikPhonebook_V1':
                    if (typeof renderPhonebook === 'function') renderPhonebook();
                    break;

                // Hasta HatÄ±rlatmalarÄ±
                case 'evdeSaglikReminders_V1':
                    if (typeof renderPatientReminders === 'function') renderPatientReminders();
                    break;

                // Rutinler
                case 'evdeSaglikRoutines_V19':
                    if (typeof renderRoutines === 'function') renderRoutines();
                    break;

                // Acil Durum & Ã‡antalar
                case 'evdeSaglikEmergency_V19':
                case 'evdeSaglikBags_V19':
                    if (typeof renderBagSelector === 'function') renderBagSelector();
                    if (typeof renderEmergency === 'function') renderEmergency();
                    break;

                // Genel Notlar
                case 'evdeSaglikGenNotesList_V1':
                    if (typeof renderGeneralNotes === 'function') renderGeneralNotes();
                    break;

                // Ana Veriler (Personel, Hasta Listesi vb.) deÄŸiÅŸince genel UI yenile
                case 'evdeSaglikData_ULTIMATE_V18':
                case 'evdeSaglikStaff_ULTIMATE_V18':
                case 'evdeSaglikNotes_ULTIMATE_V18':
                case 'evdeSaglikLeaveRec_V18':
                case 'evdeSaglikDocData_V18':
                    if (typeof renderUI === 'function') renderUI();
                    // YÃ¶netimsel listeler de etkilenebilir
                    if (typeof renderMgmtLists === 'function') renderMgmtLists();
                    break;

                // Sadece Liste/Dropdown gÃ¼ncellemeleri
                case 'evdeSaglikDoctors_V18':
                case 'evdeSaglikTeams_V19':
                case 'evdeSaglikProcs_V18':
                case 'evdeSaglikSpecList_V18':
                    if (typeof renderMgmtLists === 'function') renderMgmtLists();
                    break;
            }
        }

        // Global deÄŸiÅŸkenleri gÃ¼ncelleme haritasÄ±
        function updateGlobalVariable(key, value) {
            // DeÄŸer null veya undefined ise boÅŸ dizi/obje ata
            switch (key) {
                case 'evdeSaglikShifts_V19': shiftList = value || []; break;
                case 'evdeSaglikDevices_V1': deviceList = value || []; break;
                case 'evdeSaglikData_ULTIMATE_V18': allRecords = value || {}; break;
                case 'evdeSaglikStaff_ULTIMATE_V18': staffList = value || []; break;
                case 'evdeSaglikNotes_ULTIMATE_V18': allNotes = value || {}; break;
                case 'evdeSaglikDoctors_V18': doctorList = value || []; break;
                case 'evdeSaglikDocData_V18': docRecords = value || {}; break;
                case 'evdeSaglikProcs_V18': procList = value || []; break;
                case 'evdeSaglikSpecList_V18': specialistList = value || []; break;
                case 'evdeSaglikQuickList_V18': quickList = value || []; break;
                case 'evdeSaglikLeaveRec_V18': leaveRecords = value || []; break;
                case 'evdeSaglikTeams_V19': teamList = value || []; break;
                case 'evdeSaglikRoutines_V19': routineList = value || []; break;
                case 'evdeSaglikBudget_V19': budgetList = value || []; break;
                case 'evdeSaglikEmergency_V19': emergencyList = value || []; break;
                case 'evdeSaglikBags_V19': emergencyBags = value || ["Ana Ã‡anta"]; break;
                case 'evdeSaglikGenNotesList_V1': generalNotesList = value || []; break;
                case 'evdeSaglikPhonebook_V1': phonebookList = value || []; break;
                case 'evdeSaglikReminders_V1': patientReminders = value || []; break;
                case 'evdeSaglikApiKey_V18': apiKey = value || ""; break;
                case 'evdeSaglikAppPW_Enc_V1':
                    if (value) { try { appPassword = atob(value); } catch (e) { } }
                    break;
                case 'evdeSaglikLockedTabsConfig_V1':
                    // 1. Listeyi GÃ¼ncelle (Global deÄŸiÅŸkene yaz)
                    if (typeof value === 'string') {
                        try { window.lockedTabsConfig = JSON.parse(value); } catch (e) { window.lockedTabsConfig = []; }
                    } else {
                        window.lockedTabsConfig = value || [];
                    }

                    // 2. HafÄ±zayÄ± Temizle (Eski izinleri iptal et)
                    if (window.unlockedSessionTabs) {
                        if (Array.isArray(window.lockedTabsConfig)) {
                            window.lockedTabsConfig.forEach(tabId => {
                                window.unlockedSessionTabs[tabId] = false;
                            });
                        }
                    }

                    // 3. SUÃ‡ÃœSTÃœ YAP (EÄŸer kullanÄ±cÄ± ÅŸu an kilitlenen o sekmedeyse KOV!)
                    // Åu an aÃ§Ä±k olan (gÃ¶rÃ¼nÃ¼r) sekmeyi bul
                    const currentVisTab = document.querySelector('.tab-content:not(.hidden)');

                    if (currentVisTab && currentVisTab.id) {
                        // ID genelde 'tab-butce' ÅŸeklindedir, baÅŸÄ±ndaki 'tab-' kÄ±smÄ±nÄ± atalÄ±m
                        const curId = currentVisTab.id.replace('tab-', '');

                        // EÄŸer adamÄ±n baktÄ±ÄŸÄ± sayfa kilitliler listesindeyse
                        if (window.lockedTabsConfig.includes(curId)) {
                            console.log("ğŸš« YASAKLI BÃ–LGE: KullanÄ±cÄ± ana sayfaya atÄ±lÄ±yor...");

                            // switchTab fonksiyonu hazÄ±rsa kullan
                            if (typeof switchTab === 'function') {
                                switchTab('personel'); // AdamÄ± Personel (Ana) sekmesine fÄ±rlat

                                // KullanÄ±cÄ±ya bilgi ver
                                if (typeof showToast === 'function') {
                                    showToast("Bu sekme yÃ¶netici tarafÄ±ndan kilitlendi!", "warning");
                                }
                            } else {
                                // switchTab yoksa manuel gizle (Acil Durum)
                                document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
                                const safe = document.getElementById('tab-personel');
                                if (safe) safe.classList.remove('hidden');
                            }
                        }
                    }
                    break;
                case 'evdeSaglikTabLockPassCustom_V1': customTabPassword = value || '3981'; break;
                // YENÄ°
                case 'evdeSaglikStartupLock_V1': startupLockEnabled = (value === 'true' || value === true); break;
                // YENÄ°
                case 'evdeSaglikAdminPass_V1': adminPanelPassword = value || '1234'; break;
            }
        }
        async function toggleStartupLock() {
            startupLockEnabled = document.getElementById('setting-startup-lock').checked;
            await FirebaseStorage.setItem(LS_STARTUP_LOCK_ENABLED, JSON.stringify(startupLockEnabled));
            showToast(`AÃ§Ä±lÄ±ÅŸ kilidi ${startupLockEnabled ? 'AKTÄ°F' : 'DEVRE DIÅI'}`);
        }
        // --- YÃ–NETÄ°M ÅÄ°FRESÄ°NÄ° KAYDETME FONKSÄ°YONU ---
        async function updateAdminPassword() {
            const newVal = document.getElementById('setting-admin-pass').value.trim();
            if (newVal.length < 3) return showToast("Åifre en az 3 karakter olmalÄ±!", "error");

            adminPanelPassword = newVal;
            await FirebaseStorage.setItem('evdeSaglikAdminPass_V1', adminPanelPassword);
            showToast("YÃ¶netim ÅŸifresi gÃ¼ncellendi.");
        }
        // --- YEDEK YÃœKLEME GÃœVENLÄ°K KONTROLÃœ ---
        function triggerImportWithPassword() {
            // Sekme Kilit Åifresini Sor (customTabPassword)
            // EÄŸer ÅŸifre boÅŸsa varsayÄ±lan '3981'dir.
            const pass = prompt("Yedek dosya yÃ¼klemek iÃ§in Sekme ParolasÄ±nÄ± girin:");

            if (pass === null) return; // Ä°ptal etti

            // customTabPassword ile kontrol ediyoruz (Sekme Åifresi)
            if (pass === customTabPassword) {
                // Åifre doÄŸruysa gizli dosya kutusuna tÄ±klat
                document.getElementById('import-file').click();
            } else {
                showToast("HatalÄ± Parola!", "error");
            }
        }
        // --- CANLI KÄ°LÄ°T BEKÃ‡Ä°SÄ° (ZORUNLU YAMA) ---
        // --- ISRARCI CANLI KÄ°LÄ°T SÄ°STEMÄ° (TERMINATOR VERSÄ°YON) ---
        function baslatCanliGuvenlik() {
            // Kontrol 1: Firebase kÃ¼tÃ¼phanesi yÃ¼klendi mi?
            if (typeof firebase === 'undefined' || typeof firebase.database !== 'function') {
                console.log("â³ GÃ¼venlik sistemi: Firebase bekleniyor...");
                // YÃ¼klenmediyse 500 milisaniye (yarÄ±m saniye) sonra tekrar dene
                setTimeout(baslatCanliGuvenlik, 500);
                return;
            }

            // Kontrol 2: Daha Ã¶nce baÅŸlatÄ±ldÄ± mÄ±? (Ã‡ift Ã§alÄ±ÅŸmasÄ±n)
            if (window.canliGuvenlikAktif) return;

            try {
                const db = firebase.database();
                console.log("ğŸ”¥ GÃ¼venlik Sistemi: BAÄLANDI ve DÄ°NLÄ°YOR");

                // Kilitli Sekmeler Listesini Dinle (Her deÄŸiÅŸiklikte Ã§alÄ±ÅŸÄ±r)
                db.ref('evdeSaglikLockedTabsConfig_V1').on('value', (snapshot) => {
                    console.log("ğŸ”” Kilit GÃ¼ncellemesi AlgÄ±landÄ±:", snapshot.val());

                    // EÄŸer updateGlobalVariable fonksiyonu hazÄ±rsa Ã§alÄ±ÅŸtÄ±r
                    if (typeof updateGlobalVariable === 'function') {
                        updateGlobalVariable('evdeSaglikLockedTabsConfig_V1', snapshot.val());
                    }
                });

                // Sekme Åifresini Dinle
                db.ref('evdeSaglikTabLockPassCustom_V1').on('value', (snapshot) => {
                    if (typeof updateGlobalVariable === 'function') {
                        updateGlobalVariable('evdeSaglikTabLockPassCustom_V1', snapshot.val());
                    }
                });

                // YÃ¶netim Åifresini Dinle
                db.ref('evdeSaglikAdminPass_V1').on('value', (snapshot) => {
                    if (typeof updateGlobalVariable === 'function') {
                        updateGlobalVariable('evdeSaglikAdminPass_V1', snapshot.val());
                    }
                });

                // Sistemin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± iÅŸaretle
                window.canliGuvenlikAktif = true;

                // Ekrana kÃ¼Ã§Ã¼k bir bilgi ver (Ä°stersen silebilirsin)
                // if(typeof showToast === 'function') showToast("CanlÄ± GÃ¼venlik Aktif");

            } catch (err) {
                console.error("GÃ¼venlik BaÅŸlatma HatasÄ±:", err);
                // Hata olursa 1 saniye sonra tekrar dene
                setTimeout(baslatCanliGuvenlik, 1000);
            }
        }

        // Fonksiyonu ilk kez tetikle
        baslatCanliGuvenlik();
        // ================================================================
        // YENÄ° Ã–ZELLÄ°K: KAYIT OLMA DURUMU KONTROLÃœ
        // ================================================================

        let isRegistrationEnabled = true; // VarsayÄ±lan aÃ§Ä±k

        // 1. VeritabanÄ±ndan AyarÄ± Dinle (Uygulama aÃ§Ä±lÄ±r aÃ§Ä±lmaz Ã§alÄ±ÅŸÄ±r)
        // Bu kÄ±sÄ±m giriÅŸ yapÄ±lmÄ±ÅŸ olsun veya olmasÄ±n Ã§alÄ±ÅŸÄ±r
        database.ref('evde_saglik_ortak_veri/evdeSaglikRegStatus_V1').on('value', (snapshot) => {
            const val = snapshot.val();
            // EÄŸer veritabanÄ±nda kayÄ±t yoksa (null) varsayÄ±lan olarak aÃ§Ä±k olsun (true)
            isRegistrationEnabled = (val === null) ? true : val;

            // A) GiriÅŸ EkranÄ±ndaki Butonu YÃ¶net
            const regBtn = document.getElementById('tab-register-btn');
            const regForm = document.getElementById('register-form');

            if (regBtn) {
                if (isRegistrationEnabled) {
                    // KayÄ±t aÃ§Ä±ksa butonu gÃ¶ster
                    regBtn.style.display = 'block';
                    // Buton geniÅŸliklerini dÃ¼zelt (GiriÅŸ Yap butonu tek kalmasÄ±n)
                    document.getElementById('tab-login-btn').classList.remove('w-full');
                    document.getElementById('tab-login-btn').classList.add('flex-1');
                } else {
                    // KayÄ±t kapalÄ±ysa butonu gizle
                    regBtn.style.display = 'none';
                    // GiriÅŸ Yap butonunu tam geniÅŸlik yap
                    document.getElementById('tab-login-btn').classList.remove('flex-1');
                    document.getElementById('tab-login-btn').classList.add('w-full');

                    // EÄŸer kullanÄ±cÄ± o sÄ±rada "KayÄ±t Ol" formundaysa zorla "GiriÅŸ Yap"a at
                    if (regForm && !regForm.classList.contains('hidden')) {
                        switchAuthTab('login');
                        showAuthMessage('Yeni Ã¼ye kaydÄ± yÃ¶netici tarafÄ±ndan kapatÄ±lmÄ±ÅŸtÄ±r.', 'error');
                    }
                }
            }

            // B) Ayarlar MenÃ¼sÃ¼ndeki AnahtarÄ± (Switch) GÃ¼ncelle
            const toggleEl = document.getElementById('setting-reg-toggle');
            if (toggleEl) {
                toggleEl.checked = isRegistrationEnabled;
            }

            console.log('ğŸ”’ KayÄ±t Durumu GÃ¼ncellendi:', isRegistrationEnabled ? 'AÃ‡IK' : 'KAPALI');
        });

        // 2. AyarÄ± DeÄŸiÅŸtirme Fonksiyonu (Kalkan menÃ¼sÃ¼nden Ã§aÄŸrÄ±lÄ±r)
        async function updateRegistrationStatus(isChecked) {
            // Sadece giriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ± deÄŸiÅŸtirebilir
            if (!auth.currentUser) {
                showToast('Bunu deÄŸiÅŸtirmek iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.', 'error');
                // Switch'i eski haline getir
                document.getElementById('setting-reg-toggle').checked = !isChecked;
                return;
            }

            try {
                await database.ref('evde_saglik_ortak_veri/evdeSaglikRegStatus_V1').set(isChecked);
                showToast(isChecked ? 'Ãœye kaydÄ± AÃ‡ILDI' : 'Ãœye kaydÄ± KAPATILDI');
            } catch (error) {
                console.error('KayÄ±t ayarÄ± deÄŸiÅŸtirilemedi:', error);
                showToast('Hata oluÅŸtu, yetkinizi kontrol edin.', 'error');
                // Hata olursa switch'i geri al
                document.getElementById('setting-reg-toggle').checked = !isChecked;
            }
        }
    </script>
    <div id="tab-settings-modal"
        class="fixed inset-0 bg-black/60 z-[110] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col modal-enter max-h-[85vh]">
            <div class="p-4 border-b flex justify-between items-center bg-orange-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-orange-900 flex items-center gap-2">
                    <i data-lucide="shield" class="w-5 h-5"></i> Sekme GÃ¼venlik AyarlarÄ±
                </h3>
                <button
                    onclick="document.getElementById('tab-settings-modal').classList.add('hidden'); document.getElementById('tab-settings-modal').classList.remove('flex');"
                    class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="p-6 space-y-6 overflow-y-auto">
                <div class="flex items-center justify-between bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <div>
                        <h4 class="text-sm font-bold text-orange-900">AÃ§Ä±lÄ±ÅŸta Kilit EkranÄ±</h4>
                        <p class="text-[10px] text-gray-500">Uygulama aÃ§Ä±ldÄ±ÄŸÄ±nda ÅŸifre sorulsun mu?</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="setting-startup-lock" onchange="toggleStartupLock()"
                            class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600">
                        </div>
                    </label>
                </div>

                <hr class="border-gray-100">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">YÃ¶netim & Veri GiriÅŸi
                        Åifresi</label>
                    <div class="flex gap-2">
                        <input type="text" id="setting-admin-pass"
                            class="flex-1 p-2 border border-gray-300 rounded text-sm font-bold text-center tracking-widest focus:ring-2 focus:ring-red-500 outline-none"
                            placeholder="1234">
                        <button onclick="updateAdminPassword()"
                            class="bg-red-600 text-white px-3 py-2 rounded font-bold text-xs hover:bg-red-700 transition">GÃ¼ncelle</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">* Kalem ikonuna basÄ±nca sorulan ÅŸifredir.</p>
                </div>
                <div class="mb-6 pb-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Yeni Ãœye KaydÄ±</label>
                            <p class="text-[10px] text-gray-400">KapalÄ±yken giriÅŸ ekranÄ±nda "KayÄ±t Ol" butonu gizlenir.
                            </p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="setting-reg-toggle"
                                onchange="updateRegistrationStatus(this.checked)" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                            </div>
                        </label>
                    </div>
                </div>
                <hr class="border-gray-100">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sekme Kilit Åifresi</label>
                    <div class="flex gap-2">
                        <input type="text" id="setting-tab-pass"
                            class="flex-1 p-2 border border-gray-300 rounded text-sm font-bold text-center tracking-widest focus:ring-2 focus:ring-orange-500 outline-none"
                            placeholder="Åifre">
                        <button onclick="updateTabPassword()"
                            class="bg-orange-600 text-white px-3 py-2 rounded font-bold text-xs hover:bg-orange-700 transition">Åifreyi
                            GÃ¼ncelle</button>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">* Bu ÅŸifre sadece sekmeleri aÃ§arken sorulur.</p>
                </div>

                <br>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-3">Hangi Sekmeler
                        Åifrelensin?</label>
                    <div class="grid grid-cols-2 gap-2" id="tab-selection-grid">
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button
                    onclick="document.getElementById('tab-settings-modal').classList.add('hidden'); document.getElementById('tab-settings-modal').classList.remove('flex');"
                    class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Kapat</button>
            </div>
        </div>
    </div>
    <!-- Ã–ZEL GÃœN TEMA SÄ°STEMÄ° -->
    <script>
        const LS_THEME_DISMISSED = 'evdeSaglikThemeDismissed';

        // Hicri bayram tarihleri (2024-2030)
        const islamicHolidays = {
            ramazan: [
                { year: 2024, start: '2024-04-10', end: '2024-04-12' },
                { year: 2025, start: '2025-03-30', end: '2025-04-01' },
                { year: 2026, start: '2026-03-20', end: '2026-03-22' },
                { year: 2027, start: '2027-03-09', end: '2027-03-11' },
                { year: 2028, start: '2028-02-26', end: '2028-02-28' },
                { year: 2029, start: '2029-02-14', end: '2029-02-16' },
                { year: 2030, start: '2030-02-04', end: '2030-02-06' }
            ],
            kurban: [
                { year: 2024, start: '2024-06-16', end: '2024-06-19' },
                { year: 2025, start: '2025-06-06', end: '2025-06-09' },
                { year: 2026, start: '2026-05-27', end: '2026-05-30' },
                { year: 2027, start: '2027-05-16', end: '2027-05-19' },
                { year: 2028, start: '2028-05-05', end: '2028-05-08' },
                { year: 2029, start: '2029-04-24', end: '2029-04-27' },
                { year: 2030, start: '2030-04-13', end: '2030-04-16' }
            ]
        };

        // Ã–zel gÃ¼n tanÄ±mlarÄ±
        const specialDays = {
            newyear: {
                check: (d, m) => (m === 12 && d >= 24) || (m === 1 && d <= 2),
                icon: String.fromCodePoint(0x1F384),
                title: 'Mutlu YÄ±llar!',
                message: 'Yeni yÄ±lÄ±nÄ±z kutlu olsun, saÄŸlÄ±k ve mutluluk dolu bir yÄ±l dileriz!',
                bannerClass: 'banner-newyear',
                effect: 'snow'
            },
            children: {
                check: (d, m) => m === 4 && d === 23,
                icon: String.fromCodePoint(0x1F388),
                title: '23 Nisan Ulusal Egemenlik ve Ã‡ocuk BayramÄ±',
                message: 'TÃ¼m Ã§ocuklarÄ±mÄ±zÄ±n bayramÄ± kutlu olsun!',
                bannerClass: 'banner-children',
                effect: 'balloon'
            },
            labor: {
                check: (d, m) => m === 5 && d === 1,
                icon: String.fromCodePoint(0x2692),
                title: '1 MayÄ±s Emek ve DayanÄ±ÅŸma GÃ¼nÃ¼',
                message: 'TÃ¼m emekÃ§ilerin gÃ¼nÃ¼ kutlu olsun!',
                bannerClass: 'banner-labor',
                effect: 'confetti'
            },
            youth: {
                check: (d, m) => m === 5 && d === 19,
                icon: String.fromCodePoint(0x1F3C3),
                title: '19 MayÄ±s GenÃ§lik ve Spor BayramÄ±',
                message: 'GenÃ§liÄŸe armaÄŸan edilen bu Ã¶zel gÃ¼n kutlu olsun!',
                bannerClass: 'banner-national',
                effect: 'confetti'
            },
            democracy: {
                check: (d, m) => m === 7 && d === 15,
                icon: String.fromCodePoint(0x1F1F9) + String.fromCodePoint(0x1F1F7),
                title: '15 Temmuz Demokrasi ve Milli Birlik GÃ¼nÃ¼',
                message: 'Åehitlerimizi saygÄ± ve minnetle anÄ±yoruz.',
                bannerClass: 'banner-democracy',
                effect: 'flag'
            },
            victory: {
                check: (d, m) => m === 8 && d === 30,
                icon: String.fromCodePoint(0x2694),
                title: '30 AÄŸustos Zafer BayramÄ±',
                message: 'BÃ¼yÃ¼k Zaferin yÄ±ldÃ¶nÃ¼mÃ¼ kutlu olsun!',
                bannerClass: 'banner-national',
                effect: 'confetti'
            },
            republic: {
                check: (d, m) => m === 10 && d === 29,
                icon: String.fromCodePoint(0x1F386),
                title: 'Cumhuriyet BayramÄ± Kutlu Olsun!',
                message: 'Cumhuriyetimizin kuruluÅŸu coÅŸkuyla kutlanÄ±yor!',
                bannerClass: 'banner-republic',
                effect: 'firework'
            },
            ataturk: {
                check: (d, m) => m === 11 && d === 10,
                icon: String.fromCodePoint(0x1F5A4),
                title: 'AtatÃ¼rk\'Ã¼ Anma GÃ¼nÃ¼',
                message: 'Ulu Ã–nder Mustafa Kemal AtatÃ¼rk\'Ã¼ saygÄ± ve minnetle anÄ±yoruz.',
                bannerClass: 'banner-ataturk',
                effect: 'memorial'
            }
        };

        function isDateInRange(dateStr, startStr, endStr) {
            const date = new Date(dateStr);
            return date >= new Date(startStr) && date <= new Date(endStr);
        }

        function getSpecialDay() {
            const now = new Date();
            const day = now.getDate();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            for (const [key, config] of Object.entries(specialDays)) {
                if (config.check(day, month)) return { key, ...config };
            }

            const ramazanData = islamicHolidays.ramazan.find(h => h.year === year);
            if (ramazanData && isDateInRange(dateStr, ramazanData.start, ramazanData.end)) {
                return { key: 'ramazan', icon: String.fromCodePoint(0x1F319), title: 'Ramazan BayramÄ±nÄ±z MÃ¼barek Olsun!', message: 'Nice gÃ¼zel bayramlara...', bannerClass: 'banner-religious', effect: 'crescent' };
            }

            const kurbanData = islamicHolidays.kurban.find(h => h.year === year);
            if (kurbanData && isDateInRange(dateStr, kurbanData.start, kurbanData.end)) {
                return { key: 'kurban', icon: String.fromCodePoint(0x1F411), title: 'Kurban BayramÄ±nÄ±z MÃ¼barek Olsun!', message: 'HayÄ±rlÄ± bayramlar dileriz.', bannerClass: 'banner-religious', effect: 'crescent' };
            }

            return null;
        }

        function createSnowEffect() {
            const container = document.getElementById('theme-effects-container');
            if (!container) return;
            const snowflakes = [String.fromCodePoint(0x2744), String.fromCodePoint(0x2745), String.fromCodePoint(0x2746)];
            for (let i = 0; i < 50; i++) {
                const sf = document.createElement('div');
                sf.className = 'snowflake';
                sf.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
                sf.style.left = Math.random() * 100 + 'vw';
                sf.style.animationDuration = (Math.random() * 5 + 5) + 's';
                sf.style.animationDelay = Math.random() * 10 + 's';
                sf.style.fontSize = (Math.random() * 1.5 + 0.8) + 'rem';
                container.appendChild(sf);
            }
        }

        function createConfettiEffect() {
            const container = document.getElementById('theme-effects-container');
            if (!container) return;
            const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
            for (let i = 0; i < 80; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                c.style.animationDuration = (Math.random() * 3 + 3) + 's';
                c.style.animationDelay = Math.random() * 5 + 's';
                c.style.width = (Math.random() * 8 + 5) + 'px';
                c.style.height = (Math.random() * 8 + 5) + 'px';
                container.appendChild(c);
            }
        }

        function createBalloonEffect() {
            const container = document.getElementById('theme-effects-container');
            if (!container) return;
            const balloons = [String.fromCodePoint(0x1F388), String.fromCodePoint(0x1F381), String.fromCodePoint(0x1F380)];
            for (let i = 0; i < 20; i++) {
                const b = document.createElement('div');
                b.className = 'balloon';
                b.textContent = balloons[Math.floor(Math.random() * balloons.length)];
                b.style.left = Math.random() * 100 + 'vw';
                b.style.animationDuration = (Math.random() * 10 + 15) + 's';
                b.style.animationDelay = Math.random() * 10 + 's';
                container.appendChild(b);
            }
        }

        function createFireworkEffect() {
            const container = document.getElementById('theme-effects-container');
            if (!container) return;
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6'];
            function launch() {
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * (window.innerHeight * 0.6);
                for (let i = 0; i < 20; i++) {
                    const p = document.createElement('div');
                    p.className = 'firework';
                    p.style.left = x + 'px';
                    p.style.top = y + 'px';
                    p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    const angle = (Math.PI * 2 / 20) * i;
                    const v = 50 + Math.random() * 50;
                    p.style.transform = `translate(${Math.cos(angle) * v}px, ${Math.sin(angle) * v}px)`;
                    container.appendChild(p);
                    setTimeout(() => p.remove(), 1500);
                }
            }
            launch();
            setInterval(launch, 3000);
        }

        function createCrescentEffect() {
            const container = document.getElementById('theme-effects-container');
            if (!container) return;
            const crescents = [String.fromCodePoint(0x1F319), String.fromCodePoint(0x2728), String.fromCodePoint(0x2B50)];
            for (let i = 0; i < 30; i++) {
                const c = document.createElement('div');
                c.className = 'snowflake crescent-icon';
                c.textContent = crescents[Math.floor(Math.random() * crescents.length)];
                c.style.left = Math.random() * 100 + 'vw';
                c.style.animationDuration = (Math.random() * 8 + 8) + 's';
                c.style.animationDelay = Math.random() * 10 + 's';
                container.appendChild(c);
            }
        }

        function createFlagEffect() {
            const container = document.getElementById('theme-effects-container');
            if (!container) return;
            const flag = String.fromCodePoint(0x1F1F9) + String.fromCodePoint(0x1F1F7);
            for (let i = 0; i < 15; i++) {
                const f = document.createElement('div');
                f.className = 'snowflake flag-icon';
                f.textContent = flag;
                f.style.left = Math.random() * 100 + 'vw';
                f.style.animationDuration = (Math.random() * 10 + 10) + 's';
                f.style.animationDelay = Math.random() * 8 + 's';
                f.style.fontSize = '2rem';
                container.appendChild(f);
            }
        }

        function applyMemorialMode() { document.body.classList.add('ataturk-memorial-mode'); }

        function applyEffect(effectType) {
            switch (effectType) {
                case 'snow': createSnowEffect(); break;
                case 'confetti': createConfettiEffect(); break;
                case 'balloon': createBalloonEffect(); break;
                case 'firework': createFireworkEffect(); break;
                case 'crescent': createCrescentEffect(); break;
                case 'flag': createFlagEffect(); break;
                case 'memorial': applyMemorialMode(); break;
            }
        }

        function showSpecialDayBanner(specialDay) {
            const banner = document.getElementById('special-day-banner');
            const iconEl = document.getElementById('special-day-icon');
            const titleEl = document.getElementById('special-day-title');
            const messageEl = document.getElementById('special-day-message');
            if (!banner || !iconEl || !titleEl || !messageEl) return;
            iconEl.textContent = specialDay.icon;
            titleEl.textContent = specialDay.title;
            messageEl.textContent = specialDay.message;
            banner.className = `px-4 py-3 text-white ${specialDay.bannerClass}`;
            banner.classList.remove('hidden');
        }

        function applySpecialDayTheme() {
            const today = new Date().toDateString();
            if (localStorage.getItem(LS_THEME_DISMISSED) === today) return;
            const specialDay = getSpecialDay();
            if (!specialDay) return;
            console.log('%cğŸ‰ Ã–zel gÃ¼n tespit edildi: ' + specialDay.title, 'color: #8b5cf6; font-weight: bold;');
            showSpecialDayBanner(specialDay);
            applyEffect(specialDay.effect);
        }

        function dismissSpecialDayTheme() {
            const banner = document.getElementById('special-day-banner');
            const container = document.getElementById('theme-effects-container');
            if (banner) banner.classList.add('hidden');
            if (container) container.innerHTML = '';
            document.body.classList.remove('ataturk-memorial-mode');
            localStorage.setItem(LS_THEME_DISMISSED, new Date().toDateString());
            console.log('%cğŸ”• Ã–zel gÃ¼n temasÄ± kapatÄ±ldÄ±', 'color: #6b7280;');
        }

        function createBannerElements() {
            if (document.getElementById('special-day-banner')) return;

            // Effects container - body'ye ekle
            const effectsContainer = document.createElement('div');
            effectsContainer.id = 'theme-effects-container';
            document.body.appendChild(effectsContainer);

            // Banner - app'in iÃ§ine ekle
            const app = document.getElementById('app');
            if (!app) return;

            const bannerHTML = `
        <div id="special-day-banner" class="hidden px-4 py-3 text-white" style="position:relative; z-index:100;">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-3">
                    <span id="special-day-icon" class="text-3xl"></span>
                    <div>
                        <h3 id="special-day-title" class="font-bold text-lg"></h3>
                        <p id="special-day-message" class="text-sm opacity-90"></p>
                    </div>
                </div>
                <button onclick="dismissSpecialDayTheme()" class="text-white/70 hover:text-white hover:bg-white/20 rounded-full p-2 transition" title="Kapat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>
    `;
            app.insertAdjacentHTML('afterbegin', bannerHTML);
        }

        // Firebase auth sonrasÄ± Ã§alÄ±ÅŸtÄ±r
        if (typeof auth !== 'undefined') {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    setTimeout(() => {
                        createBannerElements();
                        applySpecialDayTheme();
                    }, 1500);
                }
            });
        }

        console.log('%cğŸŠ Ã–zel GÃ¼n Tema Sistemi YÃ¼klendi', 'color: #10b981; font-weight: bold; font-size: 14px;');

        // ============================================
        // AKTÄ°VÄ°TE LOG SÄ°STEMÄ°
        // ============================================

        const LS_ACTIVITY_LOGS = 'evdeSaglik_ActivityLogs';
        let activityLogs = [];

        // Log tÃ¼rleri ve ikonlarÄ±
        const LOG_TYPES = {
            shift: { icon: 'ğŸ“…', label: 'NÃ¶bet' },
            budget: { icon: 'ğŸ’°', label: 'BÃ¼tÃ§e' },
            emergency: { icon: 'ğŸ§°', label: 'Acil Ã‡anta' },
            device: { icon: 'ğŸ“±', label: 'Cihaz' },
            reminder: { icon: 'â°', label: 'HatÄ±rlatÄ±cÄ±' },
            contact: { icon: 'ğŸ“', label: 'Rehber' },
            note: { icon: 'ğŸ“', label: 'Not' },
            routine: { icon: 'âœ…', label: 'Rutin' },
            user: { icon: 'ğŸ‘¤', label: 'KullanÄ±cÄ±' },
            general: { icon: 'ğŸ“‹', label: 'Genel' }
        };

        // Aktivite loglarÄ±nÄ± yÃ¼kle
        async function loadActivityLogs() {
            try {
                const snapshot = await database.ref('evde_saglik_ortak_veri/activity_logs').orderByChild('timestamp').limitToLast(50).once('value');
                const data = snapshot.val();
                activityLogs = data ? Object.values(data).reverse() : [];
                renderActivityLogs();
            } catch (error) {
                console.error('Log yÃ¼kleme hatasÄ±:', error);
                activityLogs = [];
            }
        }

        // Yeni aktivite logu ekle
        async function addActivityLog(type, action, details = '') {
            if (!currentUser) return;

            const log = {
                id: Date.now().toString(),
                type: type,
                action: action,
                details: details,
                user: currentUser.email,
                timestamp: new Date().toISOString()
            };

            try {
                await database.ref(`evde_saglik_ortak_veri/activity_logs/${log.id}`).set(log);
                activityLogs.unshift(log);
                if (activityLogs.length > 50) activityLogs.pop();
                renderActivityLogs();
                updateActivityBadge();
            } catch (error) {
                console.error('Log kaydetme hatasÄ±:', error);
            }
        }

        // LoglarÄ± render et
        function renderActivityLogs() {
            const container = document.getElementById('activity-log-list');
            const countEl = document.getElementById('activity-count');

            if (!container) return;

            if (activityLogs.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-xs py-10">HenÃ¼z iÅŸlem yok</p>';
                if (countEl) countEl.textContent = '0 kayÄ±t';
                return;
            }

            let html = '';
            activityLogs.forEach(log => {
                const logType = LOG_TYPES[log.type] || LOG_TYPES.general;
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                const userShort = log.user ? log.user.split('@')[0] : '?';

                html += `
            <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:bg-gray-100 transition">
                <div class="flex items-start gap-2">
                    <span class="text-lg">${logType.icon}</span>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-gray-800">${log.action}</div>
                        ${log.details ? `<div class="text-[10px] text-gray-500 mt-0.5">${log.details}</div>` : ''}
                        <div class="text-[10px] text-gray-400 mt-1 flex items-center gap-2">
                            <span>ğŸ‘¤ ${userShort}</span>
                            <span>â€¢</span>
                            <span>${timeStr}</span>
                        </div>
                    </div>
                </div>
            </div>
            `;
            });

            container.innerHTML = html;
            if (countEl) countEl.textContent = `${activityLogs.length} kayÄ±t`;
        }

        // Badge gÃ¼ncelle
        function updateActivityBadge() {
            const badge = document.getElementById('activity-badge');
            if (!badge) return;

            // Son 1 saat iÃ§indeki loglarÄ± say
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            const recentCount = activityLogs.filter(log => new Date(log.timestamp).getTime() > oneHourAgo).length;

            if (recentCount > 0) {
                badge.textContent = recentCount > 9 ? '9+' : recentCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Panel aÃ§
        function openActivityLogPanel() {
            document.getElementById('activity-log-panel').classList.remove('translate-x-full');
            document.getElementById('activity-log-overlay').classList.remove('hidden');
            loadActivityLogs();
        }

        // Panel kapat
        function closeActivityLogPanel() {
            document.getElementById('activity-log-panel').classList.add('translate-x-full');
            document.getElementById('activity-log-overlay').classList.add('hidden');
        }
        // Log Temizleyici
        async function clearActivityLogs() {
            // Sadece admin temizleyebilir
            if (currentUserRole !== 'Admin') {
                showToast('Sadece Admin loglarÄ± temizleyebilir!', 'error');
                return;
            }
            if (!confirm('TÃ¼m loglarÄ± silmek istiyor musunuz?')) return;
            try {
                await database.ref('evde_saglik_ortak_veri/activity_logs').remove();
                activityLogs = [];
                renderActivityLogs();
                showToast('Loglar temizlendi', 'success');
            } catch (error) {
                showToast('Hata oluÅŸtu', 'error');
            }
        }

        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (currentUser) loadActivityLogs();
            }, 3000);
        });

        // Firebase auth sonrasÄ±
        if (typeof auth !== 'undefined') {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    setTimeout(loadActivityLogs, 3000);
                }
            });
        }
        // Her 30 saniyede badge gÃ¼ncelle
        setInterval(() => {
            if (currentUser) updateActivityBadge();
        }, 30000);

        // Badge'i gÃ¶ster
        function updateActivityBadge() {
            const badge = document.getElementById('activity-badge');
            if (!badge || activityLogs.length === 0) return;

            // Son 1 saat iÃ§indeki log sayÄ±sÄ±
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            const newCount = activityLogs.filter(l => new Date(l.timestamp).getTime() > oneHourAgo).length;

            if (newCount > 0) {
                badge.textContent = newCount > 9 ? '9+' : newCount;
                badge.classList.remove('hidden');
                badge.classList.add('flex');
            } else {
                badge.classList.add('hidden');
            }
        }
        console.log('ğŸ”” Aktivite Log Sistemi YÃ¼klendi');
        // Bildirim butonunu sadece admin gÃ¶rsÃ¼n
        setTimeout(() => {
            const actBtn = document.getElementById('btn-activity-log');
            if (actBtn && currentUserRole !== 'admin') {
                actBtn.style.display = 'none';
            }
        }, 3000);
    </script>
    <!-- ROL BAZLI YETKÄ°LENDÄ°RME SÄ°STEMÄ° -->
    <script>
        // ============================================
        // ROL BAZLI YETKÄ°LENDÄ°RME SÄ°STEMÄ°
        // ============================================

        const ROLES = { ADMIN: 'admin', USER: 'user', VIEWER: 'viewer' };
        const LS_USER_ROLES = 'evdeSaglik_UserRoles';
        let currentUserRole = ROLES.VIEWER; // VarsayÄ±lan: GÃ¶rÃ¼ntÃ¼leyici
        let allUsersRoles = {};

        // Email'i Firebase key formatÄ±na Ã§evir
        function emailToKey(email) {
            return email.replace(/\./g, ',').replace(/@/g, '_at_');
        }

        // Firebase key'i email'e Ã§evir
        function keyToEmail(key) {
            return key.replace(/,/g, '.').replace(/_at_/g, '@');
        }

        // KullanÄ±cÄ± rolÃ¼nÃ¼ kaydet (kayÄ±t sÄ±rasÄ±nda)
        async function saveUserRole(email, role) {
            const emailKey = emailToKey(email);
            const roleData = {
                email: email,
                role: role,
                createdAt: new Date().toISOString()
            };

            try {
                await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).set(roleData);
                console.log('âœ… Rol kaydedildi:', email, 'â†’', role);
                return true;
            } catch (error) {
                console.error('âŒ Rol kaydetme hatasÄ±:', error);
                return false;
            }
        }

        // KullanÄ±cÄ± rolÃ¼nÃ¼ oku
        async function getUserRole(email) {
            const emailKey = emailToKey(email);

            try {
                const snapshot = await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).once('value');
                const data = snapshot.val();

                if (data && data.role) {
                    return data.role;
                }
                return null;
            } catch (error) {
                console.error('âŒ Rol okuma hatasÄ±:', error);
                return null;
            }
        }

        // TÃ¼m kullanÄ±cÄ± rollerini oku
        async function getAllUserRoles() {
            try {
                const snapshot = await database.ref('evde_saglik_ortak_veri/users_roles').once('value');
                const data = snapshot.val();
                return data || {};
            } catch (error) {
                console.error('âŒ KullanÄ±cÄ± listesi okuma hatasÄ±:', error);
                return {};
            }
        }

        // Rol bazlÄ± UI kÄ±sÄ±tlamalarÄ±nÄ± uygula
        function applyRoleRestrictions() {
            console.log('ğŸ” Rol kÄ±sÄ±tlamalarÄ± uygulanÄ±yor:', currentUserRole);

            // TÃ¼m role-hide sÄ±nÄ±flarÄ±nÄ± temizle
            document.querySelectorAll('.role-hide-viewer, .role-hide-user').forEach(el => {
                el.classList.remove('role-hide-viewer', 'role-hide-user');
            });

            // Viewer iÃ§in kÄ±sÄ±tlamalar
            if (currentUserRole === ROLES.VIEWER) {
                // Ekleme/dÃ¼zenleme butonlarÄ±nÄ± gizle
                const hideForViewer = [
                    '#open-entry-modal-btn',
                    '#open-staff-modal-btn',
                    '#add-leave-btn',
                    '#save-entry-btn',
                    '#add-staff-btn',
                    '#add-doctor-btn',
                    '#add-spec-btn',
                    '#add-proc-btn',
                    '#add-team-btn',
                    '#btn-em-save',
                    '#btn-budget-save',
                    '#btn-rem-save',
                    '#btn-ph-save',
                    '#btn-device-save',
                    '[onclick*="addShift"]',
                    '[onclick*="addRoutine"]',
                    '[onclick*="addGeneralNote"]',
                    '[onclick*="addContact"]',
                    '[onclick*="addDevice"]',
                    '[onclick*="addBudgetItem"]',
                    '[onclick*="addEmergencyItem"]',
                    '[onclick*="triggerImportWithPassword"]',
                    '[onclick*="clearBudget"]',
                    '[onclick*="resetRoutines"]',
                    '#btn-user-management'
                ];

                hideForViewer.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        el.classList.add('role-hide-viewer');
                    });
                });

                // Silme butonlarÄ±nÄ± gizle (tablolardaki)
                document.querySelectorAll('[onclick*="delete"], [onclick*="remove"], [onclick*="Delete"], [onclick*="Remove"]').forEach(el => {
                    el.classList.add('role-hide-viewer');
                });

                console.log('ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼leyici modu: DÃ¼zenleme butonlarÄ± gizlendi');
            }

            // User iÃ§in kÄ±sÄ±tlamalar (sadece kullanÄ±cÄ± yÃ¶netimi gizli)
            if (currentUserRole === ROLES.USER) {
                document.querySelectorAll('#btn-user-management').forEach(el => {
                    el.classList.add('role-hide-user');
                });
                console.log('ğŸ‘¤ KullanÄ±cÄ± modu: YÃ¶netim paneli gizlendi');
            }

            // Admin iÃ§in hiÃ§bir kÄ±sÄ±tlama yok
            if (currentUserRole === ROLES.ADMIN) {
                console.log('ğŸ‘‘ Admin modu: TÃ¼m yetkiler aÃ§Ä±k');
            }

            // Rol badge'ini gÃ¼ncelle
            updateRoleBadge();
            // Ã‡Ä±kÄ±ÅŸ butonu her zaman gÃ¶rÃ¼nsÃ¼n
            setTimeout(() => {
                const logoutBtn = document.querySelector('[onclick*="logoutUser"]');
                if (logoutBtn) {
                    logoutBtn.classList.remove('role-hide-viewer', 'role-hide-user');
                    logoutBtn.style.display = '';
                }
            }, 100);
        }

        // Header'a rol badge'i ekle
        function updateRoleBadge() {
            let badge = document.getElementById('current-role-badge');

            if (!badge) {
                const headerButtons = document.querySelector('.flex.items-center.gap-3');
                if (headerButtons) {
                    badge = document.createElement('span');
                    badge.id = 'current-role-badge';
                    headerButtons.insertBefore(badge, headerButtons.firstChild);
                }
            }

            if (badge) {
                const roleNames = {
                    admin: 'ğŸ‘‘ Admin',
                    user: 'ğŸ‘¤ KullanÄ±cÄ±',
                    viewer: 'ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼leyici'
                };
                badge.className = `role-badge ${currentUserRole}`;
                badge.textContent = roleNames[currentUserRole] || currentUserRole;
            }
        }

        // KullanÄ±cÄ± YÃ¶netim ModalÄ±nÄ± AÃ§
        async function openUserManagementModal() {
            if (currentUserRole !== ROLES.ADMIN) {
                showToast('Bu iÅŸlem iÃ§in Admin yetkisi gerekli!', 'error');
                return;
            }

            const modal = document.getElementById('user-management-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // KullanÄ±cÄ± listesini yÃ¼kle
            await loadUserList();

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // KullanÄ±cÄ± YÃ¶netim ModalÄ±nÄ± Kapat
        function closeUserManagementModal() {
            const modal = document.getElementById('user-management-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // KullanÄ±cÄ± listesini yÃ¼kle
        async function loadUserList() {
            const container = document.getElementById('user-list-container');
            container.innerHTML = '<p class="text-center py-4 text-gray-400">YÃ¼kleniyor...</p>';

            allUsersRoles = await getAllUserRoles();

            if (Object.keys(allUsersRoles).length === 0) {
                container.innerHTML = '<p class="text-center py-4 text-gray-400">HenÃ¼z kayÄ±tlÄ± kullanÄ±cÄ± yok</p>';
                return;
            }

            let html = '';
            for (const [key, data] of Object.entries(allUsersRoles)) {
                const email = data.email || keyToEmail(key);
                const role = data.role || 'viewer';
                const allowedTabs = data.allowedTabs || ALL_TABS.map(t => t.id);
                const isCurrentUser = currentUser && currentUser.email === email;

                html += `
            <div class="border rounded-lg p-4 ${isCurrentUser ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="font-bold text-gray-800">${email}</div>
                        ${isCurrentUser ? '<span class="text-[10px] text-yellow-600 font-bold">(Sen)</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="role-select-${key}" class="text-xs border rounded px-2 py-1" ${isCurrentUser ? 'disabled' : ''}>
                            <option value="admin" ${role === 'admin' ? 'selected' : ''}>ğŸ‘‘ Admin</option>
                            <option value="user" ${role === 'user' ? 'selected' : ''}>ğŸ‘¤ KullanÄ±cÄ±</option>
                            <option value="viewer" ${role === 'viewer' ? 'selected' : ''}>ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼leyici</option>
                        </select>
                        ${!isCurrentUser ? `<button onclick="saveUserPermissions('${key}')" class="px-3 py-1 bg-indigo-600 text-white rounded text-xs font-bold hover:bg-indigo-700">Kaydet</button>` : ''}
                    </div>
                </div>
                <div class="border-t pt-3">
                    <div class="text-xs font-bold text-gray-500 mb-2">ğŸ“‘ EriÅŸebileceÄŸi Sekmeler:</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="tabs-${key}">
                        ${ALL_TABS.map(tab => `
                            <label class="flex items-center gap-1 text-xs cursor-pointer ${isCurrentUser ? 'opacity-50' : ''}">
                                <input type="checkbox" class="rounded border-gray-300" value="${tab.id}" ${allowedTabs.includes(tab.id) ? 'checked' : ''} ${isCurrentUser ? 'disabled' : ''}>
                                ${tab.name}
                            </label>
                        `).join('')}
                    </div>
                </div>
            </div>
            `;
            }
            container.innerHTML = html;
        }

        // KullanÄ±cÄ± rolÃ¼nÃ¼ gÃ¼ncelle
        async function updateUserRole(emailKey) {
            const select = document.getElementById(`role-select-${emailKey}`);
            const newRole = select.value;
            const email = keyToEmail(emailKey);

            try {
                await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}/role`).set(newRole);
                showToast(`${email} rolÃ¼ "${newRole}" olarak gÃ¼ncellendi!`, 'success');
                await loadUserList();
            } catch (error) {
                console.error('Rol gÃ¼ncelleme hatasÄ±:', error);
                showToast('Rol gÃ¼ncellenemedi!', 'error');
            }
        }

        // Auth listener'a rol kontrolÃ¼ ekle (mevcut onAuthStateChanged'e ek)
        const originalAuthListener = auth.onAuthStateChanged;
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // KullanÄ±cÄ±nÄ±n rolÃ¼nÃ¼ kontrol et
                let role = await getUserRole(user.email);

                // EÄŸer rol yoksa (yeni kullanÄ±cÄ±), varsayÄ±lan "viewer" ata
                if (!role) {
                    console.log('ğŸ†• Yeni kullanÄ±cÄ± tespit edildi, varsayÄ±lan rol atanÄ±yor...');
                    await saveUserRole(user.email, ROLES.VIEWER);
                    role = ROLES.VIEWER;
                }

                currentUserRole = role;
                console.log('ğŸ” KullanÄ±cÄ± rolÃ¼:', currentUserRole);
                // Sekme yetkilerini al
                const userDataFull = await database.ref(`evde_saglik_ortak_veri/users_roles/${emailToKey(user.email)}`).once('value');
                const userData = userDataFull.val();
                currentUserAllowedTabs = userData?.allowedTabs || ALL_TABS.map(t => t.id);
                console.log('ğŸ“‘ EriÅŸilebilir sekmeler:', currentUserAllowedTabs);

                // UI kÄ±sÄ±tlamalarÄ±nÄ± uygula (biraz gecikmeyle, UI yÃ¼klendikten sonra)
                setTimeout(() => {
                    applyRoleRestrictions();
                    applyTabRestrictions();

                    // Bildirim butonunu sadece admin gÃ¶rsÃ¼n
                    const actBtn = document.getElementById('btn-activity-log');
                    if (actBtn && currentUserRole !== 'admin') {
                        actBtn.style.display = 'none';
                    }
                }, 2000);
            }
        });

        // Sayfa yÃ¼klendiÄŸinde Lucide ikonlarÄ±nÄ± gÃ¼ncelle
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 1000);
        });
        // ============================================
        // SEKME BAZLI YETKÄ°LENDÄ°RME
        // ============================================

        const ALL_TABS = [
            { id: 'hastatakip', name: 'Hasta Takip' },
            { id: 'personel', name: 'Personel Takip' },
            { id: 'uzman', name: 'Uzman EÅŸleÅŸmeleri' },
            { id: 'analiz', name: 'GeÃ§miÅŸ Analiz' },
            { id: 'rutinler', name: 'GÃ¼nlÃ¼k Rutinler' },
            { id: 'acilcanta', name: 'Acil Ã‡anta' },
            { id: 'butce', name: 'BÃ¼tÃ§e Takip' },
            { id: 'notlar', name: 'Notlar' },
            { id: 'nobet', name: 'NÃ¶bet Listesi' },
            { id: 'cihazlar', name: 'Cihaz & Zimmet' },
            { id: 'istatistik', name: 'Ä°statistikler' },
            { id: 'puantaj', name: 'Puantaj' },
            { id: 'rehber', name: 'Rehber' },
            { id: 'takvim', name: 'Takvim' },
            { id: 'inrhesaplayici', name: 'Ä°NR HesaplayÄ±cÄ±' }
        ];

        let currentUserAllowedTabs = [];

        // Sekme kÄ±sÄ±tlamalarÄ±nÄ± uygula
        function applyTabRestrictions() {
            if (currentUserRole === ROLES.ADMIN) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.style.display = '';
                    btn.disabled = false;
                });
                return;
            }

            document.querySelectorAll('.tab-btn').forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                const match = onclick.match(/switchTab\(['"](.+?)['"]\)/);
                if (match) {
                    const tabId = match[1];
                    btn.style.display = currentUserAllowedTabs.includes(tabId) ? '' : 'none';
                }
            });
            console.log('ğŸ“‘ Sekme kÄ±sÄ±tlamalarÄ± uygulandÄ±:', currentUserAllowedTabs);
        }

        // KullanÄ±cÄ± yetkilerini kaydet
        async function saveUserPermissions(emailKey) {
            const roleSelect = document.getElementById(`role-select-${emailKey}`);
            const tabsContainer = document.getElementById(`tabs-${emailKey}`);
            const newRole = roleSelect.value;
            const allowedTabs = [];

            tabsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                allowedTabs.push(cb.value);
            });

            try {
                await database.ref(`evde_saglik_ortak_veri/users_roles/${emailKey}`).update({
                    role: newRole,
                    allowedTabs: allowedTabs
                });
                showToast('Yetkiler gÃ¼ncellendi!', 'success');
                await loadUserList();
            } catch (error) {
                showToast('GÃ¼ncelleme baÅŸarÄ±sÄ±z!', 'error');
            }
        }
        console.log('ğŸ” Rol BazlÄ± Yetkilendirme Sistemi YÃ¼klendi');
    </script>
    <!-- KULLANICI YÃ–NETÄ°M MODALI -->
    <div id="user-management-modal"
        class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[85vh] flex flex-col modal-enter">
            <div class="p-5 border-b flex justify-between items-center bg-yellow-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-yellow-800 flex items-center gap-2">
                    ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi
                </h3>
                <button onclick="closeUserManagementModal()"
                    class="text-gray-400 hover:text-red-500 text-xl font-bold">âœ•</button>
            </div>
            <div class="p-4 overflow-y-auto flex-grow">
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-700">
                    <strong>ğŸ‘‘ Admin:</strong> Tam yetki | <strong>ğŸ‘¤ KullanÄ±cÄ±:</strong> Veri giriÅŸi | <strong>ğŸ‘ï¸
                        GÃ¶rÃ¼ntÃ¼leyici:</strong> Sadece okuma
                </div>
                <div id="user-list-container" class="space-y-4"></div>
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button onclick="closeUserManagementModal()"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold text-sm hover:bg-gray-300">Kapat</button>
            </div>
        </div>
    </div>
    <!-- AKTÄ°VÄ°TE LOG PANELÄ° -->
    <div id="activity-log-panel"
        class="fixed top-0 right-0 w-80 h-full bg-white shadow-2xl z-[200] transform translate-x-full transition-transform duration-300 border-l">
        <div class="p-4 bg-gray-800 text-white flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2">ğŸ”” Son Ä°ÅŸlemler</h3>
            <button onclick="closeActivityLogPanel()" class="text-white/70 hover:text-white text-xl">âœ•</button>
        </div>
        <div class="p-2 bg-gray-100 border-b flex justify-between items-center">
            <span class="text-[10px] text-gray-500" id="activity-count">0 kayÄ±t</span>
            <button onclick="clearActivityLogs()"
                class="text-[10px] text-red-500 hover:text-red-700 font-bold">Temizle</button>
        </div>
        <div id="activity-log-list" class="overflow-y-auto h-[calc(100%-100px)] p-2 space-y-2">
            <p class="text-center text-gray-400 text-xs py-10">HenÃ¼z iÅŸlem yok</p>
        </div>
    </div>
    <div id="activity-log-overlay" onclick="closeActivityLogPanel()" class="fixed inset-0 bg-black/30 z-[199] hidden">
    </div>

    <!-- DOKTOR'A Ä°LET MODÃœLÃœ JAVASCRIPT -->
    <script>
        // ============================================
        // DOKTOR'A Ä°LET - VERÄ° VE FONKSÄ°YONLAR
        // ============================================

        // Global deÄŸiÅŸken - doctorRequestsList ana script bloÄŸunda tanÄ±mlÄ±
        let editingDoctorRequestId = null;

        // Alt sekme deÄŸiÅŸtirme fonksiyonu
        function switchPatientSubTab(tabName) {
            // TÃ¼m subtab iÃ§eriklerini gizle
            document.querySelectorAll('#tab-hastatakip .subtab-content').forEach(el => {
                el.classList.add('hidden');
            });

            // TÃ¼m subtab butonlarÄ±nÄ± pasif yap
            document.querySelectorAll('#tab-hastatakip [id^="subtab-btn-"]').forEach(btn => {
                btn.classList.remove('border-indigo-600', 'text-indigo-700', 'bg-indigo-50', 'border-blue-600', 'text-blue-700', 'bg-blue-50');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // SeÃ§ilen sekmeyi gÃ¶ster
            const targetContent = document.getElementById('subtab-' + tabName);
            const targetBtn = document.getElementById('subtab-btn-' + tabName);

            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            if (targetBtn) {
                targetBtn.classList.remove('border-transparent', 'text-gray-500');
                if (tabName === 'islem') {
                    targetBtn.classList.add('border-indigo-600', 'text-indigo-700', 'bg-indigo-50');
                } else {
                    targetBtn.classList.add('border-blue-600', 'text-blue-700', 'bg-blue-50');
                }
            }

            // Ä°lgili listeyi render et
            if (tabName === 'doktor') {
                renderDoctorRequestsList();
                // BugÃ¼nÃ¼n tarihini varsayÄ±lan olarak ayarla
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('dr-date');
                if (dateInput && !dateInput.value) {
                    dateInput.value = today;
                }
            }

            // Lucide ikonlarÄ± yenile
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Doktor talebi ekleme
        function addDoctorRequest() {
            const patientInput = document.getElementById('dr-patient');
            const requestInput = document.getElementById('dr-request');
            const dateInput = document.getElementById('dr-date');

            const patient = patientInput?.value?.trim();
            const request = requestInput?.value?.trim();
            const date = dateInput?.value;

            if (!patient) {
                if (typeof showToast === 'function') showToast('LÃ¼tfen hasta adÄ± girin!', 'warning');
                patientInput?.focus();
                return;
            }

            if (!request) {
                if (typeof showToast === 'function') showToast('LÃ¼tfen talebi yazÄ±n!', 'warning');
                requestInput?.focus();
                return;
            }

            if (!date) {
                if (typeof showToast === 'function') showToast('LÃ¼tfen tarih seÃ§in!', 'warning');
                dateInput?.focus();
                return;
            }

            // KullanÄ±cÄ± bilgisini al
            const userEmail = currentUser?.email || 'Bilinmeyen';

            if (editingDoctorRequestId) {
                // DÃ¼zenleme modu
                const index = window.doctorRequestsList.findIndex(r => r.id === editingDoctorRequestId);
                if (index !== -1) {
                    window.doctorRequestsList[index].patient = patient;
                    window.doctorRequestsList[index].request = request;
                    window.doctorRequestsList[index].date = date;
                    window.doctorRequestsList[index].lastModifiedBy = userEmail;
                    window.doctorRequestsList[index].lastModifiedAt = new Date().toISOString();
                }
                editingDoctorRequestId = null;
                document.getElementById('btn-dr-save').innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> <span>Doktora Ä°let</span>';
                document.getElementById('btn-dr-cancel').classList.add('hidden');
                if (typeof showToast === 'function') showToast('Talep gÃ¼ncellendi!', 'success');
            } else {
                // Yeni kayÄ±t
                const newRequest = {
                    id: Date.now(),
                    patient: patient,
                    request: request,
                    date: date,
                    createdBy: userEmail,
                    createdAt: new Date().toISOString()
                };
                window.doctorRequestsList.push(newRequest);
                if (typeof showToast === 'function') showToast('Talep doktora iletildi!', 'success');
            }

            // Formu temizle
            patientInput.value = '';
            requestInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0];

            // Kaydet ve render et
            saveDoctorRequests();
            renderDoctorRequestsList();

            // Lucide ikonlarÄ± yenile
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Talep silme
        function deleteDoctorRequest(id) {
            if (!confirm('Bu talebi silmek istediÄŸinize emin misiniz?')) return;

            window.doctorRequestsList = window.doctorRequestsList.filter(r => r.id !== id);
            saveDoctorRequests();
            renderDoctorRequestsList();

            if (typeof showToast === 'function') showToast('Talep silindi!', 'info');
        }

        // Talep dÃ¼zenleme
        function editDoctorRequest(id) {
            const request = window.doctorRequestsList.find(r => r.id === id);
            if (!request) return;

            editingDoctorRequestId = id;

            document.getElementById('dr-patient').value = request.patient || '';
            document.getElementById('dr-request').value = request.request || '';
            document.getElementById('dr-date').value = request.date || '';

            document.getElementById('btn-dr-save').innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i> <span>GÃ¼ncelle</span>';
            document.getElementById('btn-dr-cancel').classList.remove('hidden');

            // Forma scroll
            document.getElementById('dr-patient').focus();

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // DÃ¼zenleme iptali
        function cancelDoctorRequestEdit() {
            editingDoctorRequestId = null;

            document.getElementById('dr-patient').value = '';
            document.getElementById('dr-request').value = '';
            document.getElementById('dr-date').value = new Date().toISOString().split('T')[0];

            document.getElementById('btn-dr-save').innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> <span>Doktora Ä°let</span>';
            document.getElementById('btn-dr-cancel').classList.add('hidden');

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Aktif sekme durumu (varsayÄ±lan: 'active')
        window.drActiveTab = window.drActiveTab || 'active';

        // Sekme deÄŸiÅŸtirme fonksiyonu
        function switchDrTab(tab) {
            window.drActiveTab = tab;

            // Sekme butonlarÄ±nÄ± gÃ¼ncelle
            const activeBtn = document.getElementById('dr-tab-active');
            const historyBtn = document.getElementById('dr-tab-history');

            if (activeBtn && historyBtn) {
                if (tab === 'active') {
                    activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition';
                    historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
                } else {
                    historyBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition';
                    activeBtn.className = 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition';
                }
            }

            renderDoctorRequestsList();
        }

        // Arama fonksiyonu
        function searchDoctorRequests(term) {
            window.drSearchTerm = term.toLowerCase();
            renderDoctorRequestsList();
        }

        // AramayÄ± temizle
        function clearDrSearch() {
            window.drSearchTerm = '';
            const searchInput = document.getElementById('dr-search-input');
            if (searchInput) searchInput.value = '';
            renderDoctorRequestsList();
        }
        // Liste render fonksiyonu
        function renderDoctorRequestsList() {
            const container = document.getElementById('doctor-requests-list');
            const countBadge = document.getElementById('dr-count-badge');

            if (!container) return;

            const today = new Date().toISOString().split('T')[0];
            const currentTab = window.drActiveTab || 'active';
            const searchTerm = window.drSearchTerm || '';

            // Sekme ve arama HTML
            const tabsHtml = `
            <div class="flex flex-col gap-2 mb-4">
                <div class="flex gap-2 p-1 bg-gray-100 rounded-lg">
                    <button id="dr-tab-active" onclick="switchDrTab('active')"
                        class="${currentTab === 'active' ? 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition' : 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition'}">
                        ğŸ“‹ Aktif Talepler
                    </button>
                    <button id="dr-tab-history" onclick="switchDrTab('history')"
                        class="${currentTab === 'history' ? 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-blue-600 text-white transition' : 'flex-1 py-2 px-4 text-sm font-bold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition'}">
                        ğŸ“ GeÃ§miÅŸ
                    </button>
                </div>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="dr-search-input"
                        placeholder="Hasta adÄ± veya talep ara..."
                        value="${searchTerm}"
                        oninput="searchDoctorRequests(this.value)"
                        class="w-full pl-9 pr-8 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                        ${searchTerm ? `
                        <button onclick="clearDrSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
            `;

            // Liste boÅŸsa mesaj gÃ¶ster
            if (!window.doctorRequestsList || window.doctorRequestsList.length === 0) {
                container.innerHTML = tabsHtml + `
            <div class="flex flex-col items-center justify-center h-full text-gray-400 py-20">
                <i data-lucide="inbox" class="w-12 h-12 mb-3 opacity-50"></i>
                <p class="text-sm font-medium">HenÃ¼z doktor talebi yok</p>
                <p class="text-xs">Yeni talep eklemek iÃ§in formu kullanÄ±n</p>
            </div>
        `;
                if (countBadge) countBadge.textContent = '0 KayÄ±t';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // GÃ¶receli tarih formatÄ± fonksiyonu
            function getRelativeDate(dateStr) {
                const todayDate = new Date();
                todayDate.setHours(0, 0, 0, 0);
                const targetDate = new Date(dateStr);
                targetDate.setHours(0, 0, 0, 0);

                const diffTime = targetDate - todayDate;
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays === 0) return 'BugÃ¼n';
                if (diffDays === 1) return 'YarÄ±n';
                if (diffDays === -1) return 'DÃ¼n';
                if (diffDays > 1) return `${diffDays} gÃ¼n sonra`;
                if (diffDays < -1) return `${Math.abs(diffDays)} gÃ¼n Ã¶nce`;
                return dateStr;
            }

            // Sekmeye gÃ¶re filtrele
            let filteredList;
            if (currentTab === 'active') {
                // Aktif: TamamlanmamÄ±ÅŸ ve iptal edilmemiÅŸ TÃœM talepler (geÃ§miÅŸ tarihli olanlar dahil)
                filteredList = window.doctorRequestsList.filter(item => {
                    const status = item.status || 'pending';
                    // Aktif sekmede: sadece tamamlanmamÄ±ÅŸ ve iptal edilmemiÅŸ olanlar
                    return status !== 'completed' && status !== 'cancelled';
                });
            } else {
                // GeÃ§miÅŸ: TamamlanmÄ±ÅŸ veya iptal edilmiÅŸ
                filteredList = window.doctorRequestsList.filter(item => {
                    const status = item.status || 'pending';
                    // GeÃ§miÅŸ sekmede: tamamlanmÄ±ÅŸ veya iptal edilmiÅŸ
                    return status === 'completed' || status === 'cancelled';
                });
            }

            // Arama filtresi uygula
            if (searchTerm) {
                filteredList = filteredList.filter(item => {
                    const patientMatch = item.patient && item.patient.toLowerCase().includes(searchTerm);
                    const requestMatch = item.request && item.request.toLowerCase().includes(searchTerm);
                    return patientMatch || requestMatch;
                });
            }

            // Tarihe gÃ¶re kronolojik sÄ±rala (eski tarihler Ã¼stte)
            const sortedList = [...filteredList].sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateA - dateB; // KÃ¼Ã§Ã¼k tarih Ã¶nce (eski tarihler Ã¼stte)
            });

            let html = tabsHtml;

            // FiltrelenmiÅŸ liste boÅŸsa
            if (sortedList.length === 0) {
                html += `
            <div class="flex flex-col items-center justify-center text-gray-400 py-10">
                <i data-lucide="inbox" class="w-10 h-10 mb-2 opacity-50"></i>
                <p class="text-sm font-medium">${currentTab === 'active' ? 'Aktif talep yok' : 'GeÃ§miÅŸ talep yok'}</p>
            </div>
        `;
                container.innerHTML = html;
                if (countBadge) countBadge.textContent = `${sortedList.length} KayÄ±t`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // Tablo baÅŸlÄ±ÄŸÄ±
            html += `
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-[10px] text-gray-400 uppercase bg-white border-b sticky top-0">
                        <tr>
                            <th class="px-4 py-3 border-2 border-gray-600 w-32">Tarih (Kalan GÃ¼n)</th>
                            <th class="px-4 py-3 border-2 border-gray-600 w-72">Hasta</th>
                            <th class="px-4 py-3 border-2 border-gray-600">Not</th>
                            <th class="px-4 py-3 text-right border-2 border-gray-600 w-48">YÃ¶net</th>
                        </tr>
                    </thead>
                    <tbody>
                        `;

            sortedList.forEach(item => {
                const isToday = item.date === today;
                const isPast = item.date < today;

                // GÃ¶receli tarih formatÄ±
                const relativeDate = getRelativeDate(item.date);
                const dateObj = new Date(item.date);
                const formattedDate = dateObj.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });

                // Durum bazlÄ± renk ÅŸemasÄ±
                const status = item.status || 'pending';
                let rowClass = 'hover:bg-gray-50';
                let statusBadge = '';
                let statusStyle = '';
                let showActionButtons = true;

                switch (status) {
                    case 'completed':
                        rowClass = 'bg-green-50/60 opacity-75';
                        statusBadge = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold border border-green-200 block text-center mt-1">TAMAMLANDI</span>`;
                        statusStyle = 'line-through text-gray-400';
                        showActionButtons = false;
                        break;
                    case 'postponed':
                        rowClass = 'bg-amber-50';
                        const postponedFromDate = item.postponedFrom ? new Date(item.postponedFrom).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
                        statusBadge = `<span class="text-amber-600 font-bold text-[10px] block mt-1">â³ ${postponedFromDate ? postponedFromDate + ' tarihinden ' : ''}ERTELENDÄ°</span>`;
                        break;
                    case 'cancelled':
                        rowClass = 'bg-gray-100 text-gray-400';
                        statusBadge = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold border border-red-200 block text-center mt-1">Ä°PTAL</span>`;
                        statusStyle = 'line-through';
                        showActionButtons = false;
                        break;
                    default: // pending
                        if (isToday) {
                            statusBadge = `<span class="text-green-600 font-bold text-[10px] block mt-1">BUGÃœN</span>`;
                            rowClass = 'bg-green-50 border-green-200';
                        } else if (isPast) {
                            statusBadge = `<span class="text-red-600 font-bold text-[10px] block mt-1">GEÃ‡TÄ°</span>`;
                            rowClass = 'bg-red-50';
                        } else {
                            const diffDays = Math.round((dateObj - new Date().setHours(0, 0, 0, 0)) / (1000 * 60 * 60 * 24));
                            statusBadge = `<span class="text-gray-500 text-[10px] block mt-1">${diffDays} GÃ¼n KaldÄ±</span>`;
                        }
                }

                // Aksiyon butonlarÄ±
                let actionButtons = '';
                if (showActionButtons) {
                    actionButtons = `
                <div class="flex flex-wrap gap-1 justify-end">
                    <button onclick="editDoctorRequest(${item.id})" class="flex items-center gap-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded border border-blue-200 text-[10px] font-bold transition" title="DÃ¼zenle"><i data-lucide="edit-3" class="w-3 h-3"></i> DÃ¼z.</button>
                    <button onclick="setDoctorRequestStatus(${item.id}, 'completed')" class="flex items-center gap-1 bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded border border-green-200 text-[10px] font-bold transition" title="TamamlandÄ±"><i data-lucide="check" class="w-3 h-3"></i> Tamam</button>
                    <button onclick="postponeDoctorRequest(${item.id})" class="flex items-center gap-1 bg-orange-100 hover:bg-orange-200 text-orange-700 px-2 py-1 rounded border border-orange-200 text-[10px] font-bold transition" title="Ertele"><i data-lucide="calendar-clock" class="w-3 h-3"></i> Ertele</button>
                    <button onclick="setDoctorRequestStatus(${item.id}, 'cancelled')" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded border border-red-200 text-[10px] font-bold transition" title="Ä°ptal"><i data-lucide="x" class="w-3 h-3"></i> Ä°ptal</button>
                </div>
            `;
                } else {
                    actionButtons = `
                <div class="flex flex-wrap gap-1 justify-end">
                    <button onclick="setDoctorRequestStatus(${item.id}, 'pending')" class="flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded border border-gray-200 text-[10px] font-bold transition" title="Geri Al"><i data-lucide="undo" class="w-3 h-3"></i> Geri Al</button>
                    <button onclick="deleteDoctorRequest(${item.id})" class="flex items-center gap-1 bg-red-100 hover:bg-red-200 text-red-700 px-2 py-1 rounded border border-red-200 text-[10px] font-bold transition" title="Sil"><i data-lucide="trash-2" class="w-3 h-3"></i> Sil</button>
                </div>
            `;
                }

                html += `
                        <tr class="${rowClass} border-b border-gray-200">
                            <td class="px-4 py-3 border-2 border-gray-600">
                                <div class="font-bold text-sm ${statusStyle}">${formattedDate}</div>
                                ${statusBadge}
                            </td>
                            <td class="px-4 py-3 border-2 border-gray-600">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-sm ${statusStyle}">${escapeHtml(item.patient)}</span>
                                    <span class="text-[10px] px-2 py-0.5 rounded-full font-bold ${isToday ? 'bg-green-100 text-green-700' : isPast ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}">${relativeDate}</span>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-1">
                                    <i data-lucide="user" class="w-2.5 h-2.5 inline mr-0.5"></i>
                                    Ekl: ${escapeHtml(item.createdBy || 'Bilinmiyor')}
                                </div>
                                ${item.lastModifiedBy ? `
                                <div class="text-[10px] text-blue-500 mt-0.5">
                                    <i data-lucide="edit-3" class="w-2.5 h-2.5 inline mr-0.5"></i>
                                    Son: ${escapeHtml(item.lastModifiedBy)} â€¢ ${item.lastModifiedAt ? new Date(item.lastModifiedAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : ''}
                                </div>
                                ` : ''}
                            </td>
                            <td class="px-4 py-3 border-2 border-gray-600">
                                <div class="text-sm ${statusStyle} whitespace-pre-line">${escapeHtml(item.request)}</div>
                            </td>
                            <td class="px-4 py-3 border-2 border-gray-600">
                                ${actionButtons}
                            </td>
                        </tr>
                        `;
            });

            html += `
                    </tbody>
                </table>
            </div>
            `;

            container.innerHTML = html;
            if (countBadge) countBadge.textContent = window.doctorRequestsList.length + ' KayÄ±t';

            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Arama kutusuna focus'u geri ver
            if (searchTerm) {
                const searchInput = document.getElementById('dr-search-input');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.setSelectionRange(searchTerm.length, searchTerm.length);
                }
            }
        }

        // HTML escape fonksiyonu (gÃ¼venlik iÃ§in)
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Durum deÄŸiÅŸtirme fonksiyonu (TamamlandÄ±/Ertele/Ä°ptal/Geri Al)
        function setDoctorRequestStatus(id, newStatus) {
            const index = window.doctorRequestsList.findIndex(r => r.id === id);
            if (index === -1) {
                console.error('Talep bulunamadÄ±:', id);
                return;
            }

            // KullanÄ±cÄ± bilgisini al
            let userEmail = 'Bilinmeyen';
            if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                userEmail = firebase.auth().currentUser.email || 'Bilinmeyen';
            }

            // Mevcut durumu kaydet (geri alma iÃ§in)
            const currentStatus = window.doctorRequestsList[index].status || 'pending';
            const today = new Date().toISOString().split('T')[0];

            // EÄŸer geri alma iÅŸlemi ise, Ã¶nceki durumu kullan
            let finalStatus = newStatus;
            if (newStatus === 'pending' && window.doctorRequestsList[index].previousStatus) {
                finalStatus = window.doctorRequestsList[index].previousStatus;
            }

            // Ã–nceki durumu kaydet (sadece yeni bir durum deÄŸiÅŸikliÄŸi ise)
            if (newStatus !== 'pending') {
                window.doctorRequestsList[index].previousStatus = currentStatus;
            }

            // Not: Geri alma iÅŸleminde tarih deÄŸiÅŸtirilmez
            // BugÃ¼n veya gelecek tarihli iÅŸlemler Aktif'e, geÃ§miÅŸ tarihli olanlar GeÃ§miÅŸ'te kalÄ±r

            // Durumu gÃ¼ncelle
            window.doctorRequestsList[index].status = finalStatus;
            window.doctorRequestsList[index].lastModifiedBy = userEmail;
            window.doctorRequestsList[index].lastModifiedAt = new Date().toISOString();

            // Duruma gÃ¶re mesaj gÃ¶ster
            let statusMessage = '';
            switch (finalStatus) {
                case 'completed':
                    statusMessage = 'âœ“ Talep tamamlandÄ± olarak iÅŸaretlendi';
                    break;
                case 'postponed':
                    statusMessage = newStatus === 'pending' ? 'â†© Talep ertelendi durumuna geri alÄ±ndÄ±' : 'â³ Talep ertelendi';
                    break;
                case 'cancelled':
                    statusMessage = 'âœ• Talep iptal edildi';
                    break;
                case 'pending':
                    statusMessage = 'â†© Talep durumu geri alÄ±ndÄ±';
                    break;
            }

            // Kaydet ve render et
            saveDoctorRequests();
            renderDoctorRequestsList();

            if (typeof showToast === 'function') {
                showToast(statusMessage, finalStatus === 'cancelled' ? 'warning' : 'success');
            }

            console.log(`ğŸ“ Talep durumu gÃ¼ncellendi: ${finalStatus} - GÃ¼ncelleyen: ${userEmail}`);
        }

        // Erteleme fonksiyonu - Tarih seÃ§ici ile
        function postponeDoctorRequest(id) {
            const request = window.doctorRequestsList.find(r => r.id === id);
            if (!request) {
                console.error('Talep bulunamadÄ±:', id);
                return;
            }

            // Tarih seÃ§ici modalÄ± oluÅŸtur
            const modalHtml = `
            <div id="postpone-modal" class="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“…</span> Erteleme Tarihi SeÃ§
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        <strong>${escapeHtml(request.patient)}</strong> hastasÄ±nÄ±n talebini hangi gÃ¼ne ertelemek istiyorsunuz?
                    </p>
                    <input type="date" id="postpone-date-input"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 text-lg"
                        min="${new Date().toISOString().split('T')[0]}"
                        value="${request.date || new Date().toISOString().split('T')[0]}">
                        <div class="flex gap-2 mt-6">
                            <button onclick="closePostponeModal()"
                                class="flex-1 py-2.5 px-4 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition">
                                Ä°ptal
                            </button>
                            <button onclick="confirmPostpone(${id})"
                                class="flex-1 py-2.5 px-4 bg-amber-500 text-white rounded-lg font-bold hover:bg-amber-600 transition">
                                â³ Ertele
                            </button>
                        </div>
                </div>
            </div>
            `;

            // ModalÄ± ekle
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Modal kapatma
        function closePostponeModal() {
            const modal = document.getElementById('postpone-modal');
            if (modal) modal.remove();
        }

        // Erteleme onaylama
        function confirmPostpone(id) {
            const dateInput = document.getElementById('postpone-date-input');
            const newDate = dateInput?.value;

            if (!newDate) {
                if (typeof showToast === 'function') showToast('LÃ¼tfen bir tarih seÃ§in!', 'warning');
                return;
            }

            const index = window.doctorRequestsList.findIndex(r => r.id === id);
            if (index === -1) return;

            // KullanÄ±cÄ± bilgisini al
            let userEmail = 'Bilinmeyen';
            if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                userEmail = firebase.auth().currentUser.email || 'Bilinmeyen';
            }

            // Tarihi ve durumu gÃ¼ncelle
            const oldDate = window.doctorRequestsList[index].date;
            window.doctorRequestsList[index].date = newDate;
            window.doctorRequestsList[index].status = 'postponed';
            window.doctorRequestsList[index].lastModifiedBy = userEmail;
            window.doctorRequestsList[index].lastModifiedAt = new Date().toISOString();
            window.doctorRequestsList[index].postponedFrom = oldDate; // Eski tarihi sakla

            // ModalÄ± kapat
            closePostponeModal();

            // Kaydet ve render et
            saveDoctorRequests();
            renderDoctorRequestsList();

            // Tarih formatla
            const formattedDate = new Date(newDate).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });

            if (typeof showToast === 'function') {
                showToast(`â³ Talep ${formattedDate} tarihine ertelendi`, 'success');
            }

            console.log(`ğŸ“… Talep ertelendi: ${oldDate} â†’ ${newDate} - GÃ¼ncelleyen: ${userEmail}`);
        }

        // Firebase'e kaydetme (doÄŸrudan Firebase auth kullan - scope sorunu iÃ§in)
        async function saveDoctorRequests() {
            const key = 'evdeSaglikDoctorRequests_V1';

            // Cache'i gÃ¼ncelle
            if (!window._firebaseCache) window._firebaseCache = {};
            window._firebaseCache[key] = window.doctorRequestsList;

            // Firebase baÄŸlantÄ±sÄ± ve kullanÄ±cÄ± kontrolÃ¼ (doÄŸrudan firebase.auth() kullan)
            if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                const user = firebase.auth().currentUser;
                const userDataPath = `users/${user.uid}/data`;

                try {
                    console.log(`ğŸ”„ Firebase: "${key}" kaydediliyor...`);
                    await firebase.database().ref(`${userDataPath}/${key}`).set(window.doctorRequestsList);
                    console.log('âœ… Doktor talepleri Firebase\'e kaydedildi:', window.doctorRequestsList.length, 'kayÄ±t');
                } catch (err) {
                    console.error('âŒ Firebase kaydetme hatasÄ±:', err);
                }
            } else {
                // Fallback: localStorage'a kaydet
                try {
                    localStorage.setItem(key, JSON.stringify(window.doctorRequestsList));
                    console.log('ğŸ’¾ Doktor talepleri localStorage\'a kaydedildi:', window.doctorRequestsList.length, 'kayÄ±t');
                } catch (e) {
                    console.error('localStorage hatasÄ±:', e);
                }
            }
        }

        // Sayfa yÃ¼klendiÄŸinde verileri yÃ¼kle (Firebase'den doÄŸrudan)
        async function loadDoctorRequests() {
            const key = 'evdeSaglikDoctorRequests_V1';

            try {
                // Firebase baÄŸlantÄ±sÄ± ve kullanÄ±cÄ± kontrolÃ¼
                if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                    const user = firebase.auth().currentUser;
                    const userDataPath = `users/${user.uid}/data`;

                    console.log('ğŸ”„ Doktor talepleri Firebase\'den yÃ¼kleniyor...');

                    // Firebase'den doÄŸrudan oku
                    const snapshot = await firebase.database().ref(`${userDataPath}/${key}`).once('value');
                    const value = snapshot.val();

                    if (value) {
                        if (Array.isArray(value)) {
                            window.doctorRequestsList = value;
                        } else if (typeof value === 'object') {
                            window.doctorRequestsList = Object.values(value);
                        } else {
                            window.doctorRequestsList = [];
                        }
                        console.log('âœ… Doktor talepleri Firebase\'den yÃ¼klendi:', window.doctorRequestsList.length, 'kayÄ±t');
                    } else {
                        window.doctorRequestsList = [];
                        console.log('â„¹ï¸ Firebase\'de doktor talebi bulunamadÄ±');
                    }
                } else {
                    // Firebase yoksa cache veya localStorage'dan oku
                    if (window._firebaseCache && window._firebaseCache[key]) {
                        const cachedData = window._firebaseCache[key];
                        if (Array.isArray(cachedData)) {
                            window.doctorRequestsList = cachedData;
                        } else if (typeof cachedData === 'string') {
                            window.doctorRequestsList = JSON.parse(cachedData) || [];
                        } else {
                            window.doctorRequestsList = [];
                        }
                        console.log('ğŸ“¦ Doktor talepleri cache\'den yÃ¼klendi:', window.doctorRequestsList.length, 'kayÄ±t');
                    } else {
                        const data = localStorage.getItem(key);
                        if (data) {
                            window.doctorRequestsList = JSON.parse(data) || [];
                            console.log('ğŸ’¾ Doktor talepleri localStorage\'dan yÃ¼klendi:', window.doctorRequestsList.length, 'kayÄ±t');
                        }
                    }
                }

                // Listeyi render et
                if (typeof renderDoctorRequestsList === 'function') {
                    renderDoctorRequestsList();
                }
            } catch (e) {
                console.error('âŒ Doktor talepleri yÃ¼klenirken hata:', e);
                window.doctorRequestsList = [];
            }
        }

        // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r
        document.addEventListener('DOMContentLoaded', function () {
            // Veriler Firebase'den yÃ¼klenene kadar bekle
            setTimeout(() => {
                loadDoctorRequests();

                // Ã–ZEL CANLI SENKRONÄ°ZASYON - Firebase Real-time Listener
                startDoctorRequestsRealtimeListener();
            }, 2000);
        });

        // Doktor talepleri iÃ§in Ã¶zel Firebase real-time listener
        function startDoctorRequestsRealtimeListener() {
            const key = 'evdeSaglikDoctorRequests_V1';

            // Firebase baÄŸlantÄ±sÄ±nÄ± kontrol et
            const checkAndStartListener = () => {
                // Firebase database eriÅŸimi kontrol
                if (typeof firebase === 'undefined' || !firebase.database) {
                    console.log('â³ Firebase henÃ¼z hazÄ±r deÄŸil, tekrar deneniyor...');
                    setTimeout(checkAndStartListener, 1000);
                    return;
                }

                // KullanÄ±cÄ± giriÅŸ kontrolÃ¼
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('â³ KullanÄ±cÄ± henÃ¼z giriÅŸ yapmadÄ±, listener bekliyor...');
                    setTimeout(checkAndStartListener, 1000);
                    return;
                }

                // userDataPath oluÅŸtur
                const userDataPath = `users/${user.uid}/data`;
                const dbRef = firebase.database().ref(`${userDataPath}/${key}`);

                console.log('ğŸ”” Doktor talepleri iÃ§in CANLI DÄ°NLEYÄ°CÄ° baÅŸlatÄ±ldÄ±!');

                // Real-time listener ekle
                dbRef.on('value', (snapshot) => {
                    const value = snapshot.val();
                    console.log('ğŸ”„ Firebase\'den anlÄ±k gÃ¼ncelleme alÄ±ndÄ±:', key);

                    // Global deÄŸiÅŸkeni gÃ¼ncelle
                    if (Array.isArray(value)) {
                        window.doctorRequestsList = value;
                    } else if (value && typeof value === 'object') {
                        window.doctorRequestsList = Object.values(value);
                    } else {
                        window.doctorRequestsList = [];
                    }

                    // Listeyi render et
                    if (typeof renderDoctorRequestsList === 'function') {
                        renderDoctorRequestsList();
                        console.log('âœ… Doktor talepleri listesi ANLIK gÃ¼ncellendi:', window.doctorRequestsList.length, 'kayÄ±t');
                    }
                }, (error) => {
                    console.error('âŒ Firebase listener hatasÄ±:', error);
                });
            };

            checkAndStartListener();
        }
    </script>

</body>

</html>